---
/**
 * 日期时间组件
 *
 * @fileoverview 显示文章的发布/更新时间
 *
 * 核心逻辑：
 * 1. 自动选择最新时间（更新时间或发布时间）
 * 2. 生成 ISO 格式 datetime 属性（SEO 优化）
 * 3. 使用 dayjs 做时区与相对时间格式化
 *
 * 依赖关系：
 * - 被 Card.astro 等组件使用
 * - 用于显示文章列表和详情页的时间信息
 */

import dayjs from "dayjs";
import utc from "dayjs/plugin/utc";
import timezone from "dayjs/plugin/timezone";
import relativeTime from "dayjs/plugin/relativeTime";
import "dayjs/locale/zh-cn";
import { SITE } from "@/config";

dayjs.extend(utc);
dayjs.extend(timezone);
dayjs.extend(relativeTime);
dayjs.locale("zh-cn");

const TZ = SITE.timezone || "Asia/Shanghai";
/** 完整日期时间格式（用于 title 等） */
const FULL_FORMAT = "YYYY-MM-DD HH:mm:ss";
/** 短日期格式（绝对时间显示） */
const SHORT_FORMAT = "YYYY-MM-DD";

/**
 * 组件属性接口
 *
 * @property class - 额外的 CSS 类名
 * @property size - 尺寸：sm（小）或 lg（大）
 * @property timezone - 时区（可选，如 Asia/Shanghai）
 * @property pubDatetime - 发布时间
 * @property modDatetime - 更新时间（可选）
 * @property format - 显示格式：relative（相对时间）或 absolute（绝对时间 YYYY-MM-DD）
 */
export interface Props {
  class?: string;
  size?: "sm" | "lg";
  timezone: string | undefined;
  pubDatetime: string | Date;
  modDatetime: string | Date | undefined | null;
  format?: "relative" | "absolute";
}

const {
  pubDatetime,
  modDatetime,
  timezone: tzProp,
  size = "sm",
  class: className = "",
  format = "relative",
} = Astro.props;

const pub = dayjs(pubDatetime);
const mod = modDatetime ? dayjs(modDatetime) : null;
const latest = mod && mod.isAfter(pub) ? mod : pub;
const iso = latest.toISOString();
const tz = tzProp || TZ;
const latestInTz = dayjs.utc(latest.toDate()).tz(tz);
const pubInTz = dayjs.utc(pub.toDate()).tz(tz);

const title = pubInTz.format(FULL_FORMAT);
const displayTime =
  format === "absolute" ? latestInTz.format(SHORT_FORMAT) : latest.fromNow();
---

<div class:list={["flex items-end space-x-1", className]} title={title}>
    <time
    class:list={["text-sm", { "sm:text-base": size === "lg" }]}
      datetime={iso}
      data-date-format={format}
    >
      {displayTime}
    </time>
</div>
