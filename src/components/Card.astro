---
/**
 * 文章卡片组件
 *
 * @fileoverview 显示单篇文章的缩略信息，用于文章列表页
 *
 * 核心逻辑：
 * 1. 支持两种标题级别：h2（主列表）或 h3（次要列表）
 * 2. 自动处理封面图 URL（支持相对路径和绝对路径）
 * 3. 显示发布/更新时间
 * 4. 支持 View Transitions 动画
 * 6. 支持隐藏卡片（用于筛选功能）
 *
 * 依赖关系：
 * - 被首页、归档页、分类页、标签页等列表页面使用
 * - 依赖 Datetime.astro 显示日期
 * - 依赖 getPath 工具生成文章链接
 * - 依赖 config.ts 获取图片加载配置
 */

import { slugifyStr } from "@/utils/slugify";
import type { CollectionEntry } from "astro:content";
import { PostUtils } from "@/utils/postUtils";
import Datetime from "./Datetime.astro";
import { SITE } from "@/config";

/**
 * 组件属性接口
 *
 * 扩展自 CollectionEntry<"blog">，包含文章的所有元数据
 *
 * @property variant - 标题级别（h2 或 h3）
 * @property itemClass - 额外的 CSS 类名
 * @property hidden - 是否隐藏此卡片
 * @property dateFormat - 日期显示格式：relative（相对时间）或 absolute（绝对时间 YYYY-MM-DD）
 * @property priority - 是否为 LCP 优先资源（首屏首图时设为 true，使用 fetchpriority="high"）
 */
export interface Props extends CollectionEntry<"blog"> {
  variant?: "h2" | "h3";
  itemClass?: string;
  hidden?: boolean;
  dateFormat?: "relative" | "absolute";
  priority?: boolean;
}

const {
  variant = "h2",
  data,
  id,
  filePath,
  itemClass,
  hidden = false,
  dateFormat = "relative",
  priority = false,
} = Astro.props;

// 解构文章元数据
const { title, date, updated, timezone, image, categories } = data;

// 标题容器样式（处理溢出省略）
const headerProps = {
  class: "truncate overflow-hidden whitespace-nowrap min-w-0",
};

// 链接样式（包含 View Transition 名称）
const linkProps = {
  style: { viewTransitionName: slugifyStr(title) },
  class:
    "text-sm font-medium hover:underline focus-visible:no-underline focus-visible:underline-offset-0",
};

/**
 * 构建封面图 URL
 *
 * 处理逻辑：
 * 1. 如果为空，返回 categories 对应的 SVG（/thumbnails/{category}.svg），无分类则 blank.svg
 * 2. 如果是绝对路径（http/https 开头），直接使用
 * 3. 如果以 /images 开头，使用当前网站的 host
 * 4. 以 /thumbnails 开头：使用当前网站的 host
 * 5. 否则拼接 CDN URL
 *
 * @returns 完整的图片 URL 或 undefined
 */
const buildCoverSrc = (): string | undefined => {
  const src = typeof image === "string" ? image.trim() : "";
  if (!src) {
    const firstCategory = Array.isArray(categories) ? categories[0] : undefined;
    const filename = firstCategory || "blank";
    return `/thumbnails/${filename}.svg`;
  }
  // 绝对路径
  if (src.startsWith("http://") || src.startsWith("https://")) return src;
  // 以 /images 或 /thumbnails 开头：使用当前网站的 host
  if (src.startsWith("/images") || src.startsWith("/thumbnails")) return src;
  // 其他相对路径：拼接 CDN URL
  return `${SITE.imageConfig.imagesUrl}${src}`;
};

const coverSrc = buildCoverSrc();
---

<li class={`mb-4 ${itemClass ?? ""} ${hidden ? "hidden" : ""}`}>
  <div class="relative block">
    <div class="flex items-center gap-3">
      <!-- 封面图 -->
      {
        coverSrc && (
          <img
            src={coverSrc}
            alt={title}
            loading={priority ? "eager" : SITE.imageConfig.loading.lazy ? "lazy" : "eager"}
            fetchpriority={priority ? "high" : undefined}
            decoding="async"
            class="h-[50px] w-[50px] shrink-0 rounded-md object-cover"
          />
        )
      }
      <!-- 文章信息区 -->
      <div class="min-w-0 flex-1">
        <!-- 文章标题 -->
        <div class="min-w-0 text-lg font-medium text-accent underline-offset-4">
          {
            // 根据 variant 选择标题级别
            variant === "h2" ? (
              <h2 {...headerProps}>
                <a href={PostUtils.getPath(id, filePath, true, date, timezone)} {...linkProps}>
                  {title}
                </a>
              </h2>
            ) : (
              <h3 {...headerProps}>
                <a href={PostUtils.getPath(id, filePath, true, date, timezone)} {...linkProps}>
                  {title}
                </a>
              </h3>
            )
          }
        </div>

        <!-- 发布/更新时间 -->
        <div
          class="mt-1 flex flex-row flex-nowrap items-center space-x-2 whitespace-nowrap"
        >
          <div class="mr-1 flex items-center space-x-0.5">
            <Datetime
              pubDatetime={date}
              modDatetime={updated}
              {timezone}
              format={dateFormat}
              class="opacity-80"
            />
          </div>
        </div>
      </div>
    </div>
  </div>
</li>
