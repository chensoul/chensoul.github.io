---
/**
 * 文章目录（TOC）组件
 *
 * @fileoverview 基于 tocbot 在侧边栏渲染文章标题目录，包含异步样式与按需脚本
 *
 * 核心逻辑：
 * 1. variant="head"：异步加载 tocbot CSS（preload 转 stylesheet，无 JS 时 noscript 回退为同步 link）
 * 2. variant="body"（默认）：渲染占位容器 .toc-card.js-toc，按需加载 tocbot 脚本并初始化；覆盖样式在 src/styles/toc-override.css，由 base.css 引入
 * 3. 使用处：Layout 的 head slot 放 <Toc enabled={toc} variant="head" slot="head" />，侧边栏放 <Toc enabled={toc} />
 *
 * 依赖关系：
 * - 页面需提供 .js-toc-content 包裹正文（如文章详情布局）
 * - 覆盖样式：src/styles/toc-override.css（.toc-card.js-toc）
 */

const TOCBOT_CSS_CDN = "https://cos.chensoul.cc/dist/tocbot/tocbot.min.css";
const TOCBOT_JS_CDN = "https://cos.chensoul.cc/dist/tocbot/tocbot.min.js";

export interface Props {
  /** 是否启用目录，为 false 时不渲染 */
  enabled?: boolean;
  /** head：异步加载 tocbot CSS；body：容器 + 按需加载 tocbot 脚本（默认） */
  variant?: "head" | "body";
}

const { enabled = true, variant = "body" } = Astro.props;
---

{variant === "head" && enabled && (
  <>
    <link
      rel="preload"
      href={TOCBOT_CSS_CDN}
      as="style"
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
      onload="this.onload=null;this.rel='stylesheet'"
    />
    <noscript>
      <link
        rel="stylesheet"
        href={TOCBOT_CSS_CDN}
        crossorigin="anonymous"
        referrerpolicy="no-referrer"
      />
    </noscript>
  </>
)}

{variant === "body" && enabled && (
  <>
    <div class="toc-card js-toc" data-tocbot-src={TOCBOT_JS_CDN} />
    <script is:inline>
      (function () {
        function getTocbot() {
          return typeof window !== "undefined" && window.tocbot;
        }
        function initTocbot() {
          const tocbot = getTocbot();
          if (!tocbot) return;
          tocbot.init({
            tocSelector: ".js-toc",
            contentSelector: ".js-toc-content",
            headingSelector: "h2, h3, h4",
            hasInnerContainers: true,
            scrollSmoothDuration: 300,
            scrollSmoothOffset: 0,
          });
        }
        function tryLoadAndInitTocbot() {
          const container = document.querySelector(".js-toc");
          if (!container) return;
          if (getTocbot()) {
            initTocbot();
          } else {
            const src = container.getAttribute("data-tocbot-src");
            if (!src) return;
            const script = document.createElement("script");
            script.src = src;
            script.crossOrigin = "anonymous";
            script.referrerPolicy = "no-referrer";
            script.onload = initTocbot;
            document.body.appendChild(script);
          }
        }
        tryLoadAndInitTocbot();
        document.addEventListener("DOMContentLoaded", tryLoadAndInitTocbot);
        window.addEventListener("load", tryLoadAndInitTocbot);
      })();
    </script>
  </>
)}
