---
/**
 * 文章目录（TOC）组件
 *
 * @fileoverview 基于 tocbot 在侧边栏渲染文章标题目录，包含同步样式与按需脚本
 *
 * 核心逻辑：
 * 1. variant="head"：同步加载 tocbot CSS + 紧随其后的覆盖样式 /toc-override.css，避免刷新时先现默认再闪为自定义
 * 2. variant="body"（默认）：渲染占位容器 .toc-card.js-toc，按需加载 tocbot 脚本并初始化
 * 3. 使用处：Layout 的 head slot 放 <Toc enabled={toc} variant="head" slot="head" />，侧边栏放 <Toc enabled={toc} />
 *
 * 依赖关系：
 * - 页面需提供 .js-toc-content 包裹正文（如文章详情布局）
 * - 覆盖样式：public/toc-override.css，在 head 中紧接 tocbot 之后加载
 */

const TOCBOT_CSS_CDN = "https://cos.chensoul.cc/dist/tocbot/tocbot.min.css";
const TOCBOT_JS_CDN = "https://cos.chensoul.cc/dist/tocbot/tocbot.min.js";

export interface Props {
  /** 是否启用目录，为 false 时不渲染 */
  enabled?: boolean;
  /** head：同步加载 tocbot CSS 与覆盖样式；body：容器 + 按需加载 tocbot 脚本（默认） */
  variant?: "head" | "body";
}

const { enabled = true, variant = "body" } = Astro.props;
---

{variant === "head" && enabled && (
  <>
    <link
      rel="stylesheet"
      href={TOCBOT_CSS_CDN}
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <link rel="stylesheet" href="/toc-override.css" />
  </>
)}

{variant === "body" && enabled && (
  <>
    <div class="toc-card js-toc" data-tocbot-src={TOCBOT_JS_CDN} />
    <script is:inline>
      (function () {
        function getTocbot() {
          return typeof window !== "undefined" && window.tocbot;
        }
        function initTocbot() {
          const tocbot = getTocbot();
          if (!tocbot) return;
          tocbot.init({
            tocSelector: ".js-toc",
            contentSelector: ".js-toc-content",
            headingSelector: "h2, h3, h4",
            hasInnerContainers: true,
            scrollSmoothDuration: 300,
            scrollSmoothOffset: 0,
          });
        }
        function tryLoadAndInitTocbot() {
          const container = document.querySelector(".js-toc");
          if (!container) return;
          if (getTocbot()) {
            initTocbot();
          } else {
            const src = container.getAttribute("data-tocbot-src");
            if (!src) return;
            const script = document.createElement("script");
            script.src = src;
            script.crossOrigin = "anonymous";
            script.referrerPolicy = "no-referrer";
            script.onload = initTocbot;
            document.body.appendChild(script);
          }
        }
        tryLoadAndInitTocbot();
        document.addEventListener("DOMContentLoaded", tryLoadAndInitTocbot);
        window.addEventListener("load", tryLoadAndInitTocbot);
      })();
    </script>
  </>
)}
