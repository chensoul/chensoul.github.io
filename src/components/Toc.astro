---
/**
 * 文章目录（TOC）组件
 *
 * @fileoverview 基于 tocbot 在侧边栏渲染文章标题目录，按需加载脚本并初始化
 *
 * 核心逻辑：渲染占位容器 .js-toc（id=toc-container 供脚本检测），按需加载 tocbot 脚本并初始化。
 * TOC 样式（tocbot CSS + 覆盖样式）由 Layout.astro 在 toc 为 true 时条件加载。
 *
 * 依赖关系：
 * - 页面需提供 .js-toc-content 包裹正文（如文章详情布局）
 * - Layout 需传入 toc 并在 head 中输出 tocbot CSS + 覆盖样式
 */

import { SITE } from "@/config";

export interface Props {
  /** 是否启用目录，为 false 时不渲染 */
  enabled?: boolean;
}

const { enabled = true } = Astro.props;
---

{enabled && (
  <>
    <div id="toc-container" class="js-toc" />
    <script
      is:inline
      define:vars={{ tocbotJsUrl: SITE.tocbot.jsUrl }}
    >
      (function () {
        if (!document.getElementById("toc-container")) return;
        function getTocbot() {
          return typeof window !== "undefined" && window.tocbot;
        }
        function initTocbot() {
          const tocbot = getTocbot();
          if (!tocbot) return;
          tocbot.init({
            tocSelector: ".js-toc",
            contentSelector: ".js-toc-content",
            headingSelector: "h2, h3, h4",
            hasInnerContainers: true,
            scrollSmoothDuration: 300,
            scrollSmoothOffset: 0,
          });
        }
        function tryLoadAndInitTocbot() {
          if (!document.querySelector(".js-toc")) return;
          if (getTocbot()) {
            initTocbot();
          } else if (tocbotJsUrl) {
            const script = document.createElement("script");
            script.src = tocbotJsUrl;
            script.crossOrigin = "anonymous";
            script.referrerPolicy = "no-referrer";
            script.onload = initTocbot;
            document.body.appendChild(script);
          }
        }
        tryLoadAndInitTocbot();
        document.addEventListener("DOMContentLoaded", tryLoadAndInitTocbot);
        window.addEventListener("load", tryLoadAndInitTocbot);
      })();
    </script>
  </>
)}