---
/**
 * Artalk 评论组件
 *
 * @fileoverview 集成 Artalk 评论系统
 *
 * 核心逻辑：
 * 1. 单例模式：确保全局只有一个 Artalk 实例
 * 2. 主题同步：监听主题变化，自动切换评论框深浅色模式
 * 3. 页面切换：
 *    - 切换前：销毁实例、清理观察器
 *    - 切换后：重新初始化
 * 4. 主题检测优先级：
 *    - html[data-theme] 属性
 *    - 主题按钮的 aria-label
 *    - 系统偏好设置
 *
 * 配置信息：
 * - 服务器：https://artalk.chensoul.cc
 * - 站点名：ChenSoul Blog
 * - pageKey：使用当前路径作为唯一标识
 *
 * 依赖关系：
 * - 被文章详情页使用（当 comments=true 时）
 * - 需在页面中引入 Artalk 脚本库
 * - 依赖主题按钮的 ID (#theme-btn)
 */
---

<script is:inline data-astro-rerun>
  /**
   * Artalk 评论系统集成
   * 包含初始化、主题同步、页面切换处理等功能
   */
  (function () {
    // 单例模式存储 Artalk 实例
    window.artalkInstance = window.artalkInstance || null;

    // 基本配置
    const artalkConfig = {
      el: "#Comments",
      server: "https://artalk.chensoul.cc",
      site: "ChenSoul Blog",
      pageKey: window.location.pathname,
      vote: false,
    };

    /**
     * 获取当前主题状态
     *
     * 检测优先级：
     * 1. html[data-theme] 属性
     * 2. 主题按钮的 aria-label
     * 3. 系统偏好设置
     *
     * @returns 是否为深色模式
     */
    function getCurrentTheme() {
      // 优先检查 data-theme 属性
      const htmlDataTheme = document.documentElement.getAttribute("data-theme");
      if (htmlDataTheme) {
        return htmlDataTheme === "dark";
      }

      // 备选方案：检查主题按钮状态
      const themeBtn = document.querySelector("#theme-btn");
      if (themeBtn) {
        const ariaLabel = themeBtn.getAttribute("aria-label");
        if (ariaLabel === "dark" || ariaLabel === "light") {
          return ariaLabel === "dark";
        }
      }

      // 最后备选：检查系统偏好
      return (
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches
      );
    }

    /**
     * 销毁 Artalk 实例
     *
     * 清理工作：
     * 1. 调用 destroy() 方法
     * 2. 移除残留的 DOM 元素
     * 3. 清空实例引用
     */
    function destroyArtalk() {
      if (window.artalkInstance) {
        try {
          window.artalkInstance.destroy();
          // 清理残留的DOM元素（侧边栏、弹窗等）
          document
            .querySelectorAll(".atk-sidebar, .atk-layer-wrap, .atk-layer")
            .forEach(el => el.remove());
          window.artalkInstance = null;
          console.log("Artalk 实例已销毁");
        } catch (err) {
          console.error("销毁Artalk实例失败:", err);
        }
      }
    }

    /**
     * 初始化 Artalk 实例
     *
     * 处理流程：
     * 1. 检查容器是否存在
     * 2. 检查是否已初始化（避免重复）
     * 3. 获取当前主题
     * 4. 创建并配置实例
     * 5. 初始化后同步主题
     */
    function initArtalk() {
      const container = document.getElementById("Comments");
      if (!container) {
        console.warn("Artalk容器未找到");
        return;
      }

      // 如果容器已经包含Artalk实例，跳过初始化
      if (container.querySelector(".atk-app")) {
        console.log("Artalk实例已存在，跳过初始化");
        return;
      }

      // 获取当前主题
      const isDark = getCurrentTheme();

      // 更新配置
      const config = {
        ...artalkConfig,
        pageKey: window.location.pathname,
        darkMode: isDark,
      };

      try {
        // 创建新实例
        window.artalkInstance = Artalk.init(config);
        console.log(
          `Artalk 初始化完成 - 页面: ${window.location.pathname}, 主题: ${
            isDark ? "dark" : "light"
          }`
        );

        // 初始化完成后同步主题（确保主题正确应用）
        setTimeout(() => {
          syncArtalkTheme();
        }, 100);
      } catch (err) {
        console.error("Artalk初始化失败:", err);
      }
    }

    /**
     * 同步 Artalk 主题
     *
     * 获取当前主题并调用 Artalk 的 setDarkMode 方法
     */
    function syncArtalkTheme() {
      if (!window.artalkInstance) return;

      const isDark = getCurrentTheme();
      try {
        window.artalkInstance.setDarkMode(isDark);
        console.log(`Artalk主题已同步: ${isDark ? "dark" : "light"}`);
      } catch (err) {
        console.error("同步Artalk主题失败:", err);
      }
    }

    /**
     * 设置主题变化监听器
     *
     * 监听两种变化：
     * 1. html[data-theme] 属性变化
     * 2. 主题按钮 aria-label 属性变化
     */
    function setupThemeObserver() {
      // 如果观察器已存在，先断开
      if (window._artalkThemeObserver) {
        window._artalkThemeObserver.disconnect();
      }

      // 创建新的观察器
      window._artalkThemeObserver = new MutationObserver(mutations => {
        mutations.forEach(mutation => {
          if (
            mutation.type === "attributes" &&
            mutation.attributeName === "data-theme"
          ) {
            console.log("检测到主题变化");
            // 延迟同步，确保DOM更新完成
            setTimeout(() => {
              syncArtalkTheme();
            }, 50);
          }
        });
      });

      // 观察 html 元素的 data-theme 属性变化
      window._artalkThemeObserver.observe(document.documentElement, {
        attributes: true,
        attributeFilter: ["data-theme"],
      });

      // 额外监听主题按钮变化（作为备选方案）
      const themeBtn = document.querySelector("#theme-btn");
      if (themeBtn && !window._artalkBtnObserver) {
        window._artalkBtnObserver = new MutationObserver(mutations => {
          mutations.forEach(mutation => {
            if (mutation.attributeName === "aria-label") {
              console.log("检测到主题按钮变化");
              setTimeout(() => {
                syncArtalkTheme();
              }, 50);
            }
          });
        });

        window._artalkBtnObserver.observe(themeBtn, {
          attributes: true,
          attributeFilter: ["aria-label"],
        });
      }
    }

    /**
     * 页面加载处理
     *
     * 处理流程：
     * 1. 销毁旧实例
     * 2. 检查容器是否可见
     * 3. 延迟初始化（等待 DOM 稳定）
     * 4. 设置主题观察器
     */
    function handlePageLoad() {
      console.log("Artalk页面加载处理开始");

      // 先销毁旧实例
      destroyArtalk();

      // 只有在文章页面才初始化完整的评论系统
      const container = document.getElementById("Comments");
      if (container && container.offsetParent !== null) {
        // 等待DOM稳定后初始化评论系统
        setTimeout(() => {
          initArtalk();
          setupThemeObserver();
        }, 200);
      }
    }

    /**
     * 清理所有观察器
     */
    function cleanupObservers() {
      if (window._artalkThemeObserver) {
        window._artalkThemeObserver.disconnect();
        window._artalkThemeObserver = null;
      }
      if (window._artalkBtnObserver) {
        window._artalkBtnObserver.disconnect();
        window._artalkBtnObserver = null;
      }
    }

    /**
     * 页面切换前清理
     *
     * 清理工作：
     * 1. 销毁 Artalk 实例
     * 2. 断开所有观察器
     */
    function handleBeforeSwap() {
      console.log("Artalk页面切换前清理");
      destroyArtalk();
      cleanupObservers();
    }

    /**
     * 单次设置事件监听
     *
     * 避免重复绑定事件
     */
    function setupArtalk() {
      if (window._artalkInitialized) return;
      window._artalkInitialized = true;

      // 页面切换事件
      document.addEventListener("astro:before-swap", handleBeforeSwap);
      document.addEventListener("astro:after-swap", handlePageLoad);

      // 初始加载
      if (document.readyState === "complete") {
        handlePageLoad();
      } else {
        document.addEventListener("DOMContentLoaded", handlePageLoad);
      }
    }

    // 启动Artalk
    setupArtalk();
  })();
</script>
