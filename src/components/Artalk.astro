---
/**
 * Artalk 评论组件
 *
 * @fileoverview 集成 Artalk 评论系统
 *
 * 核心逻辑：
 * 1. 单例模式：确保全局只有一个 Artalk 实例
 * 2. 主题同步：监听主题变化，自动切换评论框深浅色模式
 * 3. 页面切换：切换前销毁实例与观察器，切换后重新初始化
 * 4. 配置来自 config.ts 的 SITE.artalk
 *
 * 依赖关系：
 * - 被文章详情页使用（当 comments=true 时）
 * - 依赖主题按钮的 ID (#theme-btn)
 */
import { SITE } from "@/config";
---

<script is:inline data-astro-rerun define:vars={{ ARTALK_SCRIPT_URL: SITE.artalk.scriptUrl, ARTALK_CSS_URL: SITE.artalk.cssUrl, artalkServer: SITE.artalk.server, artalkSite: SITE.artalk.site, artalkVote: SITE.artalk.vote }}>
  /* eslint-disable no-console -- Artalk 调试与错误输出 */
  /**
   * Artalk 评论系统集成
   * 包含脚本动态加载、初始化、主题同步、页面切换处理等功能
   */
  (function () {
    if (!artalkServer) return;

    window.artalkInstance = window.artalkInstance || null;

    const artalkConfig = {
      el: "#Comments",
      server: artalkServer,
      site: artalkSite,
      pageKey: window.location.pathname,
      vote: artalkVote,
    };

    /**
     * 确保 Artalk 样式已注入：若 head 中尚无该 CSS 则插入 link
     */
    function ensureArtalkCSS() {
      const selector = 'link[href="' + ARTALK_CSS_URL + '"]';
      if (document.querySelector(selector)) return;
      const link = document.createElement("link");
      link.rel = "stylesheet";
      link.href = ARTALK_CSS_URL;
      document.head.appendChild(link);
    }

    /**
     * 确保 Artalk 脚本已加载，完成后执行 callback
     * 若已存在 window.Artalk 则直接回调；否则动态插入 script，在 onload 中回调
     */
    function loadArtalkScript(callback) {
      if (typeof window.Artalk !== "undefined") {
        callback();
        return;
      }
      const existing = document.querySelector('script[src="' + ARTALK_SCRIPT_URL + '"]');
      if (existing) {
        if (typeof window.Artalk !== "undefined") {
          callback();
          return;
        }
        existing.addEventListener("load", function onLoad() {
          existing.removeEventListener("load", onLoad);
          callback();
        });
        return;
      }
      const script = document.createElement("script");
      script.src = ARTALK_SCRIPT_URL;
      script.async = false;
      script.onload = function () {
        callback();
      };
      script.onerror = function () {
        console.error("Artalk 脚本加载失败");
      };
      document.head.appendChild(script);
    }

    /**
     * 获取当前主题状态
     *
     * 检测优先级：
     * 1. html[data-theme] 属性
     * 2. 主题按钮的 aria-label
     * 3. 系统偏好设置
     *
     * @returns 是否为深色模式
     */
    function getCurrentTheme() {
      // 优先检查 data-theme 属性
      const htmlDataTheme = document.documentElement.getAttribute("data-theme");
      if (htmlDataTheme) {
        return htmlDataTheme === "dark";
      }

      // 备选方案：检查主题按钮状态
      const themeBtn = document.querySelector("#theme-btn");
      if (themeBtn) {
        const ariaLabel = themeBtn.getAttribute("aria-label");
        if (ariaLabel === "dark" || ariaLabel === "light") {
          return ariaLabel === "dark";
        }
      }

      // 最后备选：检查系统偏好
      return (
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches
      );
    }

    /**
     * 销毁 Artalk 实例
     *
     * 清理工作：
     * 1. 调用 destroy() 方法
     * 2. 移除残留的 DOM 元素
     * 3. 清空实例引用
     */
    function destroyArtalk() {
      if (window.artalkInstance) {
        try {
          window.artalkInstance.destroy();
          // 清理残留的DOM元素（侧边栏、弹窗等）
          document
            .querySelectorAll(".atk-sidebar, .atk-layer-wrap, .atk-layer")
            .forEach(el => el.remove());
          window.artalkInstance = null;
        } catch (err) {
          console.error("销毁Artalk实例失败:", err);
        }
      }
    }

    /**
     * 初始化 Artalk 实例（调用前须已通过 loadArtalkScript 确保 window.Artalk 存在）
     *
     * 处理流程：
     * 1. 检查容器是否存在
     * 2. 检查是否已初始化（避免重复）
     * 3. 获取当前主题并创建实例
     * 4. 初始化后同步主题
     */
    function initArtalk() {
      const container = document.getElementById("Comments");
      if (!container) {
        console.warn("Artalk容器未找到");
        return;
      }

      if (typeof window.Artalk === "undefined") {
        console.error("Artalk初始化失败: Artalk 未定义");
        return;
      }

      // 如果容器已经包含Artalk实例，跳过初始化
      if (container.querySelector(".atk-app")) {
        return;
      }

      const isDark = getCurrentTheme();
      const config = {
        ...artalkConfig,
        pageKey: window.location.pathname,
        darkMode: isDark,
      };

      try {
        window.artalkInstance = window.Artalk.init(config);
        setTimeout(function () {
          syncArtalkTheme();
        }, 100);
      } catch (err) {
        console.error("Artalk初始化失败:", err);
      }
    }

    /**
     * 同步 Artalk 主题
     *
     * 获取当前主题并调用 Artalk 的 setDarkMode 方法
     */
    function syncArtalkTheme() {
      if (!window.artalkInstance) return;

      const isDark = getCurrentTheme();
      try {
        window.artalkInstance.setDarkMode(isDark);
      } catch (err) {
        console.error("同步Artalk主题失败:", err);
      }
    }

    /**
     * 设置主题变化监听器
     *
     * 监听两种变化：
     * 1. html[data-theme] 属性变化
     * 2. 主题按钮 aria-label 属性变化
     */
    function setupThemeObserver() {
      // 如果观察器已存在，先断开
      if (window._artalkThemeObserver) {
        window._artalkThemeObserver.disconnect();
      }

      // 创建新的观察器
      window._artalkThemeObserver = new MutationObserver(mutations => {
        mutations.forEach(mutation => {
          if (
            mutation.type === "attributes" &&
            mutation.attributeName === "data-theme"
          ) {
            // 延迟同步，确保DOM更新完成
            setTimeout(() => {
              syncArtalkTheme();
            }, 50);
          }
        });
      });

      // 观察 html 元素的 data-theme 属性变化
      window._artalkThemeObserver.observe(document.documentElement, {
        attributes: true,
        attributeFilter: ["data-theme"],
      });

      // 额外监听主题按钮变化（作为备选方案）
      const themeBtn = document.querySelector("#theme-btn");
      if (themeBtn && !window._artalkBtnObserver) {
        window._artalkBtnObserver = new MutationObserver(mutations => {
          mutations.forEach(mutation => {
            if (mutation.attributeName === "aria-label") {
              setTimeout(() => {
                syncArtalkTheme();
              }, 50);
            }
          });
        });

        window._artalkBtnObserver.observe(themeBtn, {
          attributes: true,
          attributeFilter: ["aria-label"],
        });
      }
    }

    /**
     * 页面加载处理
     *
     * 处理流程：
     * 1. 销毁旧实例
     * 2. 检查容器是否可见
     * 3. 动态加载 Artalk 脚本，在 onload 后再初始化并设置主题观察器
     */
    function handlePageLoad() {
      destroyArtalk();

      const container = document.getElementById("Comments");
      if (!container || container.offsetParent === null) return;

      ensureArtalkCSS();
      loadArtalkScript(function () {
        setTimeout(function () {
          initArtalk();
          setupThemeObserver();
        }, 100);
      });
    }

    /**
     * 清理所有观察器
     */
    function cleanupObservers() {
      if (window._artalkThemeObserver) {
        window._artalkThemeObserver.disconnect();
        window._artalkThemeObserver = null;
      }
      if (window._artalkBtnObserver) {
        window._artalkBtnObserver.disconnect();
        window._artalkBtnObserver = null;
      }
    }

    /**
     * 页面切换前清理
     *
     * 清理工作：
     * 1. 销毁 Artalk 实例
     * 2. 断开所有观察器
     */
    function handleBeforeSwap() {
      destroyArtalk();
      cleanupObservers();
    }

    /**
     * 单次设置事件监听
     *
     * 避免重复绑定事件
     */
    function setupArtalk() {
      if (window._artalkInitialized) return;
      window._artalkInitialized = true;

      // 初始加载与整页刷新
      if (document.readyState === "complete") {
        handlePageLoad();
      } else {
        document.addEventListener("DOMContentLoaded", handlePageLoad);
      }
      window.addEventListener("load", handlePageLoad);
    }

    // 启动Artalk
    setupArtalk();
  })();
</script>
