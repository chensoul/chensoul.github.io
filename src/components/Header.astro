---
import { SITE } from "@/config";
import YearProgress from "./YearProgress.astro";

const navLinks = [
  { href: "/", text: "首页" },
  { href: "/posts", text: "文章" },
  ...(SITE.showArchives ? [{ href: "/archives", text: "归档" }] : []),
  { href: "/tags", text: "标签" },
  { href: "/categories", text: "分类" },
  { href: "/running", text: "跑步" },
  { href: "/links", text: " 链接" },
  { href: "/about", text: "关于" },
];

// 获取当前路径，用于判断激活状态
const { pathname } = Astro.url;
---

<header>
  <nav>
    <a href="/" class="logo">{SITE.title}</a>
    <div class="nav-right">
      <ul class="nav-links">
        {
          navLinks.map(link => (
            <li>
              <a
                href={link.href}
                class={
                  pathname === link.href || pathname.startsWith(link.href + "/")
                    ? "active"
                    : ""
                }
              >
                {link.text}
              </a>
            </li>
          ))
        }
      </ul>
      <a href="/search" class="search-link" aria-label="搜索">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="18"
          height="18"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <circle cx="11" cy="11" r="8"></circle>
          <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
        </svg>
      </a>
      {
        SITE.lightAndDarkMode && (
          <button id="theme-toggle" class="theme-toggle" aria-label="切换主题">
            <svg
              class="sun-icon"
              xmlns="http://www.w3.org/2000/svg"
              width="18"
              height="18"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <circle cx="12" cy="12" r="5" />
              <line x1="12" y1="1" x2="12" y2="3" />
              <line x1="12" y1="21" x2="12" y2="23" />
              <line x1="4.22" y1="4.22" x2="5.64" y2="5.64" />
              <line x1="18.36" y1="18.36" x2="19.78" y2="19.78" />
              <line x1="1" y1="12" x2="3" y2="12" />
              <line x1="21" y1="12" x2="23" y2="12" />
              <line x1="4.22" y1="19.78" x2="5.64" y2="18.36" />
              <line x1="18.36" y1="5.64" x2="19.78" y2="4.22" />
            </svg>
            <svg
              class="moon-icon"
              xmlns="http://www.w3.org/2000/svg"
              width="18"
              height="18"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" />
            </svg>
          </button>
        )
      }
    </div>
  </nav>
  {SITE.showYearProgress && <YearProgress />}
</header>

<script>
  // Theme toggle functionality
  const themeToggle = document.getElementById('theme-toggle');
  const html = document.documentElement;

  // Check for saved theme preference or default to light
  const currentTheme = localStorage.getItem('theme') || 'light';
  html.setAttribute('data-theme', currentTheme);

  themeToggle?.addEventListener('click', () => {
    const currentTheme = html.getAttribute('data-theme');
    const newTheme = currentTheme === 'light' ? 'dark' : 'light';

    html.setAttribute('data-theme', newTheme);
    localStorage.setItem('theme', newTheme);
  });

  // Keyboard support for theme toggle
  themeToggle?.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' || e.key === ' ') {
      e.preventDefault();
      const currentTheme = html.getAttribute('data-theme');
      const newTheme = currentTheme === 'light' ? 'dark' : 'light';
      html.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
    }
  });
</script>

<style>
  header {
    background: var(--background);
    border-bottom: 1px solid var(--border);
    position: sticky;
    top: 0;
    z-index: 100;
  }

  nav {
    max-width: 900px;
    margin: 0 auto;
    padding: 1rem 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .logo {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--text-primary);
    text-decoration: none;
  }

  .logo:hover {
    text-decoration: none;
  }

  .nav-right {
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  .search-link {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0.5rem;
    color: var(--text-secondary);
    text-decoration: none;
    border: 1px solid var(--border);
    border-radius: 6px;
    transition:
      border-color 0.2s ease,
      color 0.2s ease;
  }

  .search-link:hover,
  .search-link:focus-visible {
    border-color: var(--accent);
    color: var(--accent);
    outline: 2px solid var(--accent);
    outline-offset: 2px;
  }

  .nav-links {
    display: flex;
    list-style: none;
    margin: 0;
    padding: 0;
    gap: 1.25rem;
  }

  .nav-links a {
    color: var(--text-secondary);
    text-decoration: none;
    font-size: 0.9375rem;
    transition: color 0.2s ease;
    padding: 0.25rem 0;
  }

  .nav-links a:hover,
  .nav-links a:focus-visible {
    color: var(--accent);
    text-decoration: none;
  }

  .nav-links a.active {
    color: var(--accent);
    text-decoration: none;
  }

  .theme-toggle {
    background: transparent;
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 0.5rem;
    cursor: pointer;
    color: var(--text-secondary);
    transition:
      border-color 0.2s ease,
      color 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .theme-toggle:hover,
  .theme-toggle:focus-visible {
    border-color: var(--accent);
    color: var(--accent);
    outline: 2px solid var(--accent);
    outline-offset: 2px;
  }

  /* 默认亮色主题：显示月亮图标（点击可切换至暗色） */
  .theme-toggle .sun-icon {
    display: none;
  }
  .theme-toggle .moon-icon {
    display: block;
  }
  /* 暗色主题：显示太阳图标 */
  :global(html[data-theme="dark"]) .theme-toggle .sun-icon {
    display: block;
  }
  :global(html[data-theme="dark"]) .theme-toggle .moon-icon {
    display: none;
  }

  @media (max-width: 640px) {
    header {
      position: relative;
    }

    nav {
      flex-direction: column;
      gap: 0.5rem;
      padding: 0.75rem;
    }

    .nav-right {
      flex-direction: row;
      flex-wrap: wrap;
      justify-content: center;
      align-items: center;
      gap: 0.4rem 0.6rem;
      width: 100%;
    }

    .nav-links {
      display: contents;
    }

    .nav-links li {
      display: inline;
    }

    .nav-links a {
      font-size: 0.8125rem;
    }

    .search-link,
    .theme-toggle {
      padding: 0.375rem;
    }
  }
</style>
