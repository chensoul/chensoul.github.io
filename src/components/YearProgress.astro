---
/**
 * å¹´åº¦è¿›åº¦æ¡ç»„ä»¶
 *
 * @fileoverview æ˜¾ç¤ºå½“å‰å¹´åº¦å·²è¿‡æ—¶é—´çš„ç™¾åˆ†æ¯”è¿›åº¦æ¡
 *
 * æ ¸å¿ƒé€»è¾‘ï¼š
 * 1. è®¡ç®—å½“å‰æ—¶é—´åœ¨å…¨å¹´ä¸­çš„ç™¾åˆ†æ¯”
 * 2. åŠ¨ç”»æ•ˆæœï¼šä»…é¦–æ¬¡è®¿é—®/åˆ·æ–°æ—¶æ‰§è¡Œï¼Œé¡µé¢åˆ‡æ¢æ—¶ç›´æ¥æ˜¾ç¤º
 * 3. äº¤äº’åŠŸèƒ½ï¼š
 *    - æ‚¬åœæ˜¾ç¤ºç™¾åˆ†æ¯”æ ‡ç­¾
 *    - ç‚¹å‡»æ˜¾ç¤ºå‰©ä½™å¤©æ•°æç¤º
 * 4. è‡ªåŠ¨éšè—ï¼šåŠ¨ç”»ç»“æŸå 2 ç§’éšè—æ ‡ç­¾
 *
 * ä¾èµ–å…³ç³»ï¼š
 * - è¢« Header.astro å¯¼å…¥ï¼Œåœ¨å¯¼èˆªæ ä¸‹æ–¹æ˜¾ç¤º
 * - ä½¿ç”¨ CSS å˜é‡ --accent æ§åˆ¶å¡«å……è‰²
 */
---

<div
  id="year-progress"
  class="year-progress group relative mx-auto mb-5 w-full max-w-4xl sm:mb-0"
>
  <!-- è¿›åº¦æ¡èƒŒæ™¯ï¼ˆä½¿ç”¨ä¸»é¢˜å˜é‡ï¼Œéš data-theme åˆ‡æ¢ï¼‰ -->
  <div class="year-progress-track h-[3px] w-full rounded" aria-hidden="true">
    <!-- è¿›åº¦æ¡å¡«å……ï¼ˆå®½åº¦ç”± JS åŠ¨æ€è®¾ç½®ï¼Œé¢œè‰²ç”± CSS å˜é‡æ§åˆ¶ä»¥é€‚é…ä¸»é¢˜ï¼‰ -->
    <div
      id="year-progress-fill"
      class="year-progress-fill h-[3px] w-0 rounded"
    >
    </div>
  </div>
  <!-- æ ‡ç­¾é®ç½©ï¼ˆç”¨äºéšè—è¿›åº¦æ¡ï¼‰ -->
  <span
    id="year-progress-cover"
    class="pointer-events-none absolute top-1/2 left-0 z-10 h-[3px] -translate-y-1/2 rounded bg-background opacity-0 transition-opacity duration-[1000ms] ease-out"
  ></span>
  <!-- ç™¾åˆ†æ¯”æ ‡ç­¾ -->
  <span
    id="year-progress-label"
    class="pointer-events-none absolute top-1/2 left-0 z-20 -translate-y-1/2 text-xs whitespace-nowrap text-accent opacity-0 transition-opacity duration-[1000ms] ease-out"
  ></span>
  <!-- ç‚¹å‡»å¼¹çª—ï¼ˆå‰©ä½™å¤©æ•°ï¼‰ -->
  <div
    id="year-progress-popup"
    class="pointer-events-none absolute top-0 left-0 z-30 -translate-y-[calc(100%+8px)] rounded border border-border bg-background px-2 py-1 text-xs whitespace-nowrap text-foreground opacity-0 shadow transition-opacity duration-[1000ms] ease-out"
  >
  </div>
</div>

<style is:global>
  .year-progress-track {
    background-color: color-mix(in srgb, var(--color-border) 70%, transparent);
  }
  .year-progress-fill {
    background-color: var(--accent);
  }
</style>

<script>
  /**
   * å¹´åº¦è¿›åº¦æ¡ï¼šè®¡ç®—å…¨å¹´è¿›åº¦ã€åŠ¨ç”»ã€æ‚¬åœ/ç‚¹å‡»äº¤äº’
   */

  const ANIMATION_DURATION = 1200;
  const LABEL_HIDE_DELAY = 2000;
  const HOVER_HIDE_DELAY = 1000;

  type YearProgressEls = {
    container: HTMLElement;
    fill: HTMLElement;
    label: HTMLElement;
    cover: HTMLElement;
    popup: HTMLElement;
  };

  function calcProgress(): number {
    const now = new Date();
    const start = new Date(now.getFullYear(), 0, 1);
    const end = new Date(now.getFullYear() + 1, 0, 1);
    return Math.min(1, Math.max(0, (now.getTime() - start.getTime()) / (end.getTime() - start.getTime())));
  }

  function getElements(): {
    container: HTMLElement | null;
    fill: HTMLElement | null;
    label: HTMLElement | null;
    cover: HTMLElement | null;
    popup: HTMLElement | null;
  } {
    return {
      container: document.getElementById("year-progress"),
      fill: document.getElementById("year-progress-fill"),
      label: document.getElementById("year-progress-label"),
      cover: document.getElementById("year-progress-cover"),
      popup: document.getElementById("year-progress-popup"),
    };
  }

  function show(el: HTMLElement | null): void {
    if (!el) return;
    el.classList.add("duration-300", "opacity-100");
  }
  function hide(el: HTMLElement | null): void {
    if (!el) return;
    el.classList.remove("duration-300", "opacity-100");
  }

  function positionLabel(els: YearProgressEls, progress: number): void {
    const cw = els.container.getBoundingClientRect().width;
    const lw = els.label.getBoundingClientRect().width || 0;
    const pw = els.popup.getBoundingClientRect().width || 0;
    const gap = 3;
    els.label.style.left = Math.min(cw * progress + gap, cw - lw) + "px";
    els.cover.style.left = els.label.style.left;
    els.cover.style.width = lw + "px";
    els.popup.style.left = Math.min(cw * progress + gap, cw - pw) + "px";
  }

  function setProgress(els: YearProgressEls, progress: number): void {
    const text = (progress * 100).toFixed(1) + "%";
    els.fill.style.width = text;
    els.label.textContent = text;
    els.container.setAttribute("title", text);
    positionLabel(els, progress);
  }

  function animateProgress(els: YearProgressEls, target: number, onComplete?: () => void): void {
    const startTs = performance.now();
    function step(ts: number): void {
      const t = Math.min(1, (ts - startTs) / ANIMATION_DURATION);
      const current = target * t;
      els.fill.style.width = (current * 100).toFixed(3) + "%";
      els.label.textContent = (current * 100).toFixed(1) + "%";
      positionLabel(els, current);
      if (t < 1) {
        requestAnimationFrame(step);
      } else {
        setProgress(els, target);
        onComplete?.();
      }
    }
    requestAnimationFrame(step);
  }

  let popupHideTimer: ReturnType<typeof setTimeout> | null = null;

  function bindEvents(els: YearProgressEls, getProgress: () => number): void {
    if (els.container.dataset.bound) return;
    let hoverTimer: ReturnType<typeof setTimeout> | null = null;

    els.container.addEventListener("mouseenter", () => {
      if (hoverTimer) clearTimeout(hoverTimer);
      show(els.label);
      show(els.cover);
      positionLabel(els, getProgress());
    });

    els.container.addEventListener("mouseleave", () => {
      if (hoverTimer) clearTimeout(hoverTimer);
      hoverTimer = setTimeout(() => {
        hide(els.label);
        hide(els.cover);
      }, HOVER_HIDE_DELAY);
    });

    els.container.addEventListener("click", () => {
      const now = new Date();
      const end = new Date(now.getFullYear() + 1, 0, 1);
      const daysLeft = Math.ceil((end.getTime() - now.getTime()) / 86400000);
      els.popup.textContent = `ä»Šå¹´è¿˜å‰©ä¸‹${daysLeft}å¤©ï¼Œè¦çæƒœæ—¶é—´å“¦ ğŸ˜`;
      show(els.popup);
      positionLabel(els, getProgress());
      if (popupHideTimer) clearTimeout(popupHideTimer);
      popupHideTimer = setTimeout(() => hide(els.popup), LABEL_HIDE_DELAY);
    });

    els.container.dataset.bound = "1";
  }

  function init(): void {
    const raw = getElements();
    if (!raw.container || !raw.fill || !raw.label || !raw.cover || !raw.popup) return;
    const els: YearProgressEls = raw as YearProgressEls;

    const target = calcProgress();
    let currentProgress = 0;

    show(els.label);
    show(els.cover);

    animateProgress(els, target, () => {
      currentProgress = target;
      setTimeout(() => {
        hide(els.label);
        hide(els.cover);
      }, LABEL_HIDE_DELAY);
    });

    const startTs = performance.now();
    const progressInterval = setInterval(() => {
      const t = Math.min(1, (performance.now() - startTs) / ANIMATION_DURATION);
      currentProgress = target * t;
      if (t >= 1) clearInterval(progressInterval);
    }, 16);

    bindEvents(els, () => currentProgress || target);
  }

  function update(): void {
    const raw = getElements();
    if (!raw.container || !raw.fill || !raw.label || !raw.cover || !raw.popup) return;
    const els: YearProgressEls = raw as YearProgressEls;
    const target = calcProgress();
    setProgress(els, target);
    bindEvents(els, () => target);
  }

  init();
  document.addEventListener("DOMContentLoaded", update);
  window.addEventListener("load", update);
</script>
