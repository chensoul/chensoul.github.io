---
/**
 * 归档页布局组件
 *
 * @fileoverview 渲染文章归档页面，按年份分组显示文章列表
 *
 * 文件用途：
 * - 作为归档页面的专用布局组件，负责将所有文章按年份分组展示
 * - 支持懒加载机制，优化大量文章时的页面性能
 * - 提供清晰的日期导航，方便用户快速定位到特定年份的文章
 *
 * 核心逻辑：
 * 1. 接收来自路由的分页数据（Page<CollectionEntry<"blog">>
 * 2. 按文章更新时间（或发布时间）的年份进行分组
 * 3. 年份降序排列（最新的年份在前），同一年内文章按日期排序
 * 4. 初始只显示部分年份（由 SITE.archivesPerIndex 控制），其余年份隐藏
 * 5. 通过滚动触发的懒加载逐步显示更多年份
 * 6. 每篇文章格式化为 "月-日 » 文章标题" 的列表项
 *
 * 依赖关系：
 * - 被 /archives/[...page].astro 路由调用，接收其传来的 page 数据
 * - 依赖 getPostsByGroupCondition 工具函数进行年份分组
 * - 依赖 getPath 生成正确的文章链接
 * - 依赖 /lazy-list.js 脚本实现懒加载交互
 * - 使用 SITE 配置中的 archivesPerIndex 和 archivesPerPage 控制显示策略
 */

import Layout from "@/layouts/Layout.astro";
import Main from "@/layouts/Main.astro";
import Header from "@/components/Header.astro";
import Footer from "@/components/Footer.astro";
import { SITE } from "@/config";
import type { Page } from "astro";
import type { CollectionEntry } from "astro:content";
import getPostsByGroupCondition from "@/utils/getPostsByGroupCondition";
import { getPath } from "@/utils/getPath";
import { _t } from "@/i18n/lang";

/**
 * 组件属性接口
 *
 * @property page - Astro 分页数据对象，包含当前页的所有文章
 */
export interface Props {
  page: Page<CollectionEntry<"blog">>;
}

// 从 Astro.props 中解构获取分页数据
const { page } = Astro.props;

/**
 * 按年份对文章进行分组
 *
 * 分组规则：
 * - 优先使用 updated 字段（更新时间）的年份
 * - 若无 updated，则使用 date 字段（发布时间）的年份
 * - 返回一个对象，键为年份字符串，值为该年份的文章数组
 */
const groupedByYear = getPostsByGroupCondition(
  page.data,
  // 提取年份的回调函数：返回文章日期的年份部分
  item => new Date(item.data.updated ?? item.data.date).getFullYear()
);

/**
 * 获取所有年份并降序排序
 *
 * 处理步骤：
 * 1. 从分组对象的键中提取所有年份
 * 2. 将字符串年份转换为数字类型
 * 3. 降序排序（b - a），使最新的年份排在最前面
 */
const years = Object.keys(groupedByYear)
  .map(y => Number(y))
  .sort((a, b) => b - a);
---

<Layout title={`${_t.archives.title} | ${SITE.title}`}>
  <Header />
  <Main pageTitle="" pageDesc={_t.archives.desc}>
    {
      /**
       * 渲染年份区块
       *
       * 懒加载逻辑：
       * - 索引小于 SITE.archivesPerIndex 的年份直接显示
       * - 索引大于等于该值的年份添加 hidden 类，由懒加载脚本控制显示
       */
      years.map((year, i) => (
        <section
          class={`archives-year mb-8 ${i >= SITE.archivesPerIndex ? "hidden" : ""}`}
        >
          {/* 年份标题：显示年份和该年份的文章数量 */}
          <h2 class="mb-1 text-base">
            {year} ({groupedByYear[year].length})
          </h2>
          <ul class="mt-1 space-y-1">
            {
              /**
               * 渲染该年份下的所有文章
               *
               * 数据结构：
               * - data: 文章的 frontmatter 数据（标题、日期等）
               * - id: 文章的唯一标识符
               * - filePath: 文章的文件路径，用于生成链接
               */
              groupedByYear[year].map(({ data, id, filePath }) => {
                // 获取文章日期（优先使用更新时间）
                const d = new Date(data.updated ?? data.date);
                // 格式化月份：补零到两位数（01-12）
                const mm = String(d.getMonth() + 1).padStart(2, "0");
                // 格式化日期：补零到两位数（01-31）
                const dd = String(d.getDate()).padStart(2, "0");
                // 组合成 "MM-DD" 格式的日期字符串
                const dateText = `${mm}-${dd}`;
                return (
                  <li class="flex items-center gap-2 leading-6">
                    {/* 日期显示：固定宽度，右对齐，等官认数字体 */}
                    <span class="w-14 text-right text-sm tabular-nums opacity-80">
                      {dateText}
                    </span>
                    {/* 分隔符：指向右侧的箭头符号 */}
                    <span class="opacity-80">»</span>
                    {/* 文章标题链接：flex-1 占满剩余空间，truncate 超长省略 */}
                    <a
                      href={getPath(id, filePath, true, data.date)}
                      class="flex-1 truncate text-sm text-accent hover:underline"
                    >
                      {data.title}
                    </a>
                  </li>
                );
              })
            }
          </ul>
        </section>
      ))
    }
    {/* 懒加载哨兵元素：用于 IntersectionObserver 检测滚动位置 */}
    <div
      id="archives-sentinel"
      data-init={SITE.archivesPerIndex}
      data-chunk={SITE.archivesPerPage}
    >
    </div>
  </Main>
  <Footer noMarginTop={true} />
</Layout>

<script is:inline src="/lazy-list.js"></script>
<script is:inline>
  /**
   * 初始化归档页懒加载
   *
   * 配置说明：
   * - sentinelId: 哨兵元素的 ID，用于检测滚动位置
   * - itemSelector: 需要懒加载的年份区块选择器
   * - artalk.enabled: false（归档页不加载评论数）
   *
   * 事件监听：
   * - astro:after-swap: Astro 视图导航后触发（SPA 模式）
   * - astro:page-load: Astro 页面加载完成后触发
   */
  function boot() {
    window.setupLazyList({
      sentinelId: "archives-sentinel",
      itemSelector: ".archives-year",
    });
  }
  // 确保在 Astro 页面切换和加载时都能正确初始化懒加载
  document.addEventListener("astro:after-swap", () => {
    if (typeof window.setupLazyList === "function") boot();
  });
  document.addEventListener("astro:page-load", () => {
    if (typeof window.setupLazyList === "function") boot();
  });
</script>
