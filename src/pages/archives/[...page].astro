---
/**
 * 归档页路由
 *
 * @fileoverview 生成归档页的分页路由，直接使用 Layout 布局
 *
 * 核心逻辑：
 * 1. 使用 Astro 的 paginate API 生成归档页路由
 * 2. 按年份分组显示文章
 * 3. 实际分页由懒加载处理（pageSize 设为全部）
 *
 * 路由格式：
 * - /archives - 第1页
 * - /archives/2 - 第2页
 * - ...
 */

import Layout from "@/layouts/Layout.astro";
import type { GetStaticPaths } from "astro";
import type { Page } from "astro";
import type { CollectionEntry } from "astro:content";
import { getCollection } from "astro:content";
import { SITE } from "@/config";
import { PostUtils } from "@/utils/postUtils";

export const getStaticPaths = (async ({ paginate }) => {
  const posts = await getCollection("blog", ({ data }) => !data.draft);
  const sortedPosts = PostUtils.sort(posts);
  return paginate(sortedPosts, { pageSize: sortedPosts.length });
}) satisfies GetStaticPaths;

const { page } = Astro.props;

const groupedByYear = PostUtils.groupBy(
  page.data,
  item => new Date(item.data.updated ?? item.data.date).getFullYear()
);

const years = Object.keys(groupedByYear)
  .map(y => Number(y))
  .sort((a, b) => b - a);
---

<Layout title={`归档 | ${SITE.title}`}>
  {
    years.map(year => (
      <section class="archives-year mb-8">
        <h2 class="mb-1 text-base">
          {year} ({groupedByYear[year].length})
        </h2>
        <ul class="mt-1 space-y-1">
          {
            groupedByYear[year].map(({ data, id, filePath }) => {
              const d = new Date(data.updated ?? data.date);
              const tz = data.timezone ?? SITE.timezone;
              const dateStr = PostUtils.getLocalDateString(d, tz);
              const dateText = dateStr.slice(5);
              return (
                <li class="flex items-center gap-2 leading-6">
                  <span class="w-14 text-right text-sm tabular-nums opacity-80">
                    {dateText}
                  </span>
                  <span class="opacity-80">»</span>
                  <a
                    href={PostUtils.getPath(id, filePath, true, data.date, data.timezone)}
                    class="flex-1 truncate text-sm hover:underline"
                  >
                    {data.title}
                  </a>
                </li>
              );
            })
          }
        </ul>
      </section>
    ))
  }
</Layout>
