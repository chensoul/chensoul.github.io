---
import fs from "node:fs";
import path from "node:path";
import Layout from "@/layouts/Layout.astro";
import { fileURLToPath } from "node:url";
import MarkdownIt from "markdown-it";
import { SITE } from "@/config";

// 读取 links.md 文件
const __dirname = path.dirname(fileURLToPath(import.meta.url));
const filePath = path.join(__dirname, "../../content/pages/links.md");
const fileContent = fs.readFileSync(filePath, "utf-8");

// 解析 frontmatter
const frontmatterMatch = fileContent.match(/^---\n([\s\S]*?)\n---\n([\s\S]*)$/);
if (!frontmatterMatch) {
  return Astro.redirect("/404");
}

const frontmatterStr = frontmatterMatch[1];
const content = frontmatterMatch[2];

// 解析 frontmatter 为对象
const frontmatter: Record<string, string> = {};
frontmatterStr.split("\n").forEach(line => {
  const match = line.match(/^(\w+):\s*(.+)$/);
  if (match) {
    const key = match[1];
    let value = match[2].trim();
    // 移除引号
    if (
      (value.startsWith('"') && value.endsWith('"')) ||
      (value.startsWith("'") && value.endsWith("'"))
    ) {
      value = value.slice(1, -1);
    }
    frontmatter[key] = value;
  }
});

// 使用 markdown-it 渲染 markdown（不启用 typographer，避免链接 URL 中的英文逗号被替换为中文逗号）
const md = new MarkdownIt({
  html: true, // 允许 HTML
  linkify: true, // 自动转换 URL 为链接
  typographer: false, // 关闭标点替换，保证链接里的英文逗号不变
});
const htmlContent = md.render(content);
---

<Layout
  title={`链接 | ${SITE.title}`}
  description={frontmatter.description}
>
  <Fragment set:html={htmlContent} />
</Layout>
