---
import { getCollection } from "astro:content";
import type { GetStaticPathsOptions } from "astro";
import Layout from "@/layouts/Layout.astro";
import Card from "@/components/Card.astro";
import { PostUtils } from "@/utils/postUtils";
import { SITE } from "@/config";

/**
 * 生成静态路径：每个标签一个路由，该标签下全部文章由懒加载分批显示
 */
export async function getStaticPaths({ paginate }: GetStaticPathsOptions) {
  const posts = await getCollection("blog");
  const tags = PostUtils.getUniqueTags(posts);

  return tags.flatMap(({ tag, tagName }) => {
    const tagPosts = PostUtils.getPostsByTag(posts, tag);
    return paginate(tagPosts, {
      params: { tag },
      props: { tagName },
      pageSize: tagPosts.length,
    });
  });
}

const params = Astro.params;
const { tag } = params;
const { page, tagName } = Astro.props;
---

<Layout title={`${tag} | ${SITE.title}`}>
  <h1 slot="title">{`Tag:${tag}`}</h1>
  <p class="mb-4 text-base font-semibold">
    标签：{tagName}
  </p>
  <ul class="tag-posts-list list-none pl-0">
    {
      page.data.map((data, i) => (
        <Card
          {...data}
          itemClass="tag-post-item"
          hidden={i >= SITE.postPerIndex}
          dateFormat="absolute"
        />
      ))
    }
  </ul>
  <div
    id="tag-posts-sentinel"
    data-init={SITE.postPerIndex}
    data-chunk={SITE.postPerPage}
  >
  </div>
</Layout>

<script is:inline src={SITE.lazyListJsUrl || "/lazy-list.js"}></script>
<script is:inline>
  function boot() {
    if (typeof window.setupLazyList !== "function") return;
    window.setupLazyList({
      sentinelId: "tag-posts-sentinel",
      itemSelector: ".tag-post-item",
    });
  }
  document.addEventListener("DOMContentLoaded", boot);
  window.addEventListener("load", boot);
</script>
