---
/**
 * 标签详情页（懒加载）
 *
 * @fileoverview 显示某个标签下的所有文章，首屏外的文章懒加载
 *
 * 核心逻辑：
 * 1. 使用 getStaticPaths 为每个标签生成一个路由（该标签下全部文章）
 * 2. 筛选出包含当前标签的文章（使用 getPostsByTag）
 * 3. 首屏显示 SITE.postPerIndex 篇，其余由 /lazy-list.js 滚动懒加载
 *
 * 路由格式：
 * - /tags/javascript - 该标签下所有文章（懒加载）
 *
 * 依赖关系：
 * - 使用 Card 组件显示文章
 * - 依赖 /lazy-list.js 实现懒加载
 */

import { getCollection } from "astro:content";
import type { GetStaticPathsOptions } from "astro";
import Main from "@/layouts/Main.astro";
import Layout from "@/layouts/Layout.astro";
import Header from "@/components/Header.astro";
import Footer from "@/components/Footer.astro";
import Card from "@/components/Card.astro";
import { PostUtils } from "@/utils/postUtils";
import { SITE } from "@/config";
import { _t } from "@/scripts/lang";

/**
 * 生成静态路径：每个标签一个路由，该标签下全部文章由懒加载分批显示
 */
export async function getStaticPaths({ paginate }: GetStaticPathsOptions) {
  const posts = await getCollection("blog");
  const tags = PostUtils.getUniqueTags(posts);

  return tags.flatMap(({ tag, tagName }) => {
    const tagPosts = PostUtils.getPostsByTag(posts, tag);
    return paginate(tagPosts, {
      params: { tag },
      props: { tagName },
      pageSize: tagPosts.length,
    });
  });
}

const params = Astro.params;
const { tag } = params;
const { page, tagName } = Astro.props;
---

<Layout title={`${_t.tag.title}${tagName} | ${SITE.title}`}>
  <Header />
  <Main
    pageTitle={[_t.tag.title, `${tagName}`]}
    pageDesc={_t.tag.desc(tagName)}
  >
    <h1 slot="title">{`Tag:${tag}`}</h1>
    <p class="mb-4 text-base font-semibold">
      标签：{tagName}
    </p>
    <ul class="tag-posts-list">
      {
        page.data.map((data, i) => (
          <Card
            {...data}
            itemClass="tag-post-item"
            hidden={i >= SITE.postPerIndex}
            dateFormat="absolute"
          />
        ))
      }
    </ul>
    <div
      id="tag-posts-sentinel"
      data-init={SITE.postPerIndex}
      data-chunk={SITE.postPerPage}
    >
    </div>
  </Main>
  <Footer noMarginTop={true} />
</Layout>

<script is:inline src="/lazy-list.js"></script>
<script is:inline>
  function boot() {
    if (typeof window.setupLazyList !== "function") return;
    window.setupLazyList({
      sentinelId: "tag-posts-sentinel",
      itemSelector: ".tag-post-item",
    });
  }
  document.addEventListener("DOMContentLoaded", boot);
  window.addEventListener("load", boot);
</script>
