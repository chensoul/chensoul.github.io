---
/**
 * 分类索引页
 *
 * @fileoverview 显示所有分类及其文章数量
 *
 * 核心逻辑：
 * 1. 获取所有分类（使用 getUniqueCategories）
 * 2. 获取每个分类的最新文章标题（用于显示）
 * 3. 显示分类封面图、名称、文章数量
 * 4. 支持懒加载分页（使用 /lazy-list.js）
 * 5. 悬停效果：图片放大
 *
 * 视觉设计：
 * - 卡片式布局（移动端单列，桌面端双列）
 * - 16:9 宽高比的封面图
 * - 渐变遮罩 + 文字叠加
 *
 * 依赖关系：
 * - 被 /categories 路径访问
 * - 使用 getCategoryImageUrl 获取封面图
 */

import { getCollection } from "astro:content";
import Layout from "@/layouts/Layout.astro";
import { PostUtils } from "@/utils/postUtils";
import { SITE } from "@/config";
import { getCategoryImageUrl } from "@/utils/categoryImages";

// 获取所有文章并排序
const posts = await getCollection("blog");
const sortedPosts = PostUtils.sort(posts);

// 获取所有分类
let categories = PostUtils.getUniqueCategories(posts);

/**
 * 获取每个分类的最新文章标题
 *
 * 用于在分类卡片上显示该分类的最新文章标题
 */
const categoryLatestPost = new Map<string, string>();
categories.forEach(({ categoryName }) => {
  const latestPost = sortedPosts.find(post =>
    post.data.categories.includes(categoryName)
  );
  if (latestPost) {
    categoryLatestPost.set(categoryName, latestPost.data.title);
  }
});
---

<Layout title={`分类 | ${SITE.title}`}>
  <ul class="grid grid-cols-1 gap-1 sm:grid-cols-2" aria-label="分类列表">
    {
      categories.map(({ category, categoryName, count }, i) => (
        <li class={`categories-item ${i >= SITE.postPerIndex ? "hidden" : ""}`}>
          <a
            href={`/categories/${category}`}
            aria-label={`查看 ${categoryName} 分类`}
            class="group relative block overflow-hidden"
          >
            <div class="w-full overflow-hidden" style="aspect-ratio: 16 / 9;">
              {getCategoryImageUrl(category) ||
              getCategoryImageUrl(categoryName) ? (
                <img
                  src={
                    getCategoryImageUrl(category) ||
                    getCategoryImageUrl(categoryName)
                  }
                  alt={`${categoryName} 封面图`}
                  loading="lazy"
                  decoding="async"
                  class="h-full w-full object-cover transition-transform duration-300 group-hover:scale-105"
                />
              ) : (
                // 无封面图时显示占位背景
                <div class="h-full w-full bg-black/20 dark:bg-white/20" />
              )}
            </div>
            {/* 渐变遮罩 */}
            <div class="absolute inset-0 bg-gradient-to-t from-black/70 via-black/20 to-transparent" />
            {/* 文字内容 */}
            <div class="absolute right-0 bottom-0 left-0 p-4">
              <span class="mb-1 block text-xs text-white/80">
                {categoryName}（{count}篇）
              </span>
              <h3 class="line-clamp-1 text-sm leading-tight text-white">
                {categoryLatestPost.get(categoryName) || categoryName}
              </h3>
            </div>
          </a>
        </li>
      ))
    }
  </ul>
  <div
    id="categories-sentinel"
    data-init={SITE.postPerIndex}
    data-chunk={SITE.postPerPage}
  >
  </div>
</Layout>

<script is:inline src={SITE.lazyListJsUrl || "/lazy-list.js"}></script>
<script is:inline>
  function boot() {
    if (typeof window.setupLazyList !== "function") return;
    window.setupLazyList({
      sentinelId: "categories-sentinel",
      itemSelector: ".categories-item",
    });
  }
  document.addEventListener("DOMContentLoaded", boot);
  window.addEventListener("load", boot);
</script>
