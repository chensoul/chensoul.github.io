---
import "@pagefind/default-ui/css/ui.css";
import Main from "@/layouts/Main.astro";
import Layout from "@/layouts/Layout.astro";
import Header from "@/components/Header.astro";
import Footer from "@/components/Footer.astro";
import { SITE } from "@/config";
import { _t } from "@/scripts/lang";

// 返回 URL 配置
const backUrl = SITE.showBackButton ? `${Astro.url.pathname}` : "/";
---

<Layout title={`${_t.search.title} | ${SITE.title}`}>
  <Header />
  <Main pageTitle="">
    <!-- Pagefind 搜索容器 -->
    <div id="pagefind-search" data-backurl={backUrl}></div>
  </Main>
  <Footer />
</Layout>

<script>
  let _searchInitStarted = false;

  function initSearch(): void {
    const pageFindSearch = document.querySelector("#pagefind-search") as HTMLElement | null;
    if (!pageFindSearch || _searchInitStarted) return;
    _searchInitStarted = true;

    const params = new URLSearchParams(window.location.search);
    const onIdle = window.requestIdleCallback ?? ((cb: () => void) => setTimeout(cb, 1));

    onIdle(async () => {
      // @ts-expect-error — Missing types for @pagefind/default-ui package.
      const { PagefindUI } = await import("@pagefind/default-ui");

      if (import.meta.env.DEV) {
        pageFindSearch.innerHTML = `
              <div class="bg-muted/75 rounded p-4 space-y-4 mb-4">
                <p><strong>DEV mode Warning! </strong>You need to build the project at least once to see the search results during development.</p>
                <code class="block bg-black text-white px-2 py-1 rounded">pnpm run build</code>
              </div>
            `;
      }

      const search = new PagefindUI({
        element: "#pagefind-search",
        showSubResults: true,
        showImages: false,
        processResult(result: { url: string; sub_results?: Array<{ url: string }> }) {
          const cleanUrl = (url: string) =>
            url
              .replace(/\.html$/, "")
              .replace(/\.html[?#]/, (match: string) => match.substring(5));
          result.url = cleanUrl(result.url);
          if (result.sub_results?.length) {
            result.sub_results.forEach((sub) => {
              sub.url = cleanUrl(sub.url);
            });
          }
          return result;
        },
        processTerm(term: string) {
          const trimmed = term.trim();
          if (!trimmed) return term;
          params.set("q", term);
          history.replaceState(history.state, "", "?" + params.toString());
          const backUrl = pageFindSearch?.dataset?.backurl;
          sessionStorage.setItem("backUrl", (backUrl ?? "") + "?" + params.toString());
          if (!trimmed.startsWith('"') || !trimmed.endsWith('"')) {
            return `"${trimmed}"`;
          }
          return term;
        },
      });

      const query = params.get("q");
      if (query) search.triggerSearch(query);

      const searchInput = document.querySelector(".pagefind-ui__search-input");
      const clearButton = document.querySelector(".pagefind-ui__search-clear");
      const resetSearchParam = (e: Event) => {
        if ((e.target as HTMLInputElement)?.value.trim() === "") {
          history.replaceState(history.state, "", window.location.pathname);
        }
      };
      searchInput?.addEventListener("input", resetSearchParam);
      clearButton?.addEventListener("click", resetSearchParam);
    });
  }

  function maybeInitSearch() {
    initSearch();
  }
  document.addEventListener("DOMContentLoaded", maybeInitSearch);
  window.addEventListener("load", maybeInitSearch);
</script>

<style is:global>
  #pagefind-search {
    --pagefind-ui-font: var(--font-app);
    --pagefind-ui-text: var(--text-primary);
    --pagefind-ui-background: var(--background-secondary);
    --pagefind-ui-border: var(--border);
    --pagefind-ui-primary: var(--accent);
    --pagefind-ui-tag: var(--background);
    --pagefind-ui-border-radius: 0.375rem;
    --pagefind-ui-border-width: 1px;
    --pagefind-ui-image-border-radius: 8px;
    --pagefind-ui-image-box-ratio: 3 / 2;

    form::before {
      background-color: var(--text-primary);
    }

    input {
      font-weight: 400;
      border: 1px solid var(--border);
    }

    input:focus-visible {
      outline: 1px solid var(--accent);
    }

    .pagefind-ui__result-title a {
      color: var(--accent);
      outline-offset: 1px;
      outline-color: var(--accent);
      text-decoration-style: dashed;
      text-underline-offset: 4px;
    }

    .pagefind-ui__result-title a:focus-visible,
    .pagefind-ui__search-clear:focus-visible {
      text-decoration-line: none;
      outline-width: 2px;
      outline-style: dashed;
    }

    .pagefind-ui__result:last-of-type {
      border-bottom: 0;
    }

    .pagefind-ui__result-nested .pagefind-ui__result-link:before {
      font-family: system-ui;
    }
  }
</style>
