---
/**
 * Running 页面
 *
 * 参考：https://zdyxry.github.io/running/
 * 数据：public/data/running.json（构建时读取，GitHub Action 定时同步）
 */
import fs from "node:fs";
import path from "node:path";
import Layout from "@/layouts/Layout.astro";
import Header from "@/components/Header.astro";
import Footer from "@/components/Footer.astro";
import RunningPeriodStats from "@/components/running/RunningPeriodStats.astro";
import RunningContributionGraph from "@/components/running/RunningContributionGraph.astro";
import RunningRunCard from "@/components/running/RunningRunCard.astro";
import RunningDetailModal from "@/components/running/RunningDetailModal.astro";
import { SITE } from "@/config";
import { _t } from "@/scripts/lang";
import runningStyles from "@/styles/running.css?raw";

type PeriodStat = {
  total_activities: number;
  total_distance: number;
  total_duration_hours: number;
  avg_pace: string;
  avg_heart_rate?: number | null;
  avg_vdot?: number | null;
  total_training_load: number;
};

type RunningJson = {
  runs: Array<{
    date: string;
    distance: number;
    duration: string;
    pace: string;
    hr_zone?: number;
    activity_type?: string;
    workout_name?: string;
    route?: string;
    vdot?: number;
    training_load?: number;
    heart_rate?: number;
    max_heart_rate?: number;
    cadence?: number;
    segments?: unknown[];
    laps?: unknown[];
  }>;
  stats: { period_stats?: { week?: PeriodStat; month?: PeriodStat; year?: PeriodStat; total?: PeriodStat } } | null;
};

const runningPath = path.join(process.cwd(), "public", "data", "running.json");
const raw = fs.existsSync(runningPath)
  ? fs.readFileSync(runningPath, "utf-8")
  : '{"runs":[],"stats":null}';
const parsed = JSON.parse(raw) as RunningJson;
const data: RunningJson =
  parsed?.runs && Array.isArray(parsed.runs)
    ? parsed
    : { runs: [], stats: null };

const title = _t.running.title;
const description = _t.running.desc;

const recentRuns = data.runs.slice(0, 10);
const hasMoreRuns = data.runs.length > 10;
const periodStats = data.stats?.period_stats ?? {};
const periodLabels: Record<string, string> = {
  week: "周",
  month: "月",
  year: "年",
  total: "总",
};

function formatDuration(duration: string): string {
  const hourMatch = duration.match(/(\d+)小时/);
  const minMatch = duration.match(/(\d+)分钟/);
  const hours = hourMatch ? parseInt(hourMatch[1]) : 0;
  const mins = minMatch ? parseInt(minMatch[1]) : 0;
  if (hours > 0 && mins > 0) return `${hours}h${mins}m`;
  if (hours > 0) return `${hours}h`;
  return `${mins}m`;
}

const hrZoneLabels: Record<number, string> = {
  0: "",
  1: "Z1 恢复",
  2: "Z2 有氧",
  3: "Z3 节奏",
  4: "Z4 阈值",
  5: "Z5 最大",
};

const hrZoneColors: Record<number, string> = {
  0: "var(--foreground)",
  1: "var(--running-zone-1)",
  2: "var(--running-zone-2)",
  3: "var(--running-zone-3)",
  4: "var(--running-zone-4)",
  5: "var(--running-zone-5)",
};

// 日历：最近 12 个月
const today = new Date();
const currentYear = today.getFullYear();
const currentMonth = today.getMonth();
const startYear = currentMonth >= 11 ? currentYear : currentYear - 1;
const startMonth = currentMonth >= 11 ? currentMonth - 11 : currentMonth + 1;
const startOfRange = new Date(Date.UTC(startYear, startMonth, 1));
const endOfRange = new Date(Date.UTC(currentYear, currentMonth + 1, 0));

const dateMap = new Map<
  string,
  { distance: number; duration: string; runs: (typeof data.runs)[0][] }
>();
data.runs.forEach(run => {
  const dateStr = run.date.split(" ")[0];
  const existing = dateMap.get(dateStr);
  if (!existing) {
    dateMap.set(dateStr, {
      distance: run.distance,
      duration: run.duration,
      runs: [run],
    });
  } else {
    existing.distance += run.distance;
    existing.runs.push(run);
  }
});

function getIntensity(distance: number): number {
  if (!distance) return 0;
  if (distance < 3) return 1;
  if (distance < 5) return 2;
  if (distance < 10) return 3;
  if (distance < 15) return 4;
  return 5;
}

const calendarStart = new Date(startOfRange);
const dow = calendarStart.getUTCDay();
const daysToSubtract = dow === 0 ? 6 : dow - 1;
calendarStart.setUTCDate(calendarStart.getUTCDate() - daysToSubtract);

interface DayData {
  dateStr: string;
  isInRange: boolean;
  intensity: number;
  title: string;
}

const weeks: { days: DayData[] }[] = [];
const totalDays =
  Math.ceil((endOfRange.getTime() - calendarStart.getTime()) / 86400000) + 7;
const totalWeeks = Math.ceil(totalDays / 7);

for (let w = 0; w < totalWeeks; w++) {
  const weekDays: DayData[] = [];
  for (let d = 0; d < 7; d++) {
    const idx = w * 7 + d;
    const currentDate = new Date(calendarStart);
    currentDate.setUTCDate(calendarStart.getUTCDate() + idx);
    const dateStr = currentDate.toISOString().split("T")[0];
    const dayData = dateMap.get(dateStr);
    const isInRange = currentDate >= startOfRange && currentDate <= endOfRange;
    const intensity = getIntensity(dayData?.distance ?? 0);
    const title = dayData
      ? `${dateStr}: ${dayData.distance}km, ${dayData.duration}`
      : dateStr;
    weekDays.push({ dateStr, isInRange, intensity, title });
  }
  weeks.push({ days: weekDays });
}

const months: { label: string; weekIndex: number }[] = [];
for (let m = 0; m < 12; m++) {
  const monthDate = new Date(Date.UTC(startYear, startMonth + m, 1));
  const daysSinceStart = Math.floor(
    (monthDate.getTime() - calendarStart.getTime()) / 86400000
  );
  const weekIndex = Math.floor(daysSinceStart / 7);
  if (weekIndex >= 0 && weekIndex < weeks.length) {
    months.push({ label: `${monthDate.getUTCMonth() + 1}月`, weekIndex });
  }
}
---

<Layout title={`${title} | ${SITE.title}`} description={description}>
  <Header />
  <main id="main-content" class="running-main">
    <section
      id="running"
      class="running-page prose mx-auto max-w-4xl pt-0 pb-6 prose-img:mx-auto prose-img:block prose-img:w-full prose-img:max-w-full"
    >
      <article class="mt-0">
        {
          !data?.stats ? (
            <p class="text-[var(--foreground)]">
              暂无数据。可将 Garmin/Strava 等导出的数据放入{" "}
              <code class="rounded bg-[var(--muted)] px-1">
                public/data/running.json
              </code>
              。
            </p>
          ) : (
            <>
              <h2>跑步统计</h2>
              <div>
                {periodStats && Object.keys(periodStats).length > 0 && (
                  <RunningPeriodStats
                    periodStats={periodStats}
                    periodLabels={periodLabels}
                  />
                )}

                <RunningContributionGraph weeks={weeks} months={months} />

                <h2>最近活动</h2>
                <div
                  class="run-list flex flex-col gap-3"
                  id="runList"
                  data-running-json="/data/running.json"
                  data-hr-zone-labels={JSON.stringify(hrZoneLabels)}
                  data-hr-zone-colors={JSON.stringify(hrZoneColors)}
                >
                  {recentRuns.map((run, index) => (
                    <RunningRunCard
                      run={run}
                      index={index}
                      hrZoneLabels={hrZoneLabels}
                      durationFormatted={formatDuration(run.duration)}
                    />
                  ))}
                </div>
                {hasMoreRuns && (
                  <button
                    type="button"
                    class="load-more-btn mt-4 flex w-full items-center justify-center gap-2 rounded-lg border border-[var(--border)] bg-[var(--muted)]/30 py-3 text-sm font-medium text-[var(--foreground)] transition-colors hover:border-[var(--accent)] hover:bg-[var(--background)] hover:text-[var(--accent)]"
                    id="loadMoreBtn"
                  >
                    <span>更多</span>
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      width="16"
                      height="16"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    >
                      <polyline points="6 9 12 15 18 9" />
                    </svg>
                  </button>
                )}
              </div>
            </>
          )
        }
      </article>

      <RunningDetailModal />
    </section>
  </main>
  <Footer />
</Layout>

<style is:global set:html={runningStyles} />

<script>
  import "@/scripts/initRunningPage";
</script>
