---
/**
 * Running 页面
 *
 * 参考：https://zdyxry.github.io/running/
 * 数据：public/data/running.json（构建时读取，GitHub Action 定时同步）
 */
import fs from "node:fs";
import path from "node:path";
import Layout from "@/layouts/Layout.astro";
import Header from "@/components/Header.astro";
import Footer from "@/components/Footer.astro";
import { SITE } from "@/config";
import { _t } from "@/scripts/lang";
import runningStyles from "@/styles/running.css?raw";

type PeriodStat = {
  total_activities: number;
  total_distance: number;
  total_duration_hours: number;
  avg_pace: string;
  avg_heart_rate?: number | null;
  avg_vdot?: number | null;
  total_training_load: number;
};

type RunningJson = {
  runs: Array<{
    date: string;
    distance: number;
    duration: string;
    pace: string;
    hr_zone?: number;
    activity_type?: string;
    workout_name?: string;
    route?: string;
    vdot?: number;
    training_load?: number;
    heart_rate?: number;
    max_heart_rate?: number;
    cadence?: number;
    segments?: unknown[];
    laps?: unknown[];
  }>;
  stats: { period_stats?: { week?: PeriodStat; month?: PeriodStat; year?: PeriodStat; total?: PeriodStat } } | null;
};

const runningPath = path.join(process.cwd(), "public", "data", "running.json");
const raw = fs.existsSync(runningPath)
  ? fs.readFileSync(runningPath, "utf-8")
  : '{"runs":[],"stats":null}';
const parsed = JSON.parse(raw) as RunningJson;
const data: RunningJson =
  parsed?.runs && Array.isArray(parsed.runs)
    ? parsed
    : { runs: [], stats: null };

const title = _t.running.title;
const description = _t.running.desc;

const recentRuns = data.runs.slice(0, 10);
const hasMoreRuns = data.runs.length > 10;
const periodStats = data.stats?.period_stats ?? {};
const periodLabels: Record<string, string> = {
  week: "周",
  month: "月",
  year: "年",
  total: "总",
};

function formatDuration(duration: string): string {
  const hourMatch = duration.match(/(\d+)小时/);
  const minMatch = duration.match(/(\d+)分钟/);
  const hours = hourMatch ? parseInt(hourMatch[1]) : 0;
  const mins = minMatch ? parseInt(minMatch[1]) : 0;
  if (hours > 0 && mins > 0) return `${hours}h${mins}m`;
  if (hours > 0) return `${hours}h`;
  return `${mins}m`;
}

const hrZoneLabels: Record<number, string> = {
  0: "",
  1: "Z1 恢复",
  2: "Z2 有氧",
  3: "Z3 节奏",
  4: "Z4 阈值",
  5: "Z5 最大",
};

/** 心率区间颜色（与 :root --running-zone-* 一致，供 JS 注入 data 属性） */
const hrZoneColors: Record<number, string> = {
  0: "var(--foreground)",
  1: "var(--running-zone-1)",
  2: "var(--running-zone-2)",
  3: "var(--running-zone-3)",
  4: "var(--running-zone-4)",
  5: "var(--running-zone-5)",
};

// 日历：最近 12 个月
const today = new Date();
const currentYear = today.getFullYear();
const currentMonth = today.getMonth();
const startYear = currentMonth >= 11 ? currentYear : currentYear - 1;
const startMonth = currentMonth >= 11 ? currentMonth - 11 : currentMonth + 1;
const startOfRange = new Date(Date.UTC(startYear, startMonth, 1));
const endOfRange = new Date(Date.UTC(currentYear, currentMonth + 1, 0));

const dateMap = new Map<
  string,
  { distance: number; duration: string; runs: (typeof data.runs)[0][] }
>();
data.runs.forEach(run => {
  const dateStr = run.date.split(" ")[0];
  const existing = dateMap.get(dateStr);
  if (!existing) {
    dateMap.set(dateStr, {
      distance: run.distance,
      duration: run.duration,
      runs: [run],
    });
  } else {
    existing.distance += run.distance;
    existing.runs.push(run);
  }
});

function getIntensity(distance: number): number {
  if (!distance) return 0;
  if (distance < 3) return 1;
  if (distance < 5) return 2;
  if (distance < 10) return 3;
  if (distance < 15) return 4;
  return 5;
}

const calendarStart = new Date(startOfRange);
const dow = calendarStart.getUTCDay();
const daysToSubtract = dow === 0 ? 6 : dow - 1;
calendarStart.setUTCDate(calendarStart.getUTCDate() - daysToSubtract);

interface DayData {
  dateStr: string;
  isInRange: boolean;
  intensity: number;
  title: string;
}

const weeks: { days: DayData[] }[] = [];
const totalDays =
  Math.ceil((endOfRange.getTime() - calendarStart.getTime()) / 86400000) + 7;
const totalWeeks = Math.ceil(totalDays / 7);

for (let w = 0; w < totalWeeks; w++) {
  const weekDays: DayData[] = [];
  for (let d = 0; d < 7; d++) {
    const idx = w * 7 + d;
    const currentDate = new Date(calendarStart);
    currentDate.setUTCDate(calendarStart.getUTCDate() + idx);
    const dateStr = currentDate.toISOString().split("T")[0];
    const dayData = dateMap.get(dateStr);
    const isInRange = currentDate >= startOfRange && currentDate <= endOfRange;
    const intensity = getIntensity(dayData?.distance ?? 0);
    const title = dayData
      ? `${dateStr}: ${dayData.distance}km, ${dayData.duration}`
      : dateStr;
    weekDays.push({ dateStr, isInRange, intensity, title });
  }
  weeks.push({ days: weekDays });
}

const months: { label: string; weekIndex: number }[] = [];
for (let m = 0; m < 12; m++) {
  const monthDate = new Date(Date.UTC(startYear, startMonth + m, 1));
  const daysSinceStart = Math.floor(
    (monthDate.getTime() - calendarStart.getTime()) / 86400000
  );
  const weekIndex = Math.floor(daysSinceStart / 7);
  if (weekIndex >= 0 && weekIndex < weeks.length) {
    months.push({ label: `${monthDate.getUTCMonth() + 1}月`, weekIndex });
  }
}
---

<Layout title={`${title} | ${SITE.title}`} description={description}>
  <Header />
  <main id="main-content" class="running-main">
    <section
      id="running"
      class="running-page prose mx-auto max-w-4xl pt-0 pb-6 prose-img:mx-auto prose-img:block prose-img:w-full prose-img:max-w-full"
    >
      <article class="mt-0">
        {
          !data?.stats ? (
            <p class="text-[var(--foreground)]">
              暂无数据。可将 Garmin/Strava 等导出的数据放入{" "}
              <code class="rounded bg-[var(--muted)] px-1">
                public/data/running.json
              </code>
              。
            </p>
          ) : (
            <>
              <h2>跑步统计</h2>
              <div>
                {periodStats && Object.keys(periodStats).length > 0 && (
                  <div class="period-stats-section">
                    <div class="period-stats-card overflow-hidden rounded-lg border border-[var(--border)]">
                      <div
                        class="period-tab-nav flex border-b border-[var(--border)] bg-[var(--muted)]/30 px-4"
                        id="periodTabNav"
                      >
                        {(["week", "month", "year", "total"] as const).map(
                          period => {
                            const pStats = periodStats[period];
                            if (!pStats) return null;
                            const isActive = period === "week";
                            return (
                              <button
                                type="button"
                                class:list={[
                                  "period-tab-btn border-b-2 px-5 py-3.5 text-sm font-medium transition-colors",
                                  isActive
                                    ? "border-[var(--accent)] text-[var(--accent)]"
                                    : "border-transparent text-[var(--foreground)]/70 hover:text-[var(--foreground)]",
                                ]}
                                data-period={period}
                              >
                                {periodLabels[period]}
                              </button>
                            );
                          }
                        )}
                      </div>
                      <div class="period-tab-content p-5">
                        {(["week", "month", "year", "total"] as const).map(
                          period => {
                            const pStats = periodStats[period];
                            if (!pStats) return null;
                            const isActive = period === "week";
                            return (
                              <div
                                class:list={[
                                  "period-panel",
                                  !isActive && "hidden",
                                ]}
                                data-panel={period}
                              >
                                <div class="period-panel-header mb-5 flex justify-between border-b border-[var(--border)] pb-3">
                                  <span class="text-sm font-semibold text-[var(--foreground)]">
                                    {periodLabels[period]}数据统计
                                  </span>
                                  <span class="text-xs text-[var(--foreground)]/70">
                                    共计跑步 {pStats.total_activities} 次
                                  </span>
                                </div>
                                <div class="period-panel-grid grid grid-cols-3 gap-x-2 gap-y-5">
                                  <div class="period-panel-stat flex flex-col items-center gap-1.5 rounded-lg p-2 text-center">
                                    <span class="text-[1.375rem] font-bold text-[var(--foreground)]">
                                      {pStats.avg_vdot?.toFixed(1) ?? "--"}
                                    </span>
                                    <span class="text-xs text-[var(--foreground)]/70">
                                      当前跑力
                                    </span>
                                  </div>
                                  <div class="period-panel-stat flex flex-col items-center gap-1.5 rounded-lg p-2 text-center">
                                    <span class="text-[1.375rem] font-bold text-[var(--foreground)]">
                                      {pStats.total_distance}
                                    </span>
                                    <span class="text-xs text-[var(--foreground)]/70">
                                      公里
                                    </span>
                                  </div>
                                  <div class="period-panel-stat flex flex-col items-center gap-1.5 rounded-lg p-2 text-center">
                                    <span class="text-[1.375rem] font-bold text-[var(--foreground)]">
                                      {pStats.avg_pace}
                                    </span>
                                    <span class="text-xs text-[var(--foreground)]/70">
                                      平均配速
                                    </span>
                                  </div>
                                  <div class="period-panel-stat flex flex-col items-center gap-1.5 rounded-lg p-2 text-center">
                                    <span class="text-[1.375rem] font-bold text-[var(--foreground)]">
                                      {pStats.total_training_load > 0
                                        ? pStats.total_training_load.toFixed(0)
                                        : "--"}
                                    </span>
                                    <span class="text-xs text-[var(--foreground)]/70">
                                      训练负荷
                                    </span>
                                  </div>
                                  <div class="period-panel-stat flex flex-col items-center gap-1.5 rounded-lg p-2 text-center">
                                    <span class="text-[1.375rem] font-bold text-[var(--foreground)]">
                                      {pStats.total_duration_hours.toFixed(1)}
                                    </span>
                                    <span class="text-xs text-[var(--foreground)]/70">
                                      总时长(小时)
                                    </span>
                                  </div>
                                  <div class="period-panel-stat flex flex-col items-center gap-1.5 rounded-lg p-2 text-center">
                                    <span class="text-[1.375rem] font-bold text-[var(--foreground)]">
                                      {pStats.avg_heart_rate ?? "--"}
                                    </span>
                                    <span class="text-xs text-[var(--foreground)]/70">
                                      平均心率
                                    </span>
                                  </div>
                                </div>
                              </div>
                            );
                          }
                        )}
                      </div>
                    </div>
                  </div>
                )}

                <div class="contribution-graph my-4 rounded-lg border border-[var(--border)] bg-[var(--muted)]/20 p-2">
                  <div class="month-labels relative mb-1 h-4">
                    {months.map(m => (
                      <span
                        class="month-label absolute text-[10px] text-[var(--foreground)]"
                        style={`left: ${(m.weekIndex / weeks.length) * 100}%`}
                      >
                        {m.label}
                      </span>
                    ))}
                  </div>
                  <div class="weeks flex gap-0.5">
                    {weeks.map(week => (
                      <div class="week flex flex-1 flex-col gap-0.5">
                        {week.days.map(day => (
                          <div
                            class:list={[
                              "day aspect-square w-full rounded-sm transition-transform",
                              !day.isInRange && "out-of-range",
                              day.intensity === 1 && "intensity-1",
                              day.intensity === 2 && "intensity-2",
                              day.intensity === 3 && "intensity-3",
                              day.intensity === 4 && "intensity-4",
                              day.intensity === 5 && "intensity-5",
                            ]}
                            title={day.title}
                          />
                        ))}
                      </div>
                    ))}
                  </div>
                </div>

                <h2>最近活动</h2>
                <div
                  class="run-list flex flex-col gap-3"
                  id="runList"
                  data-running-json="/data/running.json"
                  data-hr-zone-labels={JSON.stringify(hrZoneLabels)}
                  data-hr-zone-colors={JSON.stringify(hrZoneColors)}
                >
                  {recentRuns.map((run, index) => (
                    <div
                      class="run-card run-card cursor-pointer rounded-lg border border-[var(--border)] p-4 shadow-sm transition-all hover:border-[var(--accent)] hover:shadow-md"
                      data-run-index={index}
                      data-run={JSON.stringify(run)}
                    >
                      <div class="run-main flex flex-1 flex-col gap-1.5">
                        <div class="run-header flex flex-wrap items-center gap-2.5">
                          <time class="run-date text-sm font-medium text-[var(--foreground)]">
                            {run.date.split(" ")[0]}
                          </time>
                          {run.hr_zone != null && run.hr_zone > 0 && (
                            <span
                              class:list={[
                                "hr-zone-badge hr-zone-tag inline-flex rounded-full px-2.5 py-1 text-[11px] font-semibold",
                                `zone-${run.hr_zone}`,
                              ]}
                            >
                              {hrZoneLabels[run.hr_zone]}
                            </span>
                          )}
                        </div>
                        <span class="run-type text-[13px] text-[var(--foreground)]/80">
                          {run.activity_type || "户外跑步"}
                          {(run.route?.trim() || run.workout_name) && (
                            <span class="workout-name">
                              {" "}
                              · {run.route?.trim() || run.workout_name}
                            </span>
                          )}
                        </span>
                      </div>
                      <div class="run-stats flex gap-5">
                        <div class="stat flex flex-col gap-0.5">
                          <span class="stat-value text-base font-semibold text-[var(--foreground)]">
                            {run.distance}
                          </span>
                          <span class="stat-label text-[11px] tracking-wide text-[var(--foreground)]/70 uppercase">
                            公里
                          </span>
                        </div>
                        <div class="stat flex flex-col gap-0.5">
                          <span class="stat-value text-base font-semibold text-[var(--foreground)]">
                            {formatDuration(run.duration)}
                          </span>
                          <span class="stat-label text-[11px] tracking-wide text-[var(--foreground)]/70 uppercase">
                            时长
                          </span>
                        </div>
                        <div class="stat flex flex-col gap-0.5">
                          <span class="stat-value text-base font-semibold text-[var(--foreground)]">
                            {run.pace}
                          </span>
                          <span class="stat-label text-[11px] tracking-wide text-[var(--foreground)]/70 uppercase">
                            配速
                          </span>
                        </div>
                        <div class="stat vdot-stat flex flex-col gap-0.5">
                          <span class="stat-value text-base font-semibold">
                            {run.vdot ?? "-"}
                          </span>
                          <span class="stat-label text-[11px] tracking-wide text-[var(--foreground)]/70 uppercase">
                            VDOT
                          </span>
                        </div>
                        {run.training_load != null && run.training_load > 0 && (
                          <div class="stat load-stat flex flex-col gap-0.5">
                            <span class="stat-value text-base font-semibold">
                              {run.training_load}
                            </span>
                            <span class="stat-label text-[11px] tracking-wide text-[var(--foreground)]/70 uppercase">
                              负荷
                            </span>
                          </div>
                        )}
                      </div>
                    </div>
                  ))}
                </div>
                {hasMoreRuns && (
                  <button
                    type="button"
                    class="load-more-btn mt-4 flex w-full items-center justify-center gap-2 rounded-lg border border-[var(--border)] bg-[var(--muted)]/30 py-3 text-sm font-medium text-[var(--foreground)] transition-colors hover:border-[var(--accent)] hover:bg-[var(--background)] hover:text-[var(--accent)]"
                    id="loadMoreBtn"
                  >
                    <span>更多</span>
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      width="16"
                      height="16"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    >
                      <polyline points="6 9 12 15 18 9" />
                    </svg>
                  </button>
                )}
              </div>
            </>
          )
        }
      </article>

      <!-- 跑步详情弹窗 -->
      <div
        class="run-detail-modal fixed inset-0 z-[1000] hidden items-center justify-center p-4"
        id="runDetailModal"
      >
        <div
          class="modal-overlay absolute inset-0 bg-black/50 backdrop-blur-sm"
          id="modalOverlay"
        >
        </div>
        <div
          class="modal-content relative max-h-[90vh] w-full max-w-2xl overflow-hidden rounded-xl border border-[var(--border)] bg-[var(--background)] shadow-xl"
          id="modalContent"
        >
          <button
            type="button"
            class="modal-close absolute top-4 right-4 flex h-9 w-9 items-center justify-center rounded-lg border border-[var(--border)] bg-[var(--muted)]/30 text-[var(--foreground)] transition-colors hover:bg-[var(--border)]"
            id="modalClose"
            aria-label="关闭"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              ><line x1="18" y1="6" x2="6" y2="18"></line><line
                x1="6"
                y1="6"
                x2="18"
                y2="18"></line></svg
            >
          </button>
          <div
            class="modal-body max-h-[90vh] overflow-y-auto p-6"
            id="modalBody"
          >
          </div>
        </div>
      </div>
    </section>
  </main>
  <Footer />
</Layout>

<style is:global set:html={runningStyles} />

<script>
  import "@/scripts/initRunningPage";
</script>
