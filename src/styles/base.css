/* ========== 字体 ========== */
@import "@fontsource/noto-sans-sc/400.css";
@import "@fontsource/noto-sans-sc/700.css";
@import "@fontsource/noto-sans-sc/800.css";
@import "@fontsource/noto-sans/400.css";
@import "@fontsource/noto-sans/400-italic.css";
@import "@fontsource/noto-sans/700.css";
@import "@fontsource/roboto-mono/400.css";
@import "@fontsource/roboto-mono/400-italic.css";
@import "@fontsource/roboto-mono/600.css";
@font-face {
  font-family: "Fallback Sans";
  src:
    local("Microsoft YaHei"), local("PingFang SC"), local("Hiragino Sans GB"),
    local("Noto Sans CJK SC"), local("Source Han Sans SC"),
    local("WenQuanYi Micro Hei");
  size-adjust: 100%;
  ascent-override: 90%;
  descent-override: 22%;
  line-gap-override: 0%;
}

/* ========== 主题（Tailwind @theme + 组件覆盖） ========== */
@theme inline {
  /* 顶栏固定后整页统一为 --background，不再区分内外背景 */
  --color-background: var(--background);
  --color-content-background: var(--background);
  --color-foreground: var(--text-primary);
  --color-accent: var(--accent);
  --color-muted: rgb(var(--gray-light));
  --color-text-muted: var(--text-secondary);
  --color-border: var(--border);
}

/* ========== 基础层 ========== */
@layer base {
  * {
    @apply border-border outline-accent/75;
    scrollbar-width: auto;
    scrollbar-color: color-mix(
        in srgb,
        var(--color-muted) 80%,
        var(--color-foreground) 20%
      )
      transparent;
  }
  html {
    @apply overflow-y-scroll scroll-smooth;
    /* 不设背景，由 body 统一提供整页背景，避免 html/body 两层色差 */
    transition: background-color 0s;
    /* 覆盖 Layout 内联的 visibility:hidden，带主题的 CSS 加载后即显示（!important 保证生效） */
    visibility: visible !important;
  }
  body {
    @apply flex min-h-svh flex-col font-sans text-foreground selection:bg-accent/75 selection:text-background;
    font-family: var(--font-sans), var(--font-emoji);
    background-color: var(--background);
    transition: background-color 0s;
  }
  #site-frame {
    background-color: var(--background);
    transition: background-color 0s;
  }
  /* 主题切换平滑过渡：由 JS 在 setTheme 之后 rAF 添加 .theme-transition，避免先加过渡再改 theme 导致闪白 */
  html.theme-transition,
  html.theme-transition body,
  html.theme-transition #site-frame,
  html.theme-transition .site-header {
    transition-duration: 0.2s;
    transition-timing-function: ease;
    transition-property: background-color, color;
  }
  a,
  button {
    @apply outline-offset-1 outline-accent focus-visible:no-underline focus-visible:outline-2;
  }
  button:not(:disabled),
  [role="button"]:not(:disabled) {
    cursor: pointer;
  }
}

.active-nav {
  color: var(--accent) !important;
  font-weight: 600;
}

@layer utilities {
  #sidebar {
    @apply fixed z-40 transform overflow-y-auto text-sm;
    background-color: var(--background);
    border: none;
  }

  @media (max-width: 1023px) {
    #sidebar {
      @apply fixed top-0 right-0 bottom-0 left-auto flex h-full max-h-none w-4/5 max-w-70 translate-x-full flex-col justify-end rounded-none p-6 pb-8;
    }

    #sidebar.mobile-open {
      @apply translate-x-0;
    }
  }

  @media (min-width: 1300px) {
    /* TOC 在 site-frame 外，固定于视口右侧；背景稍深一点更明显，无边框 */
    #sidebar {
      position: fixed;
      top: 6rem;
      right: 4.5rem;
      background-color: color-mix(in srgb, var(--text-primary) 2%, var(--background));
      border: none;
      box-shadow: none;
      @apply z-40 m-0 max-h-[calc(100vh-8rem)] w-40 translate-x-0 rounded-lg p-4;
    }

    @media (min-width: 1280px) {
      #sidebar {
        @apply w-56;
      }
    }

    /* tocbot 旧版样式（适当留白，不紧凑） */
    /* 仅顶级列表留白，避免内层列表被影响 */
    .toc > .toc-list {
      padding-top: 0.5rem;
      padding-bottom: 0.5rem;
    }
    /* h2 条目：只用 margin-bottom 控制间隔，有无子节点都一致（避免 margin 折叠） */
    .toc > .toc-list > .toc-list-item {
      margin-top: 0;
      margin-bottom: 0.75rem;
    }
    .toc > .toc-list > .toc-list-item:last-child {
      margin-bottom: 0;
    }
    /* 有子节点时：内层列表与 h2 链接的间距、且不增加底部空隙 */
    .toc > .toc-list > .toc-list-item > .toc-list {
      margin-top: 0.25rem;
      margin-bottom: 0;
      padding-left: 0.75rem;
    }
    .toc-list-item {
      @apply truncate overflow-hidden whitespace-nowrap;
      color: var(--text-primary);
    }
    .toc-list .toc-list .toc-list-item {
      @apply my-1;
    }
    .toc-link {
      color: var(--text-primary);
      @apply py-1 block;
      line-height: 1.5;
    }
    .toc-link.is-active-link {
      @apply !text-accent;
    }
    .toc-link::before {
      @apply !hidden;
      content: "";
    }

    @media (max-width: 1023px) {
      .toc-list-item {
        @apply my-4;
      }
    }
  }

  #sidebar #back-to-top svg,
  #sidebar #back-to-top span {
    color: var(--text-primary);
  }
}