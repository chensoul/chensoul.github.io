---
title: "Spring å›½é™…åŒ–å®ç°"
date: 2025-07-17
slug: spring-i18n
categories: ["java"]
tags: ['i18n','spring']
---

## ğŸ“œ ä¸€ã€è®¾è®¡èƒŒæ™¯
### 1.1 å›½é™…åŒ–éœ€æ±‚çš„äº§ç”Ÿ

éšç€è½¯ä»¶åº”ç”¨çš„å…¨çƒåŒ–å‘å±•ï¼Œä¼ä¸šçº§åº”ç”¨éœ€è¦æ”¯æŒå¤šç§è¯­è¨€å’Œåœ°åŒºè®¾ç½®ã€‚Spring Framework ä½œä¸º Java ä¼ä¸šçº§å¼€å‘çš„æ ¸å¿ƒæ¡†æ¶ï¼Œå¿…é¡»æä¾›å®Œå–„çš„å›½é™…åŒ–ï¼ˆi18nï¼‰æ”¯æŒæ¥æ»¡è¶³ä»¥ä¸‹éœ€æ±‚ï¼š

<!--more-->

- **å¤šè¯­è¨€æ”¯æŒ**ï¼šåº”ç”¨ç¨‹åºéœ€è¦æ ¹æ®ç”¨æˆ·çš„è¯­è¨€åå¥½æ˜¾ç¤ºç›¸åº”çš„æ–‡æœ¬å†…å®¹
- **åœ°åŒºåŒ–é€‚é…**ï¼šä¸åŒåœ°åŒºçš„æ—¥æœŸã€æ•°å­—ã€è´§å¸æ ¼å¼éœ€è¦æœ¬åœ°åŒ–å¤„ç†
- **åŠ¨æ€åˆ‡æ¢**ï¼šç”¨æˆ·å¯ä»¥åœ¨è¿è¡Œæ—¶åŠ¨æ€åˆ‡æ¢è¯­è¨€ç¯å¢ƒ
- **ä¼ä¸šçº§ç‰¹æ€§**ï¼šéœ€è¦æ”¯æŒå¤§è§„æ¨¡ã€é«˜å¹¶å‘çš„ä¼ä¸šçº§åº”ç”¨åœºæ™¯

### 1.2 Java å¹³å°åŸºç¡€

Spring çš„å›½é™…åŒ–è®¾è®¡åŸºäº Java å¹³å°çš„æ ‡å‡†å›½é™…åŒ–æœºåˆ¶ï¼š

- **ResourceBundle**ï¼šJava SE æä¾›çš„æ ‡å‡†èµ„æºåŒ…æœºåˆ¶
- **Locale**ï¼šè¡¨ç¤ºç‰¹å®šçš„åœ°ç†ã€æ”¿æ²»æˆ–æ–‡åŒ–åŒºåŸŸ
- **MessageFormat**ï¼šç”¨äºæ ¼å¼åŒ–å¸¦å‚æ•°çš„æ¶ˆæ¯æ–‡æœ¬
- **Properties æ–‡ä»¶**ï¼šå­˜å‚¨é”®å€¼å¯¹å½¢å¼çš„å›½é™…åŒ–èµ„æº

### 1.3 Spring çš„è®¾è®¡ç†å¿µ

Spring åœ¨ Java æ ‡å‡†å›½é™…åŒ–åŸºç¡€ä¸Šï¼Œéµå¾ªä»¥ä¸‹è®¾è®¡ç†å¿µï¼š

- **æŠ½è±¡åŒ–**ï¼šé€šè¿‡æ¥å£æŠ½è±¡å±è”½åº•å±‚å®ç°ç»†èŠ‚
- **å¯æ‰©å±•æ€§**ï¼šæ”¯æŒå¤šç§èµ„æºåŠ è½½ç­–ç•¥å’Œå­˜å‚¨æ–¹å¼
- **é›†æˆæ€§**ï¼šä¸ Spring å®¹å™¨å’Œå…¶ä»–ç»„ä»¶æ— ç¼é›†æˆ
- **ä¸€è‡´æ€§**ï¼šæä¾›ç»Ÿä¸€çš„ API å’Œé…ç½®æ–¹å¼

---

## ğŸ§± äºŒã€æ¶æ„ä¸æ ¸å¿ƒç»„ä»¶

### 1. æ ¸å¿ƒæ¥å£

Spring å›½é™…åŒ–çš„æ ¸å¿ƒæ¶æ„å›´ç»•ä»¥ä¸‹å‡ ä¸ªå…³é”®æ¥å£å±•å¼€ï¼š

```java
// æ ¸å¿ƒæ¶ˆæ¯æºæ¥å£
public interface MessageSource {
    String getMessage(String code, Object[] args, String defaultMessage, Locale locale);
    String getMessage(String code, Object[] args, Locale locale) throws NoSuchMessageException;
    String getMessage(MessageSourceResolvable resolvable, Locale locale) throws NoSuchMessageException;
}

// å±‚æ¬¡åŒ–æ¶ˆæ¯æºæ¥å£
public interface HierarchicalMessageSource extends MessageSource {
    void setParentMessageSource(MessageSource parent);
    MessageSource getParentMessageSource();
}

// æ¶ˆæ¯æºå¯è§£æå¯¹è±¡
public interface MessageSourceResolvable {
    String[] getCodes();
    Object[] getArguments();
    String getDefaultMessage();
}
```

- Spring çš„å›½é™…åŒ–æ¶ˆæ¯è§£ææ ¸å¿ƒæ¥å£ï¼Œå®šä¹‰äº†æ ¹æ® key å’Œ Locale è·å–æœ¬åœ°åŒ–æ¶ˆæ¯çš„æ–¹æ³•ã€‚
- å¸¸ç”¨å®ç°æœ‰ï¼š
  - `ResourceBundleMessageSource`
  - `ReloadableResourceBundleMessageSource`
  - è‡ªå®šä¹‰å®ç°ï¼ˆå¦‚æœ¬é¡¹ç›®çš„ `AbstractResourceMessageSource`ï¼‰



### 2. æ ¸å¿ƒæ¶æ„

```mermaid
graph TD
    A[ApplicationContext] --> B[MessageSource]
    B --> C[HierarchicalMessageSource]
    C --> D[ResourceBundleMessageSource]
    C --> E[ReloadableResourceBundleMessageSource]
    C --> F[StaticMessageSource]
    
    G[LocaleResolver] --> H[AcceptHeaderLocaleResolver]
    G --> I[SessionLocaleResolver]
    G --> J[CookieLocaleResolver]
    G --> K[FixedLocaleResolver]
    
    B --> L[MessageSourceResolvable]
    L --> M[DefaultMessageSourceResolvable]
    
    N[LocaleContextHolder] --> O[ThreadLocal Locale Storage]
```

ç»„ä»¶èŒè´£åˆ†å·¥

| ç»„ä»¶                                      | èŒè´£                     | ç‰¹ç‚¹                       |
| ----------------------------------------- | ------------------------ | -------------------------- |
| **MessageSource**                         | å®šä¹‰æ¶ˆæ¯è§£æçš„æ ¸å¿ƒæ¥å£   | æä¾›ç»Ÿä¸€çš„æ¶ˆæ¯è·å–API      |
| **HierarchicalMessageSource**             | æ”¯æŒçˆ¶å­å…³ç³»çš„æ¶ˆæ¯æº     | å®ç°æ¶ˆæ¯çš„å±‚æ¬¡åŒ–æŸ¥æ‰¾       |
| **AbstractMessageSource**                 | æä¾›æ¶ˆæ¯è§£æçš„é€šç”¨é€»è¾‘   | å¤„ç†å‚æ•°è§£æã€é»˜è®¤æ¶ˆæ¯ç­‰   |
| **ResourceBundleMessageSource**           | åŸºäºResourceBundleçš„å®ç° | æ€§èƒ½é«˜ï¼Œä½†ä¸æ”¯æŒçƒ­é‡è½½     |
| **ReloadableResourceBundleMessageSource** | æ”¯æŒçƒ­é‡è½½çš„å®ç°         | çµæ´»æ€§é«˜ï¼Œæ”¯æŒå¤šç§èµ„æºä½ç½® |
| **LocaleResolver**                        | è§£æå½“å‰è¯·æ±‚çš„Locale     | æ”¯æŒå¤šç§Localeç¡®å®šç­–ç•¥     |
| **LocaleContextHolder**                   | çº¿ç¨‹çº§Localeå­˜å‚¨         | æä¾›çº¿ç¨‹å®‰å…¨çš„Localeè®¿é—®   |

### 3. æŠ€æœ¯å®ç°

#### 3.1 MessageSource å®ç°ç±»è¯¦è§£

##### 3.1.1 ResourceBundleMessageSource

```java
public class ResourceBundleMessageSource extends AbstractResourceBasedMessageSource {
    // ç¼“å­˜ResourceBundleå®ä¾‹
    private final Map<String, Map<Locale, ResourceBundle>> cachedResourceBundles = 
        new ConcurrentHashMap<>();
    
    // ç¼“å­˜ç”Ÿæˆçš„MessageFormatå®ä¾‹
    private final Map<String, Map<Locale, MessageFormat>> cachedBundleMessageFormats = 
        new ConcurrentHashMap<>();
    
    @Override
    protected MessageFormat resolveCode(String code, Locale locale) {
        // ä»ç¼“å­˜è·å–æˆ–åˆ›å»ºMessageFormat
        MessageFormat messageFormat = getCachedMessageFormat(code, locale);
        if (messageFormat != null) {
            return messageFormat;
        }
        
        // è·å–ResourceBundle
        ResourceBundle bundle = getResourceBundle(getBasename(), locale);
        if (bundle != null) {
            String message = getStringOrNull(bundle, code);
            if (message != null) {
                messageFormat = createMessageFormat(message, locale);
                cacheMessageFormat(code, locale, messageFormat);
                return messageFormat;
            }
        }
        return null;
    }
}
```

**ç‰¹ç‚¹åˆ†æï¼š**

- **é«˜æ€§èƒ½**ï¼šåŸºäºJDKåŸç”ŸResourceBundleï¼Œæ€§èƒ½ä¼˜å¼‚
- **å¼ºç¼“å­˜**ï¼šResourceBundleå’ŒMessageFormatéƒ½è¢«ç¼“å­˜ï¼Œé¿å…é‡å¤åˆ›å»º
- **ç±»è·¯å¾„é™åˆ¶**ï¼šåªèƒ½åŠ è½½ç±»è·¯å¾„ä¸‹çš„èµ„æºæ–‡ä»¶
- **æ— çƒ­é‡è½½**ï¼šèµ„æºæ–‡ä»¶ä¿®æ”¹åéœ€è¦é‡å¯åº”ç”¨

##### 3.1.2 ReloadableResourceBundleMessageSource

```java
public class ReloadableResourceBundleMessageSource extends AbstractResourceBasedMessageSource {
    // å±æ€§æŒæœ‰è€…ç¼“å­˜
    private final ConcurrentHashMap<String, PropertiesHolder> cachedProperties = 
        new ConcurrentHashMap<>();
    
    // åˆå¹¶åçš„å±æ€§ç¼“å­˜
    private final ConcurrentHashMap<Locale, PropertiesHolder> cachedMergedProperties = 
        new ConcurrentHashMap<>();
    
    @Override
    protected MessageFormat resolveCode(String code, Locale locale) {
        PropertiesHolder propHolder = getMergedProperties(locale);
        if (propHolder != null) {
            MessageFormat messageFormat = propHolder.getMessageFormat(code);
            if (messageFormat != null) {
                return messageFormat;
            }
            
            String message = propHolder.getProperty(code);
            if (message != null) {
                messageFormat = createMessageFormat(message, locale);
                propHolder.setMessageFormat(code, messageFormat);
                return messageFormat;
            }
        }
        return null;
    }
    
    // å±æ€§æŒæœ‰è€…å†…éƒ¨ç±»
    protected class PropertiesHolder {
        private Properties properties;
        private long fileTimestamp = -1;
        private volatile Map<String, MessageFormat> cachedMessageFormats;
        
        // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦éœ€è¦é‡æ–°åŠ è½½
        public boolean isRefreshTimestamp() {
            return (this.fileTimestamp >= 0 && 
                    System.currentTimeMillis() - this.fileTimestamp > getCacheMillis());
        }
    }
}
```

**ç‰¹ç‚¹åˆ†æï¼š**

- **çƒ­é‡è½½æ”¯æŒ**ï¼šæ”¯æŒè¿è¡Œæ—¶é‡æ–°åŠ è½½èµ„æºæ–‡ä»¶
- **å¤šä½ç½®æ”¯æŒ**ï¼šæ”¯æŒæ–‡ä»¶ç³»ç»Ÿã€ç±»è·¯å¾„ã€URLç­‰å¤šç§èµ„æºä½ç½®
- **æ—¶é—´æˆ³æ£€æŸ¥**ï¼šé€šè¿‡æ–‡ä»¶æ—¶é—´æˆ³åˆ¤æ–­æ˜¯å¦éœ€è¦é‡æ–°åŠ è½½
- **å¹¶å‘ä¼˜åŒ–**ï¼šæ”¯æŒå¹¶å‘åˆ·æ–°ï¼Œå‡å°‘çº¿ç¨‹é˜»å¡

#### 3.2 Locale è§£ææœºåˆ¶

##### 3.2.1 LocaleResolver ç­–ç•¥æ¨¡å¼

```java
// åŸºäºHTTP Accept-Languageå¤´çš„è§£æå™¨
public class AcceptHeaderLocaleResolver implements LocaleResolver {
    @Override
    public Locale resolveLocale(HttpServletRequest request) {
        Locale defaultLocale = getDefaultLocale();
        if (defaultLocale != null && request.getHeader("Accept-Language") == null) {
            return defaultLocale;
        }
        Locale requestLocale = request.getLocale();
        List<Locale> supportedLocales = getSupportedLocales();
        if (supportedLocales.isEmpty() || supportedLocales.contains(requestLocale)) {
            return requestLocale;
        }
        // æŸ¥æ‰¾æœ€åŒ¹é…çš„Locale
        Locale supportedLocale = findSupportedLocale(request, supportedLocales);
        return (supportedLocale != null ? supportedLocale : 
                (defaultLocale != null ? defaultLocale : requestLocale));
    }
}

// åŸºäºSessionçš„è§£æå™¨
public class SessionLocaleResolver implements LocaleResolver {
    public static final String LOCALE_SESSION_ATTRIBUTE_NAME = 
        SessionLocaleResolver.class.getName() + ".LOCALE";
    
    @Override
    public Locale resolveLocale(HttpServletRequest request) {
        Locale locale = (Locale) WebUtils.getSessionAttribute(
            request, LOCALE_SESSION_ATTRIBUTE_NAME);
        return (locale != null ? locale : determineDefaultLocale(request));
    }
    
    @Override
    public void setLocale(HttpServletRequest request, HttpServletResponse response, 
                         Locale locale) {
        WebUtils.setSessionAttribute(request, LOCALE_SESSION_ATTRIBUTE_NAME, locale);
    }
}
```

##### 3.2.2 LocaleContextHolder çº¿ç¨‹å®‰å…¨å®ç°

```java
public abstract class LocaleContextHolder {
    private static final ThreadLocal<LocaleContext> localeContextHolder = 
        new NamedThreadLocal<>("LocaleContext");
    
    private static final ThreadLocal<LocaleContext> inheritableLocaleContextHolder = 
        new NamedInheritableThreadLocal<>("LocaleContext");
    
    public static void setLocale(Locale locale) {
        setLocale(locale, false);
    }
    
    public static void setLocale(Locale locale, boolean inheritable) {
        LocaleContext localeContext = (locale != null ? new SimpleLocaleContext(locale) : null);
        setLocaleContext(localeContext, inheritable);
    }
    
    public static Locale getLocale() {
        return getLocale(getLocaleContext());
    }
    
    public static Locale getLocale(LocaleContext localeContext) {
        if (localeContext != null) {
            Locale locale = localeContext.getLocale();
            if (locale != null) {
                return locale;
            }
        }
        return Locale.getDefault();
    }
}
```

#### 3.3 æ¶ˆæ¯æ ¼å¼åŒ–æœºåˆ¶

##### 3.3.1 MessageFormat é›†æˆä¸ä¼˜åŒ–

```java
public abstract class MessageSourceSupport {
    private boolean alwaysUseMessageFormat = false;
    
    protected String formatMessage(String msg, Object[] args, Locale locale) {
        if (msg == null || (!this.alwaysUseMessageFormat && ObjectUtils.isEmpty(args))) {
            return msg;
        }
        MessageFormat messageFormat = null;
        synchronized (this) {
            messageFormat = createMessageFormat(msg, locale);
        }
        if (messageFormat != null) {
            synchronized (messageFormat) {
                return messageFormat.format(resolveArguments(args, locale));
            }
        }
        return msg;
    }
    
    protected MessageFormat createMessageFormat(String msg, Locale locale) {
        try {
            return new MessageFormat(msg, locale);
        } catch (IllegalArgumentException ex) {
            // å¤„ç†æ ¼å¼é”™è¯¯ï¼Œè¿”å›nullæˆ–æŠ›å‡ºå¼‚å¸¸
            throw new IllegalArgumentException("Invalid message format for locale [" + 
                locale + "]: " + ex.getMessage());
        }
    }
}
```

##### 3.3.2 å‚æ•°è§£æä¸å¤„ç†

```java
public abstract class AbstractMessageSource extends MessageSourceSupport 
    implements HierarchicalMessageSource {
    
    protected Object[] resolveArguments(Object[] args, Locale locale) {
        if (ObjectUtils.isEmpty(args)) {
            return args;
        }
        List<Object> resolvedArgs = new ArrayList<>(args.length);
        for (Object arg : args) {
            if (arg instanceof MessageSourceResolvable) {
                resolvedArgs.add(getMessage((MessageSourceResolvable) arg, locale));
            } else {
                resolvedArgs.add(arg);
            }
        }
        return resolvedArgs.toArray();
    }
}
```

### 4. ä¸»è¦åŠŸèƒ½ç‰¹æ€§

#### 4.1 æ¶ˆæ¯è§£æåŠŸèƒ½

##### 4.1.1 åŸºç¡€æ¶ˆæ¯è§£æ

```java
// ç®€å•æ¶ˆæ¯è·å–
String message = messageSource.getMessage("welcome.message", null, locale);

// å¸¦é»˜è®¤å€¼çš„æ¶ˆæ¯è·å–
String message = messageSource.getMessage("unknown.key", null, "Default Message", locale);

// å‚æ•°åŒ–æ¶ˆæ¯
String message = messageSource.getMessage("welcome.user", new Object[]{"John"}, locale);
```

##### 4.1.2 å±‚æ¬¡åŒ–æ¶ˆæ¯æŸ¥æ‰¾

```java
// çˆ¶å­MessageSourceé…ç½®
@Configuration
public class MessageConfig {
    @Bean
    public MessageSource messageSource() {
        ReloadableResourceBundleMessageSource messageSource = 
            new ReloadableResourceBundleMessageSource();
        messageSource.setBasename("classpath:messages/app");
        
        // è®¾ç½®çˆ¶MessageSource
        ResourceBundleMessageSource parentSource = new ResourceBundleMessageSource();
        parentSource.setBasename("messages/common");
        messageSource.setParentMessageSource(parentSource);
        
        return messageSource;
    }
}
```

#### 4.2 èµ„æºåŠ è½½åŠŸèƒ½

##### 4.2.1 å¤šæ ¼å¼æ”¯æŒ

```java
// Propertiesæ ¼å¼ (messages.properties)
welcome.message=Welcome to our application!
user.greeting=Hello, {0}!

// XMLæ ¼å¼ (messages.xml)
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE properties SYSTEM "http://java.sun.com/dtd/properties.dtd">
<properties>
    <entry key="welcome.message">Welcome to our application!</entry>
    <entry key="user.greeting">Hello, {0}!</entry>
</properties>
```

##### 4.2.2 ç¼–ç å¤„ç†

```java
@Bean
public MessageSource messageSource() {
    ReloadableResourceBundleMessageSource messageSource = 
        new ReloadableResourceBundleMessageSource();
    messageSource.setBasename("classpath:messages/app");
    messageSource.setDefaultEncoding("UTF-8");
    
    // è®¾ç½®ç‰¹å®šæ–‡ä»¶çš„ç¼–ç 
    Properties fileEncodings = new Properties();
    fileEncodings.setProperty("messages/app_zh_CN", "GBK");
    messageSource.setFileEncodings(fileEncodings);
    
    return messageSource;
}
```

#### 4.3 Spring é›†æˆåŠŸèƒ½

##### 4.3.1 Web MVC é›†æˆ

```java
@Controller
public class HomeController {
    @Autowired
    private MessageSource messageSource;
    
    @GetMapping("/welcome")
    public String welcome(Model model, Locale locale) {
        String message = messageSource.getMessage("welcome.message", null, locale);
        model.addAttribute("message", message);
        return "welcome";
    }
}

// åœ¨JSPä¸­ä½¿ç”¨
<spring:message code="welcome.message" />
<spring:message code="user.greeting" arguments="${username}" />
```

##### 4.3.2 éªŒè¯æ¡†æ¶é›†æˆ

```java
@Configuration
public class ValidationConfig {
    @Bean
    public LocalValidatorFactoryBean validator(MessageSource messageSource) {
        LocalValidatorFactoryBean validator = new LocalValidatorFactoryBean();
        validator.setValidationMessageSource(messageSource);
        return validator;
    }
}

// éªŒè¯æ¶ˆæ¯é…ç½® (ValidationMessages.properties)
javax.validation.constraints.NotNull.message=Field cannot be null
javax.validation.constraints.Size.message=Size must be between {min} and {max}
```

### 5. å­˜åœ¨çš„ç¼ºé™·å’Œä¸è¶³

#### 5.1 æ€§èƒ½é—®é¢˜

##### 5.1.1 ResourceBundle æ€§èƒ½ç“¶é¢ˆ

```java
// é—®é¢˜ä»£ç ç¤ºä¾‹
public class ResourceBundleMessageSource {
    protected MessageFormat resolveCode(String code, Locale locale) {
        // æ¯æ¬¡éƒ½å¯èƒ½è§¦å‘ResourceBundle.getBundle()è°ƒç”¨
        ResourceBundle bundle = ResourceBundle.getBundle(basename, locale, bundleClassLoader);
        // é—®é¢˜ï¼š
        // 1. é¢‘ç¹çš„ç±»åŠ è½½å™¨æŸ¥æ‰¾
        // 2. æ–‡ä»¶ç³»ç»Ÿè®¿é—®å¼€é”€
        // 3. Propertiesæ–‡ä»¶è§£æå¼€é”€
        if (bundle != null) {
            try {
                MessageFormat messageFormat = createMessageFormat(bundle.getString(code), locale);
                return messageFormat;
            } catch (MissingResourceException ex) {
                // å¼‚å¸¸å¤„ç†ä¹Ÿæœ‰æ€§èƒ½å¼€é”€
            }
        }
        return null;
    }
}
```

**æ€§èƒ½é—®é¢˜åˆ†æï¼š**

- **é‡å¤åŠ è½½**ï¼šç›¸åŒçš„ResourceBundleå¯èƒ½è¢«é‡å¤åŠ è½½
- **åŒæ­¥å¼€é”€**ï¼šResourceBundle.getBundle()æ–¹æ³•å†…éƒ¨ä½¿ç”¨åŒæ­¥æœºåˆ¶
- **å†…å­˜å ç”¨**ï¼šå¤§é‡MessageFormatå®ä¾‹å ç”¨å†…å­˜
- **GCå‹åŠ›**ï¼šé¢‘ç¹åˆ›å»ºä¸´æ—¶å¯¹è±¡å¢åŠ GCå‹åŠ›

##### 5.1.2 MessageFormat åˆ›å»ºå¼€é”€

```java
// æ€§èƒ½ç“¶é¢ˆä»£ç 
protected MessageFormat createMessageFormat(String msg, Locale locale) {
    try {
        // é—®é¢˜ï¼šæ¯æ¬¡éƒ½åˆ›å»ºæ–°çš„MessageFormatå®ä¾‹
        return new MessageFormat(msg, locale);
    } catch (IllegalArgumentException ex) {
        // å¼‚å¸¸å¤„ç†å¼€é”€
        throw new IllegalArgumentException("Invalid message format: " + ex.getMessage());
    }
}
```

#### 5.2 åŠŸèƒ½é™åˆ¶

##### 5.2.1 èµ„æºæ ¼å¼é™åˆ¶

```properties
# Propertiesæ ¼å¼çš„å±€é™æ€§
# 1. åªæ”¯æŒkey-valueæ ¼å¼ï¼Œä¸æ”¯æŒåµŒå¥—ç»“æ„
user.profile.name=Name
user.profile.email=Email
user.profile.address.street=Street
user.profile.address.city=City

# 2. Unicodeç¼–ç é—®é¢˜
welcome.chinese=\u6b22\u8fce  # éœ€è¦è½¬ä¹‰ä¸­æ–‡å­—ç¬¦

# 3. æ³¨é‡ŠåŠŸèƒ½æœ‰é™
# This is a comment - åªæ”¯æŒè¡Œæ³¨é‡Š
user.message=Hello World
```

**å¯¹æ¯”ç°ä»£æ ¼å¼çš„ä¼˜åŠ¿ï¼š**

```json
// JSONæ ¼å¼ - æ”¯æŒåµŒå¥—ç»“æ„
{
  "user": {
    "profile": {
      "name": "Name",
      "email": "Email",
      "address": {
        "street": "Street",
        "city": "City"
      }
    }
  },
  "welcome": {
    "chinese": "æ¬¢è¿"  // ç›´æ¥æ”¯æŒUnicode
  }
}
```

##### 5.2.2 åŠ¨æ€æ›´æ–°é™åˆ¶

```java
// ResourceBundleMessageSourceçš„é™åˆ¶
public class ResourceBundleMessageSource {
    // é—®é¢˜ï¼šç¼“å­˜æ— æ³•åŠ¨æ€æ¸…ç†
    private final Map<String, Map<Locale, ResourceBundle>> cachedResourceBundles = 
        new ConcurrentHashMap<>();
    
    // æ²¡æœ‰æä¾›æ¸…ç†ç¼“å­˜çš„æ–¹æ³•
    // èµ„æºæ–‡ä»¶æ›´æ–°åå¿…é¡»é‡å¯åº”ç”¨
}

// ReloadableResourceBundleMessageSourceçš„é™åˆ¶
public class ReloadableResourceBundleMessageSource {
    // é—®é¢˜ï¼šåªæ”¯æŒåŸºäºæ—¶é—´æˆ³çš„é‡è½½æ£€æŸ¥
    protected boolean isRefreshTimestamp(PropertiesHolder propHolder) {
        return (propHolder.getRefreshTimestamp() < 0 ||
                propHolder.getRefreshTimestamp() > System.currentTimeMillis() - getCacheMillis());
    }
    
    // é™åˆ¶ï¼š
    // 1. æ— æ³•æ„ŸçŸ¥æ–‡ä»¶å†…å®¹å˜åŒ–ï¼Œåªèƒ½å®šæ—¶æ£€æŸ¥
    // 2. åœ¨é›†ç¾¤ç¯å¢ƒä¸‹æ— æ³•åŒæ­¥æ›´æ–°
    // 3. é‡è½½ç²’åº¦ç²—ç³™ï¼Œæ•´ä¸ªæ–‡ä»¶é‡æ–°åŠ è½½
}
```

#### 5.3 æ‰©å±•æ€§é—®é¢˜

##### 5.3.1 æ•°æ®æºå•ä¸€åŒ–

```java
// å½“å‰å®ç°åªæ”¯æŒæ–‡ä»¶ç³»ç»Ÿæ•°æ®æº
public abstract class AbstractResourceBasedMessageSource {
    private Set<String> basenameSet = new LinkedHashSet<>(4);
    
    // é™åˆ¶ï¼šåªèƒ½ä»æ–‡ä»¶ç³»ç»ŸåŠ è½½èµ„æº
    public void setBasenames(String... basenames) {
        this.basenameSet.clear();
        addBasenames(basenames);
    }
    
    // é—®é¢˜ï¼šæ— æ³•æ”¯æŒæ•°æ®åº“ã€Redisã€HTTP APIç­‰æ•°æ®æº
}
```

**æ‰©å±•éœ€æ±‚ç¤ºä¾‹ï¼š**

```java
// ç†æƒ³çš„æ‰©å±•æ¥å£
public interface MessageSourceProvider {
    Map<String, String> loadMessages(Locale locale);
    void saveMessage(String key, String value, Locale locale);
    boolean supportsHotReload();
    void addChangeListener(MessageChangeListener listener);
}

// æ•°æ®åº“å®ç°
public class DatabaseMessageSourceProvider implements MessageSourceProvider {
    @Autowired
    private JdbcTemplate jdbcTemplate;
    
    @Override
    public Map<String, String> loadMessages(Locale locale) {
        return jdbcTemplate.query(
            "SELECT message_key, message_value FROM i18n_messages WHERE locale = ?",
            new Object[]{locale.toString()},
            (rs, rowNum) -> Map.entry(rs.getString("message_key"), rs.getString("message_value"))
        ).stream().collect(Collectors.toMap(Map.Entry::getKey, Map.Entry::getValue));
    }
}
```

##### 5.3.2 ç¼“å­˜ç­–ç•¥å›ºåŒ–

```java
// å½“å‰ç¼“å­˜ç­–ç•¥ä¸å¤Ÿçµæ´»
public abstract class AbstractMessageSource {
    // é—®é¢˜ï¼šç¼“å­˜ç­–ç•¥ç¡¬ç¼–ç ï¼Œæ— æ³•é…ç½®
    private final Map<String, MessageFormat> messageFormatsPerMessage = 
        new ConcurrentHashMap<>();
    
    // é™åˆ¶ï¼š
    // 1. æ— æ³•é…ç½®ç¼“å­˜å¤§å°é™åˆ¶
    // 2. æ— æ³•é…ç½®è¿‡æœŸç­–ç•¥
    // 3. æ— æ³•é…ç½®ç¼“å­˜æ·˜æ±°ç®—æ³•
    // 4. æ— æ³•æ”¯æŒåˆ†å¸ƒå¼ç¼“å­˜
}
```

#### 5.4 å¼€å‘ä½“éªŒé—®é¢˜

##### 5.4.1 é…ç½®å¤æ‚æ€§

```xml
<!-- ä¼ ç»ŸXMLé…ç½®æ–¹å¼ç¹ç -->
<bean id="messageSource" 
      class="org.springframework.context.support.ReloadableResourceBundleMessageSource">
    <property name="basenames">
        <list>
            <value>classpath:messages/application</value>
            <value>classpath:messages/validation</value>
            <value>classpath:messages/security</value>
        </list>
    </property>
    <property name="defaultEncoding" value="UTF-8"/>
    <property name="cacheSeconds" value="300"/>
    <property name="fallbackToSystemLocale" value="false"/>
    <property name="fileEncodings">
        <props>
            <prop key="messages/application_zh_CN">GBK</prop>
        </props>
    </property>
</bean>

<!-- LocaleResolveré…ç½® -->
<bean id="localeResolver" 
      class="org.springframework.web.servlet.i18n.SessionLocaleResolver">
    <property name="defaultLocale" value="en"/>
</bean>

<!-- LocaleChangeInterceptoré…ç½® -->
<mvc:interceptors>
    <bean class="org.springframework.web.servlet.i18n.LocaleChangeInterceptor">
        <property name="paramName" value="lang"/>
    </bean>
</mvc:interceptors>
```

##### 5.4.2 è°ƒè¯•å›°éš¾

```java
// é—®é¢˜ï¼šé”™è¯¯ä¿¡æ¯ä¸å¤Ÿè¯¦ç»†
public String getMessage(String code, Object[] args, Locale locale) 
    throws NoSuchMessageException {
    
    MessageFormat format = resolveCode(code, locale);
    if (format != null) {
        return formatMessage(format, args, locale);
    }
    
    // é—®é¢˜ï¼šå¼‚å¸¸ä¿¡æ¯ä¸å¤Ÿè¯¦ç»†ï¼Œéš¾ä»¥å®šä½é—®é¢˜
    throw new NoSuchMessageException(code, locale);
}

// å®é™…å¼€å‘ä¸­é‡åˆ°çš„é—®é¢˜ï¼š
// 1. ä¸çŸ¥é“æ¶ˆæ¯æ˜¯ä»å“ªä¸ªæ–‡ä»¶åŠ è½½çš„
// 2. ä¸çŸ¥é“æ˜¯å¦æœ‰çˆ¶MessageSourceå‚ä¸æŸ¥æ‰¾
// 3. å‚æ•°æ ¼å¼åŒ–å¤±è´¥æ—¶é”™è¯¯ä¿¡æ¯ä¸æ˜ç¡®
// 4. ç¼ºä¹è°ƒè¯•å·¥å…·æ¥æŸ¥çœ‹å½“å‰åŠ è½½çš„æ‰€æœ‰æ¶ˆæ¯
```

##### 5.4.3 æµ‹è¯•æ”¯æŒä¸è¶³

```java
// å½“å‰æµ‹è¯•æ–¹å¼æ¯”è¾ƒåŸå§‹
@Test
public void testMessageSource() {
    MessageSource messageSource = new StaticMessageSource();
    ((StaticMessageSource) messageSource).addMessage("test.message", Locale.ENGLISH, "Test Message");
    
    String message = messageSource.getMessage("test.message", null, Locale.ENGLISH);
    assertEquals("Test Message", message);
    
    // é—®é¢˜ï¼š
    // 1. éœ€è¦æ‰‹åŠ¨åˆ›å»ºMessageSource
    // 2. æ— æ³•æ¨¡æ‹Ÿå¤æ‚çš„èµ„æºåŠ è½½åœºæ™¯
    // 3. ç¼ºä¹ä¸“é—¨çš„æµ‹è¯•å·¥å…·ç±»
    // 4. éš¾ä»¥æµ‹è¯•çƒ­é‡è½½åŠŸèƒ½
}
```

### 6. å¯ä»¥ä¼˜åŒ–æ”¹è¿›çš„åœ°æ–¹

#### 6.1 æ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆ

##### 6.1.1 æ™ºèƒ½ç¼“å­˜ç­–ç•¥

```java
// æ”¹è¿›çš„å¤šçº§ç¼“å­˜æ¶æ„
public class EnhancedMessageSource implements MessageSource {
    // L1ç¼“å­˜ï¼šæœ¬åœ°é«˜é€Ÿç¼“å­˜
    private final Cache<String, String> localCache = Caffeine.newBuilder()
        .maximumSize(10000)
        .expireAfterWrite(Duration.ofMinutes(30))
        .recordStats()
        .build();
    
    // L2ç¼“å­˜ï¼šåˆ†å¸ƒå¼ç¼“å­˜
    @Autowired
    private RedisTemplate<String, String> redisTemplate;
    
    // ç¼“å­˜é¢„çƒ­
    @PostConstruct
    public void preloadCache() {
        CompletableFuture.runAsync(() -> {
            Set<Locale> supportedLocales = getSupportedLocales();
            Set<String> commonKeys = getCommonMessageKeys();
            
            for (Locale locale : supportedLocales) {
                for (String key : commonKeys) {
                    try {
                        getMessage(key, null, locale);
                    } catch (Exception e) {
                        // å¿½ç•¥é¢„åŠ è½½å¤±è´¥çš„æ¶ˆæ¯
                    }
                }
            }
        });
    }
    
    // æ‰¹é‡æ¶ˆæ¯è·å–
    public Map<String, String> getMessages(Set<String> codes, Locale locale) {
        Map<String, String> result = new HashMap<>();
        Set<String> missedKeys = new HashSet<>();
        
        // å…ˆä»L1ç¼“å­˜è·å–
        for (String code : codes) {
            String cacheKey = buildCacheKey(code, locale);
            String message = localCache.getIfPresent(cacheKey);
            if (message != null) {
                result.put(code, message);
            } else {
                missedKeys.add(code);
            }
        }
        
        // ä»L2ç¼“å­˜æ‰¹é‡è·å–
        if (!missedKeys.isEmpty()) {
            List<String> cacheKeys = missedKeys.stream()
                .map(key -> buildCacheKey(key, locale))
                .collect(Collectors.toList());
            
            List<String> cachedMessages = redisTemplate.opsForValue().multiGet(cacheKeys);
            // å¤„ç†L2ç¼“å­˜ç»“æœ...
        }
        
        return result;
    }
}
```

##### 6.1.2 å¼‚æ­¥åŠ è½½ä¼˜åŒ–

```java
// å¼‚æ­¥æ¶ˆæ¯åŠ è½½
@Component
public class AsyncMessageLoader {
    @Autowired
    private TaskExecutor taskExecutor;
    
    @EventListener
    public void onApplicationReady(ApplicationReadyEvent event) {
        // åº”ç”¨å¯åŠ¨åå¼‚æ­¥é¢„åŠ è½½æ¶ˆæ¯
        taskExecutor.execute(this::preloadMessages);
    }
    
    private void preloadMessages() {
        // é¢„åŠ è½½å¸¸ç”¨æ¶ˆæ¯åˆ°ç¼“å­˜
        Set<String> commonKeys = Arrays.asList(
            "common.save", "common.cancel", "common.confirm",
            "error.validation", "error.network", "error.system"
        );
        
        for (Locale locale : getSupportedLocales()) {
            loadMessagesAsync(commonKeys, locale);
        }
    }
    
    @Async
    public CompletableFuture<Map<String, String>> loadMessagesAsync(
            Set<String> keys, Locale locale) {
        return CompletableFuture.supplyAsync(() -> {
            return keys.stream()
                .collect(Collectors.toMap(
                    key -> key,
                    key -> loadMessage(key, locale)
                ));
        });
    }
}
```

#### 6.2 åŠŸèƒ½å¢å¼ºæ–¹æ¡ˆ

##### 6.2.1 ç°ä»£åŒ–é…ç½®æ ¼å¼æ”¯æŒ

```java
// æ”¯æŒå¤šç§ç°ä»£é…ç½®æ ¼å¼
@Configuration
public class ModernI18nConfig {
    
    @Bean
    public MessageSource messageSource() {
        return MultiFormatMessageSourceBuilder.create()
            .addJsonResource("classpath:i18n/messages.json")
            .addYamlResource("classpath:i18n/messages.yml")
            .addPropertiesResource("classpath:i18n/messages.properties")
            .setDefaultLocale(Locale.ENGLISH)
            .setSupportedLocales(Locale.ENGLISH, Locale.SIMPLIFIED_CHINESE)
            .enableHotReload(Duration.ofMinutes(5))
            .enableCache(CacheConfig.builder()
                .maxSize(10000)
                .expireAfterWrite(Duration.ofHours(1))
                .build())
            .build();
    }
}

// JSONæ ¼å¼æ¶ˆæ¯æ–‡ä»¶
{
  "common": {
    "buttons": {
      "save": "Save",
      "cancel": "Cancel",
      "confirm": "Confirm"
    },
    "messages": {
      "success": "Operation completed successfully",
      "error": "An error occurred: {0}"
    }
  },
  "user": {
    "profile": {
      "title": "User Profile",
      "fields": {
        "name": "Name",
        "email": "Email"
      }
    }
  }
}

// YAMLæ ¼å¼æ¶ˆæ¯æ–‡ä»¶
common:
  buttons:
    save: Save
    cancel: Cancel
    confirm: Confirm
  messages:
    success: Operation completed successfully
    error: "An error occurred: {0}"
user:
  profile:
    title: User Profile
    fields:
      name: Name
      email: Email
```

##### 6.2.2 å¤šæ•°æ®æºæ”¯æŒ

```java
// å¯æ’æ‹”çš„æ•°æ®æºæä¾›è€…
public interface MessageSourceProvider {
    String getName();
    Map<String, String> loadMessages(Locale locale);
    void saveMessage(String key, String value, Locale locale);
    boolean supportsHotReload();
    void addChangeListener(MessageChangeListener listener);
    int getPriority(); // æ•°æ®æºä¼˜å…ˆçº§
}

// æ•°æ®åº“æ•°æ®æºå®ç°
@Component
public class DatabaseMessageSourceProvider implements MessageSourceProvider {
    @Autowired
    private MessageRepository messageRepository;
    
    @Override
    public Map<String, String> loadMessages(Locale locale) {
        return messageRepository.findByLocale(locale.toString())
            .stream()
            .collect(Collectors.toMap(
                Message::getKey, 
                Message::getValue
            ));
    }
    
    @Override
    public void saveMessage(String key, String value, Locale locale) {
        Message message = messageRepository.findByKeyAndLocale(key, locale.toString())
            .orElse(new Message());
        message.setKey(key);
        message.setValue(value);
        message.setLocale(locale.toString());
        messageRepository.save(message);
        
        // é€šçŸ¥å˜æ›´
        notifyChange(key, value, locale);
    }
}

// HTTP APIæ•°æ®æºå®ç°
@Component
public class HttpApiMessageSourceProvider implements MessageSourceProvider {
    @Autowired
    private RestTemplate restTemplate;
    
    @Value("${i18n.api.base-url}")
    private String apiBaseUrl;
    
    @Override
    public Map<String, String> loadMessages(Locale locale) {
        String url = apiBaseUrl + "/messages?locale=" + locale.toString();
        ResponseEntity<Map<String, String>> response = 
            restTemplate.exchange(url, HttpMethod.GET, null, 
                new ParameterizedTypeReference<Map<String, String>>() {});
        return response.getBody();
    }
}

// ç»„åˆæ•°æ®æºç®¡ç†å™¨
@Component
public class CompositeMessageSourceManager {
    private final List<MessageSourceProvider> providers;
    
    public CompositeMessageSourceManager(List<MessageSourceProvider> providers) {
        // æŒ‰ä¼˜å…ˆçº§æ’åº
        this.providers = providers.stream()
            .sorted(Comparator.comparingInt(MessageSourceProvider::getPriority))
            .collect(Collectors.toList());
    }
    
    public String getMessage(String key, Locale locale) {
        for (MessageSourceProvider provider : providers) {
            Map<String, String> messages = provider.loadMessages(locale);
            if (messages.containsKey(key)) {
                return messages.get(key);
            }
        }
        return null;
    }
}
```

#### 6.3 å¼€å‘ä½“éªŒæ”¹è¿›

##### 6.3.1 æ³¨è§£é©±åŠ¨é…ç½®

```java
// ç®€åŒ–çš„æ³¨è§£é…ç½®
@EnableI18n
@I18nConfiguration(
    basenames = {"classpath:i18n/messages", "classpath:i18n/validation"},
    defaultLocale = "en",
    supportedLocales = {"en", "zh_CN", "ja"},
    cacheStrategy = CacheStrategy.MULTI_LEVEL,
    hotReload = @HotReload(enabled = true, checkInterval = "5m"),
    providers = {
        @DataSource(type = DataSourceType.PROPERTIES, location = "classpath:i18n/"),
        @DataSource(type = DataSourceType.DATABASE, table = "i18n_messages"),
        @DataSource(type = DataSourceType.HTTP_API, url = "${i18n.api.url}")
    }
)
@Configuration
public class I18nConfig {
    // è‡ªåŠ¨é…ç½®ï¼Œæ— éœ€æ‰‹åŠ¨åˆ›å»ºBean
}

// ç±»å‹å®‰å…¨çš„æ¶ˆæ¯é”®
@MessageKeys("classpath:i18n/messages")
public interface AppMessages {
    @MessageKey("common.save")
    String COMMON_SAVE = "common.save";
    
    @MessageKey("common.cancel")
    String COMMON_CANCEL = "common.cancel";
    
    @MessageKey("user.validation.email.invalid")
    String USER_EMAIL_INVALID = "user.validation.email.invalid";
}

// ä½¿ç”¨æ–¹å¼
@Service
public class UserService {
    @Autowired
    private MessageSource messageSource;
    
    public void validateUser(User user) {
        if (!isValidEmail(user.getEmail())) {
            String message = messageSource.getMessage(
                AppMessages.USER_EMAIL_INVALID, 
                null, 
                LocaleContextHolder.getLocale()
            );
            throw new ValidationException(message);
        }
    }
}
```

##### 6.3.2 å¼€å‘å·¥å…·æ”¯æŒ

```java
// æ¶ˆæ¯ç®¡ç†REST API
@RestController
@RequestMapping("/admin/i18n")
public class I18nManagementController {
    
    @Autowired
    private MessageSourceManager messageSourceManager;
    
    @GetMapping("/messages")
    public ResponseEntity<PageResult<MessageInfo>> getMessages(
            @RequestParam(required = false) String locale,
            @RequestParam(required = false) String key,
            @RequestParam(defaultValue = "0") int page,
            @RequestParam(defaultValue = "20") int size) {
        
        PageRequest pageRequest = PageRequest.of(page, size);
        Page<MessageInfo> messages = messageSourceManager.findMessages(locale, key, pageRequest);
        return ResponseEntity.ok(PageResult.of(messages));
    }
    
    @PostMapping("/messages")
    public ResponseEntity<Void> updateMessage(@RequestBody MessageUpdateRequest request) {
        messageSourceManager.updateMessage(
            request.getKey(), 
            request.getValue(), 
            Locale.forLanguageTag(request.getLocale())
        );
        return ResponseEntity.ok().build();
    }
    
    @DeleteMapping("/messages/{key}")
    public ResponseEntity<Void> deleteMessage(
            @PathVariable String key,
            @RequestParam String locale) {
        messageSourceManager.deleteMessage(key, Locale.forLanguageTag(locale));
        return ResponseEntity.ok().build();
    }
    
    @PostMapping("/cache/clear")
    public ResponseEntity<Void> clearCache() {
        messageSourceManager.clearCache();
        return ResponseEntity.ok().build();
    }
    
    @GetMapping("/statistics")
    public ResponseEntity<I18nStatistics> getStatistics() {
        I18nStatistics stats = messageSourceManager.getStatistics();
        return ResponseEntity.ok(stats);
    }
}

// Webç®¡ç†ç•Œé¢
@Controller
@RequestMapping("/admin/i18n/ui")
public class I18nManagementUIController {
    
    @GetMapping("/")
    public String index() {
        return "i18n/index";
    }
    
    @GetMapping("/editor")
    public String editor(@RequestParam String key, @RequestParam String locale, Model model) {
        MessageInfo message = messageSourceManager.getMessage(key, Locale.forLanguageTag(locale));
        model.addAttribute("message", message);
        return "i18n/editor";
    }
}
```

##### 6.3.3 IDEæ’ä»¶æ”¯æŒ

```java
// IDEæ’ä»¶æ¥å£å®šä¹‰
public interface I18nIDESupport {
    
    // éªŒè¯æ¶ˆæ¯é”®çš„å­˜åœ¨æ€§
    ValidationResult validateMessageKey(String key, Set<Locale> locales);
    
    // è‡ªåŠ¨å®Œæˆæ¶ˆæ¯é”®
    List<String> getMessageKeyCompletions(String prefix);
    
    // æŸ¥æ‰¾æ¶ˆæ¯é”®çš„ä½¿ç”¨ä½ç½®
    List<Usage> findMessageKeyUsages(String key);
    
    // ç”Ÿæˆç¼ºå¤±çš„æ¶ˆæ¯é”®
    void generateMissingKeys(Set<String> keys, Set<Locale> locales);
    
    // é‡æ„æ¶ˆæ¯é”®
    void refactorMessageKey(String oldKey, String newKey);
}

// æ¶ˆæ¯é”®éªŒè¯å™¨
@Component
public class MessageKeyValidator implements I18nIDESupport {
    
    @Override
    public ValidationResult validateMessageKey(String key, Set<Locale> locales) {
        ValidationResult result = new ValidationResult();
        
        for (Locale locale : locales) {
            try {
                String message = messageSource.getMessage(key, null, locale);
                if (message == null || message.equals(key)) {
                    result.addWarning("Message key '" + key + "' not found for locale " + locale);
                }
            } catch (NoSuchMessageException e) {
                result.addError("Message key '" + key + "' missing for locale " + locale);
            }
        }
        
        return result;
    }
    
    @Override
    public void generateMissingKeys(Set<String> keys, Set<Locale> locales) {
        for (String key : keys) {
            for (Locale locale : locales) {
                if (!messageExists(key, locale)) {
                    // ç”Ÿæˆé»˜è®¤æ¶ˆæ¯
                    String defaultMessage = generateDefaultMessage(key);
                    messageSourceManager.saveMessage(key, defaultMessage, locale);
                }
            }
        }
    }
}
```

#### 6.4 äº‘åŸç”Ÿå’Œå¾®æœåŠ¡æ”¯æŒ

##### 6.4.1 é…ç½®ä¸­å¿ƒé›†æˆ

```java
// ä¸Spring Cloud Configé›†æˆ
@Component
@RefreshScope
public class ConfigCenterMessageSource implements MessageSource {
    
    @Value("${i18n.config.enabled:true}")
    private boolean configEnabled;
    
    @Autowired
    private ConfigurableEnvironment environment;
    
    @EventListener
    public void onRefreshScopeRefreshed(RefreshScopeRefreshedEvent event) {
        if (configEnabled) {
            refreshMessages();
        }
    }
    
    private void refreshMessages() {
        // ä»é…ç½®ä¸­å¿ƒé‡æ–°åŠ è½½æ¶ˆæ¯
        for (Locale locale : getSupportedLocales()) {
            String prefix = "i18n.messages." + locale.toString() + ".";
            Map<String, Object> properties = environment.getSystemProperties();
            
            Map<String, String> messages = properties.entrySet().stream()
                .filter(entry -> entry.getKey().toString().startsWith(prefix))
                .collect(Collectors.toMap(
                    entry -> entry.getKey().toString().substring(prefix.length()),
                    entry -> entry.getValue().toString()
                ));
            
            updateMessages(locale, messages);
        }
    }
}

// Kubernetes ConfigMapé›†æˆ
@Component
public class KubernetesConfigMapMessageSource {
    
    @Autowired
    private KubernetesClient kubernetesClient;
    
    @Scheduled(fixedDelay = 30000) // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡
    public void watchConfigMapChanges() {
        try {
            ConfigMap configMap = kubernetesClient.configMaps()
                .inNamespace("default")
                .withName("i18n-messages")
                .get();
            
            if (configMap != null && hasChanged(configMap)) {
                reloadFromConfigMap(configMap);
            }
        } catch (Exception e) {
            log.error("Failed to watch ConfigMap changes", e);
        }
    }
}
```

##### 6.4.2 æœåŠ¡ç½‘æ ¼æ”¯æŒ

```java
// åˆ†å¸ƒå¼æ¶ˆæ¯æœåŠ¡
@FeignClient(name = "i18n-service", fallback = I18nServiceFallback.class)
public interface I18nServiceClient {
    
    @GetMapping("/api/v1/messages")
    Map<String, String> getMessages(
        @RequestParam String locale,
        @RequestParam(required = false) Set<String> keys
    );
    
    @GetMapping("/api/v1/messages/{key}")
    String getMessage(
        @PathVariable String key,
        @RequestParam String locale,
        @RequestParam(required = false) String defaultMessage
    );
    
    @PostMapping("/api/v1/messages")
    void updateMessage(@RequestBody MessageUpdateRequest request);
    
    @GetMapping("/api/v1/locales")
    Set<String> getSupportedLocales();
}

// é™çº§å¤„ç†
@Component
public class I18nServiceFallback implements I18nServiceClient {
    
    @Autowired
    private LocalMessageSource localMessageSource;
    
    @Override
    public Map<String, String> getMessages(String locale, Set<String> keys) {
        // é™çº§åˆ°æœ¬åœ°æ¶ˆæ¯æº
        return localMessageSource.getMessages(Locale.forLanguageTag(locale), keys);
    }
    
    @Override
    public String getMessage(String key, String locale, String defaultMessage) {
        try {
            return localMessageSource.getMessage(key, null, Locale.forLanguageTag(locale));
        } catch (NoSuchMessageException e) {
            return defaultMessage != null ? defaultMessage : key;
        }
    }
}

// æ¶ˆæ¯åŒæ­¥æœåŠ¡
@Service
public class MessageSyncService {
    
    @Autowired
    private I18nServiceClient i18nServiceClient;
    
    @Autowired
    private LocalMessageSource localMessageSource;
    
    @EventListener
    @Async
    public void onMessageChanged(MessageChangedEvent event) {
        // åŒæ­¥æ¶ˆæ¯å˜æ›´åˆ°å…¶ä»–æœåŠ¡å®ä¾‹
        try {
            i18nServiceClient.updateMessage(MessageUpdateRequest.builder()
                .key(event.getKey())
                .value(event.getValue())
                .locale(event.getLocale().toString())
                .build());
        } catch (Exception e) {
            log.error("Failed to sync message change", e);
            // å¯ä»¥è€ƒè™‘ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—è¿›è¡Œå¼‚æ­¥é‡è¯•
        }
    }
}
```

### 7. æ€»ç»“

Spring çš„å›½é™…åŒ–è®¾è®¡åœ¨ä¼ä¸šçº§åº”ç”¨ä¸­å‘æŒ¥äº†é‡è¦ä½œç”¨ï¼Œå…¶åŸºäºæ¥å£æŠ½è±¡çš„è®¾è®¡ç†å¿µã€å±‚æ¬¡åŒ–çš„æ¶ˆæ¯æŸ¥æ‰¾æœºåˆ¶ã€ä»¥åŠä¸Springç”Ÿæ€çš„æ·±åº¦é›†æˆéƒ½ä½“ç°äº†ä¼˜ç§€çš„æ¶æ„è®¾è®¡ã€‚ç„¶è€Œï¼Œéšç€æŠ€æœ¯å‘å±•å’Œåº”ç”¨åœºæ™¯çš„å˜åŒ–ï¼Œç°æœ‰å®ç°åœ¨æ€§èƒ½ã€åŠŸèƒ½ã€æ‰©å±•æ€§å’Œå¼€å‘ä½“éªŒç­‰æ–¹é¢éƒ½å­˜åœ¨æ”¹è¿›ç©ºé—´ã€‚

**ä¸»è¦ä¼˜åŠ¿ï¼š**

- æˆç†Ÿç¨³å®šçš„æ¶æ„è®¾è®¡
- è‰¯å¥½çš„Springç”Ÿæ€é›†æˆ
- æ”¯æŒå±‚æ¬¡åŒ–æ¶ˆæ¯æŸ¥æ‰¾
- æä¾›å¤šç§LocaleResolverç­–ç•¥

**ä¸»è¦ä¸è¶³ï¼š**

- æ€§èƒ½ç“¶é¢ˆï¼ˆç¼“å­˜ç­–ç•¥ã€MessageFormatåˆ›å»ºï¼‰
- åŠŸèƒ½é™åˆ¶ï¼ˆèµ„æºæ ¼å¼ã€æ•°æ®æºå•ä¸€ï¼‰
- æ‰©å±•æ€§é—®é¢˜ï¼ˆç¼“å­˜ç­–ç•¥å›ºåŒ–ã€æ•°æ®æºé™åˆ¶ï¼‰
- å¼€å‘ä½“éªŒï¼ˆé…ç½®å¤æ‚ã€è°ƒè¯•å›°éš¾ã€å·¥å‘å·¥å…·ç¼ºå°‘ï¼‰