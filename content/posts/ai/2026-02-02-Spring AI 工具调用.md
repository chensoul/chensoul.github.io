---
title: "Spring AI 工具调用"
date: 2026-02-02
slug: spring-ai-tool-calling
categories: ["ai"]
tags: ['spring-ai']
---

本文介绍如何在 Spring AI 中使用**工具调用（Tool Calling / Function Calling）**：让大模型在对话中按需调用你定义的 Java 方法（查员工、查请假、获取当前日期等），并根据工具返回结果生成回复。本文使用 **DeepSeek**（OpenAI 兼容 API），通过 **@Tool** 注解和 **ChatClient.defaultTools()** 实现员工与日期相关的工具调用。

<!--more-->

> **示例代码库**
>
> 您可以在 [GitHub 仓库](https://github.com/chensoul/spring-ai-samples/tree/main/09-tool-calling) 中找到本文的示例代码。

## 为什么需要工具调用

大模型只能基于训练数据和当前对话生成文本，无法直接查数据库、调接口、算日期。**工具调用** 的做法是：

1. **定义工具**：用 Java 方法实现「查员工」「查请假」「获取当前日期」等能力，并用 **@Tool** 注解标注，让 Spring AI 生成工具描述供模型使用。
2. **注册到 ChatClient**：通过 **defaultTools(...)** 把这些工具注册到对话客户端。
3. **模型决策**：用户提问时，模型根据问题决定是否调用工具、调用哪个工具、传什么参数；框架执行工具后把结果返回给模型，模型再生成最终回复。

这样，对话既能用自然语言，又能触发真实业务逻辑（查库、写库等），适合客服、内部助手、数据查询等场景。

本示例使用 **DeepSeek**（OpenAI 兼容 API），依赖 `spring-ai-starter-model-openai`，无需额外 Tool Calling 专用依赖。

## 项目结构概览

- **Application**：Spring Boot 入口。
- **ChatController**：`POST /api/chat`，接收用户输入，调用带工具的 ChatClient，返回模型回复。
- **EmployeeTools**：员工相关工具（查员工、查请假、申请请假），内部调用 **EmployeeService**。
- **DateTimeTools**：日期工具（获取当前日期）。
- **Employee** / **EmployeeService**：员工实体与内存模拟数据（emp1001、emp1002、emp1003 等）。

## 定义工具：@Tool

用 **@Tool** 注解标注方法，并写清 **description**，模型会根据描述决定何时调用以及传什么参数。方法参数名和类型会参与生成工具的 schema（如 `empId`、`date`）。

**员工工具示例**（EmployeeTools）：

```java
@Service
public class EmployeeTools {
    private final EmployeeService employeeService;

    @Tool(description = "Get employee details for a given employee id")
    public Employee getEmployee(String empId) {
        return employeeService.getEmployee(empId);
    }

    @Tool(description = "Find employees who are on leave for a given date in YYYY-MM-DD format")
    public List<Employee> findEmployeesOnLeave(LocalDate date) {
        return employeeService.findEmployeesOnLeave(date);
    }

    @Tool(description = "Apply leave for a given employee id and date in YYYY-MM-DD format")
    public void applyLeave(String empId, LocalDate date) {
        employeeService.applyLeave(empId, date);
    }
}
```

**日期工具示例**（DateTimeTools）：

```java
class DateTimeTools {
    @Tool(description = "Get the current date in the ISO-8601 format yyyy-MM-dd")
    String getCurrentDate() {
        return LocalDate.now().toString();
    }
}
```

- 参数类型如 **LocalDate**、**String** 会被序列化/反序列化，模型传入的字符串（如 `"2025-01-01"`）会转换为对应类型。
- **description** 中写清「做什么、参数含义、格式」（如 YYYY-MM-DD），有助于模型正确选择工具和填参。

## 注册工具并配置 ChatClient

在构造 **ChatClient** 时通过 **defaultTools(...)** 注册一个或多个工具类实例，并可配合 **defaultSystem(...)** 设定助手角色，让模型知道「只根据工具返回的数据回答」：

```java
@RestController
@RequestMapping("/")
class ChatController {
    private final ChatClient chatClient;

    ChatController(ChatClient.Builder builder, EmployeeTools employeeTools) {
        this.chatClient = builder
                .defaultSystem("""
                You are a helpful assistant for our company.
                You always respond based on the data you have from tools available to you.
                If you don't know the answer, you will respond with "I don't know".
                """)
                .defaultTools(employeeTools, new DateTimeTools())
                .defaultAdvisors(new SimpleLoggerAdvisor())
                .build();
    }

    @PostMapping("/api/chat")
    Output chat(@RequestBody @Valid Input input) {
        String response = chatClient.prompt(input.prompt()).call().content();
        return new Output(response);
    }

    record Input(@NotBlank String prompt) {}
    record Output(String content) {}
}
```

- **defaultTools(employeeTools, new DateTimeTools())**：注册员工工具和日期工具，模型在对话中可自动选择调用。
- **defaultSystem(...)**：设定系统提示，约束模型依据工具结果回答，不知道时说 "I don't know"。
- **defaultAdvisors(new SimpleLoggerAdvisor())**：可选，便于在日志中查看请求/响应与工具调用。

一次用户提问可能触发多轮「模型 → 调用工具 → 返回结果 → 模型再生成」；框架会处理好工具调用的往返，最终返回给接口的是模型的最后一轮文本回复。

## 配置

**application.properties** 示例（DeepSeek）：

```properties
spring.application.name=09-tool-calling

spring.ai.openai.base-url=https://api.deepseek.com
spring.ai.openai.api-key=${DEEPSEEK_API_KEY}
spring.ai.openai.chat.options.model=deepseek-reasoner
spring.ai.openai.chat.options.temperature=0.7

logging.level.org.springframework.ai.chat.client.advisor=DEBUG
```

运行前请设置环境变量 **DEEPSEEK_API_KEY**。

## 运行与验证

1. **设置 API Key**：
   ```bash
   export DEEPSEEK_API_KEY=<your-api-key>
   ```

2. **启动应用**：
   ```bash
   cd 09-tool-calling && mvn spring-boot:run
   ```

3. **调用对话接口**（模型会按需调用工具并基于结果回答）：
   ```bash
   # 获取当前日期（会调用 DateTimeTools.getCurrentDate）
   curl -s -X POST http://localhost:8080/api/chat \
     -H "Content-Type: application/json" \
     -d '{"prompt":"What is today'\''s date?"}'
   
   # 查询员工（会调用 EmployeeTools.getEmployee）
   curl -s -X POST http://localhost:8080/api/chat \
     -H "Content-Type: application/json" \
     -d '{"prompt":"Get details of employee id emp1002"}'
   
   # 查询某天请假员工（会调用 findEmployeesOnLeave）
   curl -s -X POST http://localhost:8080/api/chat \
     -H "Content-Type: application/json" \
     -d '{"prompt":"Which employees are on leave on 2025-01-01?"}'
   
   # 申请请假（会调用 applyLeave）
   curl -s -X POST http://localhost:8080/api/chat \
     -H "Content-Type: application/json" \
     -d '{"prompt":"Apply leave for employee id emp1001 on 2025-04-01"}'
   ```

## 小结

- **工具调用** = 用 **@Tool** 定义方法 + **ChatClient.defaultTools(...)** 注册 + 模型在对话中自动选择工具与参数，框架执行后把结果交回模型生成回复。
- **description** 要写清工具用途和参数格式（如日期 YYYY-MM-DD），便于模型正确调用。
- 本示例使用 **DeepSeek**（OpenAI 兼容 API），通过 **EmployeeTools**（查员工、查请假、申请请假）和 **DateTimeTools**（当前日期）演示 Spring AI Tool Calling 的完整流程；可将工具替换为你的业务逻辑（查库、调 API 等）即可扩展为实际应用。

