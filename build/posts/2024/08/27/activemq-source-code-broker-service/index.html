<!DOCTYPE html>
<html class="no-js" lang="zh-cn">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>ActiveMQ源码-BrokerService和PersistenceAdapter - Java、Spring、Spring Boot、MicroServices、Architecture、Kubernetes、DevOps</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	<meta property="og:title" content="ActiveMQ源码-BrokerService和PersistenceAdapter">
	<meta property="og:description" content="Java、Spring、Spring Boot、MicroServices、Architecture、Kubernetes、DevOps">
	<meta property="og:type" content="article">
	<meta property="og:url" content="https://blog.chensoul.cc/posts/2024/08/27/activemq-source-code-broker-service/">
	<meta property="og:site_name" content="ChenSoul Blog">
	<meta property="og:image" content="">
	
  <meta itemprop="name" content="ActiveMQ源码-BrokerService和PersistenceAdapter">
  <meta itemprop="description" content="activemq-broker 模块 test/java 目录下有个 IDERunner 类：">
  <meta itemprop="datePublished" content="2024-08-27T00:00:00+00:00">
  <meta itemprop="dateModified" content="2024-08-27T00:00:00+00:00">
  <meta itemprop="wordCount" content="1698">
  <meta itemprop="keywords" content="Javascript,Backend,Security,Tutorial">
	<meta name="twitter:card" content="summary_large_image">
	<meta name="twitter:title" content="ActiveMQ源码-BrokerService和PersistenceAdapter">
	<meta name="twitter:description" content="Java、Spring、Spring Boot、MicroServices、Architecture、Kubernetes、DevOps">
	<meta name="twitter:image" content="">

	<link rel="preconnect" href="//fonts.loli.net" crossorigin>
	<link rel="dns-prefetch" href="//fonts.loli.net">
	<link rel="stylesheet" href="https://fonts.loli.net/css?family=Open+Sans:400,400i,700">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" integrity="sha512-2SwdPD6INVrV/lHTZbO2nodKhrnDdJK9/kg2XD1r9uGqPo1cUbujc+IYdlYdEErWNu69gVcYgdxlmVmzTWnetw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
	<link rel="stylesheet" href="/css/style.css">

	<link rel="shortcut icon" href="/favicon.ico">
		
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo logo--mixed">
		<a class="logo__link" href="/" title="ChenSoul Blog" rel="home">
			<div class="logo__item logo__imagebox">
					<img class="logo__img" src="/logo.svg" loading="lazy" alt="Site logo" width="60" height="60">
				</div><div class="logo__item logo__text">
					<div class="logo__title">ChenSoul Blog</div>
					<div class="logo__tagline">Java、Spring、Spring Boot、MicroServices、Architecture、Kubernetes、DevOps</div>
				</div>
		</a>
	</div>
		
<nav class="menu">
	<button class="menu__btn" aria-haspopup="true" aria-expanded="false" tabindex="0">
		<span class="menu__btn-title" tabindex="-1">菜单</span>
	</button>
	<ul class="menu__list">
		<li class="menu__item">
			<a class="menu__link" href="/">
				
				<span class="menu__text">首页</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/categories/">
				
				<span class="menu__text">分类</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/tags/">
				
				<span class="menu__text">标签</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/index.xml">
				
				<span class="menu__text">订阅</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/about/">
				
				<span class="menu__text">关于</span>
				
			</a>
		</li>
	</ul>
</nav>

	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">ActiveMQ源码-BrokerService和PersistenceAdapter</h1>
			<div class="post__meta meta">
<div class="meta__item-datetime meta__item">
	<svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0a14 14 0 1 1 0 28 1 1 0 0 1 0-28m0 3a3 3 0 1 0 0 22 3 3 0 0 0 0-22m1 4h-2v8.4l6.8 4.4L22 18l-6-3.8z"/></svg><time class="meta__text" datetime="2024-08-27">2024-08-27</time></div><div class="meta__item-categories meta__item"><svg class="meta__icon icon icon-category" width="16" height="16" viewBox="0 0 16 16"><path d="m7 2 1 2h8v11H0V2z"/></svg><span class="meta__text"><a class="meta__link" href="/categories/java/" rel="category">Java</a>
	</span>
</div><div class="meta__item-tags meta__item"><svg class="meta__icon icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M4 0h8s2 0 4 2l15 15s2 2 0 4L21 31s-2 2-4 0L2 16s-2-2-2-4V3s0-3 4-3m3 10a3 3 0 0 0 0-6 3 3 0 0 0 0 6"/></svg><span class="meta__text"><a class="meta__link" href="/tags/javascript/" rel="tag">Javascript</a>, <a class="meta__link" href="/tags/backend/" rel="tag">Backend</a>, <a class="meta__link" href="/tags/security/" rel="tag">Security</a>, <a class="meta__link" href="/tags/tutorial/" rel="tag">Tutorial</a>
	</span>
</div>
</div>
		</header>
		
		<div class="content post__content clearfix">
			<p>activemq-broker 模块 test/java 目录下有个 IDERunner 类：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">IDERunner</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> TRANSPORT_TRACE <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span>(String<span style="color:#f92672">[]</span>args) <span style="color:#66d9ef">throws</span> Exception {
</span></span><span style="display:flex;"><span>        BrokerService brokerService <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> BrokerService();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//        brokerService.addConnector(</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//            &#34;tcp://0.0.0.0:61616?trace=&#34; + TRANSPORT_TRACE +</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//                &#34;&amp;transport.wireFormat.maxFrameSize=104857600&#34;);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        brokerService.<span style="color:#a6e22e">setPersistent</span>(<span style="color:#66d9ef">false</span>);
</span></span><span style="display:flex;"><span>        brokerService.<span style="color:#a6e22e">setUseJmx</span>(<span style="color:#66d9ef">false</span>);
</span></span><span style="display:flex;"><span>        brokerService.<span style="color:#a6e22e">setAdvisorySupport</span>(<span style="color:#66d9ef">false</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        brokerService.<span style="color:#a6e22e">start</span>();
</span></span><span style="display:flex;"><span>        brokerService.<span style="color:#a6e22e">waitUntilStopped</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>注释掉 brokerService 调用 addConnector 方法的三行代码，然后 debug 运行该类的 main 方法。</p>
<h2 id="brokerservice">BrokerService</h2>
<p>BrokerService 管理 ActiveMQ Broker 的生命周期。BrokerService 由许多传输连接器、网络连接器和一系列属性组成，这些属性可用于在延迟创建代理时对其进行配置。</p>
<p>BrokerService 类实现了 Service 接口。Service 接口是 ActiveMQ 组件的核心生命周期接口。如果有标准方法，最好将此接口注册到 Spring，以便它将启动/ 停止方法视为 <code>org.springframework.beans.factory.InitializingBean</code> 和 <code>org.springframework. beans.factory.DisposableBean</code> 的方法</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">Service</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">start</span>() <span style="color:#66d9ef">throws</span> Exception; 
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">stop</span>() <span style="color:#66d9ef">throws</span> Exception; 
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>BrokerService 类没有构造方法，有一个 static 代码块：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">static</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>        Boolean bouncyCastleNotAdded <span style="color:#f92672">=</span> Boolean.<span style="color:#a6e22e">getBoolean</span>(<span style="color:#e6db74">&#34;org.apache.activemq.broker.BouncyCastleNotAdded&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (bouncyCastleNotAdded <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">||</span> bouncyCastleNotAdded <span style="color:#f92672">==</span> <span style="color:#66d9ef">false</span>) {
</span></span><span style="display:flex;"><span>            ClassLoader loader <span style="color:#f92672">=</span> BrokerService.<span style="color:#a6e22e">class</span>.<span style="color:#a6e22e">getClassLoader</span>();
</span></span><span style="display:flex;"><span>            Class<span style="color:#f92672">&lt;?&gt;</span> clazz <span style="color:#f92672">=</span> loader.<span style="color:#a6e22e">loadClass</span>(<span style="color:#e6db74">&#34;org.bouncycastle.jce.provider.BouncyCastleProvider&#34;</span>);
</span></span><span style="display:flex;"><span>            Provider bouncycastle <span style="color:#f92672">=</span> (Provider) clazz.<span style="color:#a6e22e">getDeclaredConstructor</span>().<span style="color:#a6e22e">newInstance</span>();
</span></span><span style="display:flex;"><span>            Integer bouncyCastlePosition <span style="color:#f92672">=</span> Integer.<span style="color:#a6e22e">getInteger</span>(<span style="color:#e6db74">&#34;org.apache.activemq.broker.BouncyCastlePosition&#34;</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">int</span> ret;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (bouncyCastlePosition <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>                ret <span style="color:#f92672">=</span> Security.<span style="color:#a6e22e">insertProviderAt</span>(bouncycastle, bouncyCastlePosition);
</span></span><span style="display:flex;"><span>            } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                ret <span style="color:#f92672">=</span> Security.<span style="color:#a6e22e">addProvider</span>(bouncycastle);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            LOG.<span style="color:#a6e22e">info</span>(<span style="color:#e6db74">&#34;Loaded the Bouncy Castle security provider at position: {}&#34;</span>, ret);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">catch</span>(Throwable e) {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// No BouncyCastle found so we use the default Java Security Provider</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    String localHostName <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;localhost&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>        localHostName <span style="color:#f92672">=</span>  InetAddressUtil.<span style="color:#a6e22e">getLocalHostName</span>();
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">catch</span> (UnknownHostException e) {
</span></span><span style="display:flex;"><span>        LOG.<span style="color:#a6e22e">error</span>(<span style="color:#e6db74">&#34;Failed to resolve localhost&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    LOCAL_HOST_NAME <span style="color:#f92672">=</span> localHostName;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    String version <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>(InputStream in <span style="color:#f92672">=</span> BrokerService.<span style="color:#a6e22e">class</span>.<span style="color:#a6e22e">getResourceAsStream</span>(<span style="color:#e6db74">&#34;/org/apache/activemq/version.txt&#34;</span>)) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (in <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">try</span>(InputStreamReader isr <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> InputStreamReader(in);
</span></span><span style="display:flex;"><span>                BufferedReader reader <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> BufferedReader(isr)) {
</span></span><span style="display:flex;"><span>                version <span style="color:#f92672">=</span> reader.<span style="color:#a6e22e">readLine</span>();
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">catch</span> (IOException ie) {
</span></span><span style="display:flex;"><span>        LOG.<span style="color:#a6e22e">warn</span>(<span style="color:#e6db74">&#34;Error reading broker version&#34;</span>, ie);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    BROKER_VERSION <span style="color:#f92672">=</span> version;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>上面代码的主要逻辑：</p>
<ul>
<li>加载 Bouncy Castle security provider</li>
<li>获取当前主机的名称</li>
<li>从 /org/apache/activemq/version.txt 文件获取当前 activemq 版本</li>
</ul>
<p>BrokerService 实现了 Service 接口，程序启动入口方法为 start 方法，停止方法为 stop 方法。</p>
<p>start 方法：</p>
<ul>
<li>
<p>1、判断是否已经启动。用到了 stopped 和 started 两个变量。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">//private final AtomicBoolean started = new AtomicBoolean(false);</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//private final AtomicBoolean stopped = new AtomicBoolean(false);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (stopped.<span style="color:#a6e22e">get</span>() <span style="color:#f92672">||</span> <span style="color:#f92672">!</span>started.<span style="color:#a6e22e">compareAndSet</span>(<span style="color:#66d9ef">false</span>, <span style="color:#66d9ef">true</span>)) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// lets just ignore redundant start() calls</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// as its way too easy to not be completely sure if start() has been</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// called or not with the gazillion of different configuration</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// mechanisms</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// throw new IllegalStateException(&#34;Already started.&#34;);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
<li>
<p>2、初始化变量 startException、stopping、preShutdownHooksInvoked、startDate</p>
</li>
<li>
<p>3、将 brokerName （默认为 localhost）保存到 MDC 上下文中的 activemq.broker 中</p>
</li>
<li>
<p>4、 检查内存使用限制</p>
</li>
<li>
<p>5、检查 systemExitOnShutdown 和 useShutdownHook 不能同时为 true</p>
</li>
<li>
<p>6、处理 transportConnectorURIs、networkConnectorURIs、jmsBridgeConnectors 属性，用于调用 addConnector、addNetworkConnector、addJmsConnector 方法。</p>
</li>
<li>
<p>7、注册 JMX</p>
</li>
<li>
<p>8、使用 brokerName 将 当前 BrokerService 绑定到 BrokerRegistry</p>
</li>
<li>
<p>9、启动持久化适配器 PersistenceAdapter，可以设置是否异步启动</p>
</li>
<li>
<p>10、启动 Broker，可以设置是否异步启动</p>
</li>
<li>
<p>11、从 MDC 删除 activemq.broker</p>
</li>
</ul>
<p>调用链如下：</p>
<pre tabindex="0"><code>BrokerService
	BrokerRegistry
	PersistenceAdapter
	PListStore
	JobSchedulerStore
	Broker
	TransportConnector
		TransportServer
			TransportConnection
				Transport
	NetworkConnector
	ProxyConnector
	JmsConnector
</code></pre><h2 id="brokerregistry">BrokerRegistry</h2>
<p>BrokerRegistry 是一个单例类，BrokerRegistry内部维护了一个 INSTANCE 实例，通过对 mutex 对象添加同步锁来确保 BrokerRegistry 类的线程安全。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> BrokerRegistry INSTANCE <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> BrokerRegistry();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> Object mutex <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Object();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> Map<span style="color:#f92672">&lt;</span>String, BrokerService<span style="color:#f92672">&gt;</span> brokers <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HashMap<span style="color:#f92672">&lt;</span>String, BrokerService<span style="color:#f92672">&gt;</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> BrokerRegistry <span style="color:#a6e22e">getInstance</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> INSTANCE;
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><p>查找方法：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> BrokerService <span style="color:#a6e22e">lookup</span>(String brokerName) {
</span></span><span style="display:flex;"><span>  BrokerService result <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">synchronized</span> (mutex) {
</span></span><span style="display:flex;"><span>      result <span style="color:#f92672">=</span> brokers.<span style="color:#a6e22e">get</span>(brokerName);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (result <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> brokerName <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> brokerName.<span style="color:#a6e22e">equals</span>(BrokerService.<span style="color:#a6e22e">DEFAULT_BROKER_NAME</span>)) {
</span></span><span style="display:flex;"><span>          result <span style="color:#f92672">=</span> findFirst();
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">if</span> (result <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>              LOG.<span style="color:#a6e22e">warn</span>(<span style="color:#e6db74">&#34;Broker localhost not started so using {} instead&#34;</span>, result.<span style="color:#a6e22e">getBrokerName</span>());
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (result <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> (brokerName<span style="color:#f92672">==</span><span style="color:#66d9ef">null</span> <span style="color:#f92672">||</span> brokerName.<span style="color:#a6e22e">isEmpty</span>() <span style="color:#f92672">||</span> brokerName.<span style="color:#a6e22e">equals</span>(<span style="color:#e6db74">&#34;null&#34;</span>))){
</span></span><span style="display:flex;"><span>          result <span style="color:#f92672">=</span> findFirst();
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> result;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> BrokerService <span style="color:#a6e22e">findFirst</span>() {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">synchronized</span> (mutex) {
</span></span><span style="display:flex;"><span>      Iterator<span style="color:#f92672">&lt;</span>BrokerService<span style="color:#f92672">&gt;</span> iter <span style="color:#f92672">=</span> brokers.<span style="color:#a6e22e">values</span>().<span style="color:#a6e22e">iterator</span>();
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">while</span> (iter.<span style="color:#a6e22e">hasNext</span>()) {
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">return</span> iter.<span style="color:#a6e22e">next</span>();
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>绑定和解绑方法：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">bind</span>(String brokerName, BrokerService broker) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">synchronized</span> (mutex) {
</span></span><span style="display:flex;"><span>      brokers.<span style="color:#a6e22e">put</span>(brokerName, broker);
</span></span><span style="display:flex;"><span>      mutex.<span style="color:#a6e22e">notifyAll</span>();
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">unbind</span>(String brokerName) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">synchronized</span> (mutex) {
</span></span><span style="display:flex;"><span>      brokers.<span style="color:#a6e22e">remove</span>(brokerName);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>注意：bind 方法中调用了 <code>mutex.notifyAll();</code> 方法用于唤醒其他想获取 mutex 锁的阻塞的线程。</p>
<h2 id="persistenceadapter">PersistenceAdapter</h2>
<p>为防止因系统崩溃而导致消息丢失，消息中间件一般会支持消息持久化便于服务重启后恢复原来的消息数据。</p>
<p>通常消息持久化的逻辑是：当生产者发送消息后，Broker 首先将消息存储到文件、内存或数据库等地方，然后再将消息发送给消费者，发送成功后将消息从存储中删除，若失败则继续尝试发送。Broker 在启动时会先检查指定位置的存储，若有发送失败的消息，则继续发送。</p>
<p>在 JMS 规范中对消息转发模式有两种：持久化(Persistent) 和 非持久化(Non_Persistent)。ActiveMQ 实现了 JSM 规范，即也支持这两种消息转发模式。</p>
<ul>
<li>
<p>持久化（PERSISTENT）</p>
<p>对于持久化消息，被发送到消息服务器后，会被持久化存储，如果当前没有消费者，则会继续存在，只有等到消息被处理并被消费确认后，才会被消息服务器删除。</p>
<p>该模式保证消息在被成功消费之前不会丢失。</p>
</li>
<li>
<p>非持久化（NON_PERSISTENT）</p>
<p>JMS 实现者必须保证尽最大努力分发消息，但消息不会持久化存储。非持久化消息通常用于发送通知或不重要的实时数据。</p>
<p>该模式消息保证最多只传递一次，不保证消息不丢失。若看重系统性能并且即使丢失一些消息也不会影响业务正常运行，可选择非持久化消息。</p>
</li>
</ul>
<p><code>PersistenceAdapter</code>接口是一个关键组件，用于定义数据持久化的行为</p>
<p>startPersistenceAdapter 方法：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">startPersistenceAdapter</span>(<span style="color:#66d9ef">boolean</span> async) <span style="color:#66d9ef">throws</span> Exception {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (async) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">new</span> Thread(<span style="color:#e6db74">&#34;Persistence Adapter Starting Thread&#34;</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span>() {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>                    doStartPersistenceAdapter();
</span></span><span style="display:flex;"><span>                } <span style="color:#66d9ef">catch</span> (Throwable e) {
</span></span><span style="display:flex;"><span>                    setStartException(e);
</span></span><span style="display:flex;"><span>                } <span style="color:#66d9ef">finally</span> {
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">synchronized</span> (persistenceAdapterStarted) {
</span></span><span style="display:flex;"><span>                        persistenceAdapterStarted.<span style="color:#a6e22e">set</span>(<span style="color:#66d9ef">true</span>);
</span></span><span style="display:flex;"><span>                        persistenceAdapterStarted.<span style="color:#a6e22e">notifyAll</span>();
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }.<span style="color:#a6e22e">start</span>();
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        doStartPersistenceAdapter();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>如果传入参数 async 为 true，则启动一个线程进行异步操作（使用 persistenceAdapterStarted 保存状态）；否则为同步调用。</p>
<p>doStartPersistenceAdapter 方法：</p>
<ul>
<li>
<p>1、初始化 PersistenceAdapter 对象</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">synchronized</span> PersistenceAdapter <span style="color:#a6e22e">getPersistenceAdapter</span>() <span style="color:#66d9ef">throws</span> IOException {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (persistenceAdapter <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>hasStartException()) {
</span></span><span style="display:flex;"><span>        persistenceAdapter <span style="color:#f92672">=</span> createPersistenceAdapter();
</span></span><span style="display:flex;"><span>        configureService(persistenceAdapter);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">persistenceAdapter</span> <span style="color:#f92672">=</span> registerPersistenceAdapterMBean(persistenceAdapter);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> persistenceAdapter;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li>
<p>createPersistenceAdapter：创建 PersistenceAdapter</p>
<ul>
<li>如果开启持久化 persistent =true，则
<ul>
<li>PersistenceAdapterFactory 不为空，则调用 PersistenceAdapterFactory.createPersistenceAdapter() 方法</li>
<li>否则，通过反射初始化 KahaDBPersistenceAdapter 对象，并设置持久化目录为 <code>${org.apache.activemq.default.directory.prefix}/activemq-data/${brokerName}/KahaDB</code></li>
</ul>
</li>
<li>如果没有开启持久化，则返回 MemoryPersistenceAdapter</li>
</ul>
</li>
<li>
<p>configureService：配置 Service</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">configureService</span>(Object service) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (service <span style="color:#66d9ef">instanceof</span> BrokerServiceAware) {
</span></span><span style="display:flex;"><span>        BrokerServiceAware serviceAware <span style="color:#f92672">=</span> (BrokerServiceAware) service;
</span></span><span style="display:flex;"><span>        serviceAware.<span style="color:#a6e22e">setBrokerService</span>(<span style="color:#66d9ef">this</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
<li>
<p>registerPersistenceAdapterMBean：注册 JMX</p>
</li>
</ul>
</li>
<li>
<p>2、判断启动时是否删除所有消息</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (deleteAllMessagesOnStartup) {
</span></span><span style="display:flex;"><span>  LOG.<span style="color:#a6e22e">info</span>(<span style="color:#e6db74">&#34;Deleting all messages on startup because deleteAllMessagesOnStartup configuration has been provided&#34;</span>);
</span></span><span style="display:flex;"><span>  deleteAllMessages();
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">deleteAllMessages</span>() <span style="color:#66d9ef">throws</span> IOException {
</span></span><span style="display:flex;"><span>  getPersistenceAdapter().<span style="color:#a6e22e">deleteAllMessages</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
<li>
<p>3、启动 PersistenceAdapter</p>
</li>
<li>
<p>4、初始化 tempDataStore 即 PListStore</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">synchronized</span> PListStore <span style="color:#a6e22e">getTempDataStore</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (tempDataStore <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>hasStartException()) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>isPersistent()) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>            PersistenceAdapter pa <span style="color:#f92672">=</span> getPersistenceAdapter();
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span>( pa<span style="color:#f92672">!=</span><span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> pa <span style="color:#66d9ef">instanceof</span> PListStore) {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> (PListStore) pa;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">catch</span> (IOException e) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> RuntimeException(e);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>            String clazz <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;org.apache.activemq.store.kahadb.plist.PListStoreImpl&#34;</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">tempDataStore</span> <span style="color:#f92672">=</span> (PListStore) getClass().<span style="color:#a6e22e">getClassLoader</span>().<span style="color:#a6e22e">loadClass</span>(clazz).<span style="color:#a6e22e">getDeclaredConstructor</span>().<span style="color:#a6e22e">newInstance</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">tempDataStore</span>.<span style="color:#a6e22e">setDirectory</span>(getTmpDataDirectory());
</span></span><span style="display:flex;"><span>            configureService(tempDataStore);
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">catch</span> (ClassNotFoundException e) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> RuntimeException(<span style="color:#e6db74">&#34;Kahadb class PListStoreImpl not found. Add activemq-kahadb jar or set persistent to false on BrokerService.&#34;</span>, e);
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">catch</span> (Exception e) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> RuntimeException(e);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> tempDataStore;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
<li>
<p>5、启动 PListStore</p>
</li>
<li>
<p>6、初始化 JobSchedulerStore</p>
</li>
<li>
<p>7、启动  JobSchedulerStore</p>
</li>
</ul>
<p>PersistenceAdapter 接口的定义：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">PersistenceAdapter</span> <span style="color:#66d9ef">extends</span> Service {
</span></span><span style="display:flex;"><span>  Set<span style="color:#f92672">&lt;</span>ActiveMQDestination<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">getDestinations</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 创建 MessageStore</span>
</span></span><span style="display:flex;"><span>  MessageStore <span style="color:#a6e22e">createQueueMessageStore</span>(ActiveMQQueue destination) <span style="color:#66d9ef">throws</span> IOException;
</span></span><span style="display:flex;"><span>  TopicMessageStore <span style="color:#a6e22e">createTopicMessageStore</span>(ActiveMQTopic destination) <span style="color:#66d9ef">throws</span> IOException;
</span></span><span style="display:flex;"><span>  JobSchedulerStore <span style="color:#a6e22e">createJobSchedulerStore</span>() <span style="color:#66d9ef">throws</span> IOException, UnsupportedOperationException;
</span></span><span style="display:flex;"><span>  TransactionStore <span style="color:#a6e22e">createTransactionStore</span>() <span style="color:#66d9ef">throws</span> IOException;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 删除 MessageStore</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">removeQueueMessageStore</span>(ActiveMQQueue destination);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">removeTopicMessageStore</span>(ActiveMQTopic destination);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 事务</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">beginTransaction</span>(ConnectionContext context) <span style="color:#66d9ef">throws</span> IOException;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">commitTransaction</span>(ConnectionContext context) <span style="color:#66d9ef">throws</span> IOException;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">rollbackTransaction</span>(ConnectionContext context) <span style="color:#66d9ef">throws</span> IOException;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 删除消息</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">deleteAllMessages</span>() <span style="color:#66d9ef">throws</span> IOException;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setUsageManager</span>(SystemUsage usageManager);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setBrokerName</span>(String brokerName);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setDirectory</span>(File dir);
</span></span><span style="display:flex;"><span>  File <span style="color:#a6e22e">getDirectory</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">checkpoint</span>(<span style="color:#66d9ef">boolean</span> cleanup) <span style="color:#66d9ef">throws</span> IOException;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">long</span> <span style="color:#a6e22e">size</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">long</span> <span style="color:#a6e22e">getLastProducerSequenceId</span>(ProducerId id) <span style="color:#66d9ef">throws</span> IOException;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">long</span> <span style="color:#a6e22e">getLastMessageBrokerSequenceId</span>() <span style="color:#66d9ef">throws</span> IOException;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">allowIOResumption</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>PersistenceAdapter 实现类：</p>
<ul>
<li>MemoryPersistenceAdapter：基于内存的 PersistenceAdapter</li>
<li>KahaDBPersistenceAdapter：基于 KahaDB 的 PersistenceAdapter</li>
<li>MultiKahaDBPersistenceAdapter：基于多个 KahaDB 的 PersistenceAdapter</li>
<li>JDBCPersistenceAdapter：基于 JDBC 数据库的 PersistenceAdapter</li>
<li>TempKahaDBStore：临时的 KahaDB PersistenceAdapter</li>
</ul>
<h3 id="memorypersistenceadapter">MemoryPersistenceAdapter</h3>
<p>基于内存的 PersistenceAdapter 最简单，先了解 MemoryPersistenceAdapter 的实现。</p>
<p>JMS 规范中定义了两种模型：Queue 和 Topic。对应的，在 MemoryPersistenceAdapter 里面使用 Map 来保存 Queue 和 Topic。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>MemoryTransactionStore transactionStore;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ConcurrentMap<span style="color:#f92672">&lt;</span>ActiveMQDestination, TopicMessageStore<span style="color:#f92672">&gt;</span> topics <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ConcurrentHashMap<span style="color:#f92672">&lt;</span>ActiveMQDestination, TopicMessageStore<span style="color:#f92672">&gt;</span>();
</span></span><span style="display:flex;"><span>ConcurrentMap<span style="color:#f92672">&lt;</span>ActiveMQDestination, MessageStore<span style="color:#f92672">&gt;</span> queues <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ConcurrentHashMap<span style="color:#f92672">&lt;</span>ActiveMQDestination, MessageStore<span style="color:#f92672">&gt;</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">boolean</span> useExternalMessageReferences;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">protected</span> BrokerService brokerService;
</span></span></code></pre></div><p>topics 和 queues 的 key 是 ActiveMQDestination，值是 MessageStore。一个 destination 对应一个 Queue 或者 Topic，并对应一个 MessageStore。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">MessageStore</span> <span style="color:#66d9ef">extends</span> Service {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">addMessage</span>(ConnectionContext context, Message message) <span style="color:#66d9ef">throws</span> IOException;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">addMessage</span>(ConnectionContext context, Message message, <span style="color:#66d9ef">boolean</span> canOptimizeHint) <span style="color:#66d9ef">throws</span> IOException;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    ListenableFuture<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">asyncAddQueueMessage</span>(ConnectionContext context, Message message) <span style="color:#66d9ef">throws</span> IOException;
</span></span><span style="display:flex;"><span>    ListenableFuture<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">asyncAddQueueMessage</span>(ConnectionContext context, Message message, <span style="color:#66d9ef">boolean</span> canOptimizeHint) <span style="color:#66d9ef">throws</span> IOException;
</span></span><span style="display:flex;"><span>    ListenableFuture<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">asyncAddTopicMessage</span>(ConnectionContext context, Message message) <span style="color:#66d9ef">throws</span> IOException;
</span></span><span style="display:flex;"><span>    ListenableFuture<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">asyncAddTopicMessage</span>(ConnectionContext context, Message message, <span style="color:#66d9ef">boolean</span> canOptimizeHint) <span style="color:#66d9ef">throws</span> IOException;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Message <span style="color:#a6e22e">getMessage</span>(MessageId identity) <span style="color:#66d9ef">throws</span> IOException;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">removeMessage</span>(ConnectionContext context, MessageAck ack) <span style="color:#66d9ef">throws</span> IOException;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">removeAsyncMessage</span>(ConnectionContext context, MessageAck ack) <span style="color:#66d9ef">throws</span> IOException;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">removeAllMessages</span>(ConnectionContext context) <span style="color:#66d9ef">throws</span> IOException;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">recover</span>(MessageRecoveryListener container) <span style="color:#66d9ef">throws</span> Exception;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    ActiveMQDestination <span style="color:#a6e22e">getDestination</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setMemoryUsage</span>(MemoryUsage memoryUsage);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">getMessageCount</span>() <span style="color:#66d9ef">throws</span> IOException;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">long</span> <span style="color:#a6e22e">getMessageSize</span>() <span style="color:#66d9ef">throws</span> IOException;
</span></span><span style="display:flex;"><span>    MessageStoreStatistics <span style="color:#a6e22e">getMessageStoreStatistics</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">resetBatching</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">recoverNextMessages</span>(<span style="color:#66d9ef">int</span> maxReturned, MessageRecoveryListener listener) <span style="color:#66d9ef">throws</span> Exception;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">recoverNextMessages</span>(<span style="color:#66d9ef">int</span> offset, <span style="color:#66d9ef">int</span> maxReturned, MessageRecoveryListener listener) <span style="color:#66d9ef">throws</span> Exception;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">dispose</span>(ConnectionContext context);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setBatch</span>(MessageId messageId) <span style="color:#66d9ef">throws</span> Exception;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">isEmpty</span>() <span style="color:#66d9ef">throws</span> Exception;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setPrioritizedMessages</span>(<span style="color:#66d9ef">boolean</span> prioritizedMessages);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">isPrioritizedMessages</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">updateMessage</span>(Message message) <span style="color:#66d9ef">throws</span> IOException;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">registerIndexListener</span>(IndexListener indexListener);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>在内存模式下，MessageStore 的实现有 MemoryMessageStore 和 MemoryTopicMessageStore。</p>
<p>AbstractMessageStore 是一个抽象类，实现了 MessageStore 接口：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">abstract</span> <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AbstractMessageStore</span> <span style="color:#66d9ef">implements</span> MessageStore {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> ListenableFuture<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;</span> FUTURE;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">final</span> ActiveMQDestination destination;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">boolean</span> prioritizedMessages;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">protected</span> IndexListener indexListener;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">final</span> MessageStoreStatistics messageStoreStatistics <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> MessageStoreStatistics();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">AbstractMessageStore</span>(ActiveMQDestination destination) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">destination</span> <span style="color:#f92672">=</span> destination;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//...</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>通过构造方法，可以看到创建一个 MessageStore ，需要一个 ActiveMQDestination。AbstractMessageStore 内部还有一个 IndexListener 和 MessageStoreStatistics。IndexListener 是一个回调，作用是在消息索引更新时执行一些有序的工作。MessageStoreStatistics 用于记录和管理消息存储统计信息。</p>
<p>ActiveMQ 中统计相关的接口设计如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">Stats</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> Statistic <span style="color:#a6e22e">getStatistic</span>(String statisticName);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> String<span style="color:#f92672">[]</span> <span style="color:#a6e22e">getStatisticNames</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> Statistic<span style="color:#f92672">[]</span> <span style="color:#a6e22e">getStatistics</span>();
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">Statistic</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">getName</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">getUnit</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">getDescription</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">long</span> <span style="color:#a6e22e">getStartTime</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">long</span> <span style="color:#a6e22e">getLastSampleTime</span>();
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Statistic</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// StatisticImpl</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// CountStatisticImpl</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// SizeStatisticImpl</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Stats</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// StatsImpl</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// MessageStoreStatistics</span>
</span></span></code></pre></div><p>创建 Queue 和 Topic 时，需要事务支持，ActiveMQ 定义了 TransactionStore 接口：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">TransactionStore</span> <span style="color:#66d9ef">extends</span> Service {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">prepare</span>(TransactionId txid) <span style="color:#66d9ef">throws</span> IOException;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">commit</span>(TransactionId txid, <span style="color:#66d9ef">boolean</span> wasPrepared, Runnable preCommit,Runnable postCommit) <span style="color:#66d9ef">throws</span> IOException;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">rollback</span>(TransactionId txid) <span style="color:#66d9ef">throws</span> IOException;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">recover</span>(TransactionRecoveryListener listener) <span style="color:#66d9ef">throws</span> IOException;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>TransactionStore 是在 MessageStore 基础上添加事务的功能。MemoryPersistenceAdapter 类创建 MessageStore 时，会使用 TransactionStore 代理 MessageStore，例如 createQueueMessageStore 方法：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> MessageStore <span style="color:#a6e22e">createQueueMessageStore</span>(ActiveMQQueue destination) <span style="color:#66d9ef">throws</span> IOException {
</span></span><span style="display:flex;"><span>    MessageStore rc <span style="color:#f92672">=</span> queues.<span style="color:#a6e22e">get</span>(destination);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (rc <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>        rc <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> MemoryMessageStore(destination);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (transactionStore <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>            rc <span style="color:#f92672">=</span> transactionStore.<span style="color:#a6e22e">proxy</span>(rc);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        queues.<span style="color:#a6e22e">put</span>(destination, rc);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> rc;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>在内存模式下，TransactionStore 的实现有 MemoryTransactionStore。</p>
<p>MemoryPersistenceAdapter 创建 TransactionStore：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> TransactionStore <span style="color:#a6e22e">createTransactionStore</span>() <span style="color:#66d9ef">throws</span> IOException {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (transactionStore <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>        transactionStore <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> MemoryTransactionStore(<span style="color:#66d9ef">this</span>, brokerService);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> transactionStore;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>MemoryPersistenceAdapter 删除消息：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">deleteAllMessages</span>() <span style="color:#66d9ef">throws</span> IOException {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (Iterator<span style="color:#f92672">&lt;</span>TopicMessageStore<span style="color:#f92672">&gt;</span> iter <span style="color:#f92672">=</span> topics.<span style="color:#a6e22e">values</span>().<span style="color:#a6e22e">iterator</span>(); iter.<span style="color:#a6e22e">hasNext</span>();) {
</span></span><span style="display:flex;"><span>      MemoryMessageStore store <span style="color:#f92672">=</span> asMemoryMessageStore(iter.<span style="color:#a6e22e">next</span>());
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (store <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>          store.<span style="color:#a6e22e">delete</span>();
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (Iterator<span style="color:#f92672">&lt;</span>MessageStore<span style="color:#f92672">&gt;</span> iter <span style="color:#f92672">=</span> queues.<span style="color:#a6e22e">values</span>().<span style="color:#a6e22e">iterator</span>(); iter.<span style="color:#a6e22e">hasNext</span>();) {
</span></span><span style="display:flex;"><span>      MemoryMessageStore store <span style="color:#f92672">=</span> asMemoryMessageStore(iter.<span style="color:#a6e22e">next</span>());
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (store <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>          store.<span style="color:#a6e22e">delete</span>();
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (transactionStore <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>      transactionStore.<span style="color:#a6e22e">delete</span>();
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="memorymessagestore">MemoryMessageStore</h4>
<p>内存消息存储主要是存储所有的消息在 JVM 内存中，当重启JVM之后会丢失持久化的消息。</p>
<p>使用 MemoryMessageStore 条件是设置 <strong>persistent</strong> 为 false。</p>
<p>设置方法，第一种是设置 activemq.xml 文件：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#f92672">&lt;broker</span> <span style="color:#a6e22e">xmlns=</span><span style="color:#e6db74">&#34;http://activemq.apache.org/schema/core&#34;</span> <span style="color:#a6e22e">persistent=</span><span style="color:#e6db74">&#34;false&#34;</span> <span style="color:#a6e22e">brokerName=</span><span style="color:#e6db74">&#34;brokerName&#34;</span> <span style="color:#a6e22e">dataDirectory=</span><span style="color:#e6db74">&#34;${activemq.data}&#34;</span><span style="color:#f92672">&gt;</span>
</span></span></code></pre></div><p>第二种方法是通过 BrokerService 对象进行设置：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>  BrokerService brokerService <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> BrokerService();
</span></span><span style="display:flex;"><span>  brokerService.<span style="color:#a6e22e">setPersistent</span>(<span style="color:#66d9ef">false</span>);
</span></span><span style="display:flex;"><span>  brokerService.<span style="color:#a6e22e">setUseJmx</span>(<span style="color:#66d9ef">true</span>);
</span></span><span style="display:flex;"><span>  brokerService.<span style="color:#a6e22e">start</span>();
</span></span></code></pre></div><p>addMessage 方法：使用了两次 synchronized</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">synchronized</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">addMessage</span>(ConnectionContext context, Message message) <span style="color:#66d9ef">throws</span> IOException {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">synchronized</span> (messageTable) {
</span></span><span style="display:flex;"><span>        messageTable.<span style="color:#a6e22e">put</span>(message.<span style="color:#a6e22e">getMessageId</span>(), message);
</span></span><span style="display:flex;"><span>        incMessageStoreStatistics(getMessageStoreStatistics(), message);
</span></span><span style="display:flex;"><span>        message.<span style="color:#a6e22e">incrementReferenceCount</span>();
</span></span><span style="display:flex;"><span>        message.<span style="color:#a6e22e">getMessageId</span>().<span style="color:#a6e22e">setFutureOrSequenceLong</span>(sequenceId<span style="color:#f92672">++</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (indexListener <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>            indexListener.<span style="color:#a6e22e">onAdd</span>(<span style="color:#66d9ef">new</span> IndexListener.<span style="color:#a6e22e">MessageContext</span>(context, message, <span style="color:#66d9ef">null</span>));
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>removeMessage 方法：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">removeMessage</span>(MessageId msgId) <span style="color:#66d9ef">throws</span> IOException {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">synchronized</span> (messageTable) {
</span></span><span style="display:flex;"><span>        Message removed <span style="color:#f92672">=</span> messageTable.<span style="color:#a6e22e">remove</span>(msgId);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (removed <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>            removed.<span style="color:#a6e22e">decrementReferenceCount</span>();
</span></span><span style="display:flex;"><span>            decMessageStoreStatistics(getMessageStoreStatistics(), removed);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ((lastBatchId <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> lastBatchId.<span style="color:#a6e22e">equals</span>(msgId)) <span style="color:#f92672">||</span> messageTable.<span style="color:#a6e22e">isEmpty</span>()) {
</span></span><span style="display:flex;"><span>            lastBatchId <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>recover 方法：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">recover</span>(MessageRecoveryListener listener) <span style="color:#66d9ef">throws</span> Exception {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// the message table is a synchronizedMap - so just have to synchronize here</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">synchronized</span> (messageTable) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> (Message message : messageTable.<span style="color:#a6e22e">values</span>()) {
</span></span><span style="display:flex;"><span>            listener.<span style="color:#a6e22e">recoverMessage</span>(message);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>removeAllMessages 方法：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">removeAllMessages</span>(ConnectionContext context) <span style="color:#66d9ef">throws</span> IOException {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">synchronized</span> (messageTable) {
</span></span><span style="display:flex;"><span>        messageTable.<span style="color:#a6e22e">clear</span>();
</span></span><span style="display:flex;"><span>        getMessageStoreStatistics().<span style="color:#a6e22e">reset</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="memorytopicmessagestore">MemoryTopicMessageStore</h4>
<p><code>MemoryTopicMessageStore</code>是一个用于存储主题（Topic）消息的内存消息存储实现。</p>
<p>字段：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">private</span> Map<span style="color:#f92672">&lt;</span>SubscriptionKey, SubscriptionInfo<span style="color:#f92672">&gt;</span> subscriberDatabase;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">private</span> Map<span style="color:#f92672">&lt;</span>SubscriptionKey, MemoryTopicSub<span style="color:#f92672">&gt;</span> topicSubMap;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> Map<span style="color:#f92672">&lt;</span>MessageId, Message<span style="color:#f92672">&gt;</span> originalMessageTable;
</span></span></code></pre></div><ul>
<li>topicSubMap：保存主题订阅</li>
</ul>
<p>添加订阅：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">synchronized</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">addSubscription</span>(SubscriptionInfo info, <span style="color:#66d9ef">boolean</span> retroactive) <span style="color:#66d9ef">throws</span> IOException {
</span></span><span style="display:flex;"><span>    SubscriptionKey key <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> SubscriptionKey(info);
</span></span><span style="display:flex;"><span>    MemoryTopicSub sub <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> MemoryTopicSub(key);
</span></span><span style="display:flex;"><span>    topicSubMap.<span style="color:#a6e22e">put</span>(key, sub);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (retroactive) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> (Map.<span style="color:#a6e22e">Entry</span><span style="color:#f92672">&lt;</span>MessageId, Message<span style="color:#f92672">&gt;</span> entry : messageTable.<span style="color:#a6e22e">entrySet</span>()) {
</span></span><span style="display:flex;"><span>            sub.<span style="color:#a6e22e">addMessage</span>(entry.<span style="color:#a6e22e">getKey</span>(), entry.<span style="color:#a6e22e">getValue</span>());
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    subscriberDatabase.<span style="color:#a6e22e">put</span>(key, info);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>addMessage 方法：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">synchronized</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">addMessage</span>(ConnectionContext context, Message message) <span style="color:#66d9ef">throws</span> IOException {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">super</span>.<span style="color:#a6e22e">addMessage</span>(context, message);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (MemoryTopicSub sub : topicSubMap.<span style="color:#a6e22e">values</span>()) {
</span></span><span style="display:flex;"><span>        sub.<span style="color:#a6e22e">addMessage</span>(message.<span style="color:#a6e22e">getMessageId</span>(), message);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="memorytransactionstore">MemoryTransactionStore</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">protected</span> ConcurrentMap<span style="color:#f92672">&lt;</span>Object, Tx<span style="color:#f92672">&gt;</span> inflightTransactions <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ConcurrentHashMap<span style="color:#f92672">&lt;</span>Object, Tx<span style="color:#f92672">&gt;</span>();
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">protected</span> Map<span style="color:#f92672">&lt;</span>TransactionId, Tx<span style="color:#f92672">&gt;</span> preparedTransactions <span style="color:#f92672">=</span> Collections.<span style="color:#a6e22e">synchronizedMap</span>(<span style="color:#66d9ef">new</span> LinkedHashMap<span style="color:#f92672">&lt;</span>TransactionId, Tx<span style="color:#f92672">&gt;</span>());
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">final</span> PersistenceAdapter persistenceAdapter;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">final</span> BrokerService brokerService;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">boolean</span> doingRecover;
</span></span></code></pre></div><p>MemoryTransactionStore 类的 <code>proxy</code> 方法会对 MessageStore、TopicMessageStore 进行代理，例如代理 addMessage、removeMessage 方法，转而使用 MemoryTransactionStore 自己的 addMessage、removeMessage方法（如果开启了事务，则创建 Tx 对象，保存到 <code>List&lt;AddMessageCommand&gt; messages</code> 或者 <code>List&lt;RemoveMessageCommand&gt; acks</code>）。</p>
<h3 id="kahadbpersistenceadapter">KahaDBPersistenceAdapter</h3>
<p>KahaDB 是 ActiveMQ 框架的基于文件的持久性数据库。它位于使用它的消息代理的本地，已针对快速持久性进行了优化。它是自ActiveMQ Classic 5.4以来的默认存储机制。与其前身<a href="https://activemq.apache.org/components/classic/documentation/amq-message-store" target="_blank">AMQ 消息存储</a>相比，KahaDB 使用更少的文件描述符并提供更快的恢复速度。</p>
<p><img src="https://access.redhat.com/webassets/avalon/d/Red_Hat_AMQ-6.3-Tuning_Guide-en-US/images/e0a0cfdb72b20fd6a0e40b5767cec38c/persist_01.gif" alt="KahaDB Architecture"></p>

		</div>


	</article>
</main>
<footer class="post__footer">
	

<div class="post-related">
	<h3>相关文章</h3>
	<ul class="post-related-list">
		
		<li class="post-related-item">
			<a href="/posts/2024/06/05/oauth2/" target="_blank" title="RFC6749 | OAuth2.0授权框架中文版">RFC6749 | OAuth2.0授权框架中文版</a>
		</li>
		
		<li class="post-related-item">
			<a href="/posts/2024/06/05/oauth2-server/" target="_blank" title="[译]OAuth2.0服务器">[译]OAuth2.0服务器</a>
		</li>
		
		<li class="post-related-item">
			<a href="/posts/2024/06/05/oauth-2-simplified/" target="_blank" title="[译]OAuth2简化版">[译]OAuth2简化版</a>
		</li>
		
		<li class="post-related-item">
			<a href="/posts/2024/05/07/http/" target="_blank" title="[译]什么是 HTTP？">[译]什么是 HTTP？</a>
		</li>
		
		<li class="post-related-item">
			<a href="/posts/2024/05/07/oauth/" target="_blank" title="[译]什么是 OAuth？">[译]什么是 OAuth？</a>
		</li>
		
		<li class="post-related-item">
			<a href="/posts/2024/07/24/jms20/" target="_blank" title="[译]JMS 2.0 中的新增功能（第一部分）- 易于使用">[译]JMS 2.0 中的新增功能（第一部分）- 易于使用</a>
		</li>
		
	</ul>
</div>

</footer>

<footer class="post__footer">
	<footer class="post__footer">
		
<div class="post__tags tags clearfix">
	<svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M4 0h8s2 0 4 2l15 15s2 2 0 4L21 31s-2 2-4 0L2 16s-2-2-2-4V3s0-3 4-3m3 10a3 3 0 0 0 0-6 3 3 0 0 0 0 6"/></svg>
	<ul class="tags__list">
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/javascript/" rel="tag">javascript</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/backend/" rel="tag">backend</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/security/" rel="tag">security</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/tutorial/" rel="tag">tutorial</a>
		</li>
	</ul>
</div>
	</footer>
</footer>


<nav class="pagination flex">
	<div class="pagination__item pagination__item--prev">
		<a class="pagination__link" href="/posts/2024/08/27/thingsboard-code-source-compile/" rel="prev">
			<p class="pagination__title">«&thinsp;上一篇: ThingsBoard源码编译和Idea运行</p>
		</a>
	</div>
	<div class="pagination__item pagination__item--next">
		<a class="pagination__link" href="/posts/2024/10/14/testing-spring-boot-applications-best-practices-and-frameworks/" rel="next">
			<p class="pagination__title">&thinsp;» 下一篇: [译]测试 Spring Boot 应用程序：最佳实践和框架</p>
		</a>
	</div>
</nav>



<div class="authorbox clearfix">
	<figure class="authorbox__avatar">
		<img alt="ChenSoul avatar" src="/avatar.jpg" class="avatar" height="60" width="60" loading="lazy">
	</figure>
	<div class="authorbox__header">
		<span class="authorbox__name">关于 ChenSoul</span>
	</div>
	<div class="authorbox__description">
		一个来自中国武汉的开发者，主要撰写软件开发和开源方面的文章。浏览我的<a href="%28/posts%29">博客文章</a>，订阅我的 <a href="/index.xml">RSS</a> 源，或了解更多<a href="/about/">关于我</a>的信息。
	</div>
</div>




	<p><h3>欢迎留言！</h3></p>
<div id="remark42"></div>
<script>
	var remark_config = {
		host: 'https:\/\/comment.chensoul.cc',
		site_id: 'remark',
		components: ['embed'],
		url: 'https:\/\/blog.chensoul.cc\/posts\/2024\/08\/27\/activemq-source-code-broker-service\/',
		locale: 'zh'
	};

	!function(e, n) {
		for (var o = 0; o < e.length; o++) {
			var r = n.createElement('script'),
			c = '.js',
			d = n.head || n.body;
			'noModule' in r ? (r.type = 'module', c = '.mjs') : r.async = !0, r.defer = !0, r.src = remark_config.host + '/web/' + e[o] + c, d.appendChild(r)
		}
	}(remark_config.components || ['embed'], document);

</script>





			</div>
			

<aside class="sidebar sidebar--right">
	<div class="post__toc toc">
		<div class="toc__title">目录</div>
		<div class="toc__menu">
			<nav id="TableOfContents">
  <ul>
    <li><a href="#brokerservice">BrokerService</a></li>
    <li><a href="#brokerregistry">BrokerRegistry</a></li>
    <li><a href="#persistenceadapter">PersistenceAdapter</a>
      <ul>
        <li><a href="#memorypersistenceadapter">MemoryPersistenceAdapter</a></li>
        <li><a href="#kahadbpersistenceadapter">KahaDBPersistenceAdapter</a></li>
      </ul>
    </li>
  </ul>
</nav>
		</div>
	</div>
</aside>

		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
<div class="footer__links">
	<a class="footer__link" href="/">首页</a> | <a class="footer__link" href="/categories/">分类</a> | <a class="footer__link" href="/tags/">标签</a> | <a class="footer__link" href="/index.xml">订阅</a> | <a class="footer__link" href="/about/">关于</a>
</div>
		<div class="footer__copyright">
			&copy; 2025 ChenSoul.
			<span class="footer__copyright-credits">基于 <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> 引擎和 <a href="https://github.com/chensoul/rose-hugo/" rel="nofollow noopener" target="_blank">Rose Hugo</a> 主题</span>
		</div>
	</div>

	






<style>
	.scroll-up a {
		display: block;
		height: 3.125rem;
		width: 3.125rem;
		text-align: center;
		line-height: 2.7;
		border-radius: 50px;
		font-size: 1.125rem;
		color: #fff;
		opacity: 1;
		transition: all 0.3s ease 0s;
		box-shadow: 0 0 10px rgb(0 0 0 / 20%);
	}
	.scroll-up a {
		background: #ee591f;
	}
	.scroll-up {
		position: fixed;
		display: none;
		bottom: 50px;
		z-index: 999;
	}
	.scroll-up.right {
		right: 60px;
	}
</style>

<div class="scroll-up custom right" style="display: block;"><a href="#top" id="top-link" accesskey="g"><i
	class="fa fa-arrow-up"></i></a></div>

<script>
	var mybutton = document.getElementById("top-link");
	window.onscroll = function () {
		if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
			mybutton.style.visibility = "visible";
			mybutton.style.opacity = "1";
		} else {
			mybutton.style.visibility = "hidden";
			mybutton.style.opacity = "0";
		}
	};
</script>


    <script defer src="https://umami.chensoul.cc/random-string.js" data-website-id="1e07d36d-bec3-4ba6-9459-876b1ac3bbe7"></script>
</footer>


	</div>

	<script>
		'use strict';
		(function iifeMenu(document, window, undefined) {
			var menuBtn = document.querySelector('.menu__btn');
			var	menu = document.querySelector('.menu__list');
			function toggleMenu() {
				menu.classList.toggle('menu__list--active');
				menu.classList.toggle('menu__list--transition');
				this.classList.toggle('menu__btn--active');
				this.setAttribute(
					'aria-expanded',
					this.getAttribute('aria-expanded') === 'true' ? 'false' : 'true'
				);
			}
			function removeMenuTransition() {
				this.classList.remove('menu__list--transition');
			}
			if (menuBtn && menu) {
				menuBtn.addEventListener('click', toggleMenu, false);
				menu.addEventListener('transitionend', removeMenuTransition, false);
			}
		}(document, window));
	</script>
</body>
</html>