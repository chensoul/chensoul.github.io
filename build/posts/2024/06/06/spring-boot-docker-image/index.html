<!DOCTYPE html>
<html class="no-js" lang="zh-cn">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Spring Boot项目创建Docker镜像并运行应用 - Java、Spring、Spring Boot、MicroServices、Architecture、Kubernetes、DevOps</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	<meta property="og:title" content="Spring Boot项目创建Docker镜像并运行应用">
	<meta property="og:description" content="Java、Spring、Spring Boot、MicroServices、Architecture、Kubernetes、DevOps">
	<meta property="og:type" content="article">
	<meta property="og:url" content="https://blog.chensoul.cc/posts/2024/06/06/spring-boot-docker-image/">
	<meta property="og:site_name" content="ChenSoul Blog">
	<meta property="og:image" content="">
	
  <meta itemprop="name" content="Spring Boot项目创建Docker镜像并运行应用">
  <meta itemprop="description" content="手动创建 Dockerfile 在您的 Spring Boot 项目根目录下创建一个名为 Dockerfile 的文件，并添加以下内容:">
  <meta itemprop="datePublished" content="2024-06-06T00:00:00+00:00">
  <meta itemprop="dateModified" content="2024-06-06T00:00:00+00:00">
  <meta itemprop="wordCount" content="1767">
  <meta itemprop="keywords" content="Docker,Java,Kubernetes,Backend">
	<meta name="twitter:card" content="summary_large_image">
	<meta name="twitter:title" content="Spring Boot项目创建Docker镜像并运行应用">
	<meta name="twitter:description" content="Java、Spring、Spring Boot、MicroServices、Architecture、Kubernetes、DevOps">
	<meta name="twitter:image" content="">

	<link rel="preconnect" href="//fonts.loli.net" crossorigin>
	<link rel="dns-prefetch" href="//fonts.loli.net">
	<link rel="stylesheet" href="https://fonts.loli.net/css?family=Open+Sans:400,400i,700">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" integrity="sha512-2SwdPD6INVrV/lHTZbO2nodKhrnDdJK9/kg2XD1r9uGqPo1cUbujc+IYdlYdEErWNu69gVcYgdxlmVmzTWnetw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
	<link rel="stylesheet" href="/css/style.css">

	<link rel="shortcut icon" href="/favicon.ico">
		
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo logo--mixed">
		<a class="logo__link" href="/" title="ChenSoul Blog" rel="home">
			<div class="logo__item logo__imagebox">
					<img class="logo__img" src="/logo.svg" loading="lazy" alt="Site logo" width="60" height="60">
				</div><div class="logo__item logo__text">
					<div class="logo__title">ChenSoul Blog</div>
					<div class="logo__tagline">Java、Spring、Spring Boot、MicroServices、Architecture、Kubernetes、DevOps</div>
				</div>
		</a>
	</div>
		
<nav class="menu">
	<button class="menu__btn" aria-haspopup="true" aria-expanded="false" tabindex="0">
		<span class="menu__btn-title" tabindex="-1">菜单</span>
	</button>
	<ul class="menu__list">
		<li class="menu__item">
			<a class="menu__link" href="/">
				
				<span class="menu__text">首页</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/categories/">
				
				<span class="menu__text">分类</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/tags/">
				
				<span class="menu__text">标签</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/index.xml">
				
				<span class="menu__text">订阅</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/about/">
				
				<span class="menu__text">关于</span>
				
			</a>
		</li>
	</ul>
</nav>

	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Spring Boot项目创建Docker镜像并运行应用</h1>
			<div class="post__meta meta">
<div class="meta__item-datetime meta__item">
	<svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0a14 14 0 1 1 0 28 1 1 0 0 1 0-28m0 3a3 3 0 1 0 0 22 3 3 0 0 0 0-22m1 4h-2v8.4l6.8 4.4L22 18l-6-3.8z"/></svg><time class="meta__text" datetime="2024-06-06">2024-06-06</time></div><div class="meta__item-categories meta__item"><svg class="meta__icon icon icon-category" width="16" height="16" viewBox="0 0 16 16"><path d="m7 2 1 2h8v11H0V2z"/></svg><span class="meta__text"><a class="meta__link" href="/categories/spring-boot/" rel="category">Spring-Boot</a>
	</span>
</div><div class="meta__item-tags meta__item"><svg class="meta__icon icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M4 0h8s2 0 4 2l15 15s2 2 0 4L21 31s-2 2-4 0L2 16s-2-2-2-4V3s0-3 4-3m3 10a3 3 0 0 0 0-6 3 3 0 0 0 0 6"/></svg><span class="meta__text"><a class="meta__link" href="/tags/docker/" rel="tag">Docker</a>, <a class="meta__link" href="/tags/java/" rel="tag">Java</a>, <a class="meta__link" href="/tags/kubernetes/" rel="tag">Kubernetes</a>, <a class="meta__link" href="/tags/backend/" rel="tag">Backend</a>
	</span>
</div>
</div>
		</header>
		
		<div class="content post__content clearfix">
			<h2 id="手动创建-dockerfile">手动创建 Dockerfile</h2>
<p>在您的 Spring Boot 项目根目录下创建一个名为 <code>Dockerfile</code> 的文件，并添加以下内容:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> eclipse-temurin:21-jre-alpine</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> target/*.jar app.jar<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">EXPOSE</span><span style="color:#e6db74"> 8080</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ENTRYPOINT</span> [<span style="color:#e6db74">&#34;java&#34;</span>,<span style="color:#e6db74">&#34;-jar&#34;</span>,<span style="color:#e6db74">&#34;app.jar&#34;</span>]<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>如果 target 目录下存在多个 jar 文件，则可以在 dockerfile 同级添加一个 .dockerignore 文件忽略掉 <code>*-sources.jar</code> ：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Include any files or directories that you don&#39;t want to be copied to your</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># container here (e.g., local build artifacts, temporary files, etc.).</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># For more help, visit the .dockerignore file reference guide at</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># https://docs.docker.com/go/build-context-dockerignore/</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>**/.classpath
</span></span><span style="display:flex;"><span>**/.dockerignore
</span></span><span style="display:flex;"><span>**/.env
</span></span><span style="display:flex;"><span>**/.git
</span></span><span style="display:flex;"><span>**/.gitignore
</span></span><span style="display:flex;"><span>**/.project
</span></span><span style="display:flex;"><span>**/.settings
</span></span><span style="display:flex;"><span>**/.toolstarget
</span></span><span style="display:flex;"><span>**/.vs
</span></span><span style="display:flex;"><span>**/.vscode
</span></span><span style="display:flex;"><span>**/.next
</span></span><span style="display:flex;"><span>**/.cache
</span></span><span style="display:flex;"><span>**/*.*proj.user
</span></span><span style="display:flex;"><span>**/*.dbmdl
</span></span><span style="display:flex;"><span>**/*.jfm
</span></span><span style="display:flex;"><span>**/charts
</span></span><span style="display:flex;"><span>**/docker-compose*
</span></span><span style="display:flex;"><span>**/compose.y*ml
</span></span><span style="display:flex;"><span>**/target/*-sources.jar
</span></span><span style="display:flex;"><span>**/Dockerfile*
</span></span><span style="display:flex;"><span>**/node_modules
</span></span><span style="display:flex;"><span>**/npm-debug.log
</span></span><span style="display:flex;"><span>**/obj
</span></span><span style="display:flex;"><span>**/secrets.dev.yaml
</span></span><span style="display:flex;"><span>**/values.dev.yaml
</span></span><span style="display:flex;"><span>**/vendor
</span></span><span style="display:flex;"><span>LICENSE
</span></span><span style="display:flex;"><span>README.md
</span></span></code></pre></div><p>在项目根目录下运行以下命令，构建 Docker 镜像:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mvn clean package
</span></span><span style="display:flex;"><span>docker build -t my-spring-boot-app .
</span></span></code></pre></div><p>这将先使用 Maven 编译项目，然后使用 Dockerfile 构建名为 <code>my-spring-boot-app</code> 的 Docker 镜像。</p>
<p>使用以下命令启动 Docker 容器:</p>
<pre tabindex="0"><code>docker run -p 8080:8080 my-spring-boot-app
</code></pre><h2 id="使用-docker-init-创建-dockerfile">使用 Docker init 创建 Dockerfile</h2>
<p>参考 <a href="https://docs.docker.com/language/java/containerize/" target="_blank">Containerize a Java application</a>，首先需要安装 docker desktop，这样才能使用 docker init 命令。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ docker init
</span></span><span style="display:flex;"><span>Welcome to the Docker Init CLI!
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>This utility will walk you through creating the following files with sensible defaults <span style="color:#66d9ef">for</span> your project:
</span></span><span style="display:flex;"><span>  - .dockerignore
</span></span><span style="display:flex;"><span>  - Dockerfile
</span></span><span style="display:flex;"><span>  - compose.yaml
</span></span><span style="display:flex;"><span>  - README.Docker.md
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Let<span style="color:#e6db74">&#39;s get started!
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">WARNING: The following Docker files already exist in this directory:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - docker-compose.yml
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">? Do you want to overwrite them? Yes
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">? What application platform does your project use? Java
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">? What&#39;</span>s the relative directory <span style="color:#f92672">(</span>with a leading .<span style="color:#f92672">)</span> <span style="color:#66d9ef">for</span> your app? ./src
</span></span><span style="display:flex;"><span>? What version of Java <span style="color:#66d9ef">do</span> you want to use? <span style="color:#ae81ff">21</span>
</span></span><span style="display:flex;"><span>? What port does your server listen on? <span style="color:#ae81ff">8080</span>
</span></span></code></pre></div><p>生成的 Dockerfile 文件如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span><span style="color:#75715e"># syntax=docker/dockerfile:1</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># Comments are provided throughout this file to help you get started.</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># If you need more help, visit the Dockerfile reference guide at</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># https://docs.docker.com/go/dockerfile-reference/</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># Want to help us make this template better? Share your feedback here: https://forms.gle/ybq9Krt8jtBL3iCk7</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e">################################################################################</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># Create a stage for resolving and downloading dependencies.</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> eclipse-temurin:21-jdk-jammy as deps</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span><span style="color:#e6db74"> /build</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># Copy the mvnw wrapper with executable permissions.</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> --chmod<span style="color:#f92672">=</span><span style="color:#ae81ff">0755</span> mvnw mvnw<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> .mvn/ .mvn/<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># Download dependencies as a separate step to take advantage of Docker&#39;s caching.</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># Leverage a cache mount to /root/.m2 so that subsequent builds don&#39;t have to</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># re-download packages.</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> --mount<span style="color:#f92672">=</span>type<span style="color:#f92672">=</span>bind,source<span style="color:#f92672">=</span>pom.xml,target<span style="color:#f92672">=</span>pom.xml <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --mount<span style="color:#f92672">=</span>type<span style="color:#f92672">=</span>cache,target<span style="color:#f92672">=</span>/root/.m2 ./mvnw dependency:go-offline -DskipTests<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e">################################################################################</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># Create a stage for building the application based on the stage with downloaded dependencies.</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># This Dockerfile is optimized for Java applications that output an uber jar, which includes</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># all the dependencies needed to run your app inside a JVM. If your app doesn&#39;t output an uber</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># jar and instead relies on an application server like Apache Tomcat, you&#39;ll need to update this</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># stage with the correct filename of your package and update the base image of the &#34;final&#34; stage</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># use the relevant app server, e.g., using tomcat (https://hub.docker.com/_/tomcat/) as a base image.</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> deps as package</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span><span style="color:#e6db74"> /build</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> ./src src/<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> --mount<span style="color:#f92672">=</span>type<span style="color:#f92672">=</span>bind,source<span style="color:#f92672">=</span>pom.xml,target<span style="color:#f92672">=</span>pom.xml <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --mount<span style="color:#f92672">=</span>type<span style="color:#f92672">=</span>cache,target<span style="color:#f92672">=</span>/root/.m2 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    ./mvnw package -DskipTests <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    mv target/<span style="color:#66d9ef">$(</span>./mvnw help:evaluate -Dexpression<span style="color:#f92672">=</span>project.artifactId -q -DforceStdout<span style="color:#66d9ef">)</span>-<span style="color:#66d9ef">$(</span>./mvnw help:evaluate -Dexpression<span style="color:#f92672">=</span>project.version -q -DforceStdout<span style="color:#66d9ef">)</span>.jar target/app.jar<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e">################################################################################</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># Create a stage for extracting the application into separate layers.</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># Take advantage of Spring Boot&#39;s layer tools and Docker&#39;s caching by extracting</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># the packaged application into separate layers that can be copied into the final stage.</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># See Spring&#39;s docs for reference:</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># https://docs.spring.io/spring-boot/docs/current/reference/html/container-images.html</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> package as extract</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span><span style="color:#e6db74"> /build</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> java -Djarmode<span style="color:#f92672">=</span>tools -jar target/app.jar extract --layers --launcher --destination target/extracted<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e">################################################################################</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># Create a new stage for running the application that contains the minimal</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># runtime dependencies for the application. This often uses a different base</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># image from the install or build stage where the necessary files are copied</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># from the install stage.</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e">#</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># The example below uses eclipse-turmin&#39;s JRE image as the foundation for running the app.</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># By specifying the &#34;21-jre-jammy&#34; tag, it will also use whatever happens to be the</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># most recent version of that tag when you build your Dockerfile.</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># If reproducability is important, consider using a specific digest SHA, like</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># eclipse-temurin@sha256:99cede493dfd88720b610eb8077c8688d3cca50003d76d1d539b0efc8cca72b4.</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> eclipse-temurin:21-jre-jammy AS final</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># Create a non-privileged user that the app will run under.</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># See https://docs.docker.com/go/dockerfile-user-best-practices/</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ARG</span> UID<span style="color:#f92672">=</span><span style="color:#ae81ff">10001</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">RUN</span> adduser <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --disabled-password <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --gecos <span style="color:#e6db74">&#34;&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --home <span style="color:#e6db74">&#34;/nonexistent&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --shell <span style="color:#e6db74">&#34;/sbin/nologin&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --no-create-home <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --uid <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>UID<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    appuser<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">USER</span><span style="color:#e6db74"> appuser</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># Copy the executable from the &#34;package&#34; stage.</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> --from<span style="color:#f92672">=</span>extract build/target/extracted/dependencies/ ./<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> --from<span style="color:#f92672">=</span>extract build/target/extracted/spring-boot-loader/ ./<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> --from<span style="color:#f92672">=</span>extract build/target/extracted/snapshot-dependencies/ ./<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> --from<span style="color:#f92672">=</span>extract build/target/extracted/application/ ./<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">EXPOSE</span><span style="color:#e6db74"> 8080</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ENTRYPOINT</span> [ <span style="color:#e6db74">&#34;java&#34;</span>, <span style="color:#e6db74">&#34;org.springframework.boot.loader.launch.JarLauncher&#34;</span> ]<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><blockquote>
<p>注意：</p>
<p>JDK21 使用：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>java -Djarmode<span style="color:#f92672">=</span>tools -jar target/app.jar extract --layers --launcher --destination target/extracted
</span></span></code></pre></div></blockquote>
<p>这个Dockerfile文件是用于构建和运行Java应用程序的Docker镜像。它使用多个阶段（stages）来完成不同的任务。</p>
<p>参考《<a href="https://blog.chensoul.cc/posts/2024/07/09/docker-for-spring-boot/" target="_blank">使用 Docker 容器化并运行 Spring Boot 应用程序</a>》，修改 Dockerfile 后的文件如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span><span style="color:#75715e"># syntax=docker/dockerfile:1</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># https://docs.docker.com/reference/dockerfile/</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># https://docs.docker.com/build/guide/multi-stage/</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> maven:3-eclipse-temurin-21-alpine AS base</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span><span style="color:#e6db74"> /build</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> ./src src/<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> sed -i -E <span style="color:#e6db74">&#39;159a &lt;mirror&gt;\n&lt;id&gt;aliyun&lt;/id&gt;\n&lt;name&gt;Aliyun Mirror&lt;/name&gt;\n&lt;url&gt;http://maven.aliyun.com/nexus/content/groups/public/&lt;/url&gt;\n&lt;mirrorOf&gt;central&lt;/mirrorOf&gt;\n&lt;/mirror&gt;&#39;</span> /usr/share/maven/conf/settings.xml<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> base AS test</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span><span style="color:#e6db74"> /build</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> --mount<span style="color:#f92672">=</span>type<span style="color:#f92672">=</span>bind,source<span style="color:#f92672">=</span>pom.xml,target<span style="color:#f92672">=</span>pom.xml <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --mount<span style="color:#f92672">=</span>type<span style="color:#f92672">=</span>cache,target<span style="color:#f92672">=</span>/root/.m2 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    mvn test<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> base AS package</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span><span style="color:#e6db74"> /build</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> --mount<span style="color:#f92672">=</span>type<span style="color:#f92672">=</span>bind,source<span style="color:#f92672">=</span>pom.xml,target<span style="color:#f92672">=</span>pom.xml <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --mount<span style="color:#f92672">=</span>type<span style="color:#f92672">=</span>cache,target<span style="color:#f92672">=</span>/root/.m2 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    mvn package -DskipTests <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    mv target/<span style="color:#66d9ef">$(</span>mvn help:evaluate -Dexpression<span style="color:#f92672">=</span>project.artifactId -q -DforceStdout<span style="color:#66d9ef">)</span>-<span style="color:#66d9ef">$(</span>mvn help:evaluate -Dexpression<span style="color:#f92672">=</span>project.version -q -DforceStdout<span style="color:#66d9ef">)</span>.jar target/app.jar<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> package AS extract</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span><span style="color:#e6db74"> /build</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> java -Djarmode<span style="color:#f92672">=</span>layertools -jar target/app.jar extract --destination target/extracted<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> extract AS development</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span><span style="color:#e6db74"> /build</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> cp -r /build/target/extracted/dependencies/. ./<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> cp -r /build/target/extracted/spring-boot-loader/. ./<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> cp -r /build/target/extracted/snapshot-dependencies/. ./<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> cp -r /build/target/extracted/application/. ./<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">CMD</span> [ <span style="color:#e6db74">&#34;java&#34;</span>, <span style="color:#e6db74">&#34;-Dspring-boot.run.jvmArguments=&#39;-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:8000&#39;&#34;</span>, <span style="color:#e6db74">&#34;org.springframework.boot.loader.launch.JarLauncher&#34;</span> ]<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> eclipse-temurin:21-jre-jammy AS final</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span><span style="color:#e6db74"> /app</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># See https://docs.docker.com/go/dockerfile-user-best-practices/</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ARG</span> UID<span style="color:#f92672">=</span><span style="color:#ae81ff">10001</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">RUN</span> adduser <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --disabled-password <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --gecos <span style="color:#e6db74">&#34;&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --home <span style="color:#e6db74">&#34;/nonexistent&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --shell <span style="color:#e6db74">&#34;/sbin/nologin&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --no-create-home <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --uid <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>UID<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    appuser<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">USER</span><span style="color:#e6db74"> appuser</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> --from<span style="color:#f92672">=</span>extract /build/target/extracted/dependencies/ ./<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> --from<span style="color:#f92672">=</span>extract /build/target/extracted/spring-boot-loader/ ./<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> --from<span style="color:#f92672">=</span>extract /build/target/extracted/snapshot-dependencies/ ./<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> --from<span style="color:#f92672">=</span>extract /build/target/extracted/application/ ./<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">EXPOSE</span><span style="color:#e6db74"> 8080</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ENTRYPOINT</span> [ <span style="color:#e6db74">&#34;java&#34;</span>,  <span style="color:#e6db74">&#34;org.springframework.boot.loader.launch.JarLauncher&#34;</span> ]<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>主要改动：</p>
<ul>
<li>1、基于 maven:3-eclipse-temurin-21-alpine 镜像构建，并使用阿里云 maven 镜像，使用 mvn 命令，而不是项目中的 mvnw 命令</li>
<li>2、去掉 deps 阶段</li>
</ul>
<h2 id="使用-maven-插件">使用 Maven 插件</h2>
<h3 id="jib-maven-plugin">jib-maven-plugin</h3>
<p>jib-maven-plugin 是 Google 开发的一款容器镜像构建工具，可以与 Maven 或 Gradle 集成使用。</p>
<ol>
<li>在项目的 <code>pom.xml</code> 文件中添加 Jib Maven 插件:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#f92672">&lt;build&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;plugins&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;plugin&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&lt;groupId&gt;</span>com.google.cloud.tools<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&lt;artifactId&gt;</span>jib-maven-plugin<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&lt;version&gt;</span>3.4.4<span style="color:#f92672">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&lt;configuration&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;from&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;image&gt;</span>eclipse-temurin:21-jre-jammy<span style="color:#f92672">&lt;/image&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;/from&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;to&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;image&gt;</span>chensoul/${project.artifactId}<span style="color:#f92672">&lt;/image&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;tags&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;tag&gt;</span>latest<span style="color:#f92672">&lt;/tag&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;tag&gt;</span>${project.version}<span style="color:#f92672">&lt;/tag&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;/tags&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;/to&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&lt;/configuration&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/plugin&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;/plugins&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/build&gt;</span>
</span></span></code></pre></div><ol start="2">
<li>如果使用 Gradle，在 <code>build.gradle</code> 文件中添加 Jib Gradle 插件:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span>plugins <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    id <span style="color:#e6db74">&#39;com.google.cloud.tools.jib&#39;</span> version <span style="color:#e6db74">&#39;3.4.4&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>jib <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    from <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        image <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;eclipse-temurin:21-jre-jammy&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    to <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        image <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;my-spring-boot-app&#39;</span>
</span></span><span style="display:flex;"><span>        tags <span style="color:#f92672">=</span> <span style="color:#f92672">[</span><span style="color:#e6db74">&#39;latest&#39;</span><span style="color:#f92672">,</span> project<span style="color:#f92672">.</span><span style="color:#a6e22e">version</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    container <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        mainClass <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;com.example.MySpringBootApp&#39;</span>
</span></span><span style="display:flex;"><span>        ports <span style="color:#f92672">=</span> <span style="color:#f92672">[</span><span style="color:#e6db74">&#39;8080&#39;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><ol start="3">
<li>运行构建命令:</li>
</ol>
<ul>
<li>对于 Maven 项目：<code>mvn compile jib:build</code></li>
<li>对于 Gradle 项目：<code>./gradlew jibBuild</code></li>
</ul>
<h3 id="docker-maven-plugin">docker-maven-plugin</h3>
<ol>
<li>在 pom.xml 中添加如下配置:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#f92672">&lt;plugin&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;groupId&gt;</span>io.fabric8<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;artifactId&gt;</span>docker-maven-plugin<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;version&gt;</span>0.43.4<span style="color:#f92672">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;configuration&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;verbose&gt;</span>true<span style="color:#f92672">&lt;/verbose&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;images&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;image&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;name&gt;</span>spring-fabric8<span style="color:#f92672">&lt;/name&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;build&gt;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">&lt;from&gt;</span>eclipse-temurin:21-jre-jammy<span style="color:#f92672">&lt;/from&gt;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">&lt;assembly&gt;</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">&lt;descriptorRef&gt;</span>artifact<span style="color:#f92672">&lt;/descriptorRef&gt;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">&lt;/assembly&gt;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">&lt;entryPoint&gt;</span>
</span></span><span style="display:flex;"><span>                      <span style="color:#f92672">&lt;exec&gt;</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">&lt;arg&gt;</span>java<span style="color:#f92672">&lt;/arg&gt;</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">&lt;arg&gt;</span>-jar<span style="color:#f92672">&lt;/arg&gt;</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">&lt;arg&gt;</span>/maven/${project.build.finalName}.${project.packaging}<span style="color:#f92672">&lt;/arg&gt;</span>
</span></span><span style="display:flex;"><span>                      <span style="color:#f92672">&lt;/exec&gt;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">&lt;/entryPoint&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;/build&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;run&gt;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">&lt;ports&gt;</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">&lt;port&gt;</span>8080:8080<span style="color:#f92672">&lt;/port&gt;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">&lt;/ports&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;/run&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;/image&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;/images&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/configuration&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/plugin&gt;</span>
</span></span></code></pre></div><ol start="2">
<li>运行 <code>mvn docker:build</code> 命令构建镜像。</li>
</ol>
<h3 id="spotify-docker-maven-plugin">Spotify Docker Maven Plugin</h3>
<ol>
<li>在 pom.xml 中添加如下配置:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#f92672">&lt;build&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;plugins&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;plugin&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;groupId&gt;</span>com.spotify<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;artifactId&gt;</span>dockerfile-maven-plugin<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;version&gt;</span>1.4.13<span style="color:#f92672">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;configuration&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;repository&gt;</span>my-spring-boot-app<span style="color:#f92672">&lt;/repository&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;tag&gt;</span>${project.version}<span style="color:#f92672">&lt;/tag&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;buildArgs&gt;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">&lt;JAR_FILE&gt;</span>${project.build.finalName}.jar<span style="color:#f92672">&lt;/JAR_FILE&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;/buildArgs&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;/configuration&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;/plugin&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/plugins&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/build&gt;</span>
</span></span></code></pre></div><ol start="2">
<li>运行 <code>mvn dockerfile:build</code> 命令构建镜像。</li>
</ol>
<h3 id="kubernetes-maven-plugin">kubernetes-maven-plugin</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>&lt;plugin&gt;
</span></span><span style="display:flex;"><span>    &lt;groupId&gt;org.eclipse.jkube&lt;/groupId&gt;
</span></span><span style="display:flex;"><span>    &lt;artifactId&gt;kubernetes-maven-plugin&lt;/artifactId&gt;
</span></span><span style="display:flex;"><span>    &lt;version&gt;1.17.0&lt;/version&gt;
</span></span><span style="display:flex;"><span>    &lt;configuration&gt;
</span></span><span style="display:flex;"><span>        &lt;images&gt;
</span></span><span style="display:flex;"><span>            &lt;image&gt;
</span></span><span style="display:flex;"><span>                &lt;alias&gt;<span style="color:#e6db74">${</span>project.artifactId<span style="color:#e6db74">}</span>&lt;/alias&gt;
</span></span><span style="display:flex;"><span>                &lt;name&gt;chensoul/<span style="color:#e6db74">${</span>project.artifactId<span style="color:#e6db74">}</span>:latest&lt;/name&gt;
</span></span><span style="display:flex;"><span>                &lt;build&gt;
</span></span><span style="display:flex;"><span>                    &lt;from&gt;openjdk:21&lt;/from&gt;
</span></span><span style="display:flex;"><span>                    &lt;assembly&gt;
</span></span><span style="display:flex;"><span>                        &lt;mode&gt;dir&lt;/mode&gt;
</span></span><span style="display:flex;"><span>                        &lt;targetDir&gt;/usr/home/app&lt;/targetDir&gt;
</span></span><span style="display:flex;"><span>                        &lt;inline&gt;
</span></span><span style="display:flex;"><span>                            &lt;id&gt;copy-jar&lt;/id&gt;
</span></span><span style="display:flex;"><span>                            &lt;baseDirectory&gt;/home/home/app&lt;/baseDirectory&gt;
</span></span><span style="display:flex;"><span>                            &lt;files&gt;
</span></span><span style="display:flex;"><span>                                &lt;file&gt;
</span></span><span style="display:flex;"><span>                                    &lt;source&gt;target/<span style="color:#e6db74">${</span>project.artifactId<span style="color:#e6db74">}</span>-<span style="color:#e6db74">${</span>project.version<span style="color:#e6db74">}</span>.jar&lt;/source&gt;
</span></span><span style="display:flex;"><span>                                    &lt;outputDirectory&gt;.&lt;/outputDirectory&gt;
</span></span><span style="display:flex;"><span>                                &lt;/file&gt;
</span></span><span style="display:flex;"><span>                            &lt;/files&gt;
</span></span><span style="display:flex;"><span>                        &lt;/inline&gt;
</span></span><span style="display:flex;"><span>                    &lt;/assembly&gt;
</span></span><span style="display:flex;"><span>                    &lt;workdir&gt;/usr/home/app&lt;/workdir&gt;
</span></span><span style="display:flex;"><span>                    &lt;cmd&gt;java -jar <span style="color:#e6db74">${</span>project.artifactId<span style="color:#e6db74">}</span>-<span style="color:#e6db74">${</span>project.version<span style="color:#e6db74">}</span>.jar&lt;/cmd&gt;
</span></span><span style="display:flex;"><span>                    &lt;ports&gt;
</span></span><span style="display:flex;"><span>                        &lt;port&gt;8080&lt;/port&gt;
</span></span><span style="display:flex;"><span>                    &lt;/ports&gt;
</span></span><span style="display:flex;"><span>                &lt;/build&gt;
</span></span><span style="display:flex;"><span>            &lt;/image&gt;
</span></span><span style="display:flex;"><span>        &lt;/images&gt;
</span></span><span style="display:flex;"><span>    &lt;/configuration&gt;
</span></span><span style="display:flex;"><span>    &lt;executions&gt;
</span></span><span style="display:flex;"><span>        &lt;execution&gt;
</span></span><span style="display:flex;"><span>            &lt;id&gt;goals&lt;/id&gt;
</span></span><span style="display:flex;"><span>            &lt;goals&gt;
</span></span><span style="display:flex;"><span>                &lt;goal&gt;resource&lt;/goal&gt;
</span></span><span style="display:flex;"><span>                &lt;!--goal&gt;helm&lt;/goal--&gt;
</span></span><span style="display:flex;"><span>                &lt;!--goal&gt;build&lt;/goal--&gt;
</span></span><span style="display:flex;"><span>                &lt;!--goal&gt;deploy&lt;/goal--&gt;
</span></span><span style="display:flex;"><span>            &lt;/goals&gt;
</span></span><span style="display:flex;"><span>        &lt;/execution&gt;
</span></span><span style="display:flex;"><span>    &lt;/executions&gt;
</span></span><span style="display:flex;"><span>&lt;/plugin&gt;
</span></span></code></pre></div><h3 id="exec-maven-plugin">exec-maven-plugin</h3>
<p>参考 <a href="https://github.com/odedia/spring-petclinic-microservices/blob/main/pom.xml" target="_blank">spring-petclinic-microservices</a> 项目：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#f92672">&lt;properties&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;docker.image.prefix&gt;</span>springcommunity<span style="color:#f92672">&lt;/docker.image.prefix&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;docker.image.exposed.port&gt;</span>9090<span style="color:#f92672">&lt;/docker.image.exposed.port&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;docker.image.dockerfile.dir&gt;</span>${basedir}<span style="color:#f92672">&lt;/docker.image.dockerfile.dir&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">&lt;!-- podman is also supported --&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;container.executable&gt;</span>docker<span style="color:#f92672">&lt;/container.executable&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">&lt;!-- By default, the OCI image is build for the linux/amd64 platform --&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">&lt;!-- For Apple Silicon M2 Chip you have to change it to the linux/arm64 --&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;container.platform&gt;</span>linux/amd64<span style="color:#f92672">&lt;/container.platform&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">&lt;!-- The -load option is a shortcut for or -output=type=docker --&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">&lt;!-- Could be changed by the -push option !--&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;container.build.extraarg&gt;</span>--load<span style="color:#f92672">&lt;/container.build.extraarg&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/properties&gt;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#f92672">&lt;plugin&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;groupId&gt;</span>org.codehaus.mojo<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;artifactId&gt;</span>exec-maven-plugin<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;version&gt;</span>3.1.1<span style="color:#f92672">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;executions&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;execution&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;id&gt;</span>docker-build<span style="color:#f92672">&lt;/id&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;phase&gt;</span>install<span style="color:#f92672">&lt;/phase&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;goals&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;goal&gt;</span>exec<span style="color:#f92672">&lt;/goal&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;/goals&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;configuration&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;executable&gt;</span>${container.executable}<span style="color:#f92672">&lt;/executable&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;workingDirectory&gt;</span>${docker.image.dockerfile.dir}<span style="color:#f92672">&lt;/workingDirectory&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;arguments&gt;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">&lt;argument&gt;</span>build<span style="color:#f92672">&lt;/argument&gt;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">&lt;argument&gt;</span>-f<span style="color:#f92672">&lt;/argument&gt;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">&lt;argument&gt;</span>Dockerfile<span style="color:#f92672">&lt;/argument&gt;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">&lt;argument&gt;</span>--build-arg<span style="color:#f92672">&lt;/argument&gt;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">&lt;argument&gt;</span>ARTIFACT_NAME=${project.build.finalName}<span style="color:#f92672">&lt;/argument&gt;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">&lt;argument&gt;</span>--build-arg<span style="color:#f92672">&lt;/argument&gt;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">&lt;argument&gt;</span>EXPOSED_PORT=${docker.image.exposed.port}<span style="color:#f92672">&lt;/argument&gt;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">&lt;argument&gt;</span>--platform<span style="color:#f92672">&lt;/argument&gt;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">&lt;argument&gt;</span>${container.platform}<span style="color:#f92672">&lt;/argument&gt;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">&lt;argument&gt;</span>${container.build.extraarg}<span style="color:#f92672">&lt;/argument&gt;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">&lt;argument&gt;</span>-t<span style="color:#f92672">&lt;/argument&gt;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">&lt;argument&gt;</span>${docker.image.prefix}/${project.artifactId}<span style="color:#f92672">&lt;/argument&gt;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">&lt;argument&gt;</span>${project.build.directory}<span style="color:#f92672">&lt;/argument&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;/arguments&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;/configuration&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;/execution&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/executions&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/plugin&gt;</span>
</span></span></code></pre></div><h2 id="使用-spring-boot-maven-插件">使用 Spring Boot Maven 插件</h2>
<h3 id="使用-buildpacks">使用 Buildpacks</h3>
<p>Spring Boot在2.3.0之后，引入了Cloud Native 的buildpacks，通过这个工具，我们可以非常非常方便的创建docker image。</p>
<p>在Maven和Gradle中，Spring Boot引入了新的phase： <code>spring-boot:build-image</code></p>
<blockquote>
<p><strong>使用 Buildpacks 构建镜像</strong>:</p>
<ul>
<li>Buildpacks 是一种自动化的构建过程,可以根据应用程序源码生成 Docker 镜像。</li>
<li>可以使用 Cloud Native Buildpacks 或 Heroku Buildpacks 来构建 Spring Boot 应用的 Docker 镜像。</li>
<li>运行 <code>pack build my-spring-boot-app --builder gcr.io/buildpacks/builder:v1</code> 即可构建镜像。</li>
</ul></blockquote>
<ol>
<li>在项目的 <code>pom.xml</code> 文件中添加 <code>spring-boot-maven-plugin</code> 插件配置。</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#f92672">&lt;plugin&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;artifactId&gt;</span>spring-boot-maven-plugin<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;configuration&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;image&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;name&gt;</span>chensoul/${project.artifactId}<span style="color:#f92672">&lt;/name&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;env&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">&lt;!-- Make sure `mvn spring-boot:build-image` uses the Java version defined in this project --&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;BP_JVM_VERSION&gt;</span>${java.version}<span style="color:#f92672">&lt;/BP_JVM_VERSION&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;/env&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;/image&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;docker&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;publishRegistry&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;username&gt;</span>${docker.publishRegistry.username}<span style="color:#f92672">&lt;/username&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;password&gt;</span>${docker.publishRegistry.password}<span style="color:#f92672">&lt;/password&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;/publishRegistry&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;/docker&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/configuration&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/plugin&gt;</span>
</span></span></code></pre></div><ol start="2">
<li>构建镜像</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mvn spring-boot:build-image -DskipTests
</span></span></code></pre></div><ol start="3">
<li>或者构建镜像并上传到 docker hub</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mvn spring-boot:build-image -DskipTests <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -Ddocker.publishRegistry.username<span style="color:#f92672">=</span>user <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -Ddocker.publishRegistry.password<span style="color:#f92672">=</span>secret <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -Dspring-boot.build-image.publish<span style="color:#f92672">=</span>true
</span></span></code></pre></div><h3 id="使用-layered-jar">使用 Layered Jar</h3>
<p>如果你不想使用Cloud Native Buildpacks，还是想使用传统的Dockerfile。 没关系，SpringBoot为我们提供了独特的分层jar包系统。</p>
<p>怎么开启呢？ 我们需要在POM文件中加上下面的配置：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#f92672">&lt;build&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;plugins&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;plugin&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;artifactId&gt;</span>spring-boot-maven-plugin<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;configuration&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;layers&gt;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">&lt;enabled&gt;</span>true<span style="color:#f92672">&lt;/enabled&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;/layers&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;/configuration&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;/plugin&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/plugins&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/build&gt;</span>
</span></span></code></pre></div><p>使用 layer 之后，<a href="https://docs.spring.io/spring-boot/reference/packaging/container-images/dockerfiles.html" target="_blank">Spring 官方文档</a>中提供dockerfile如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> bellsoft/liberica-runtime-container:jre-17-cds-slim-glibc as builder</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span><span style="color:#e6db74"> /builder</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ARG</span> JAR_FILE<span style="color:#f92672">=</span>target/*.jar<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> <span style="color:#e6db74">${</span>JAR_FILE<span style="color:#e6db74">}</span> application.jar<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> java -Djarmode<span style="color:#f92672">=</span>tools -jar application.jar extract --layers --destination extracted<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> bellsoft/liberica-runtime-container:jre-17-cds-slim-glibc</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span><span style="color:#e6db74"> /application</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> --from<span style="color:#f92672">=</span>builder /builder/extracted/dependencies/ ./<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> --from<span style="color:#f92672">=</span>builder /builder/extracted/spring-boot-loader/ ./<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> --from<span style="color:#f92672">=</span>builder /builder/extracted/snapshot-dependencies/ ./<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> --from<span style="color:#f92672">=</span>builder /builder/extracted/application/ ./<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ENTRYPOINT</span> [<span style="color:#e6db74">&#34;java&#34;</span>, <span style="color:#e6db74">&#34;-jar&#34;</span>, <span style="color:#e6db74">&#34;application.jar&#34;</span>]<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><h2 id="使用-spring-boot-gradle-插件">使用 Spring Boot Gradle 插件</h2>
<ul>
<li>在项目的 <code>build.gradle</code> 文件中添加 <code>spring-boot-gradle-plugin</code> 插件配置。</li>
<li>插件会自动生成 Dockerfile 并构建 Docker 镜像。</li>
<li>使用 <code>./gradlew bootBuildImage</code> 命令即可构建并推送镜像。</li>
</ul>
<h2 id="使用-maven-镜像从源码运行">使用 Maven 镜像从源码运行</h2>
<h3 id="使用-dockerfile">使用 dockerfile</h3>
<p>参考 《<a href="https://medium.com/@ramanamuttana/build-a-docker-image-using-maven-and-spring-boot-418e24c00776" target="_blank">Build a Docker Image using Maven and Spring boot</a>》不使用分层构建：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span><span style="color:#75715e"># Use an official Maven image as the base image</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> maven:3.8.4-openjdk-11-slim AS build</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># Set the working directory in the container</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span><span style="color:#e6db74"> /app</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># Copy the pom.xml and the project files to the container</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> pom.xml .<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> src ./src<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># Build the application using Maven</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> mvn clean package -DskipTests<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># Use an official OpenJDK image as the base image</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> openjdk:11-jre-slim</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># Set the working directory in the container</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span><span style="color:#e6db74"> /app</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># Copy the built JAR file from the previous stage to the container</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> --from<span style="color:#f92672">=</span>build /app/target/my-application.jar .<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># Set the command to run the application</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">CMD</span> [<span style="color:#e6db74">&#34;java&#34;</span>, <span style="color:#e6db74">&#34;-jar&#34;</span>, <span style="color:#e6db74">&#34;my-application.jar&#34;</span>]<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>结合前面的分层构建镜像，一个简单版本的 dockerfile 如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> maven:3-eclipse-temurin-21-alpine AS package</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span><span style="color:#e6db74"> /build</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> . .<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> mvn package -DskipTests <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    mv target/*.jar target/app.jar<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> package AS extract</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span><span style="color:#e6db74"> /build </span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> java -Djarmode<span style="color:#f92672">=</span>tools -jar app.jar target/extract --layers --launcher --destination target/extracted<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> eclipse-temurin:21-jre-jammy AS final</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span><span style="color:#e6db74"> /app</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> --from<span style="color:#f92672">=</span>extract /build/target/extracted/dependencies/ ./<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> --from<span style="color:#f92672">=</span>extract /build/target/extracted/spring-boot-loader/ ./<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> --from<span style="color:#f92672">=</span>extract /build/target/extracted/snapshot-dependencies/ ./<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> --from<span style="color:#f92672">=</span>extract /build/target/extracted/application/ ./<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">EXPOSE</span><span style="color:#e6db74"> 8080</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ENTRYPOINT</span> [ <span style="color:#e6db74">&#34;java&#34;</span>,  <span style="color:#e6db74">&#34;org.springframework.boot.loader.launch.JarLauncher&#34;</span> ]<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>复杂一点的 dockerfile 如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span><span style="color:#75715e"># syntax=docker/dockerfile:1</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># https://docs.docker.com/reference/dockerfile/</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># https://docs.docker.com/build/guide/multi-stage/</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> maven:3-eclipse-temurin-21-alpine AS base</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span><span style="color:#e6db74"> /build</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> ./src src/<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> sed -i -E <span style="color:#e6db74">&#39;159a &lt;mirror&gt;\n&lt;id&gt;aliyun&lt;/id&gt;\n&lt;name&gt;Aliyun Mirror&lt;/name&gt;\n&lt;url&gt;http://maven.aliyun.com/nexus/content/groups/public/&lt;/url&gt;\n&lt;mirrorOf&gt;central&lt;/mirrorOf&gt;\n&lt;/mirror&gt;&#39;</span> /usr/share/maven/conf/settings.xml<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> base AS package</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span><span style="color:#e6db74"> /build</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> --mount<span style="color:#f92672">=</span>type<span style="color:#f92672">=</span>bind,source<span style="color:#f92672">=</span>pom.xml,target<span style="color:#f92672">=</span>pom.xml <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --mount<span style="color:#f92672">=</span>type<span style="color:#f92672">=</span>cache,target<span style="color:#f92672">=</span>/root/.m2 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    mvn package -DskipTests <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    mv target/<span style="color:#66d9ef">$(</span>mvn help:evaluate -Dexpression<span style="color:#f92672">=</span>project.artifactId -q -DforceStdout<span style="color:#66d9ef">)</span>-<span style="color:#66d9ef">$(</span>mvn help:evaluate -Dexpression<span style="color:#f92672">=</span>project.version -q -DforceStdout<span style="color:#66d9ef">)</span>.jar target/app.jar<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> package AS extract</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span><span style="color:#e6db74"> /build</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> java -Djarmode<span style="color:#f92672">=</span>layertools -jar target/app.jar extract --destination target/extracted<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> eclipse-temurin:21-jre-jammy AS final</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span><span style="color:#e6db74"> /app</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># See https://docs.docker.com/go/dockerfile-user-best-practices/</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ARG</span> UID<span style="color:#f92672">=</span><span style="color:#ae81ff">10001</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">RUN</span> adduser <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --disabled-password <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --gecos <span style="color:#e6db74">&#34;&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --home <span style="color:#e6db74">&#34;/nonexistent&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --shell <span style="color:#e6db74">&#34;/sbin/nologin&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --no-create-home <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --uid <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>UID<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    appuser<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">USER</span><span style="color:#e6db74"> appuser</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> --from<span style="color:#f92672">=</span>extract /build/target/extracted/dependencies/ ./<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> --from<span style="color:#f92672">=</span>extract /build/target/extracted/spring-boot-loader/ ./<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> --from<span style="color:#f92672">=</span>extract /build/target/extracted/snapshot-dependencies/ ./<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> --from<span style="color:#f92672">=</span>extract /build/target/extracted/application/ ./<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">EXPOSE</span><span style="color:#e6db74"> 8080</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ENTRYPOINT</span> [ <span style="color:#e6db74">&#34;java&#34;</span>,  <span style="color:#e6db74">&#34;org.springframework.boot.loader.launch.JarLauncher&#34;</span> ]<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><h3 id="使用-docker-compose">使用 docker-compose</h3>
<ol>
<li>在项目根目录创建一个 docker-compose.yml文件：</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span><span style="color:#f92672">services</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">app</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">maven:3.9.6-eclipse-temurin-21</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">.://usr/src/workdir</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">~/.m2://root/.m2</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">working_dir</span>: <span style="color:#ae81ff">/usr/src/workdir</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">command</span>: <span style="color:#e6db74">&#34;mvn clean -DskipTests spring-boot:run&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">healthcheck</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">test</span>: [ <span style="color:#e6db74">&#39;CMD-SHELL&#39;</span>,<span style="color:#e6db74">&#39;curl --fail --silent localhost:8080/actuator/health | grep UP || exit 1&#39;</span> ]
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">interval</span>: <span style="color:#ae81ff">5s</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">timeout</span>: <span style="color:#ae81ff">5s</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">retries</span>: <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">start_period</span>: <span style="color:#ae81ff">30s</span>
</span></span></code></pre></div><ol start="2">
<li>启动容器</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker-compose app -f docker-compose.yml up -d
</span></span></code></pre></div><h2 id="参考文章">参考文章</h2>
<ul>
<li><a href="https://www.cnblogs.com/flydean/p/13824496.html" target="_blank">使用Spring Boot创建docker image</a></li>
<li><a href="https://github.com/jhipster/jhipster-lite/blob/main/Dockerfile" target="_blank">https://github.com/jhipster/jhipster-lite/blob/main/Dockerfile</a></li>
<li><a href="https://docs.spring.io/spring-boot/reference/packaging/container-images/dockerfiles.html" target="_blank">https://docs.spring.io/spring-boot/reference/packaging/container-images/dockerfiles.html</a></li>
</ul>

		</div>


	</article>
</main>
<footer class="post__footer">
	

<div class="post-related">
	<h3>相关文章</h3>
	<ul class="post-related-list">
		
		<li class="post-related-item">
			<a href="/posts/2024/02/02/til/" target="_blank" title="2024-02-02｜foodie-cloud集成Spring Cloud Config和SpringDoc">2024-02-02｜foodie-cloud集成Spring Cloud Config和SpringDoc</a>
		</li>
		
		<li class="post-related-item">
			<a href="/posts/2024/01/04/til/" target="_blank" title="2024-01-04｜GitHub Actions">2024-01-04｜GitHub Actions</a>
		</li>
		
		<li class="post-related-item">
			<a href="/posts/2023/12/21/til/" target="_blank" title="2023-12-21｜Spring Security对OAuth2的支持及实现方式">2023-12-21｜Spring Security对OAuth2的支持及实现方式</a>
		</li>
		
		<li class="post-related-item">
			<a href="/posts/2023/08/16/spring-boot-docker/" target="_blank" title="[译]为 Spring Boot 应用程序创建优化的 Docker 映像">[译]为 Spring Boot 应用程序创建优化的 Docker 映像</a>
		</li>
		
		<li class="post-related-item">
			<a href="/posts/2024/06/05/oauth2-with-spring-part-1-knowing-the-basic-concepts/" target="_blank" title="[译]OAuth2 with Spring 第1部分：了解基本概念">[译]OAuth2 with Spring 第1部分：了解基本概念</a>
		</li>
		
		<li class="post-related-item">
			<a href="/posts/2024/06/05/oauth2-with-spring-part-2-getting-started-with-authorization-server/" target="_blank" title="[译]OAuth2 with Spring 第2部分：授权服务器入门">[译]OAuth2 with Spring 第2部分：授权服务器入门</a>
		</li>
		
	</ul>
</div>

</footer>

<footer class="post__footer">
	<footer class="post__footer">
		
<div class="post__tags tags clearfix">
	<svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M4 0h8s2 0 4 2l15 15s2 2 0 4L21 31s-2 2-4 0L2 16s-2-2-2-4V3s0-3 4-3m3 10a3 3 0 0 0 0-6 3 3 0 0 0 0 6"/></svg>
	<ul class="tags__list">
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/docker/" rel="tag">docker</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/java/" rel="tag">java</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/kubernetes/" rel="tag">kubernetes</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/backend/" rel="tag">backend</a>
		</li>
	</ul>
</div>
	</footer>
</footer>


<nav class="pagination flex">
	<div class="pagination__item pagination__item--prev">
		<a class="pagination__link" href="/posts/2024/06/05/oauth2-with-spring-part-1-knowing-the-basic-concepts/" rel="prev">
			<p class="pagination__title">«&thinsp;上一篇: [译]OAuth2 with Spring 第1部分：了解基本概念</p>
		</a>
	</div>
	<div class="pagination__item pagination__item--next">
		<a class="pagination__link" href="/posts/2024/06/06/oauth2-oidc/" rel="next">
			<p class="pagination__title">&thinsp;» 下一篇: OAuth2和OIDC区别</p>
		</a>
	</div>
</nav>



<div class="authorbox clearfix">
	<figure class="authorbox__avatar">
		<img alt="ChenSoul avatar" src="/avatar.jpg" class="avatar" height="60" width="60" loading="lazy">
	</figure>
	<div class="authorbox__header">
		<span class="authorbox__name">关于 ChenSoul</span>
	</div>
	<div class="authorbox__description">
		一个来自中国武汉的开发者，主要撰写软件开发和开源方面的文章。浏览我的<a href="%28/posts%29">博客文章</a>，订阅我的 <a href="/index.xml">RSS</a> 源，或了解更多<a href="/about/">关于我</a>的信息。
	</div>
</div>




	<p><h3>欢迎留言！</h3></p>
<div id="remark42"></div>
<script>
	var remark_config = {
		host: 'https:\/\/comment.chensoul.cc',
		site_id: 'remark',
		components: ['embed'],
		url: 'https:\/\/blog.chensoul.cc\/posts\/2024\/06\/06\/spring-boot-docker-image\/',
		locale: 'zh'
	};

	!function(e, n) {
		for (var o = 0; o < e.length; o++) {
			var r = n.createElement('script'),
			c = '.js',
			d = n.head || n.body;
			'noModule' in r ? (r.type = 'module', c = '.mjs') : r.async = !0, r.defer = !0, r.src = remark_config.host + '/web/' + e[o] + c, d.appendChild(r)
		}
	}(remark_config.components || ['embed'], document);

</script>





			</div>
			

<aside class="sidebar sidebar--right">
	<div class="post__toc toc">
		<div class="toc__title">目录</div>
		<div class="toc__menu">
			<nav id="TableOfContents">
  <ul>
    <li><a href="#手动创建-dockerfile">手动创建 Dockerfile</a></li>
    <li><a href="#使用-docker-init-创建-dockerfile">使用 Docker init 创建 Dockerfile</a></li>
    <li><a href="#使用-maven-插件">使用 Maven 插件</a>
      <ul>
        <li><a href="#jib-maven-plugin">jib-maven-plugin</a></li>
        <li><a href="#docker-maven-plugin">docker-maven-plugin</a></li>
        <li><a href="#spotify-docker-maven-plugin">Spotify Docker Maven Plugin</a></li>
        <li><a href="#kubernetes-maven-plugin">kubernetes-maven-plugin</a></li>
        <li><a href="#exec-maven-plugin">exec-maven-plugin</a></li>
      </ul>
    </li>
    <li><a href="#使用-spring-boot-maven-插件">使用 Spring Boot Maven 插件</a>
      <ul>
        <li><a href="#使用-buildpacks">使用 Buildpacks</a></li>
        <li><a href="#使用-layered-jar">使用 Layered Jar</a></li>
      </ul>
    </li>
    <li><a href="#使用-spring-boot-gradle-插件">使用 Spring Boot Gradle 插件</a></li>
    <li><a href="#使用-maven-镜像从源码运行">使用 Maven 镜像从源码运行</a>
      <ul>
        <li><a href="#使用-dockerfile">使用 dockerfile</a></li>
        <li><a href="#使用-docker-compose">使用 docker-compose</a></li>
      </ul>
    </li>
    <li><a href="#参考文章">参考文章</a></li>
  </ul>
</nav>
		</div>
	</div>
</aside>

		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
<div class="footer__links">
	<a class="footer__link" href="/">首页</a> | <a class="footer__link" href="/categories/">分类</a> | <a class="footer__link" href="/tags/">标签</a> | <a class="footer__link" href="/index.xml">订阅</a> | <a class="footer__link" href="/about/">关于</a>
</div>
		<div class="footer__copyright">
			&copy; 2025 ChenSoul.
			<span class="footer__copyright-credits">基于 <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> 引擎和 <a href="https://github.com/chensoul/rose-hugo/" rel="nofollow noopener" target="_blank">Rose Hugo</a> 主题</span>
		</div>
	</div>

	






<style>
	.scroll-up a {
		display: block;
		height: 3.125rem;
		width: 3.125rem;
		text-align: center;
		line-height: 2.7;
		border-radius: 50px;
		font-size: 1.125rem;
		color: #fff;
		opacity: 1;
		transition: all 0.3s ease 0s;
		box-shadow: 0 0 10px rgb(0 0 0 / 20%);
	}
	.scroll-up a {
		background: #ee591f;
	}
	.scroll-up {
		position: fixed;
		display: none;
		bottom: 50px;
		z-index: 999;
	}
	.scroll-up.right {
		right: 60px;
	}
</style>

<div class="scroll-up custom right" style="display: block;"><a href="#top" id="top-link" accesskey="g"><i
	class="fa fa-arrow-up"></i></a></div>

<script>
	var mybutton = document.getElementById("top-link");
	window.onscroll = function () {
		if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
			mybutton.style.visibility = "visible";
			mybutton.style.opacity = "1";
		} else {
			mybutton.style.visibility = "hidden";
			mybutton.style.opacity = "0";
		}
	};
</script>


    <script defer src="https://umami.chensoul.cc/random-string.js" data-website-id="1e07d36d-bec3-4ba6-9459-876b1ac3bbe7"></script>
</footer>


	</div>

	<script>
		'use strict';
		(function iifeMenu(document, window, undefined) {
			var menuBtn = document.querySelector('.menu__btn');
			var	menu = document.querySelector('.menu__list');
			function toggleMenu() {
				menu.classList.toggle('menu__list--active');
				menu.classList.toggle('menu__list--transition');
				this.classList.toggle('menu__btn--active');
				this.setAttribute(
					'aria-expanded',
					this.getAttribute('aria-expanded') === 'true' ? 'false' : 'true'
				);
			}
			function removeMenuTransition() {
				this.classList.remove('menu__list--transition');
			}
			if (menuBtn && menu) {
				menuBtn.addEventListener('click', toggleMenu, false);
				menu.addEventListener('transitionend', removeMenuTransition, false);
			}
		}(document, window));
	</script>
</body>
</html>