<!DOCTYPE html>
<html class="no-js" lang="zh-cn">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Gitlab安装和部署-使用Docker - Java、Spring、Spring Boot、MicroServices、Architecture、Kubernetes、DevOps</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	<meta property="og:title" content="Gitlab安装和部署-使用Docker">
	<meta property="og:description" content="Java、Spring、Spring Boot、MicroServices、Architecture、Kubernetes、DevOps">
	<meta property="og:type" content="article">
	<meta property="og:url" content="https://blog.chensoul.cc/posts/2024/06/26/install-gitlab/">
	<meta property="og:site_name" content="ChenSoul Blog">
	<meta property="og:image" content="">
	
  <meta itemprop="name" content="Gitlab安装和部署-使用Docker">
  <meta itemprop="description" content="安装 Gitlab 安装 gitlab-ce 版本，当前最新版本为 17.2.0">
  <meta itemprop="datePublished" content="2024-06-26T00:00:00+00:00">
  <meta itemprop="dateModified" content="2024-06-26T00:00:00+00:00">
  <meta itemprop="wordCount" content="2208">
  <meta itemprop="keywords" content="Docker,Javascript,Redis,Tutorial">
	<meta name="twitter:card" content="summary_large_image">
	<meta name="twitter:title" content="Gitlab安装和部署-使用Docker">
	<meta name="twitter:description" content="Java、Spring、Spring Boot、MicroServices、Architecture、Kubernetes、DevOps">
	<meta name="twitter:image" content="">

	<link rel="preconnect" href="//fonts.loli.net" crossorigin>
	<link rel="dns-prefetch" href="//fonts.loli.net">
	<link rel="stylesheet" href="https://fonts.loli.net/css?family=Open+Sans:400,400i,700">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" integrity="sha512-2SwdPD6INVrV/lHTZbO2nodKhrnDdJK9/kg2XD1r9uGqPo1cUbujc+IYdlYdEErWNu69gVcYgdxlmVmzTWnetw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
	<link rel="stylesheet" href="/css/style.css">

	<link rel="shortcut icon" href="/favicon.ico">
		
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo logo--mixed">
		<a class="logo__link" href="/" title="ChenSoul Blog" rel="home">
			<div class="logo__item logo__imagebox">
					<img class="logo__img" src="/logo.svg" loading="lazy" alt="Site logo" width="60" height="60">
				</div><div class="logo__item logo__text">
					<div class="logo__title">ChenSoul Blog</div>
					<div class="logo__tagline">Java、Spring、Spring Boot、MicroServices、Architecture、Kubernetes、DevOps</div>
				</div>
		</a>
	</div>
		
<nav class="menu">
	<button class="menu__btn" aria-haspopup="true" aria-expanded="false" tabindex="0">
		<span class="menu__btn-title" tabindex="-1">菜单</span>
	</button>
	<ul class="menu__list">
		<li class="menu__item">
			<a class="menu__link" href="/">
				
				<span class="menu__text">首页</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/categories/">
				
				<span class="menu__text">分类</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/tags/">
				
				<span class="menu__text">标签</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/index.xml">
				
				<span class="menu__text">订阅</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/about/">
				
				<span class="menu__text">关于</span>
				
			</a>
		</li>
	</ul>
</nav>

	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Gitlab安装和部署-使用Docker</h1>
			<div class="post__meta meta">
<div class="meta__item-datetime meta__item">
	<svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0a14 14 0 1 1 0 28 1 1 0 0 1 0-28m0 3a3 3 0 1 0 0 22 3 3 0 0 0 0-22m1 4h-2v8.4l6.8 4.4L22 18l-6-3.8z"/></svg><time class="meta__text" datetime="2024-06-26">2024-06-26</time></div><div class="meta__item-categories meta__item"><svg class="meta__icon icon icon-category" width="16" height="16" viewBox="0 0 16 16"><path d="m7 2 1 2h8v11H0V2z"/></svg><span class="meta__text"><a class="meta__link" href="/categories/devops/" rel="category">Devops</a>
	</span>
</div><div class="meta__item-tags meta__item"><svg class="meta__icon icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M4 0h8s2 0 4 2l15 15s2 2 0 4L21 31s-2 2-4 0L2 16s-2-2-2-4V3s0-3 4-3m3 10a3 3 0 0 0 0-6 3 3 0 0 0 0 6"/></svg><span class="meta__text"><a class="meta__link" href="/tags/docker/" rel="tag">Docker</a>, <a class="meta__link" href="/tags/javascript/" rel="tag">Javascript</a>, <a class="meta__link" href="/tags/redis/" rel="tag">Redis</a>, <a class="meta__link" href="/tags/tutorial/" rel="tag">Tutorial</a>
	</span>
</div>
</div>
		</header>
		
		<div class="content post__content clearfix">
			<h2 id="安装-gitlab">安装 Gitlab</h2>
<p>安装 gitlab-ce  版本，当前最新版本为  17.2.0</p>
<h3 id="配置-external_url">配置 external_url</h3>
<p>参考 <a href="https://docs.gitlab.com/ee/install/docker.html#install-gitlab-using-docker-compose" target="_blank">https://docs.gitlab.com/ee/install/docker.html#install-gitlab-using-docker-compose</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">services</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">gitlab</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">gitlab/gitlab-ce</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">container_name</span>: <span style="color:#ae81ff">gitlab</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">restart</span>: <span style="color:#ae81ff">always</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">hostname</span>: <span style="color:#e6db74">&#39;gitlab.example.com&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">environment</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">GITLAB_OMNIBUS_CONFIG</span>: |<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        external_url &#39;https://gitlab.example.com&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#39;80:80&#39;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#39;443:443&#39;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#39;22:22&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#39;/srv/gitlab/config://etc/gitlab&#39;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#39;/srv/gitlab/logs://var/log/gitlab&#39;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#39;/srv/gitlab/data://var/opt/gitlab&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">shm_size</span>: <span style="color:#e6db74">&#39;256m&#39;</span>
</span></span></code></pre></div><p>停止本地的 sshd 和 nginx 服务，避免 22 、80、443端口备占用：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>systemctl stop nginx
</span></span><span style="display:flex;"><span>systemctl stop sshd
</span></span></code></pre></div><p>启动 gitlab：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>export GITLAB_HOME<span style="color:#f92672">=</span>/srv/gitlab <span style="color:#f92672">&amp;&amp;</span> docker compose up -d
</span></span></code></pre></div><p>查看日志：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker logs -f gitlab
</span></span></code></pre></div><p>本地配置 /etc/host 文件：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>127.0.0.1 gitlab.example.com
</span></span></code></pre></div><p>打开浏览器访问：https://gitlab.example.com/ ，用户名 root，密码通过下面命令查看：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cat /srv/gitlab/config/initial_root_password
</span></span></code></pre></div><h3 id="修改默认端口">修改默认端口</h3>
<p>参考 <a href="https://github.com/hutchgrant/gitlab-docker-local/" target="_blank">https://github.com/hutchgrant/gitlab-docker-local/</a>，</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">services</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">gitlab</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">gitlab/gitlab-ce</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">container_name</span>: <span style="color:#ae81ff">gitlab</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">restart</span>: <span style="color:#ae81ff">always</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">hostname</span>: <span style="color:#e6db74">&#39;gitlab.example.com&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">environment</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">GITLAB_OMNIBUS_CONFIG</span>: |<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        external_url &#39;https://gitlab.example.com:3143&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        gitlab_rails[&#39;gitlab_shell_ssh_port&#39;] = 3122</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#39;3143:443&#39;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#39;3122:22&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#39;/srv/gitlab/config://etc/gitlab&#39;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#39;/srv/gitlab/logs://var/log/gitlab&#39;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#39;/srv/gitlab/data://var/opt/gitlab&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">shm_size</span>: <span style="color:#e6db74">&#39;256m&#39;</span>
</span></span></code></pre></div><h3 id="配置时区">配置时区</h3>
<p>进入容器，修改配置  /etc/gitlab/gitlab.rb：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 时区</span>
</span></span><span style="display:flex;"><span>gitlab_rails<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;time_zone&#39;</span><span style="color:#f92672">]</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Asia/Shanghai&#39;</span>
</span></span></code></pre></div><h3 id="解决头像显示异常问题">解决头像显示异常问题</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-toml" data-lang="toml"><span style="display:flex;"><span><span style="color:#75715e"># 解决头像显示异常问题</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">gitlab_rails</span>[<span style="color:#e6db74">&#39;gravatar_plain_url&#39;</span>] = <span style="color:#e6db74">&#39;http://cravatar.cn/avatar/%{hash}?s=%{size}&amp;d=identicon&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">gitlab_rails</span>[<span style="color:#e6db74">&#39;gravatar_ssl_url&#39;</span>] = <span style="color:#e6db74">&#39;https://cravatar.cn/avatar/%{hash}?s=%{size}&amp;d=identicon&#39;</span>
</span></span></code></pre></div><h3 id="关闭不需要的服务">关闭不需要的服务</h3>
<p>GitLab 默认提供了软件包仓库、容器仓库、软件依赖管理，这些可以使用 Nexus 代替</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-toml" data-lang="toml"><span style="display:flex;"><span><span style="color:#75715e"># 关闭容器仓库功能</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">gitlab_rails</span>[<span style="color:#e6db74">&#39;gitlab_default_projects_features_container_registry&#39;</span>] = <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">gitlab_rails</span>[<span style="color:#e6db74">&#39;registry_enabled&#39;</span>] = <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">registry</span>[<span style="color:#e6db74">&#39;enable&#39;</span>] = <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">registry_nginx</span>[<span style="color:#e6db74">&#39;enable&#39;</span>] = <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 关闭包仓库、依赖管理</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">gitlab_rails</span>[<span style="color:#e6db74">&#39;packages_enabled&#39;</span>] = <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">gitlab_rails</span>[<span style="color:#e6db74">&#39;dependency_proxy_enabled&#39;</span>] = <span style="color:#66d9ef">false</span>
</span></span></code></pre></div><p>关闭GitLab Pages：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-toml" data-lang="toml"><span style="display:flex;"><span><span style="color:#75715e"># 关闭GitLab Pages</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">gitlab_pages</span>[<span style="color:#e6db74">&#39;enable&#39;</span>] = <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">pages_nginx</span>[<span style="color:#e6db74">&#39;enable&#39;</span>] = <span style="color:#66d9ef">false</span>
</span></span></code></pre></div><p>关闭监控和性能基准相关功能：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-toml" data-lang="toml"><span style="display:flex;"><span><span style="color:#75715e">#关闭监控和性能基准相关功能</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">prometheus_monitoring</span>[<span style="color:#e6db74">&#39;enable&#39;</span>] = <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">alertmanager</span>[<span style="color:#e6db74">&#39;enable&#39;</span>] = <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">node_exporter</span>[<span style="color:#e6db74">&#39;enable&#39;</span>] = <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">redis_exporter</span>[<span style="color:#e6db74">&#39;enable&#39;</span>] = <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">postgres_exporter</span>[<span style="color:#e6db74">&#39;enable&#39;</span>] = <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">pgbouncer_exporter</span>[<span style="color:#e6db74">&#39;enable&#39;</span>] = <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">gitlab_exporter</span>[<span style="color:#e6db74">&#39;enable&#39;</span>] = <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">sidekiq</span>[<span style="color:#e6db74">&#39;metrics_enabled&#39;</span>] = <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 关闭使用统计</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">gitlab_rails</span>[<span style="color:#e6db74">&#39;usage_ping_enabled&#39;</span>] = <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">gitlab_rails</span>[<span style="color:#e6db74">&#39;sentry_enabled&#39;</span>] = <span style="color:#66d9ef">false</span>
</span></span></code></pre></div><p>关闭 KAS、Terraform、Mattermost：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-toml" data-lang="toml"><span style="display:flex;"><span><span style="color:#75715e"># GitLab KAS</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">gitlab_kas</span>[<span style="color:#e6db74">&#39;enable&#39;</span>] = <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">gitlab_rails</span>[<span style="color:#e6db74">&#39;gitlab_kas_enabled&#39;</span>] = <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Terraform</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">gitlab_rails</span>[<span style="color:#e6db74">&#39;terraform_state_enabled&#39;</span>] = <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Mattermost</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">mattermost</span>[<span style="color:#e6db74">&#39;enable&#39;</span>] = <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">mattermost_nginx</span>[<span style="color:#e6db74">&#39;enable&#39;</span>] = <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Kerberos</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">gitlab_rails</span>[<span style="color:#e6db74">&#39;kerberos_enabled&#39;</span>] = <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">sentinel</span>[<span style="color:#e6db74">&#39;enable&#39;</span>] = <span style="color:#66d9ef">false</span>
</span></span></code></pre></div><p>关闭电子邮件相关功能：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-toml" data-lang="toml"><span style="display:flex;"><span><span style="color:#75715e"># 关闭电子邮件相关功能</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">gitlab_rails</span>[<span style="color:#e6db74">&#39;smtp_enable&#39;</span>] = <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">gitlab_rails</span>[<span style="color:#e6db74">&#39;gitlab_email_enabled&#39;</span>] = <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">gitlab_rails</span>[<span style="color:#e6db74">&#39;incoming_email_enabled&#39;</span>] = <span style="color:#66d9ef">false</span>
</span></span></code></pre></div><h3 id="优化-puma-和--sidekiq">优化 PUMA 和  sidekiq</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># 禁用 PUMA 集群模式</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">puma[&#39;worker_processes&#39;] = 0</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">puma[&#39;min_threads&#39;] = 1</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">puma[&#39;max_threads&#39;] = 2</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 降低后台守护进程并发数</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">sidekiq[&#39;concurrency&#39;] = 5</span>
</span></span></code></pre></div><h3 id="优化-postgresql">优化 postgresql</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-toml" data-lang="toml"><span style="display:flex;"><span><span style="color:#75715e"># 减少 postgresql 数据库缓存</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">postgresql</span>[<span style="color:#e6db74">&#39;shared_buffers&#39;</span>] = <span style="color:#e6db74">&#34;128MB&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 减少 postgresql 数据库并发数量</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">postgresql</span>[<span style="color:#e6db74">&#39;max_connections&#39;</span>] = <span style="color:#ae81ff">60</span>
</span></span></code></pre></div><h3 id="使用自签名证书不建议">使用自签名证书（不建议）</h3>
<p>参考 <a href="https://github.com/danieleagle/gitlab-https-docker#generating-a-self-signed-certificate" target="_blank">https://github.com/danieleagle/gitlab-https-docker#generating-a-self-signed-certificate</a> ，生成服务端 key：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo openssl genrsa -out server-key.pem <span style="color:#ae81ff">4096</span>
</span></span></code></pre></div><p>生成服务端 csr：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo openssl req -new -key server-key.pem -out server.csr
</span></span></code></pre></div><p>生成服务端证书：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo openssl x509 -req -days <span style="color:#ae81ff">365</span> -in server.csr -signkey server-key.pem -out server-cert.pem
</span></span></code></pre></div><p>删除 csr 文件：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo rm server.csr
</span></span></code></pre></div><p>拷贝证书文件：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo mkdir -p /srv/gitlab/ssl
</span></span><span style="display:flex;"><span>sudo cp server-*.pem /srv/gitlab/ssl/
</span></span></code></pre></div><p>修改 docker-compose 文件，添加证书相关配置：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">services</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">gitlab</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">gitlab/gitlab-ce</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">container_name</span>: <span style="color:#ae81ff">gitlab</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">restart</span>: <span style="color:#ae81ff">always</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">hostname</span>: <span style="color:#e6db74">&#39;gitlab.example.com&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">environment</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">GITLAB_OMNIBUS_CONFIG</span>: |<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        external_url &#39;https://gitlab.example.com:3143&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        gitlab_rails[&#39;gitlab_shell_ssh_port&#39;] = 3122
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        nginx[&#39;listen_port&#39;] = 443
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        nginx[&#39;redirect_http_to_https&#39;] = true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        nginx[&#39;ssl_certificate&#39;] = &#34;/etc/ssl/certs/gitlab/server-cert.pem&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        nginx[&#39;ssl_certificate_key&#39;] = &#34;/etc/ssl/certs/gitlab/server-key.pem&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#39;3143:443&#39;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#39;3122:22&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#39;/srv/gitlab/config://etc/gitlab&#39;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#39;/srv/gitlab/logs://var/log/gitlab&#39;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#39;/srv/gitlab/data://var/opt/gitlab&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">shm_size</span>: <span style="color:#e6db74">&#39;256m&#39;</span>
</span></span></code></pre></div><p>为了从主机或网络上的其他地方的 gitlab 克隆，我们需要告诉 git 接受我们的自签名证书。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>git config --global http.<span style="color:#e6db74">&#34;https://gitlab.example.com:3143/&#34;</span>.sslCAInfo /srv/gitlab/ssl/server-cert.pem
</span></span></code></pre></div><h3 id="使用外部-nginx建议">使用外部 Nginx（建议）</h3>
<p>修改配置，禁用 nginx：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>services:
</span></span><span style="display:flex;"><span>  gitlab:
</span></span><span style="display:flex;"><span>    image: gitlab/gitlab-ce
</span></span><span style="display:flex;"><span>    container_name: gitlab
</span></span><span style="display:flex;"><span>    restart: always
</span></span><span style="display:flex;"><span>    hostname: <span style="color:#e6db74">&#39;gitlab.example.com&#39;</span>
</span></span><span style="display:flex;"><span>    environment:
</span></span><span style="display:flex;"><span>      GITLAB_OMNIBUS_CONFIG: |
</span></span><span style="display:flex;"><span>        external_url <span style="color:#e6db74">&#39;https://gitlab.example.com&#39;</span>
</span></span><span style="display:flex;"><span>        gitlab_rails<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;gitlab_shell_ssh_port&#39;</span><span style="color:#f92672">]</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">3122</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        gitlab_workhorse<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;listen_network&#39;</span><span style="color:#f92672">]</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;tcp&#34;</span>
</span></span><span style="display:flex;"><span>        gitlab_workhorse<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;listen_addr&#39;</span><span style="color:#f92672">]</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;0.0.0.0:8000&#34;</span>
</span></span><span style="display:flex;"><span>        nginx<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;enable&#39;</span><span style="color:#f92672">]</span> <span style="color:#f92672">=</span> false
</span></span><span style="display:flex;"><span>        unicorn<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;enable&#39;</span><span style="color:#f92672">]</span> <span style="color:#f92672">=</span> false
</span></span><span style="display:flex;"><span>    ports:
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#39;8000:8000&#39;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#39;3122:22&#39;</span>
</span></span><span style="display:flex;"><span>    volumes:
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#39;/srv/gitlab/config://etc/gitlab&#39;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#39;/srv/gitlab/logs://var/log/gitlab&#39;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#39;/srv/gitlab/data://var/opt/gitlab&#39;</span>
</span></span><span style="display:flex;"><span>    shm_size: <span style="color:#e6db74">&#39;256m&#39;</span>
</span></span></code></pre></div><p>本地配置 /etc/host 文件：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>127.0.0.1 gitlab.example.com
</span></span><span style="display:flex;"><span>127.0.0.1 gitlab-registry.example.com
</span></span></code></pre></div><p>安装 nginx ，为 gitlab.example.com 配置反向代理：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">map</span> $http_upgrade $connection_upgrade {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">default</span> <span style="color:#e6db74">upgrade</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#39;&#39;</span> <span style="color:#e6db74">close</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">server</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">listen</span> <span style="color:#ae81ff">80</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">server_name</span> <span style="color:#e6db74">gitlab.example.com</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">rewrite</span> <span style="color:#e6db74">^</span> <span style="color:#e6db74">https://</span>$http_host$request_uri? <span style="color:#e6db74">permanent</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">server</span> {
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">listen</span> <span style="color:#ae81ff">443</span> <span style="color:#e6db74">ssl</span>;
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">server_name</span> <span style="color:#e6db74">gitlab.example.com</span>;
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">ssl_certificate</span> <span style="color:#e6db74">/etc/nginx/ssl/server-cert.pem</span>;
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">ssl_certificate_key</span> <span style="color:#e6db74">/etc/nginx/ssl/server-key.pem</span>;
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">ssl_session_timeout</span> <span style="color:#ae81ff">5m</span>;
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">ssl_protocols</span> <span style="color:#e6db74">TLSv1</span> <span style="color:#e6db74">TLSv1.1</span> <span style="color:#e6db74">TLSv1.2</span>;
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">ssl_ciphers</span> <span style="color:#e6db74">ECDHE-RSA-AES128-GCM-SHA256:HIGH:!aNULL:!MD5:!RC4:!DHE</span>;
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">ssl_prefer_server_ciphers</span> <span style="color:#66d9ef">on</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">client_max_body_size</span> <span style="color:#e6db74">1g</span>;
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">access_log</span> <span style="color:#e6db74">/var/log/nginx/gitlab.log</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">location</span> <span style="color:#e6db74">/</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">proxy_pass</span>     <span style="color:#e6db74">http://127.0.0.1:8000</span>;
</span></span><span style="display:flex;"><span>				<span style="color:#f92672">proxy_read_timeout</span>  <span style="color:#ae81ff">90</span>;
</span></span><span style="display:flex;"><span>    		<span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">Host</span> $host;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">X-Real-IP</span> $remote_addr;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">X-Forwarded-For</span> $proxy_add_x_forwarded_for;
</span></span><span style="display:flex;"><span>    		<span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">X-Forwarded-Proto</span> $scheme;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    		<span style="color:#75715e"># Websocket connection
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">Upgrade</span> $http_upgrade;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">Connection</span> $connection_upgrade;
</span></span><span style="display:flex;"><span>     }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>拷贝证书文件到 /etc/nginx/ssl/ 目录：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo mkdir -p /etc/nginx/ssl/
</span></span><span style="display:flex;"><span>sudo cp server-*.pem /etc/nginx/ssl/
</span></span></code></pre></div><h3 id="使用外部-redis可选">使用外部 Redis（可选）</h3>
<p>参考 <a href="https://github.com/shamithmc/gitlab-docker/blob/master/doc/settings/redis.md#using-a-non-packaged-redis-instance" target="_blank">Using a non-packaged Redis instance</a>，进入容器，修改 /etc/gitlab/gitlab.rb</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>redis<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;enable&#39;</span><span style="color:#f92672">]</span> <span style="color:#f92672">=</span> false
</span></span><span style="display:flex;"><span>gitlab_rails<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;redis_host&#39;</span><span style="color:#f92672">]</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;x.x.x.x&#39;</span>
</span></span><span style="display:flex;"><span>gitlab_rails<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;redis_port&#39;</span><span style="color:#f92672">]</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">6379</span>
</span></span></code></pre></div><h3 id="使用外部-postgres可选">使用外部 Postgres（可选）</h3>
<p>参考 <a href="https://github.com/shamithmc/gitlab-docker/blob/master/doc/settings/database.md#using-a-non-packaged-postgresql-database-management-server" target="_blank">Using a non-packaged PostgreSQL database management server</a></p>
<p>在 Postgres 修改 <code>/var/lib/pgsql/data/pg_hba.conf</code> 令其支持密码登录</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-diff" data-lang="diff"><span style="display:flex;"><span> # &#34;local&#34; is for Unix domain socket connections only
</span></span><span style="display:flex;"><span> local   all             all                                     peer
</span></span><span style="display:flex;"><span> # IPv4 local connections:
</span></span><span style="display:flex;"><span><span style="color:#f92672">-host    all             all             127.0.0.1/32            ident
</span></span></span><span style="display:flex;"><span><span style="color:#f92672"></span><span style="color:#a6e22e">+host    all             all             127.0.0.1/32            md5
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e"></span> # IPv6 local connections:
</span></span><span style="display:flex;"><span><span style="color:#f92672">-host    all             all             ::1/128                 ident
</span></span></span><span style="display:flex;"><span><span style="color:#f92672"></span><span style="color:#a6e22e">+host    all             all             ::1/128                 md5
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e"></span> # Allow replication connections from localhost, by a user with the
</span></span><span style="display:flex;"><span> # replication privilege.
</span></span><span style="display:flex;"><span> local   replication     all                                     peer
</span></span></code></pre></div><p>数据库执行以下 sql 命令：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#75715e">-- 重新加载 pg_hba.conf
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">SELECT</span> pg_reload_conf();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- 创建 gitlab 角色
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">ROLE</span> gitlab <span style="color:#66d9ef">WITH</span> LOGIN SUPERUSER;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">ALTER</span> <span style="color:#66d9ef">ROLE</span> gitlab PASSWORD <span style="color:#e6db74">&#39;your-db-passwd&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- 创建 gitlabhq_production 数据库
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">DATABASE</span> gitlabhq_production <span style="color:#66d9ef">OWNER</span> gitlab;
</span></span></code></pre></div><p>其中，在 gitlab 安装阶段需要赋予其 <code>SUPERUSER</code> 权限，安装完成后可以将该权限去除:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">ALTER</span> <span style="color:#66d9ef">ROLE</span> gitlab <span style="color:#66d9ef">WITH</span> NOSUPERUSER;
</span></span></code></pre></div><p>进入容器，修改 /etc/gitlab/gitlab.rb</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>postgresql<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;enable&#39;</span><span style="color:#f92672">]</span> <span style="color:#f92672">=</span> false
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>gitlab_rails<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;db_adapter&#39;</span><span style="color:#f92672">]</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;postgresql&#39;</span>
</span></span><span style="display:flex;"><span>gitlab_rails<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;db_database&#39;</span><span style="color:#f92672">]</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;gitlabhq_production&#34;</span>
</span></span><span style="display:flex;"><span>gitlab_rails<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;db_encoding&#39;</span><span style="color:#f92672">]</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;utf8&#39;</span>
</span></span><span style="display:flex;"><span>gitlab_rails<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;db_host&#39;</span><span style="color:#f92672">]</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;x.x.x.x&#39;</span>
</span></span><span style="display:flex;"><span>gitlab_rails<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;db_port&#39;</span><span style="color:#f92672">]</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;5432&#39;</span>
</span></span><span style="display:flex;"><span>gitlab_rails<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;db_username&#39;</span><span style="color:#f92672">]</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;USERNAME&#39;</span>
</span></span><span style="display:flex;"><span>gitlab_rails<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;db_password&#39;</span><span style="color:#f92672">]</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;PASSWORD&#39;</span>
</span></span></code></pre></div><blockquote>
<p>数据库名称：gitlabhq_production</p></blockquote>
<p>使配置生效：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>gitlab-ctl reconfigure
</span></span></code></pre></div><p>设置数据库：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Remove &#39;sudo&#39; if you are the &#39;git&#39; user</span>
</span></span><span style="display:flex;"><span>sudo gitlab-rake gitlab:setup
</span></span></code></pre></div><h3 id="完整配置">完整配置</h3>
<p>修改默认端口，配置时区，关闭不需要的服务，优化数据库，使用外部 Nginx：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">services</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">gitlab</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">gitlab/gitlab-ce</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">container_name</span>: <span style="color:#ae81ff">gitlab</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">restart</span>: <span style="color:#ae81ff">always</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">hostname</span>: <span style="color:#e6db74">&#39;gitlab.wesine.com.cn&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">environment</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">GITLAB_OMNIBUS_CONFIG</span>: |<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        external_url &#39;https://gitlab.wesine.com.cn&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        gitlab_rails[&#39;gitlab_shell_ssh_port&#39;] = 3122
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        </span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e"># 使用外部 Niginx</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">gitlab_workhorse[&#39;listen_network&#39;] = &#34;tcp&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">gitlab_workhorse[&#39;listen_addr&#39;] = &#34;0.0.0.0:8000&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">nginx[&#39;enable&#39;] = false</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">unicorn[&#39;enable&#39;] = false</span>
</span></span><span style="display:flex;"><span>       
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 时区</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">gitlab_rails[&#39;time_zone&#39;] = &#39;Asia/Shanghai&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 解决头像显示异常问题</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">gitlab_rails[&#39;gravatar_plain_url&#39;] = &#39;http://gravatar.loli.net/avatar/%{hash}?s=%{size}&amp;d=identicon&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">gitlab_rails[&#39;gravatar_ssl_url&#39;] = &#39;https://gravatar.loli.net/avatar/%{hash}?s=%{size}&amp;d=identicon&#39;</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 关闭容器仓库功能</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">gitlab_rails[&#39;gitlab_default_projects_features_container_registry&#39;] = false</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">gitlab_rails[&#39;registry_enabled&#39;] = false</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">registry[&#39;enable&#39;] = false</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">registry_nginx[&#39;enable&#39;] = false</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 关闭包仓库、依赖管理</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">gitlab_rails[&#39;packages_enabled&#39;] = false</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">gitlab_rails[&#39;dependency_proxy_enabled&#39;] = false</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 关闭GitLab Pages</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">gitlab_pages[&#39;enable&#39;] = false</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">pages_nginx[&#39;enable&#39;] = false</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">#关闭监控和性能基准相关功能</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">prometheus_monitoring[&#39;enable&#39;] = false</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">alertmanager[&#39;enable&#39;] = false</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">node_exporter[&#39;enable&#39;] = false</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">redis_exporter[&#39;enable&#39;] = false</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">postgres_exporter[&#39;enable&#39;] = false</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">pgbouncer_exporter[&#39;enable&#39;] = false</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">gitlab_exporter[&#39;enable&#39;] = false</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">sidekiq[&#39;metrics_enabled&#39;] = false</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 关闭使用统计</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">gitlab_rails[&#39;usage_ping_enabled&#39;] = false</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">gitlab_rails[&#39;sentry_enabled&#39;] = false</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 关闭电子邮件相关功能</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">gitlab_rails[&#39;smtp_enable&#39;] = false</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">gitlab_rails[&#39;gitlab_email_enabled&#39;] = false</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">gitlab_rails[&#39;incoming_email_enabled&#39;] = false</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># GitLab KAS</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">gitlab_kas[&#39;enable&#39;] = false</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">gitlab_rails[&#39;gitlab_kas_enabled&#39;] = false</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Terraform</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">gitlab_rails[&#39;terraform_state_enabled&#39;] = false</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Mattermost</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">mattermost[&#39;enable&#39;] = false</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">mattermost_nginx[&#39;enable&#39;] = false</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Kerberos</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">gitlab_rails[&#39;kerberos_enabled&#39;] = false</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">sentinel[&#39;enable&#39;] = false</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 减少 postgresql 数据库缓存</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">postgresql[&#39;shared_buffers&#39;] = &#34;128MB&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 减少 postgresql 数据库并发数量</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">postgresql[&#39;max_connections&#39;] = 60</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 禁用 PUMA 集群模式</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">puma[&#39;worker_processes&#39;] = 0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">puma[&#39;min_threads&#39;] = 1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">puma[&#39;max_threads&#39;] = 2</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 降低后台守护进程并发数</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">sidekiq[&#39;concurrency&#39;] = 5</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#39;8000:8000&#39;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#39;3122:22&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#39;/srv/config://etc/gitlab&#39;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#39;/srv/logs://var/log/gitlab&#39;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#39;/srv/data://var/opt/gitlab&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">shm_size</span>: <span style="color:#e6db74">&#39;256m&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">gitlab-runner</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">gitlab/gitlab-runner:latest</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">container_name</span>: <span style="color:#ae81ff">gitlab-runner</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">restart</span>: <span style="color:#ae81ff">always</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#39;/srv/gitlab-runner://etc/gitlab-runner&#39;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#39;/var/run/docker.sock://var/run/docker.sock&#39;</span>
</span></span></code></pre></div><p>将上面文件保存为 gitlab.yaml，然后执行安装命令：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker compose -f gitlab.yaml up -d
</span></span></code></pre></div><p>启动成功之后，查看容器资源使用情况：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker stats
</span></span></code></pre></div><p>结果如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>CONTAINER ID   NAME            CPU %     MEM USAGE / LIMIT     MEM %     NET I/O          BLOCK I/O        PIDS
</span></span><span style="display:flex;"><span>f384149bfeab   gitlab          0.21%     2.028GiB / 31.26GiB   6.49%     756kB / 4.66MB   246kB / 12.2MB   <span style="color:#ae81ff">123</span>
</span></span><span style="display:flex;"><span>febd4b504da8   gitlab-runner   0.00%     21.61MiB / 31.26GiB   0.07%     54kB / 330kB     0B / 0B          <span style="color:#ae81ff">10</span>
</span></span></code></pre></div><h2 id="安装-gitlab-runner">安装 Gitlab Runner</h2>
<p>参考 <a href="https://xubiaosunny.top/post/gitlab_container_registry_and_auto_build_images_pfkb.html#%E9%83%A8%E7%BD%B2gitlab-runner" target="_blank">部署gitlab-runner</a>，在 docker-compose.yaml 文件中添加：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>  <span style="color:#f92672">gitlab-runner</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">gitlab/gitlab-runner</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">container_name</span>: <span style="color:#ae81ff">gitlab-runner</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">restart</span>: <span style="color:#ae81ff">always</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#39;/srv/gitlab-runner://etc/gitlab-runner&#39;</span>
</span></span></code></pre></div><p>在 管理中心 -&gt; CICD -&gt; Runner ，新建实例 Runner，标签名称设置为 docker-runner，记住 Runner 身份验证令牌</p>
<p>进入 github-runner：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker exec -it gitlab-runner bash
</span></span></code></pre></div><p>复制并粘贴以下命令到您的命令行中，注册 runner。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>gitlab-runner register --url https://gitlab.example.com --token glrt-JhEv5bxs4ezxY53uyYiz
</span></span></code></pre></div><ul>
<li><code>glrt-JhEv5bxs4ezxY53uyYiz</code> 为新建 Runner 实例时的 Runner 身份验证令牌</li>
</ul>
<p>如果提示：<code>couldn't execute POST against https://gitlab.example.com/api/v4/runners/verify: Post &quot;https://gitlab.example.com/api/v4/runners/verify&quot;: dial tcp 172.28.0.2:443: connect: connection refused</code>，原因是 gitlab.example.com 这个域名无法通过 DNS 解析。</p>
<p>解决办法两种：</p>
<ul>
<li>
<p>给该域名进行 DNS 解析，这个需要自己注册域名</p>
</li>
<li>
<p>通过 extra_hosts 添加域名映射，可以参考 <a href="https://gitee.com/xuxiaowei-com-cn/GitLab/blob/main/docker-compose.yml" target="_blank">https://gitee.com/xuxiaowei-com-cn/GitLab/blob/main/docker-compose.yml</a></p>
</li>
<li>
<p>自定义网络并添加别名，参考：https://github.com/hutchgrant/gitlab-docker-local/blob/master/docker-compose.yml</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">services</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">gitlab</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">gitlab/gitlab-ce</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">container_name</span>: <span style="color:#ae81ff">gitlab</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">restart</span>: <span style="color:#ae81ff">always</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">hostname</span>: <span style="color:#e6db74">&#39;gitlab.example.com&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">environment</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">GITLAB_OMNIBUS_CONFIG</span>: |<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        external_url &#39;https://gitlab.example.com&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        gitlab_rails[&#39;gitlab_shell_ssh_port&#39;] = 3122
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        gitlab_workhorse[&#39;listen_network&#39;] = &#34;tcp&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        gitlab_workhorse[&#39;listen_addr&#39;] = &#34;0.0.0.0:8000&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        nginx[&#39;enable&#39;] = false
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        unicorn[&#39;enable&#39;] = false
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        registry_external_url &#39;https://gitlab.example.com:4567&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        registry_nginx[&#39;enable&#39;] = false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#39;8000:8000&#39;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#39;3122:22&#39;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#39;4567:4567&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">networks</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">dev-net</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">aliases</span>:
</span></span><span style="display:flex;"><span>          - <span style="color:#ae81ff">gitlab.example.com</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#39;/srv/gitlab/config://etc/gitlab&#39;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#39;/srv/gitlab/logs://var/log/gitlab&#39;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#39;/srv/gitlab/data://var/opt/gitlab&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">shm_size</span>: <span style="color:#e6db74">&#39;256m&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">gitlab-runner</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">gitlab/gitlab-runner</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">container_name</span>: <span style="color:#ae81ff">gitlab-runner</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">restart</span>: <span style="color:#ae81ff">always</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#39;/srv/gitlab-runner://etc/gitlab-runner&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">networks</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">dev-net</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">networks</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">dev-net</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">external</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">name</span>: <span style="color:#ae81ff">development</span>
</span></span></code></pre></div></li>
<li>
<p>不使用域名，而是使用 IP:Port，例如：http://192.168.1.107:8000/</p>
</li>
</ul>
<h3 id="注册一个使用-docker-executor-的-runner">注册一个使用 Docker executor 的 runner</h3>
<p>参考 <a href="https://docs.gitlab.cn/jh/ci/docker/using_docker_build.html" target="_blank">使用 Docker 构建 Docker 镜像</a> 。要为 CI/CD 作业启用 Docker 命令，您可以使用：</p>
<ul>
<li><a href="https://docs.gitlab.cn/jh/ci/docker/using_docker_build.html#%e4%bd%bf%e7%94%a8-shell-executor" target="_blank">Shell executor</a></li>
<li><a href="https://docs.gitlab.cn/jh/ci/docker/using_docker_build.html#%e4%bd%bf%e7%94%a8-docker-in-docker" target="_blank">Docker-in-Docker</a></li>
<li><a href="https://docs.gitlab.cn/jh/ci/docker/using_docker_build.html#%e4%bd%bf%e7%94%a8-docker-%e5%a5%97%e6%8e%a5%e5%ad%97%e7%bb%91%e5%ae%9a" target="_blank">Docker 套接字绑定</a></li>
</ul>
<h4 id="使用-docker-in-docker">使用 Docker-in-Docker</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo gitlab-runner register <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>	--url https://gitlab.example.com <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>	--token glrt-JhEv5bxs4ezxY53uyYiz
</span></span><span style="display:flex;"><span>  --executor <span style="color:#e6db74">&#34;docker&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --docker-privileged <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --docker-image docker:stable 
</span></span></code></pre></div><p>编辑 /srv/gitlab/gitlab-runner/config.toml ，或者进入容器：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker exec -it gitlab-runner nano /etc/gitlab-runner/config.toml
</span></span></code></pre></div><p>修改 gitlab url 为 IP:Port，添加 maven 缓存，docker 缓存：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-toml" data-lang="toml"><span style="display:flex;"><span><span style="color:#a6e22e">concurrent</span> = <span style="color:#ae81ff">10</span> <span style="color:#75715e"># 并行执行作业数</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">check_interval</span> = <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">shutdown_timeout</span> = <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">connection_max_age</span> = <span style="color:#e6db74">&#34;15m0s&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[<span style="color:#a6e22e">session_server</span>]
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">session_timeout</span> = <span style="color:#ae81ff">1800</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[[<span style="color:#a6e22e">runners</span>]]
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">name</span> = <span style="color:#e6db74">&#34;runner&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">url</span> = <span style="color:#e6db74">&#34;http://192.168.1.107:8000/&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">token</span> = <span style="color:#e6db74">&#34;glrt-bEe2isyLds2kaxxS74hP&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">executor</span> = <span style="color:#e6db74">&#34;docker&#34;</span>
</span></span><span style="display:flex;"><span>  [<span style="color:#a6e22e">runners</span>.<span style="color:#a6e22e">cache</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">MaxUploadedArchiveSize</span> = <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>  [<span style="color:#a6e22e">runners</span>.<span style="color:#a6e22e">docker</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">tls_verify</span> = <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">image</span> = <span style="color:#e6db74">&#34;docker:latest&#34;</span> <span style="color:#75715e"># 配置默认镜像</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">privileged</span> = <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">disable_entrypoint_overwrite</span> = <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">oom_kill_disable</span> = <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">disable_cache</span> = <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">volumes</span> = [<span style="color:#e6db74">&#34;/root/.m2://root/.m2&#34;</span>] <span style="color:#75715e"># 配置挂载路径</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">shm_size</span> = <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">network_mtu</span> = <span style="color:#ae81ff">0</span>
</span></span></code></pre></div><p>重启 gitlab-runner：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker exec -it gitlab-runner gitlab-runner restart
</span></span></code></pre></div><h4 id="使用-docker-socket">使用 Docker Socket</h4>
<p>要使 Docker 在镜像上下文中可用，您需要将 <code>/var/run/docker.sock</code> 挂载到启动的容器中。要使用 Docker executor 执行此操作，您需要将 <code>&quot;/var/run/docker.sock://var/run/docker.sock&quot;</code> 添加到 <code>[runners.docker]</code> 部分的卷中。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo gitlab-runner register <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>	--url https://gitlab.example.com <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>	--token glrt-JhEv5bxs4ezxY53uyYiz
</span></span><span style="display:flex;"><span>  --executor <span style="color:#e6db74">&#34;docker&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --docker-image docker:latest <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --docker-volumes /var/run/docker.sock://var/run/docker.sock
</span></span></code></pre></div><p>修改 /srv/gitlab/gitlab-runner/config.toml ：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-toml" data-lang="toml"><span style="display:flex;"><span><span style="color:#a6e22e">concurrent</span> = <span style="color:#ae81ff">10</span> <span style="color:#75715e"># 并行执行作业数</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">check_interval</span> = <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">shutdown_timeout</span> = <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">connection_max_age</span> = <span style="color:#e6db74">&#34;15m0s&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[<span style="color:#a6e22e">session_server</span>]
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">session_timeout</span> = <span style="color:#ae81ff">1800</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[[<span style="color:#a6e22e">runners</span>]]
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">name</span> = <span style="color:#e6db74">&#34;runner&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">url</span> = <span style="color:#e6db74">&#34;http://192.168.1.107:8000/&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">token</span> = <span style="color:#e6db74">&#34;glrt-bEe2isyLds2kaxxS74hP&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">executor</span> = <span style="color:#e6db74">&#34;docker&#34;</span>
</span></span><span style="display:flex;"><span>  [<span style="color:#a6e22e">runners</span>.<span style="color:#a6e22e">cache</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">MaxUploadedArchiveSize</span> = <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>  [<span style="color:#a6e22e">runners</span>.<span style="color:#a6e22e">docker</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">tls_verify</span> = <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">image</span> = <span style="color:#e6db74">&#34;alpine:latest&#34;</span> <span style="color:#75715e"># 配置默认镜像</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">privileged</span> = <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">disable_entrypoint_overwrite</span> = <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">oom_kill_disable</span> = <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">disable_cache</span> = <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">pull_policy</span> = <span style="color:#e6db74">&#34;if-not-present&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">volumes</span> = [<span style="color:#e6db74">&#34;/etc/docker/daemon.json:ro&#34;</span>,<span style="color:#e6db74">&#34;/var/run/docker.sock&#34;</span>,<span style="color:#e6db74">&#34;/root/.m2://root/.m2&#34;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">shm_size</span> = <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">network_mtu</span> = <span style="color:#ae81ff">0</span>
</span></span></code></pre></div><p>说明：</p>
<ul>
<li>
<p>在 docker 执行器内是无法访问没有通过 DNS 解析的 gitlab 域名的。需要配置 host 文件，一种方式是挂载 /etc/hosts 文件，另一种方式是添加下面配置：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>    extra_hosts <span style="color:#f92672">=</span> <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;https://gitlab.example.com:192.168.1.107&#34;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>    network_mode <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;host&#34;</span>
</span></span></code></pre></div></li>
<li>
<p>配置 docker 镜像加速。将 github runner 容器中的 /etc/docker/daemon.json 挂载到 docker-in-docker 中，/etc/docker/daemon.json 内容如下：</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">&#34;registry-mirrors&#34;</span> : [
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;https://docker.1panel.live&#34;</span>
</span></span><span style="display:flex;"><span>   ]
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li>
<p>Maven 缓存。在 docker 容器挂载 /root/.m2目录。</p>
</li>
<li>
<p>Maven 镜像加速。在宿主机的 /root/.m2 目录下创建 settings.xml，使用阿里云 Maven 仓库。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#f92672">&lt;settings</span> <span style="color:#a6e22e">xmlns=</span><span style="color:#e6db74">&#34;http://maven.apache.org/SETTINGS/1.0.0&#34;</span> <span style="color:#a6e22e">xmlns:xsi=</span><span style="color:#e6db74">&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">xsi:schemaLocation=</span><span style="color:#e6db74">&#34;http://maven.apache.org/SETTINGS/1.0.0 https://maven.apache.org/xsd/settings-1.0.0.xsd&#34;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;mirrors&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;mirror&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&lt;id&gt;</span>alimaven<span style="color:#f92672">&lt;/id&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&lt;name&gt;</span>aliyun maven<span style="color:#f92672">&lt;/name&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&lt;url&gt;</span>http://maven.aliyun.com/nexus/content/groups/public/<span style="color:#f92672">&lt;/url&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&lt;mirrorOf&gt;</span>central<span style="color:#f92672">&lt;/mirrorOf&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/mirror&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;/mirrors&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/settings&gt;</span>
</span></span></code></pre></div></li>
</ul>
<h2 id="配置-gitlab">配置 Gitlab</h2>
<h3 id="实例配置">实例配置</h3>
<h4 id="默认语言实例">默认语言【实例】</h4>
<ul>
<li><code>管理中心</code> -&gt; <code>设置</code> -&gt; <code>偏好设置</code> -&gt; <code>本地化</code> -&gt; <code>默认语言</code> -&gt; <code>Chinese, Simplified - 简体中文</code></li>
<li><code>Admin Area</code> -&gt; <code>Settings</code> -&gt; <code>Preferences</code> -&gt; <code>Localization</code> -&gt; <code>Default language</code> -&gt; <code>Chinese, Simplified - 简体中文</code></li>
</ul>
<ol>
<li>仅对修改此配置后创建的新用户有效</li>
</ol>
<h4 id="默认语言用户">默认语言【用户】</h4>
<ul>
<li><code>偏好设置</code> -&gt; <code>本地化</code> -&gt; <code>语言</code> -&gt; <code>Chinese, Simplified - 简体中文</code></li>
<li><code>Preferences</code> -&gt; <code>Localization</code> -&gt; <code>Language</code> -&gt; <code>Chinese, Simplified - 简体中文</code></li>
</ul>
<h4 id="启用禁用允许用户注册">启用/禁用允许用户注册</h4>
<ul>
<li><code>管理中心</code> -&gt; <code>设置</code> -&gt; <code>通用</code> -&gt; <code>注册限制</code> -&gt; <code>已启用注册功能</code></li>
<li><code>Admin Area</code> -&gt; <code>Settings</code> -&gt; <code>General</code> -&gt; <code>Sign-up restrictions</code> -&gt; <code>Sign-up enabled</code></li>
</ul>
<h4 id="未登录用户重定向地址">未登录用户重定向地址</h4>
<ul>
<li><code>管理中心</code> -&gt; <code>设置</code> -&gt; <code>通用</code> -&gt; <code>登录限制</code> -&gt; <code>首页URL</code></li>
<li><code>Admin Area</code> -&gt; <code>Settings</code> -&gt; <code>General</code> -&gt; <code>Sign-in restrictions</code> -&gt; <code>Home page URL</code></li>
</ul>
<ol>
<li>将未经身份验证的用户定向到此页面。</li>
</ol>
<h4 id="限制新建项目可见性">限制新建项目可见性</h4>
<ul>
<li><code>管理中心</code> -&gt; <code>设置</code> -&gt; <code>通用</code> -&gt; <code>可见性与访问控制</code> -&gt; <code>限制可见性级别</code> -&gt; <code>公开</code></li>
<li><code>Admin Area</code> -&gt; <code>Settings</code> -&gt; <code>General</code> -&gt; <code>Visibility and access controls</code> -&gt; <code>Restricted visibility levels</code> -&gt; <code>Public</code></li>
</ul>
<ol>
<li>Private 私有：如果选中，只有管理员能够创建私有群组、项目和代码片段。</li>
<li>Internal 内部：如果选中，则只有管理员能够创建内部群组、项目和代码片段。</li>
<li>Public 公开：如果选中，则只有管理员能够创建公开群组、项目和片段。此外，个人资料仅对经过身份验证的用户可见。</li>
</ol>
<h4 id="自定义-git-访问协议">自定义 Git 访问协议</h4>
<ul>
<li><code>管理中心</code> -&gt; <code>设置</code> -&gt; <code>通用</code> -&gt; <code>可见性与访问控制</code> -&gt; <code>启用 Git 访问协议</code> -&gt; <code>Only HTTP(S)</code></li>
<li><code>Admin Area</code> -&gt; <code>Settings</code> -&gt; <code>General</code> -&gt; <code>Visibility and access controls</code> -&gt; <code>Enabled Git access protocols</code> -&gt; <code>Only HTTP(S)</code></li>
</ul>
<ol>
<li>Both SSH and HTTP(S)：可以使用 HTTP(S) 或 SSH 检出、推送代码</li>
<li>Only SSH：只能使用 SSH 检出、推送代码</li>
<li>Only HTTP(S)：只能使用 HTTP(S) 检出、推送代码</li>
</ol>
<h4 id="导入和导出设置">导入和导出设置</h4>
<ul>
<li><code>管理中心</code> -&gt; <code>设置</code> -&gt; <code>通用</code> -&gt; <code>导入源</code> -&gt; <code>GitHub、Bitbucket Cloud、Bitbucket Server、FogBugz、Repository by URL、GitLab export、Gitea、Manifest file、Gitee</code></li>
<li><code>Admin Area</code> -&gt; <code>Settings</code> -&gt; <code>General</code> -&gt; <code>Import and export settings</code> -&gt; <code>GitHub、Bitbucket Cloud、Bitbucket Server、FogBugz、Repository by URL、GitLab export、Gitea、Manifest file、Gitee</code></li>
</ul>
<h4 id="流水线计划的最大数量">流水线计划的最大数量</h4>
<ul>
<li><code>管理中心</code> -&gt; <code>设置</code> -&gt; <code>CI/CD</code> -&gt; <code>持续集成和部署</code> -&gt; <code>CI/CD 限制</code> -&gt; <code>流水线计划的最大数量</code></li>
<li><code>Admin Area</code> -&gt; <code>Settings</code> -&gt; <code>CI/CD</code> -&gt; <code>Continuous Integration and Deployment</code> -&gt; <code>CI/CD limits</code> -&gt; <code>Maximum number of pipeline schedules</code></li>
</ul>
<h4 id="实例级别环境变量">实例级别环境变量</h4>
<ul>
<li><code>管理中心</code> -&gt; <code>设置</code> -&gt; <code>CI/CD</code> -&gt; <code>变量</code> -&gt; <code>添加变量</code></li>
<li><code>Admin Area</code> -&gt; <code>Settings</code> -&gt; <code>CI/CD</code> -&gt; <code>Variables</code> -&gt; <code>Add variable</code></li>
</ul>
<table>
  <thead>
      <tr>
          <th>键</th>
          <th>值</th>
          <th>描述</th>
          <th>说明</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>SETTINGS_RAW_URL</code></td>
          <td><code>http://172.25.25.14:48081/repository/raw/settings.xml</code></td>
          <td>自建 Maven 私库的 settings.xml 配置文件</td>
          <td>使用 Nexus 搭建了一个 Maven 私库，包含了众多 Maven (镜像)仓库 ，用于加速依赖下载</td>
      </tr>
  </tbody>
</table>
<h3 id="修改初始密码">修改初始密码</h3>
<p>进入容器：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker exec -it gitlab bash
</span></span></code></pre></div><p>获取root用户密码：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cat /etc/gitlab/initial_root_password | grep Password
</span></span></code></pre></div><p>运行下面命令修改root默认密码为 <code>abcd1234!</code>：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ gitlab-rails console
</span></span><span style="display:flex;"><span>u<span style="color:#f92672">=</span>User.where<span style="color:#f92672">(</span>id:1<span style="color:#f92672">)</span>.first
</span></span><span style="display:flex;"><span>new_password<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;abcd1234!&#39;</span>
</span></span><span style="display:flex;"><span>u.password<span style="color:#f92672">=</span>new_password
</span></span><span style="display:flex;"><span>u.password_confirmation<span style="color:#f92672">=</span>new_password
</span></span><span style="display:flex;"><span>u.save!
</span></span><span style="display:flex;"><span>exit
</span></span></code></pre></div><h3 id="配置系统服务">配置系统服务</h3>
<p>脚本：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Create gitlab systemd service</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># First parameter is the linux account username you want the service run under</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Second parameter is the location of your gitlab docker-compose.yml</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Example:  $ sudo sh gitlab_service.sh LINUXUSER /home/youruser/gitlab-docker-local</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Description=Gitlab Service
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Requires=docker.service
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">After=docker.service
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Type=oneshot
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">RemainAfterExit=yes
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">User=</span>$1<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">WorkingDirectory=</span>$2<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStart=/usr/local/bin/docker-compose up -d
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStop=/usr/local/bin/docker-compose down
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">TimeoutStartSec=0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">WantedBy=multi-user.target&#34;</span> &gt; /etc/systemd/system/gitlab.service
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>systemctl start gitlab
</span></span><span style="display:flex;"><span>systemctl enable gitlab
</span></span></code></pre></div><blockquote>
<p>注意：该脚本依赖 Docker Service，所有需要先创建 Docker 系统服务。</p></blockquote>
<p>运行命令：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># sudo sh gitlab_service.sh LINUXUSER PATH_REPO_FOLDER</span>
</span></span><span style="display:flex;"><span>sudo sh gitlab_service.sh root /opt/docker/gitlab.yaml
</span></span></code></pre></div><h2 id="测试">测试</h2>
<h3 id="访问">访问</h3>
<p>访问 <a href="https://gitlab.example.com" target="_blank">https://gitlab.example.com</a>，修改默认密码，创建一个测试用户：test</p>
<h3 id="添加-ssh-key">添加 SSH Key</h3>
<p><a href="https://docs.gitlab.com/ce/ssh/README.html#generating-a-new-ssh-key-pair" target="_blank">Add</a> / <a href="https://docs.gitlab.com/ce/ssh/README.html#generating-a-new-ssh-key-pair" target="_blank">generate</a> a ssh key</p>
<pre tabindex="0"><code>tail ~/.ssh/id_rsa.pub
</code></pre><p>拷贝并保存到 <a href="https://gitlab.example.com/profile/keys" target="_blank">https://gitlab.example.com/profile/keys</a></p>
<h3 id="创建新项目">创建新项目</h3>
<p>创建一个项目 example ，克隆项目：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>git clone ssh://git@gitlab.example.com:3122/root/example.git
</span></span></code></pre></div><p>测试添加文件并提交：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cd example
</span></span><span style="display:flex;"><span>git add .
</span></span><span style="display:flex;"><span>git commit -m <span style="color:#e6db74">&#34;Initial commit&#34;</span>
</span></span><span style="display:flex;"><span>git push -u origin main
</span></span></code></pre></div><h2 id="备份">备份</h2>
<h3 id="备份数据">备份数据</h3>
<p>参考 <a href="https://docs.gitlab.com/ee/raketasks/backup_restore.html" target="_blank">Official Docs</a>，备份：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker exec -it gitlab gitlab-rake gitlab:backup:create
</span></span></code></pre></div><p>备份后的文件在 /srv/gitlab/data/backups/ ：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ ls -l --color<span style="color:#f92672">=</span>auto /srv/gitlab/data/backups/
</span></span><span style="display:flex;"><span>总用量 <span style="color:#ae81ff">532</span>
</span></span><span style="display:flex;"><span>-rw------- <span style="color:#ae81ff">1</span> chrony polkitd <span style="color:#ae81ff">542720</span> 7月  <span style="color:#ae81ff">12</span> 08:57 1720745862_2024_07_12_17.1.1_gitlab_backup.tar
</span></span></code></pre></div><h3 id="备份-gitlab-配置">备份 Gitlab 配置</h3>
<p>参考 <a href="https://docs.gitlab.com/omnibus/settings/backups.html" target="_blank">recommends storing the configuration backups seperate from your application backups</a>：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo sh -c <span style="color:#e6db74">&#39;umask 0077; tar cfz /data/backups/$(date &#34;+%s-gitlab-config.tgz&#34;) -C /srv/gitlab config ssl&#39;</span>
</span></span></code></pre></div><h3 id="备份-gitlab-runner-配置">备份 Gitlab Runner 配置</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo sh -c <span style="color:#e6db74">&#39;umask 0077; tar cfz /data/backups/$(date &#34;+%s-gitlab-runner-ssl.tgz&#34;) -C /srv/gitlab-runner .&#39;</span>
</span></span></code></pre></div><h3 id="定时备份">定时备份</h3>
<p>参考 <a href="https://github.com/hutchgrant/gitlab-docker-local/blob/master/gitlab_backup.sh" target="_blank">gitlab_backup.sh</a>，备份脚本：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>CONTAINER<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;gitlab&#34;</span>
</span></span><span style="display:flex;"><span>TARGET_DIR<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/data/backups&#34;</span>
</span></span><span style="display:flex;"><span>GITLAB_DIR<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/srv/gitlab&#34;</span>
</span></span><span style="display:flex;"><span>RUNNER_DIR<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/srv/gitlab-runner&#34;</span>
</span></span><span style="display:flex;"><span>REMOVE_DAYS<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>mkdir -p $TARGET_DIR
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Backup Application DATA</span>
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;Backing up GitLab application data&#34;</span>
</span></span><span style="display:flex;"><span>docker exec -t $CONTAINER gitlab-rake gitlab:backup:create
</span></span><span style="display:flex;"><span>cp -u $GITLAB_DIR/backups/. $TARGET_DIR/ -a
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Backup configurations, SSH keys, and SSL certs</span>
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;Backing up GitLab configurations, ssh keys, and ssl certs&#34;</span>
</span></span><span style="display:flex;"><span>sh -c <span style="color:#e6db74">&#34;umask 0077; tar cf </span>$TARGET_DIR<span style="color:#e6db74">/</span><span style="color:#66d9ef">$(</span>date <span style="color:#e6db74">&#34;+%s-gitlab-config.tar&#34;</span><span style="color:#66d9ef">)</span><span style="color:#e6db74"> -C </span>$GITLAB_DIR<span style="color:#e6db74"> config ssl&#34;</span> 
</span></span><span style="display:flex;"><span>sh -c <span style="color:#e6db74">&#34;umask 0077; tar cf </span>$TARGET_DIR<span style="color:#e6db74">/</span><span style="color:#66d9ef">$(</span>date <span style="color:#e6db74">&#34;+%s-gitlab-runner.tar&#34;</span><span style="color:#66d9ef">)</span><span style="color:#e6db74"> -C </span>$RUNNER_DIR<span style="color:#e6db74"> .&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Remove files older than x days </span>
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;Removing files older than </span>$REMOVE_DAYS<span style="color:#e6db74"> days&#34;</span>
</span></span><span style="display:flex;"><span>find $TARGET_DIR/*.tar -mtime $REMOVE_DAYS -exec rm <span style="color:#f92672">{}</span> <span style="color:#ae81ff">\;</span>
</span></span></code></pre></div><p>添加定时任务：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo crontab -e
</span></span></code></pre></div><p>添加脚本，每天早上 2 点定时执行：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ae81ff">0</span> <span style="color:#ae81ff">2</span> * * * sh /your/directory/gitlab_backup.sh
</span></span></code></pre></div><h2 id="还原">还原</h2>
<p>还原应用数据：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo cp /data/backups/1720746362_2024_07_12_17.1.1_gitlab_backup.tar /srv/gitlab/data/backups/
</span></span><span style="display:flex;"><span>docker exec -it gitlab sh -c <span style="color:#e6db74">&#39;chown git.git /var/opt/gitlab/backups/*.tar&#39;</span>
</span></span><span style="display:flex;"><span>docker exec -it gitlab gitlab-rake gitlab:backup:restore
</span></span></code></pre></div><p>还原配置文件：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo tar -xvf /data/backups/1720746535-gitlab-config.tar -C /srv/gitlab
</span></span><span style="display:flex;"><span>docker exec -it gitlab gitlab-ctl reconfigure
</span></span></code></pre></div><p>还原 Runner 配置文件：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo tar -xvf /data/backups/1720746535-gitlab-runner.tar -C /srv/gitlab-runner
</span></span><span style="display:flex;"><span>docker exec -it gitlab-runner gitlab-runner restart
</span></span></code></pre></div><p>重启：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker-compose restart
</span></span></code></pre></div><p>完整脚本：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>CONTAINER<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;gitlab&#34;</span>
</span></span><span style="display:flex;"><span>TARGET_DIR<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/srv/gitlab&#34;</span>
</span></span><span style="display:flex;"><span>RUNNER<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;gitlab-runner&#34;</span>
</span></span><span style="display:flex;"><span>RUNNER_DIR<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/srv/gitlab-runner&#34;</span>
</span></span><span style="display:flex;"><span>BACKUP_DIR<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/data/backups&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Restore application data</span>
</span></span><span style="display:flex;"><span>cp $BACKUP_DIR/*_gitlab_backup.tar $TARGET_DIR/data/backups/
</span></span><span style="display:flex;"><span>docker exec -it $CONTAINER sh -c <span style="color:#e6db74">&#39;chown git.git /var/opt/gitlab/backups/*.tar&#39;</span>
</span></span><span style="display:flex;"><span>docker exec -it $CONTAINER gitlab-rake gitlab:backup:restore
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Restore configurations, ssh keys, SSL</span>
</span></span><span style="display:flex;"><span>tar -xvf $BACKUP_DIR/*-gitlab-config.tar -C $TARGET_DIR
</span></span><span style="display:flex;"><span>docker exec -it $CONTAINER gitlab-ctl reconfigure
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Restore Gitlab Runner </span>
</span></span><span style="display:flex;"><span>tar -xvf $BACKUP_DIR/*-gitlab-runner.tar -C $RUNNER_DIR
</span></span><span style="display:flex;"><span>docker exec -it $RUNNER gitlab-runner restart
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Restart all containers</span>
</span></span><span style="display:flex;"><span>docker-compose restart
</span></span></code></pre></div><h2 id="升级">升级</h2>
<p>1、先备份相关文件，特别是数据库</p>
<p>2、修改 docker-compose 文件中 gitlab 版本</p>
<p>3、执行下面命令</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker compose pull
</span></span><span style="display:flex;"><span>docker compose up -d
</span></span></code></pre></div><h2></h2>
<h2 id="参考文章">参考文章</h2>
<ul>
<li><a href="https://techoverflow.net/2018/12/17/running-gitlab-ce-via-docker-behind-a-reverse-proxy-on-ubuntu/" target="_blank">Running Gitlab CE Via Docker Behind A Reverse Proxy On Ubuntu</a></li>
<li><a href="https://github.com/hutchgrant/gitlab-docker-local/" target="_blank">https://github.com/hutchgrant/gitlab-docker-local/</a></li>
<li><a href="https://gitee.com/xuxiaowei-com-cn/GitLab" target="_blank">https://gitee.com/xuxiaowei-com-cn/GitLab</a></li>
<li><a href="https://blog.csdn.net/tergou/article/details/120397845" target="_blank">Gitlab系列（3）—— 基于Gitlab-runner 的CI/CD集成</a></li>
</ul>

		</div>


	</article>
</main>
<footer class="post__footer">
	

<div class="post-related">
	<h3>相关文章</h3>
	<ul class="post-related-list">
		
		<li class="post-related-item">
			<a href="/posts/2024/06/26/install-jenkins/" target="_blank" title="Jenkins安装和部署-使用Docker">Jenkins安装和部署-使用Docker</a>
		</li>
		
		<li class="post-related-item">
			<a href="/posts/2024/06/25/install-nexus/" target="_blank" title="搭建本地Maven仓库Nexus">搭建本地Maven仓库Nexus</a>
		</li>
		
		<li class="post-related-item">
			<a href="/posts/2024/05/14/redis-install/" target="_blank" title="Redis安装和部署">Redis安装和部署</a>
		</li>
		
		<li class="post-related-item">
			<a href="/posts/2023/12/12/til/" target="_blank" title="2023-12-12｜RMI、Java漏洞安全、Semgrep漏洞检测">2023-12-12｜RMI、Java漏洞安全、Semgrep漏洞检测</a>
		</li>
		
		<li class="post-related-item">
			<a href="/posts/2023/06/01/python-wheels/" target="_blank" title="[译]什么是 Python Wheels，你为什么要关心它？">[译]什么是 Python Wheels，你为什么要关心它？</a>
		</li>
		
		<li class="post-related-item">
			<a href="/posts/2024/06/25/install-artifactory-oss/" target="_blank" title="搭建本地 Maven 仓库 Artifactory 开源版">搭建本地 Maven 仓库 Artifactory 开源版</a>
		</li>
		
	</ul>
</div>

</footer>

<footer class="post__footer">
	<footer class="post__footer">
		
<div class="post__tags tags clearfix">
	<svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M4 0h8s2 0 4 2l15 15s2 2 0 4L21 31s-2 2-4 0L2 16s-2-2-2-4V3s0-3 4-3m3 10a3 3 0 0 0 0-6 3 3 0 0 0 0 6"/></svg>
	<ul class="tags__list">
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/docker/" rel="tag">docker</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/javascript/" rel="tag">javascript</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/redis/" rel="tag">redis</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/tutorial/" rel="tag">tutorial</a>
		</li>
	</ul>
</div>
	</footer>
</footer>


<nav class="pagination flex">
	<div class="pagination__item pagination__item--prev">
		<a class="pagination__link" href="/posts/2024/06/26/install-jenkins/" rel="prev">
			<p class="pagination__title">«&thinsp;上一篇: Jenkins安装和部署-使用Docker</p>
		</a>
	</div>
	<div class="pagination__item pagination__item--next">
		<a class="pagination__link" href="/posts/2024/07/05/install-activemq/" rel="next">
			<p class="pagination__title">&thinsp;» 下一篇: ActiveMQ安装和使用</p>
		</a>
	</div>
</nav>



<div class="authorbox clearfix">
	<figure class="authorbox__avatar">
		<img alt="ChenSoul avatar" src="/avatar.jpg" class="avatar" height="60" width="60" loading="lazy">
	</figure>
	<div class="authorbox__header">
		<span class="authorbox__name">关于 ChenSoul</span>
	</div>
	<div class="authorbox__description">
		一个来自中国武汉的开发者，主要撰写软件开发和开源方面的文章。浏览我的<a href="%28/posts%29">博客文章</a>，订阅我的 <a href="/index.xml">RSS</a> 源，或了解更多<a href="/about/">关于我</a>的信息。
	</div>
</div>




	<p><h3>欢迎留言！</h3></p>
<div id="remark42"></div>
<script>
	var remark_config = {
		host: 'https:\/\/comment.chensoul.cc',
		site_id: 'remark',
		components: ['embed'],
		url: 'https:\/\/blog.chensoul.cc\/posts\/2024\/06\/26\/install-gitlab\/',
		locale: 'zh'
	};

	!function(e, n) {
		for (var o = 0; o < e.length; o++) {
			var r = n.createElement('script'),
			c = '.js',
			d = n.head || n.body;
			'noModule' in r ? (r.type = 'module', c = '.mjs') : r.async = !0, r.defer = !0, r.src = remark_config.host + '/web/' + e[o] + c, d.appendChild(r)
		}
	}(remark_config.components || ['embed'], document);

</script>





			</div>
			

<aside class="sidebar sidebar--right">
	<div class="post__toc toc">
		<div class="toc__title">目录</div>
		<div class="toc__menu">
			<nav id="TableOfContents">
  <ul>
    <li><a href="#安装-gitlab">安装 Gitlab</a>
      <ul>
        <li><a href="#配置-external_url">配置 external_url</a></li>
        <li><a href="#修改默认端口">修改默认端口</a></li>
        <li><a href="#配置时区">配置时区</a></li>
        <li><a href="#解决头像显示异常问题">解决头像显示异常问题</a></li>
        <li><a href="#关闭不需要的服务">关闭不需要的服务</a></li>
        <li><a href="#优化-puma-和--sidekiq">优化 PUMA 和  sidekiq</a></li>
        <li><a href="#优化-postgresql">优化 postgresql</a></li>
        <li><a href="#使用自签名证书不建议">使用自签名证书（不建议）</a></li>
        <li><a href="#使用外部-nginx建议">使用外部 Nginx（建议）</a></li>
        <li><a href="#使用外部-redis可选">使用外部 Redis（可选）</a></li>
        <li><a href="#使用外部-postgres可选">使用外部 Postgres（可选）</a></li>
        <li><a href="#完整配置">完整配置</a></li>
      </ul>
    </li>
    <li><a href="#安装-gitlab-runner">安装 Gitlab Runner</a>
      <ul>
        <li><a href="#注册一个使用-docker-executor-的-runner">注册一个使用 Docker executor 的 runner</a></li>
      </ul>
    </li>
    <li><a href="#配置-gitlab">配置 Gitlab</a>
      <ul>
        <li><a href="#实例配置">实例配置</a></li>
        <li><a href="#修改初始密码">修改初始密码</a></li>
        <li><a href="#配置系统服务">配置系统服务</a></li>
      </ul>
    </li>
    <li><a href="#测试">测试</a>
      <ul>
        <li><a href="#访问">访问</a></li>
        <li><a href="#添加-ssh-key">添加 SSH Key</a></li>
        <li><a href="#创建新项目">创建新项目</a></li>
      </ul>
    </li>
    <li><a href="#备份">备份</a>
      <ul>
        <li><a href="#备份数据">备份数据</a></li>
        <li><a href="#备份-gitlab-配置">备份 Gitlab 配置</a></li>
        <li><a href="#备份-gitlab-runner-配置">备份 Gitlab Runner 配置</a></li>
        <li><a href="#定时备份">定时备份</a></li>
      </ul>
    </li>
    <li><a href="#还原">还原</a></li>
    <li><a href="#升级">升级</a></li>
    <li></li>
    <li><a href="#参考文章">参考文章</a></li>
  </ul>
</nav>
		</div>
	</div>
</aside>

		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
<div class="footer__links">
	<a class="footer__link" href="/">首页</a> | <a class="footer__link" href="/categories/">分类</a> | <a class="footer__link" href="/tags/">标签</a> | <a class="footer__link" href="/index.xml">订阅</a> | <a class="footer__link" href="/about/">关于</a>
</div>
		<div class="footer__copyright">
			&copy; 2025 ChenSoul.
			<span class="footer__copyright-credits">基于 <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> 引擎和 <a href="https://github.com/chensoul/rose-hugo/" rel="nofollow noopener" target="_blank">Rose Hugo</a> 主题</span>
		</div>
	</div>

	






<style>
	.scroll-up a {
		display: block;
		height: 3.125rem;
		width: 3.125rem;
		text-align: center;
		line-height: 2.7;
		border-radius: 50px;
		font-size: 1.125rem;
		color: #fff;
		opacity: 1;
		transition: all 0.3s ease 0s;
		box-shadow: 0 0 10px rgb(0 0 0 / 20%);
	}
	.scroll-up a {
		background: #ee591f;
	}
	.scroll-up {
		position: fixed;
		display: none;
		bottom: 50px;
		z-index: 999;
	}
	.scroll-up.right {
		right: 60px;
	}
</style>

<div class="scroll-up custom right" style="display: block;"><a href="#top" id="top-link" accesskey="g"><i
	class="fa fa-arrow-up"></i></a></div>

<script>
	var mybutton = document.getElementById("top-link");
	window.onscroll = function () {
		if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
			mybutton.style.visibility = "visible";
			mybutton.style.opacity = "1";
		} else {
			mybutton.style.visibility = "hidden";
			mybutton.style.opacity = "0";
		}
	};
</script>


    <script defer src="https://umami.chensoul.cc/random-string.js" data-website-id="1e07d36d-bec3-4ba6-9459-876b1ac3bbe7"></script>
</footer>


	</div>

	<script>
		'use strict';
		(function iifeMenu(document, window, undefined) {
			var menuBtn = document.querySelector('.menu__btn');
			var	menu = document.querySelector('.menu__list');
			function toggleMenu() {
				menu.classList.toggle('menu__list--active');
				menu.classList.toggle('menu__list--transition');
				this.classList.toggle('menu__btn--active');
				this.setAttribute(
					'aria-expanded',
					this.getAttribute('aria-expanded') === 'true' ? 'false' : 'true'
				);
			}
			function removeMenuTransition() {
				this.classList.remove('menu__list--transition');
			}
			if (menuBtn && menu) {
				menuBtn.addEventListener('click', toggleMenu, false);
				menu.addEventListener('transitionend', removeMenuTransition, false);
			}
		}(document, window));
	</script>
</body>
</html>