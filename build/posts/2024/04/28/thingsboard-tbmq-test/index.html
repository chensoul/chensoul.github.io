<!DOCTYPE html>
<html class="no-js" lang="zh-cn">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>TBMQ测试和源码分析 - Java、Spring、Spring Boot、MicroServices、Architecture、Kubernetes、DevOps</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	<meta property="og:title" content="TBMQ测试和源码分析">
	<meta property="og:description" content="Java、Spring、Spring Boot、MicroServices、Architecture、Kubernetes、DevOps">
	<meta property="og:type" content="article">
	<meta property="og:url" content="https://blog.chensoul.cc/posts/2024/04/28/thingsboard-tbmq-test/">
	<meta property="og:site_name" content="ChenSoul Blog">
	<meta property="og:image" content="">
	
  <meta itemprop="name" content="TBMQ测试和源码分析">
  <meta itemprop="description" content="启动 TBMQ 程序，浏览器访问 http://localhost:8083，创建一个 Application，Credentials Type 为 BASIC，客户端 ID、用户名和密码均设置为 tbmq_app">
  <meta itemprop="datePublished" content="2024-04-28T00:00:00+00:00">
  <meta itemprop="dateModified" content="2024-04-28T00:00:00+00:00">
  <meta itemprop="wordCount" content="393">
  <meta itemprop="keywords" content="Javascript,React,Backend,Tutorial">
	<meta name="twitter:card" content="summary_large_image">
	<meta name="twitter:title" content="TBMQ测试和源码分析">
	<meta name="twitter:description" content="Java、Spring、Spring Boot、MicroServices、Architecture、Kubernetes、DevOps">
	<meta name="twitter:image" content="">

	<link rel="preconnect" href="//fonts.loli.net" crossorigin>
	<link rel="dns-prefetch" href="//fonts.loli.net">
	<link rel="stylesheet" href="https://fonts.loli.net/css?family=Open+Sans:400,400i,700">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" integrity="sha512-2SwdPD6INVrV/lHTZbO2nodKhrnDdJK9/kg2XD1r9uGqPo1cUbujc+IYdlYdEErWNu69gVcYgdxlmVmzTWnetw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
	<link rel="stylesheet" href="/css/style.css">

	<link rel="shortcut icon" href="/favicon.ico">
		
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo logo--mixed">
		<a class="logo__link" href="/" title="ChenSoul Blog" rel="home">
			<div class="logo__item logo__imagebox">
					<img class="logo__img" src="/logo.svg" loading="lazy" alt="Site logo" width="60" height="60">
				</div><div class="logo__item logo__text">
					<div class="logo__title">ChenSoul Blog</div>
					<div class="logo__tagline">Java、Spring、Spring Boot、MicroServices、Architecture、Kubernetes、DevOps</div>
				</div>
		</a>
	</div>
		
<nav class="menu">
	<button class="menu__btn" aria-haspopup="true" aria-expanded="false" tabindex="0">
		<span class="menu__btn-title" tabindex="-1">菜单</span>
	</button>
	<ul class="menu__list">
		<li class="menu__item">
			<a class="menu__link" href="/">
				
				<span class="menu__text">首页</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/categories/">
				
				<span class="menu__text">分类</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/tags/">
				
				<span class="menu__text">标签</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/index.xml">
				
				<span class="menu__text">订阅</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/about/">
				
				<span class="menu__text">关于</span>
				
			</a>
		</li>
	</ul>
</nav>

	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">TBMQ测试和源码分析</h1>
			<div class="post__meta meta">
<div class="meta__item-datetime meta__item">
	<svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0a14 14 0 1 1 0 28 1 1 0 0 1 0-28m0 3a3 3 0 1 0 0 22 3 3 0 0 0 0-22m1 4h-2v8.4l6.8 4.4L22 18l-6-3.8z"/></svg><time class="meta__text" datetime="2024-04-28">2024-04-28</time></div><div class="meta__item-categories meta__item"><svg class="meta__icon icon icon-category" width="16" height="16" viewBox="0 0 16 16"><path d="m7 2 1 2h8v11H0V2z"/></svg><span class="meta__text"><a class="meta__link" href="/categories/java/" rel="category">Java</a>
	</span>
</div><div class="meta__item-tags meta__item"><svg class="meta__icon icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M4 0h8s2 0 4 2l15 15s2 2 0 4L21 31s-2 2-4 0L2 16s-2-2-2-4V3s0-3 4-3m3 10a3 3 0 0 0 0-6 3 3 0 0 0 0 6"/></svg><span class="meta__text"><a class="meta__link" href="/tags/javascript/" rel="tag">Javascript</a>, <a class="meta__link" href="/tags/react/" rel="tag">React</a>, <a class="meta__link" href="/tags/backend/" rel="tag">Backend</a>, <a class="meta__link" href="/tags/tutorial/" rel="tag">Tutorial</a>
	</span>
</div>
</div>
		</header>
		
		<div class="content post__content clearfix">
			<ol>
<li>
<p>启动 TBMQ 程序，浏览器访问 http://localhost:8083，创建一个 Application，Credentials Type 为   BASIC，客户端 ID、用户名和密码均设置为 tbmq_app</p>
</li>
<li>
<p>使用 mosquitto 测试订阅消息</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mosquitto_sub -d -q <span style="color:#ae81ff">1</span> -h localhost -p <span style="color:#ae81ff">1883</span> -t tbmq/demo/+ -i <span style="color:#e6db74">&#39;tbmq_app&#39;</span> -u <span style="color:#e6db74">&#39;tbmq_app&#39;</span> -P <span style="color:#e6db74">&#39;tbmq_app&#39;</span> -c -v
</span></span></code></pre></div></li>
<li>
<p>Debug 调试 MqttSessionHandler 类的 <code>channelRead(ChannelHandlerContext ctx, Object msg)</code> 方法</p>
<ol>
<li>
<p>第一次连接，消息类型是 CONNECT</p>
<ul>
<li>
<p>消息：</p>
<ul>
<li>
<p>固定头：MqttFixedHeader[messageType=CONNECT, isDup=false, qosLevel=AT_MOST_ONCE, isRetain=false, remainingLength=40]</p>
</li>
<li>
<p>变量头：MqttConnectVariableHeader[name=MQTT, version=4, hasUserName=true, hasPassword=true, isWillRetain=false, isWillFlag=false, isCleanSession=false, keepAliveTimeSeconds=60]</p>
</li>
<li>
<p>负载：MqttConnectPayload[clientIdentifier=tbmq_app, willTopic=null, willMessage=null, userName=tbmq_app, password=[116, 98, 109, 113, 95, 97, 112, 112]]</p>
</li>
</ul>
</li>
<li>
<p>address 为空，故从 ChannelHandlerContext 获取客户端地址，并将地址保持到客户端 Session 上下文 ClientSessionCtx</p>
</li>
<li>
<p>初始化 Session：获取 clientI、mqtt 版本，调用 ClientMqttActorManager 初始化 session：创建 clientActorRef，发送一个 SessionInitMsg 消息</p>
</li>
<li>
<p>调用 ClientMqttActorManager connect 方法，发送一个 MqttConnectMsg 消息</p>
</li>
</ul>
</li>
<li>
<p>第二次连接，消息类型是 SUBSCRIBE</p>
<p>MqttSubscribeMessage[fixedHeader=MqttFixedHeader[messageType=SUBSCRIBE, isDup=false, qosLevel=AT_LEAST_ONCE, isRetain=false, remainingLength=16], variableHeader=MqttMessageIdAndPropertiesVariableHeader[messageId=1, properties=io.netty.handler.codec.mqtt.MqttProperties@15c52601], payload=MqttSubscribePayload[MqttTopicSubscription[topicFilter=tbmq/demo/+, option=SubscriptionOption[qos=AT_LEAST_ONCE, noLocal=false, retainAsPublished=false, retainHandling=SEND_AT_SUBSCRIBE]]]]</p>
</li>
<li>
<p>第三次连接，消息类型是 PINGREQ</p>
</li>
</ol>
</li>
</ol>
<h2 id="mqttsessionhandler">MqttSessionHandler</h2>
<p>第一次连接时，ClientMqttActorManagerImpl 初始化代码</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">initSession</span>(String clientId, <span style="color:#66d9ef">boolean</span> isClientIdGenerated, SessionInitMsg sessionInitMsg) {
</span></span><span style="display:flex;"><span>    TbActorRef clientActorRef <span style="color:#f92672">=</span> getActor(clientId);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (clientActorRef <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>        clientActorRef <span style="color:#f92672">=</span> createRootActor(clientId, isClientIdGenerated);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    clientActorRef.<span style="color:#a6e22e">tellWithHighPriority</span>(sessionInitMsg);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>可以看到：</p>
<ul>
<li>
<p>MqttSessionHandler 将消息的处理委托给了 ClientMqttActorManager 对象。ClientMqttActorManager使用了 Actor 模型。</p>
<ul>
<li>
<p>ClientMqttActorManager</p>
<ul>
<li>
<p>ActorSystemContext</p>
</li>
<li>
<p>TbActorSystem</p>
<ul>
<li>
<p>通过  ClientActorCreator 创建一个 TbActorCtx，其实是创建了一个 TbActorMailbox</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">private</span> TbActorRef <span style="color:#a6e22e">createRootActor</span>(String clientId, <span style="color:#66d9ef">boolean</span> isClientIdGenerated) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> actorSystem.<span style="color:#a6e22e">createRootActor</span>(ActorSystemLifecycle.<span style="color:#a6e22e">CLIENT_DISPATCHER_NAME</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">new</span> ClientActorCreator(actorSystemContext, clientId, isClientIdGenerated));
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
<li>
<p>ClientActorCreator 负责创建 ClientActor</p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p>NettyMqttConverter 负责将 MqttMessage 转换为 TbActorMsg。</p>
</li>
<li>
<p>clientActorRef.tellWithHighPriority 发送了一个高优先级的消息：<code>clientActorRef.tellWithHighPriority(sessionInitMsg)</code>。这个方法是 Actor 模型定义的方法，调用该方法意味着程序的执行进入了 Actor。关于 Actor 具体的执行逻辑，可以先忽略，主要关注 Actor 是在什么时候、怎么调用业务代码的（即如何处理 MQTT 消息的逻辑）。</p>
<ul>
<li>调用 TbActorMailbox的 enqueue(TbActorMsg msg, boolean highPriority)  方法
<ul>
<li>调用 tryProcessQueue(true);
<ul>
<li>调用 processMailbox() 方法
<ul>
<li>调用 actor.process(msg); 方法，这里的 actor 是由 ClientActorCreator 创建的 ClientActor
<ul>
<li>调用 ClientActor 的actor.process(msg); 方法
<ul>
<li>如果 TimedMsg 则 clientActorStats.logMsgQueueTime(msg, TimeUnit.NANOSECONDS);</li>
<li>clientLogger 记录事件</li>
<li>如果是队列消息 QueueableMqttMsg，调用 processQueueableMqttMsg((QueueableMqttMsg) msg); 方法</li>
<li>如果是其他消息：</li>
<li>SessionInitMsg：ActorProcessor
<ul>
<li>创建 AuthContext</li>
<li>调用 AuthResponse authenticateClient(AuthContext authContext)
<ul>
<li>调用 authenticationService.authenticate(authContext)
<ul>
<li>调用 MqttClientAuthProvider的authenticate(AuthContext authContext)
<ul>
<li>调用 BasicMqttClientAuthProvider
<ul>
<li>认证密码 BasicMqttCredentials</li>
<li>调用 authorizationRuleService.parseBasicAuthorizationRule(credentials) 获取 AuthRulePatterns</li>
<li>返回 AuthResponse</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>finishSessionAuth(state.getClientId(), sessionCtx, authResponse) ： ClientSessionCtx 保存客户端类型、authRulePatterns</li>
<li>更新 ClientActorState</li>
</ul>
</li>
<li>MQTT_CONNECT_MSG：
<ul>
<li>ConnectService startConnection
<ul>
<li>ClientSessionCtx 保存 SessionInfo</li>
<li>ClientSessionCtx 设置 TopicAliasCtx</li>
<li>KeepAliveService 注册 session</li>
<li>ClientSessionEventService requestConnection(SessionInfo sessionInfo)
<ul>
<li>发送 ClientSessionEventProto 到 MQ</li>
</ul>
</li>
</ul>
</li>
<li></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>​</p>
<p>MqttSessionHandler 类调用关系：</p>
<ul>
<li>
<p>MqttSessionHandler</p>
<ul>
<li>
<p>ClientMqttActorManager</p>
<ul>
<li>
<p>TbActorMailbox</p>
<ul>
<li>
<p>ContextAwareActor</p>
<ul>
<li>
<p>ClientActor</p>
<ul>
<li>
<p>1：SessionInitMsg</p>
<ul>
<li>ActorProcessor
<ul>
<li>AuthenticationService
<ul>
<li>MqttClientAuthProvider
<ul>
<li>MqttClientCredentialsService
<ul>
<li>MqttClientCredentialsDao</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>
<ol start="2">
<li>MqttConnectMsg</li>
</ol>
<ul>
<li>ConnectService
<ul>
<li>ClientSessionEventService
<ul>
<li>TbQueueProducer
<ul>
<li>ClientSessionEventConsumer
<ul>
<li>ClientSessionEventActorManager
<ul>
<li>TbActorRef</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>
<ol start="3">
<li>ConnectionRequestMsg</li>
</ol>
<ul>
<li>SessionClusterManager
<ul>
<li>ClientSessionService
<ul>
<li>ClientSessionPersistenceService
<ul>
<li>TbQueueProducer</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p>ConnectionAcceptedMsg</p>
<ul>
<li>ConnectService</li>
</ul>
</li>
<li>
<p>MqttDisconnectMsg</p>
<ul>
<li>DisconnectService</li>
</ul>
</li>
<li>
<p>SessionDisconnectedMsg</p>
<ul>
<li>SessionClusterManager
<ul>
<li>ClientSessionService</li>
<li>ClientSubscriptionService</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>MqttSessionHandler 是一个用于处理MQTT会话的Java类。它实现了<code>ChannelInboundHandlerAdapter</code>和<code>GenericFutureListener</code>接口，因此可以作为Netty框架中的处理组件。</p>
<p>实现原理：</p>
<ol>
<li>类中包含了一个<code>sessionId</code>，用于标识每个会话。sessionId是随机生成的UUID，每次会话开始时都会重新生成一个新的sessionId。</li>
<li>类中包含了各种处理MQTT消息的方法，例如<code>processMqttMsg</code>方法。这个方法会根据接收到的MQTT消息类型进行相应的处理。例如，当收到<code>CONNECT</code>消息时，会调用<code>initSession</code>方法初始化会话。当收到<code>PUBLISH</code>消息时，会检查速率限制并处理消息。</li>
<li><code>disconnect</code>方法用于断开与客户端的连接。当收到断开连接的消息时，会调用这个方法。这个方法会关闭客户端的通道，并发送一个MQTT断开连接消息给客户端。</li>
<li><code>getAddress</code>方法用于获取客户端的连接地址。这个方法会从上下文中获取客户端的地址，如果获取失败，会使用远程地址作为备选方案。</li>
<li><code>operationComplete</code>方法实现了<code>GenericFutureListener</code>接口的方法。当一个操作完成时，会调用这个方法。在这个方法中，会检查<code>clientId</code>是否为<code>null</code>，如果是，则断开连接，发送一个MQTT断开连接消息给客户端。</li>
<li><code>exceptionCaught</code>方法用于处理异常。当发生异常时，会调用这个方法。这个方法会记录异常信息，并断开连接。</li>
<li><code>channelReadComplete</code>方法用于刷新缓冲区。当一条消息读取完成时，会调用这个方法。</li>
<li><code>channelRead</code>方法是主要处理方法。当接收到数据时，会调用这个方法进行处理。这个方法会先检查<code>address</code>是否为<code>null</code>，如果是，则生成一个新的<code>address</code>。然后，会根据接收到的MQTT消息类型进行相应的处理。</li>
</ol>
<p><code>channelRead</code>方法用于处理来自网络通道的消息。具体来说，它处理的是MQTT协议的消息。MQTT是一种轻量级的通信协议，用于简化网络应用程序之间的通信。这段代码的主要作用是解析和处理来自客户端的MQTT消息。</p>
<p>实现原理：</p>
<ol>
<li>首先，代码检查address是否为null，如果是，则调用getAddress(ctx)获取客户端的地址，并将其设置到address变量中。同时，将address设置到clientSessionCtx中。这样可以方便地在日志中记录客户端的地址。</li>
<li>如果log.isTraceEnabled()为true，则记录下当前处理的消息，以便于调试和日志分析。</li>
<li>将ctx设置到clientSessionCtx中，这样后续的处理都可以通过clientSessionCtx来进行。</li>
<li>检查接收到的消息msg是否是MqttMessage类型。如果不是，则记录一条警告信息，并断开与客户端的连接。</li>
<li>如果消息msg的解码结果不成功，则记录一条警告信息，并断开与客户端的连接。如果消息msg的解码结果是TooLongFrameException异常，则断开连接的原因是ON_PACKET_TOO_LARGE，否则断开连接的原因是ON_MALFORMED_PACKET。</li>
<li>调用processMqttMsg方法处理MqttMessage类型的消息。</li>
<li>在处理消息后， finally 块中，通过ReferenceCountUtil.safeRelease(msg)释放消息msg的引用计数。</li>
</ol>
<p><code>processMqttMsg</code> 方法接收一个MqttMessage对象作为参数，然后根据消息的类型进行相应的处理。</p>
<p>实现原理：</p>
<ol>
<li>首先，它检查消息的固定头部是否为空，如果为空，则抛出一个协议违反异常。</li>
<li>接下来，它检查客户端ID（clientId）是否为空。如果是连接消息（CONNECT），则初始化会话（initSession方法）；否则，如果clientId为空，则抛出一个协议违反异常。</li>
<li>然后，它记录客户端日志（clientLogger）并使用一个switch语句根据消息类型进行相应的处理。</li>
</ol>
<p>用途：</p>
<p>这个方法主要用于处理MQTT消息，根据消息类型进行相应的处理。</p>
<p>例如，当收到CONNECT消息时，它需要初始化会话；收到SUBSCRIBE消息时，需要订阅topic；收到PUBLISH消息时，需要发布消息等。</p>
<h2 id="clientmqttactormanagerimpl">ClientMqttActorManagerImpl</h2>
<p>这个代码是一个Java实现的MQTT客户端 ActorSystem，用于处理MQTT消息。以下是这个代码的主要实现原理、用途和注意事项：</p>
<ol>
<li>实现原理：这个类使用了Akka框架的ActorSystem来处理MQTT消息。ActorSystem是一个用于组织和管理Akkaactor的层次结构。Actor是Akka的核心概念，它允许代码以消息传递的方式编写，从而实现并行和无阻塞的异步编程。在这个类中，ClientMqttActorManagerImpl作为管理器，负责创建、配置和控制Actor的创建和消息处理。</li>
<li>用途：这个类的主要用途是处理MQTT消息，特别是连接、断连、订阅和取消订阅等消息。通过这个类，客户端可以与ActorSystem通信，从而处理MQTT消息。</li>
</ol>
<blockquote>
<p>Akka 是一个用于开发并发应用程序的Java框架，它基于Akka Actor模型。ActorSystem是一个用于组织和管理Akkaactor的层次结构。Actor是Akka的核心概念，它允许代码以消息传递的方式编写，从而实现并行和无阻塞的异步编程。ActorSystem的主要作用是创建、配置和控制Actor的创建和消息处理。</p>
<p>在这个系统中，Actor是基本的通信单元。它们通过消息传递进行通信，而不是直接调用其他方法。这种设计允许代码以一种灵活的方式编写，从而适应并发编程的要求。ActorSystem的主要组件包括：</p>
<ol>
<li>Celluloid：这是一个用于协调并发行为的库，它提供了基本的线程安全和通信机制。</li>
<li>JSR 229：这是一个Java标准规范，它定义了一个用于处理消息的API。Akka使用JSR 229 API来实现Actor之间的通信。</li>
<li>ThreadPool：这是一个线程池，它用于在Actor系统中共享线程资源。这样可以提高性能，避免频繁创建和销毁线程。</li>
<li>Mailbox：这是一个消息存储结构，用于存储Actor收到的消息。Mailbox可以确保消息的安全性和顺序性。</li>
<li>ActorRef：这是一个引用，用于表示Actor的实例。ActorRef允许其他Actor通过其访问和操作Actor。</li>
<li>Manager：这是一个高级的Actor管理器，它负责创建、配置和控制Actor的创建和消息处理。</li>
<li>ActorSystem：这是一个全局的Actor系统，它负责管理所有的Actor和消息。</li>
</ol>
<p>总之，Akka框架的主要特性是并行编程，它通过ActorSystem来实现。ActorSystem是一个层次结构，由Actor组成，它们通过消息传递进行通信。这种设计使得代码易于理解和维护，同时满足并发编程的要求。</p></blockquote>
<h2 id="tbactormailbox">TbActorMailbox</h2>
<p>这个代码是一个实现高优先级消息处理的Java类。它主要用于在消息队列中处理高优先级消息，从而提高性能。以下是这个类的详细解释：</p>
<ol>
<li>定义了两个常量<code>HIGH_PRIORITY</code>和<code>NORMAL_PRIORITY</code>来表示高优先级和普通优先级。</li>
<li>定义了两个常量<code>FREE</code>和<code>BUSY</code>来表示邮箱的空闲状态和处理消息的状态。</li>
<li>定义了两个常量<code>NOT_READY</code>和<code>READY</code>来表示邮箱未准备好接收消息和已准备好接收消息的状态。</li>
<li>使用了<code>ConcurrentLinkedQueue</code>来存储消息，以提高性能。</li>
<li><code>initActor</code>方法用于初始化 Actor，它会将初始化任务分配给线程池执行。</li>
<li><code>enqueue</code>方法用于将消息添加到邮箱中，它会根据消息的优先级将消息添加到相应的队列中。</li>
<li><code>tryProcessQueue</code>方法用于处理消息，它会检查邮箱是否已准备好接收消息，是否在destroyInProgress中，以及是否还有消息需要处理。如果满足条件，它会调用<code>processMailbox</code>方法来处理消息。</li>
<li><code>processMailbox</code>方法用于处理消息，它会从队列中取出消息，并调用<code>actor.process</code>方法来处理消息。</li>
<li><code>getSelf</code>方法用于获取当前的ActorId。</li>
<li><code>tell</code>方法用于发送消息给子Actor，它会将消息发送给系统。</li>
<li><code>broadcastToChildren</code>方法用于向子Actor广播消息，它会将消息广播给系统中满足条件的子Actor。</li>
<li><code>filterChildren</code>方法用于过滤子Actor，它会返回满足条件的子Actor列表。</li>
<li><code>stop</code>方法用于停止Actor，它会将停止消息发送给系统。</li>
<li><code>getOrCreateChildActor</code>方法用于创建或获取子Actor，它会根据条件来创建或获取子Actor。</li>
<li><code>destroy</code>方法用于销毁Actor，它会设置<code>destroyInProgress</code>为true，然后销毁Actor。</li>
<li>实现了<code>TbActorId</code>接口，该接口定义了Actor的唯一标识。</li>
<li><code>tell</code>和<code>tellWithHighPriority</code>方法用于发送消息给子Actor，它会根据消息的优先级将消息添加到相应的队列中。</li>
</ol>
<p>通过实现这个类，可以在Actor系统中处理高优先级消息，从而提高性能。</p>
<p>MQ消息主题：</p>
<ul>
<li>tbmq.client.session
<ul>
<li>ClientSessionConsumer</li>
</ul>
</li>
<li>tbmq.client.subscriptions
<ul>
<li>ClientSubscriptionConsumer</li>
</ul>
</li>
<li>tbmq.client.session.event.request
<ul>
<li>ClientSessionEventConsumer</li>
</ul>
</li>
<li>tbmq.msg.persisted</li>
<li>tbmq.msg.retained
<ul>
<li>RetainedMsgConsumer</li>
</ul>
</li>
<li>tbmq.client.disconnect.chensoulMacBook.local
<ul>
<li>DisconnectClientCommandConsumer</li>
</ul>
</li>
<li>tbmq.client.session.event.response.chensoulMacBook.local</li>
<li>tbmq.msg.downlink.basic.chensoulMacBook.local</li>
<li>tbmq.msg.app.1b2512eca293401e8be2f7376becfb6273758da77822acc28f9debd557f1d97a</li>
<li>tbmq.sys.historical.data
<ul>
<li>HistoricalStatsTotalConsumer</li>
</ul>
</li>
</ul>

		</div>


	</article>
</main>
<footer class="post__footer">
	

<div class="post-related">
	<h3>相关文章</h3>
	<ul class="post-related-list">
		
		<li class="post-related-item">
			<a href="/posts/2023/09/22/react-create-project/" target="_blank" title="React入门：初始化应用的两种方法">React入门：初始化应用的两种方法</a>
		</li>
		
		<li class="post-related-item">
			<a href="/posts/2023/07/26/spring-boot-exception-handling/" target="_blank" title="[译]Spring Boot异常处理完整指南">[译]Spring Boot异常处理完整指南</a>
		</li>
		
		<li class="post-related-item">
			<a href="/posts/2023/06/21/modern-css-explained-for-dinosaurs/" target="_blank" title="[译]为恐龙解释现代CSS">[译]为恐龙解释现代CSS</a>
		</li>
		
		<li class="post-related-item">
			<a href="/posts/2023/06/20/modern-html-explained-for-dinosaurs/" target="_blank" title="[译]为恐龙解释现代HTML">[译]为恐龙解释现代HTML</a>
		</li>
		
		<li class="post-related-item">
			<a href="/posts/2023/06/19/modern-javascript-explained-for-dinosaurs/" target="_blank" title="[译]为恐龙解释现代JavaScript">[译]为恐龙解释现代JavaScript</a>
		</li>
		
		<li class="post-related-item">
			<a href="/posts/2023/05/18/jsr-166/" target="_blank" title="JSR 166规范">JSR 166规范</a>
		</li>
		
	</ul>
</div>

</footer>

<footer class="post__footer">
	<footer class="post__footer">
		
<div class="post__tags tags clearfix">
	<svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M4 0h8s2 0 4 2l15 15s2 2 0 4L21 31s-2 2-4 0L2 16s-2-2-2-4V3s0-3 4-3m3 10a3 3 0 0 0 0-6 3 3 0 0 0 0 6"/></svg>
	<ul class="tags__list">
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/javascript/" rel="tag">javascript</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/react/" rel="tag">react</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/backend/" rel="tag">backend</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/tutorial/" rel="tag">tutorial</a>
		</li>
	</ul>
</div>
	</footer>
</footer>


<nav class="pagination flex">
	<div class="pagination__item pagination__item--prev">
		<a class="pagination__link" href="/posts/2024/04/17/thingsboard-tbmq-local-docker-run/" rel="prev">
			<p class="pagination__title">«&thinsp;上一篇: ThingsBoard TBMQ本地和通过Docker运行</p>
		</a>
	</div>
	<div class="pagination__item pagination__item--next">
		<a class="pagination__link" href="/posts/2024/04/29/all-things-about-thingsboard/" rel="next">
			<p class="pagination__title">&thinsp;» 下一篇: All things about ThingsBoard</p>
		</a>
	</div>
</nav>



<div class="authorbox clearfix">
	<figure class="authorbox__avatar">
		<img alt="ChenSoul avatar" src="/avatar.jpg" class="avatar" height="60" width="60" loading="lazy">
	</figure>
	<div class="authorbox__header">
		<span class="authorbox__name">关于 ChenSoul</span>
	</div>
	<div class="authorbox__description">
		一个来自中国武汉的开发者，主要撰写软件开发和开源方面的文章。浏览我的<a href="%28/posts%29">博客文章</a>，订阅我的 <a href="/index.xml">RSS</a> 源，或了解更多<a href="/about/">关于我</a>的信息。
	</div>
</div>




	<p><h3>欢迎留言！</h3></p>
<div id="remark42"></div>
<script>
	var remark_config = {
		host: 'https:\/\/comment.chensoul.cc',
		site_id: 'remark',
		components: ['embed'],
		url: 'https:\/\/blog.chensoul.cc\/posts\/2024\/04\/28\/thingsboard-tbmq-test\/',
		locale: 'zh'
	};

	!function(e, n) {
		for (var o = 0; o < e.length; o++) {
			var r = n.createElement('script'),
			c = '.js',
			d = n.head || n.body;
			'noModule' in r ? (r.type = 'module', c = '.mjs') : r.async = !0, r.defer = !0, r.src = remark_config.host + '/web/' + e[o] + c, d.appendChild(r)
		}
	}(remark_config.components || ['embed'], document);

</script>





			</div>
			

<aside class="sidebar sidebar--right">
	<div class="post__toc toc">
		<div class="toc__title">目录</div>
		<div class="toc__menu">
			<nav id="TableOfContents">
  <ul>
    <li><a href="#mqttsessionhandler">MqttSessionHandler</a></li>
    <li><a href="#clientmqttactormanagerimpl">ClientMqttActorManagerImpl</a></li>
    <li><a href="#tbactormailbox">TbActorMailbox</a></li>
  </ul>
</nav>
		</div>
	</div>
</aside>

		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
<div class="footer__links">
	<a class="footer__link" href="/">首页</a> | <a class="footer__link" href="/categories/">分类</a> | <a class="footer__link" href="/tags/">标签</a> | <a class="footer__link" href="/index.xml">订阅</a> | <a class="footer__link" href="/about/">关于</a>
</div>
		<div class="footer__copyright">
			&copy; 2025 ChenSoul.
			<span class="footer__copyright-credits">基于 <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> 引擎和 <a href="https://github.com/chensoul/rose-hugo/" rel="nofollow noopener" target="_blank">Rose Hugo</a> 主题</span>
		</div>
	</div>

	






<style>
	.scroll-up a {
		display: block;
		height: 3.125rem;
		width: 3.125rem;
		text-align: center;
		line-height: 2.7;
		border-radius: 50px;
		font-size: 1.125rem;
		color: #fff;
		opacity: 1;
		transition: all 0.3s ease 0s;
		box-shadow: 0 0 10px rgb(0 0 0 / 20%);
	}
	.scroll-up a {
		background: #ee591f;
	}
	.scroll-up {
		position: fixed;
		display: none;
		bottom: 50px;
		z-index: 999;
	}
	.scroll-up.right {
		right: 60px;
	}
</style>

<div class="scroll-up custom right" style="display: block;"><a href="#top" id="top-link" accesskey="g"><i
	class="fa fa-arrow-up"></i></a></div>

<script>
	var mybutton = document.getElementById("top-link");
	window.onscroll = function () {
		if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
			mybutton.style.visibility = "visible";
			mybutton.style.opacity = "1";
		} else {
			mybutton.style.visibility = "hidden";
			mybutton.style.opacity = "0";
		}
	};
</script>


    <script defer src="https://umami.chensoul.cc/random-string.js" data-website-id="1e07d36d-bec3-4ba6-9459-876b1ac3bbe7"></script>
</footer>


	</div>

	<script>
		'use strict';
		(function iifeMenu(document, window, undefined) {
			var menuBtn = document.querySelector('.menu__btn');
			var	menu = document.querySelector('.menu__list');
			function toggleMenu() {
				menu.classList.toggle('menu__list--active');
				menu.classList.toggle('menu__list--transition');
				this.classList.toggle('menu__btn--active');
				this.setAttribute(
					'aria-expanded',
					this.getAttribute('aria-expanded') === 'true' ? 'false' : 'true'
				);
			}
			function removeMenuTransition() {
				this.classList.remove('menu__list--transition');
			}
			if (menuBtn && menu) {
				menuBtn.addEventListener('click', toggleMenu, false);
				menu.addEventListener('transitionend', removeMenuTransition, false);
			}
		}(document, window));
	</script>
</body>
</html>