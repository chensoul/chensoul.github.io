<!DOCTYPE html>
<html class="no-js" lang="zh-cn">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>[译]Spring Security 和 JWT 入门 - Java、Spring、Spring Boot、MicroServices、Architecture、Kubernetes、DevOps</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	<meta property="og:title" content="[译]Spring Security 和 JWT 入门">
	<meta property="og:description" content="Java、Spring、Spring Boot、MicroServices、Architecture、Kubernetes、DevOps">
	<meta property="og:type" content="article">
	<meta property="og:url" content="https://blog.chensoul.cc/posts/2024/10/15/spring-security-jwt/">
	<meta property="og:site_name" content="ChenSoul Blog">
	<meta property="og:image" content="">
	
  <meta itemprop="name" content="[译]Spring Security 和 JWT 入门">
  <meta itemprop="description" content="Spring Security 为 Java 应用程序提供了一套全面的安全功能，涵盖身份验证、授权、会话管理以及针对CSRF（跨站点请求伪造）等常见安全威胁的防护。Spring Security 框架具有高度可定制性，允许开发人员根据其应用程序需求来管理安全配置。它提供了一个灵活的架构，支持各种身份验证机制，如基本身份验证、JWT 和 OAuth。">
  <meta itemprop="datePublished" content="2024-10-15T00:00:00+00:00">
  <meta itemprop="dateModified" content="2024-10-15T00:00:00+00:00">
  <meta itemprop="wordCount" content="1779">
  <meta itemprop="keywords" content="Java,Javascript,Backend,Security">
	<meta name="twitter:card" content="summary_large_image">
	<meta name="twitter:title" content="[译]Spring Security 和 JWT 入门">
	<meta name="twitter:description" content="Java、Spring、Spring Boot、MicroServices、Architecture、Kubernetes、DevOps">
	<meta name="twitter:image" content="">

	<link rel="preconnect" href="//fonts.loli.net" crossorigin>
	<link rel="dns-prefetch" href="//fonts.loli.net">
	<link rel="stylesheet" href="https://fonts.loli.net/css?family=Open+Sans:400,400i,700">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" integrity="sha512-2SwdPD6INVrV/lHTZbO2nodKhrnDdJK9/kg2XD1r9uGqPo1cUbujc+IYdlYdEErWNu69gVcYgdxlmVmzTWnetw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
	<link rel="stylesheet" href="/css/style.css">

	<link rel="shortcut icon" href="/favicon.ico">
		
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo logo--mixed">
		<a class="logo__link" href="/" title="ChenSoul Blog" rel="home">
			<div class="logo__item logo__imagebox">
					<img class="logo__img" src="/logo.svg" loading="lazy" alt="Site logo" width="60" height="60">
				</div><div class="logo__item logo__text">
					<div class="logo__title">ChenSoul Blog</div>
					<div class="logo__tagline">Java、Spring、Spring Boot、MicroServices、Architecture、Kubernetes、DevOps</div>
				</div>
		</a>
	</div>
		
<nav class="menu">
	<button class="menu__btn" aria-haspopup="true" aria-expanded="false" tabindex="0">
		<span class="menu__btn-title" tabindex="-1">菜单</span>
	</button>
	<ul class="menu__list">
		<li class="menu__item">
			<a class="menu__link" href="/">
				
				<span class="menu__text">首页</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/categories/">
				
				<span class="menu__text">分类</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/tags/">
				
				<span class="menu__text">标签</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/index.xml">
				
				<span class="menu__text">订阅</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/about/">
				
				<span class="menu__text">关于</span>
				
			</a>
		</li>
	</ul>
</nav>

	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">[译]Spring Security 和 JWT 入门</h1>
			<div class="post__meta meta">
<div class="meta__item-datetime meta__item">
	<svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0a14 14 0 1 1 0 28 1 1 0 0 1 0-28m0 3a3 3 0 1 0 0 22 3 3 0 0 0 0-22m1 4h-2v8.4l6.8 4.4L22 18l-6-3.8z"/></svg><time class="meta__text" datetime="2024-10-15">2024-10-15</time></div><div class="meta__item-categories meta__item"><svg class="meta__icon icon icon-category" width="16" height="16" viewBox="0 0 16 16"><path d="m7 2 1 2h8v11H0V2z"/></svg><span class="meta__text"><a class="meta__link" href="/categories/spring-boot/" rel="category">Spring-Boot</a>
	</span>
</div><div class="meta__item-tags meta__item"><svg class="meta__icon icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M4 0h8s2 0 4 2l15 15s2 2 0 4L21 31s-2 2-4 0L2 16s-2-2-2-4V3s0-3 4-3m3 10a3 3 0 0 0 0-6 3 3 0 0 0 0 6"/></svg><span class="meta__text"><a class="meta__link" href="/tags/java/" rel="tag">Java</a>, <a class="meta__link" href="/tags/javascript/" rel="tag">Javascript</a>, <a class="meta__link" href="/tags/backend/" rel="tag">Backend</a>, <a class="meta__link" href="/tags/security/" rel="tag">Security</a>
	</span>
</div>
</div>
		</header>
		
		<div class="content post__content clearfix">
			<p><a href="https://docs.spring.io/spring-security/reference/index.html" target="_blank">Spring Security</a> 为 Java 应用程序提供了一套全面的安全功能，涵盖身份验证、授权、会话管理以及针对<a href="https://reflectoring.io/spring-csrf/" target="_blank">CSRF（跨站点请求伪造）</a>等常见安全威胁的防护。Spring Security 框架具有高度可定制性，允许开发人员根据其应用程序需求来管理安全配置。它提供了一个灵活的架构，支持各种身份验证机制，如基本身份验证、JWT 和 OAuth。</p>
<p>Spring Security 提供了开箱即用的基本身份验证。要了解其工作原理，请参阅<a href="https://reflectoring.io/spring-security/" target="_blank">本文</a>。在本文中，我们将深入探讨 JWT 的工作原理以及如何使用 Spring Security 对其进行配置。</p>
<h2 id="示例代码">示例代码</h2>
<p>本文附带了<a href="https://github.com/thombergs/code-examples/tree/master/spring-security-jwt/getting-started" target="_blank">GitHub </a>可用的代码示例。</p>
<h2 id="什么是-jwt">什么是 JWT</h2>
<p>JWT（JSON Web Token）是一种在双方之间传递 JSON 消息的安全方式。它是<a href="https://www.rfc-editor.org/rfc/rfc7519" target="_blank">RFC 7519</a>中定义的标准。JWT 令牌中包含的信息可以验证和信任，因为它是经过数字签名的。可以使用密钥（使用 HMAC 算法）或使用 RSA 或 ECDSA 的公钥/私钥对对 JWT 进行签名。</p>
<p>对于本文，我们将使用密钥创建一个 JWT 令牌，并使用它来保护我们的 REST 端点。</p>
<h2 id="jwt-结构">JWT 结构</h2>
<p>在本节中，我们将了解一个示例 JWT 结构。JSON Web Token 由三部分组成：</p>
<ul>
<li><strong>标头</strong></li>
<li><strong>有效载荷</strong></li>
<li><strong>签名</strong></li>
</ul>
<h3 id="jwt-标头">JWT 标头</h3>
<p>标头由两部分组成：令牌的类型（即 JWT）和正在使用的签名算法（如 HMAC SHA 256 或 RSA）。示例 JSON 标头：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;alg&#34;</span>: <span style="color:#e6db74">&#34;HS256&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;typ&#34;</span>: <span style="color:#e6db74">&#34;JWT&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>然后对此 JSON 进行 Base64 编码，从而形成 JWT 令牌的第一部分。</p>
<h3 id="jwt-有效负载">JWT 有效负载</h3>
<p>有效载荷是包含实际数据的主体。数据可以是用户数据或任何需要安全传输的信息。这些数据也称为<code>claims</code>。声明有三种类型：<strong>注册声明、公共声明和私有声明</strong>。</p>
<h4 id="已登记的索赔">已登记的索赔</h4>
<p>它们是一组预定义的三个字符声明，定义在<a href="https://datatracker.ietf.org/doc/html/rfc7519#section-4.1" target="_blank">RFC7519</a>中。一些常用的声明包括<strong>iss (Issuer Claim)</strong>、<strong>sub (Subject Claim)</strong>、<strong>aud (Audience Claim)</strong>、<strong>exp (Expiration Time Claim)</strong>、<strong>iat (Issued At Time)</strong>、<strong>nbf (Not Before)</strong>。让我们详细了解一下它们：</p>
<ul>
<li><strong>iss</strong>：此声明用于指定 JWT 的颁发者。它用于标识颁发令牌的实体，例如身份验证服务器或身份提供者。</li>
<li><strong>sub</strong>：此声明用于识别 JWT 的主题，即颁发令牌的用户或实体。</li>
<li><strong>aud</strong>：此声明用于指定 JWT 的目标受众。这通常用于限制令牌仅供某些服务或应用程序使用。</li>
<li><strong>exp</strong>：此声明用于指定 JWT 的过期时间，超过此时间后，令牌将不再有效。以自 Unix 纪元以来的秒数表示。</li>
<li><strong>iat</strong>：签发 JWT 的时间。可用于确定 JWT 的年龄。以自 Unix 纪元以来的秒数表示。</li>
<li><strong>nbf</strong>：标识在此之前 JWT 不能被接受处理的时间。</li>
</ul>
<p><a href="https://www.iana.org/assignments/jwt/jwt.xhtml#claims" target="_blank">在此处</a>查看已注册声明的完整列表。在后续章节中，我们将介绍几个如何使用它们的示例。</p>
<h4 id="公开声明">公开声明</h4>
<p>与已注册的、具有预定义含义的声明不同，这些声明可以根据应用程序的要求进行定制。大多数公开声明属于以下类别：</p>
<ul>
<li><strong>用户/客户端数据</strong>：包括用户名、客户端 ID、电子邮件、地址、角色、权限、范围、特权以及用于身份验证或授权的任何用户/客户端相关信息。</li>
<li><strong>应用程序数据</strong>：包括会话详细信息、用户偏好（例如语言偏好）、应用程序设置或任何应用程序特定的数据。</li>
<li><strong>安全信息</strong>：包括其他安全相关信息，如密钥、证书、令牌等。</li>
</ul>
<h4 id="私人索赔">私人索赔</h4>
<p>私有声明是特定于特定组织的自定义声明。它们不是由官方 JWT 规范标准化的，而是由参与 JWT 交换的各方定义的。</p>
<h4 id="jwt-声明推荐最佳实践">JWT 声明推荐最佳实践</h4>
<ul>
<li>尽可能使用 JWT 规范中定义的标准声明。它们被广泛认可并且具有明确的含义。</li>
<li>为了获得更好的可维护性，JWT 有效负载应该仅具有所需的最少声明，并限制令牌大小。</li>
<li>公共声明应该具有清晰且描述性的名称。</li>
<li>遵循一致的命名约定以保持一致性和可读性。</li>
<li>避免包含 PII 信息以最大限度地降低数据泄露的风险。</li>
<li>确保使用注册声明中指定<a href="https://www.iana.org/assignments/jose/jose.xhtml#web-signature-encryption-algorithms" target="_blank">的推荐算法</a>对 JWT 进行加密<code>alg</code>。声明<code>none</code>中的值<code>alg</code>表示 JWT 未签名且不推荐使用。</li>
</ul>
<h3 id="jwt-签名">JWT 签名</h3>
<p>为了创建签名，我们对标头进行编码，对有效负载进行编码，并使用密钥通过标头中指定的算法对元素进行签名。 <strong>生成的令牌将具有三个以点分隔的 Base64 URL 字符串。JWT</strong> 的图示如下所示：</p>
<p><img src="../../../static/images/spring-security-jwt-01.webp" alt="设置"></p>
<p>签名的目的是验证消息在传输过程中没有被更改。由于它们也使用密钥签名，因此可以验证 JWT 的发送者是否是其声称的那个人。</p>
<h2 id="jwt-的常见用例">JWT 的常见用例</h2>
<p>JWT 用途广泛，可用于如下所述的各种场景：</p>
<ul>
<li><strong>单点登录</strong>：JWT 允许跨多个服务或应用程序进行用户身份验证，从而实现单点登录 (SSO)。用户登录到一个应用程序后，会收到一个 JWT，该 JWT 可用于登录其他服务（用户有权访问），而无需输入/维护单独的登录凭据。</li>
<li><strong>API 身份验证</strong>：JWT 通常用于对 API 的访问进行身份验证和授权。客户端将 JWT 令牌包含在API 请求的<strong>授权</strong>标头中，以验证其对 API 的访问权限。然后，API 将解码 JWT 以授予或拒绝访问权限。</li>
<li><strong>无状态会话</strong>：JWT 有助于提供无状态会话管理，因为会话信息存储在令牌本身中。</li>
<li><strong>信息交换</strong>：由于 JWT 安全可靠，因此它们不仅可用于交换用户信息，还可用于交换任何需要在双方之间安全传输的信息。</li>
<li><strong>微服务</strong>：JWT 是微服务生态系统中最受欢迎的 API 通信方式之一，因为微服务可以独立验证令牌，而无需依赖外部身份验证服务器，从而更易于扩展。</li>
</ul>
<h2 id="使用-jwt-的注意事项">使用 JWT 的注意事项</h2>
<p>现在我们了解了 JWT 提供的好处，让我们看看使用 JWT 的缺点。这里的想法是让开发人员权衡手头的选项，并做出在应用程序中使用基于令牌的架构的明智决定。</p>
<ul>
<li>在 JWT 取代会话的情况下，如果我们最终使用较大的有效负载，JWT 令牌可能会膨胀。最重要的是，如果我们添加加密签名，则会导致整体性能开销。对于存储简单的用户会话来说，这最终会变得过度。</li>
<li>JWT 会以一定的时间间隔过期，过期后需要刷新令牌并生成新的令牌。从安全角度来看，这很好，但过期时间需要仔细考虑。例如，24 小时的过期时间是一个糟糕的设计考虑。</li>
</ul>
<p>现在，我们已经了解了重点，我们将能够就如何以及何时使用 JWT 做出明智的决定。在下一节中，我们将用 Java 创建一个简单的 JWT 令牌。</p>
<h2 id="使用-java-创建-jwt-令牌">使用 Java 创建 JWT 令牌</h2>
<p><a href="https://github.com/jwtk/jjwt" target="_blank">JJWT</a>是在 Java 和 Android 中创建 JWT 令牌最常用的 Java 库。我们将首先将其依赖项添加到我们的应用程序中。</p>
<h3 id="配置-jwt-依赖项">配置 JWT 依赖项</h3>
<p><em>Maven 依赖项：</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;groupId&gt;</span>io.jsonwebtoken<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;artifactId&gt;</span>jjwt-api<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;version&gt;</span>0.11.1<span style="color:#f92672">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;groupId&gt;</span>io.jsonwebtoken<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;artifactId&gt;</span>jjwt-impl<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;version&gt;</span>0.11.1<span style="color:#f92672">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;scope&gt;</span>runtime<span style="color:#f92672">&lt;/scope&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;groupId&gt;</span>io.jsonwebtoken<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;artifactId&gt;</span>jjwt-jackson<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;version&gt;</span>0.11.1<span style="color:#f92672">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;scope&gt;</span>runtime<span style="color:#f92672">&lt;/scope&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span></code></pre></div><p><em>Gradle 依赖性</em>：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span>compile <span style="color:#e6db74">&#39;io.jsonwebtoken:jjwt-api:0.11.1&#39;</span>
</span></span><span style="display:flex;"><span>runtime <span style="color:#e6db74">&#39;io.jsonwebtoken:jjwt-impl:0.11.1&#39;</span>
</span></span><span style="display:flex;"><span>runtime <span style="color:#e6db74">&#39;io.jsonwebtoken:jjwt-jackson:0.11.1&#39;</span>
</span></span></code></pre></div><p>我们的 Java 应用程序基于 Maven，因此我们将上述 Maven 依赖项添加到我们的<em>pom.xml</em>中。</p>
<h3 id="创建-jwt-令牌">创建 JWT 令牌</h3>
<p>我们将使用包<code>Jwts</code>中的类<code>io.jsonwebtoken</code>。我们可以指定声明（已注册和公开）和其他 JWT 属性，并创建一个令牌，如下所示：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> String <span style="color:#a6e22e">createJwt</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> Jwts.<span style="color:#a6e22e">builder</span>()
</span></span><span style="display:flex;"><span>                .<span style="color:#a6e22e">claim</span>(<span style="color:#e6db74">&#34;id&#34;</span>, <span style="color:#e6db74">&#34;abc123&#34;</span>)
</span></span><span style="display:flex;"><span>                .<span style="color:#a6e22e">claim</span>(<span style="color:#e6db74">&#34;role&#34;</span>, <span style="color:#e6db74">&#34;admin&#34;</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">//*.addClaims(Map.of(&#34;id&#34;, &#34;abc123&#34;,</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#e6db74">&#34;role&#34;</span>, <span style="color:#e6db74">&#34;admin&#34;</span>))<span style="color:#f92672">*/</span>
</span></span><span style="display:flex;"><span>                .<span style="color:#a6e22e">setIssuer</span>(<span style="color:#e6db74">&#34;TestApplication&#34;</span>)
</span></span><span style="display:flex;"><span>                .<span style="color:#a6e22e">setIssuedAt</span>(java.<span style="color:#a6e22e">util</span>.<span style="color:#a6e22e">Date</span>.<span style="color:#a6e22e">from</span>(Instant.<span style="color:#a6e22e">now</span>()))
</span></span><span style="display:flex;"><span>                .<span style="color:#a6e22e">setExpiration</span>(Date.<span style="color:#a6e22e">from</span>(Instant.<span style="color:#a6e22e">now</span>().<span style="color:#a6e22e">plus</span>(10, ChronoUnit.<span style="color:#a6e22e">MINUTES</span>)))
</span></span><span style="display:flex;"><span>                .<span style="color:#a6e22e">compact</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span></code></pre></div><p>此方法创建一个 JWT 令牌，如下所示：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>eyJhbGciOiJub25lIn0.eyJpZCI6ImFiYzEyMyIsInJvbGUiOiJhZG1pbiIsImlzcyI6IlR
</span></span><span style="display:flex;"><span>lc3RBcHBsaWNhdGlvbiIsImlhdCI6MTcxMTY2MTA1MiwiZXhwIjoxNzExNjYxNjUyfQ.
</span></span></code></pre></div><p>接下来我们看一下用于生成令牌的构建器方法：</p>
<ul>
<li><code>claim</code>：允许我们指定任意数量的自定义名称值对声明。我们还可以使用<code>addClaims</code>方法添加声明映射作为替代方案。</li>
<li><code>setIssuer</code>：此方法与已注册的权利要求相对应<code>iss</code>。</li>
<li><code>setIssuedAt</code>：此方法对应于已注册的声明<code>iat</code>。此方法以<code>java.util.Date</code>作为参数。这里我们将此值设置为当前时刻。</li>
<li><code>setExpiration</code>：此方法对应于已注册的声明<code>exp</code>。此方法以<code>java.util.Date</code>作为参数。这里我们将此值设置为从当前时刻开始的 10 分钟。</li>
</ul>
<p>让我们尝试使用在线<a href="https://jwt.is/" target="_blank">JWT 解码器</a>解码该 JWT ：</p>
<p><img src="../../../static/images/spring-security-jwt-02.webp" alt="设置"></p>
<p>如果我们仔细查看标头，我们会看到<code>alg:none</code>。这是因为我们没有指定要使用的任何算法。正如我们之前看到的，建议我们使用算法来生成签名。</p>
<p>因此，让我们在我们的方法中使用<strong>HMAC SHA256 算法</strong>：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> String <span style="color:#a6e22e">createJwt</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Recommended to be stored in Secret</span>
</span></span><span style="display:flex;"><span>        String secret <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;5JzoMbk6E5qIqHSuBTgeQCARtUsxAkBiHwdjXOSW8kWdXzYmP3X51C0&#34;</span>;
</span></span><span style="display:flex;"><span>        Key hmacKey <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> SecretKeySpec(Base64.<span style="color:#a6e22e">getDecoder</span>().<span style="color:#a6e22e">decode</span>(secret),
</span></span><span style="display:flex;"><span>                SignatureAlgorithm.<span style="color:#a6e22e">HS256</span>.<span style="color:#a6e22e">getJcaName</span>());
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> Jwts.<span style="color:#a6e22e">builder</span>()
</span></span><span style="display:flex;"><span>                .<span style="color:#a6e22e">claim</span>(<span style="color:#e6db74">&#34;id&#34;</span>, <span style="color:#e6db74">&#34;abc123&#34;</span>)
</span></span><span style="display:flex;"><span>                .<span style="color:#a6e22e">claim</span>(<span style="color:#e6db74">&#34;role&#34;</span>, <span style="color:#e6db74">&#34;admin&#34;</span>)
</span></span><span style="display:flex;"><span>                .<span style="color:#a6e22e">setIssuer</span>(<span style="color:#e6db74">&#34;TestApplication&#34;</span>)
</span></span><span style="display:flex;"><span>                .<span style="color:#a6e22e">setIssuedAt</span>(java.<span style="color:#a6e22e">util</span>.<span style="color:#a6e22e">Date</span>.<span style="color:#a6e22e">from</span>(Instant.<span style="color:#a6e22e">now</span>()))
</span></span><span style="display:flex;"><span>                .<span style="color:#a6e22e">setExpiration</span>(Date.<span style="color:#a6e22e">from</span>(Instant.<span style="color:#a6e22e">now</span>().<span style="color:#a6e22e">plus</span>(10, ChronoUnit.<span style="color:#a6e22e">MINUTES</span>)))
</span></span><span style="display:flex;"><span>                .<span style="color:#a6e22e">signWith</span>(hmacKey)
</span></span><span style="display:flex;"><span>                .<span style="color:#a6e22e">compact</span>();
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><p>生成的令牌结果如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>eyJthbGciOiJIUzI1NiJ9.eyJpZCI6ImFiYzEyMyIsInJvbGUiOiJhZG1pbiIsImlz
</span></span><span style="display:flex;"><span>cyI6IlRlc3RBcHBsaWNhdGlvbiIsImlhdCI6MTcxMjMyODQzMSwiZXhwIjoxNzEyMzI5MDMxfQ.
</span></span><span style="display:flex;"><span>pj9AvbLtwITqBYazDnaTibCLecM-cQ5RAYw2YYtkyeA
</span></span></code></pre></div><p>解码此 JWT 可得到：</p>
<p><img src="../../../static/images/spring-security-jwt-03.webp" alt="设置"></p>
<h3 id="解析-jwt-令牌">解析 JWT 令牌</h3>
<p>现在我们已经创建了 JWT，让我们看看如何解析令牌以提取声明。只有当我们知道最初用于创建 JWT 的密钥时，我们才能解析令牌。以下代码可用于实现此目的：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> Jws<span style="color:#f92672">&lt;</span>Claims<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">parseJwt</span>(String jwtString) {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Recommended to be stored in Secret</span>
</span></span><span style="display:flex;"><span>        String secret <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;5JzoMbk6E5qIqHSuBTgeQCARtUsxAkBiHwdjXOSW8kWdXzYmP3X51C0&#34;</span>;
</span></span><span style="display:flex;"><span>        Key hmacKey <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> SecretKeySpec(Base64.<span style="color:#a6e22e">getDecoder</span>().<span style="color:#a6e22e">decode</span>(secret),
</span></span><span style="display:flex;"><span>                SignatureAlgorithm.<span style="color:#a6e22e">HS256</span>.<span style="color:#a6e22e">getJcaName</span>());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        Jws<span style="color:#f92672">&lt;</span>Claims<span style="color:#f92672">&gt;</span> jwt <span style="color:#f92672">=</span> Jwts.<span style="color:#a6e22e">parserBuilder</span>()
</span></span><span style="display:flex;"><span>                .<span style="color:#a6e22e">setSigningKey</span>(hmacKey)
</span></span><span style="display:flex;"><span>                .<span style="color:#a6e22e">build</span>()
</span></span><span style="display:flex;"><span>                .<span style="color:#a6e22e">parseClaimsJws</span>(jwtString);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> jwt;
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><p>这里，该方法<code>parseJwt</code>将 JWT 令牌作为字符串参数。使用相同的密钥（用于创建令牌），可以解析此令牌以检索声明。可以使用以下测试来验证这一点：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Test</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">testParseJwtClaims</span>() {
</span></span><span style="display:flex;"><span>        String jwtToken <span style="color:#f92672">=</span> JWTCreator.<span style="color:#a6e22e">createJwt</span>();
</span></span><span style="display:flex;"><span>        assertNotNull(jwtToken);
</span></span><span style="display:flex;"><span>        Jws<span style="color:#f92672">&lt;</span>Claims<span style="color:#f92672">&gt;</span> claims <span style="color:#f92672">=</span> JWTCreator.<span style="color:#a6e22e">parseJwt</span>(jwtToken);
</span></span><span style="display:flex;"><span>        assertNotNull(claims);
</span></span><span style="display:flex;"><span>        Assertions.<span style="color:#a6e22e">assertAll</span>(
</span></span><span style="display:flex;"><span>                () <span style="color:#f92672">-&gt;</span> assertNotNull(claims.<span style="color:#a6e22e">getSignature</span>()),
</span></span><span style="display:flex;"><span>                () <span style="color:#f92672">-&gt;</span> assertNotNull(claims.<span style="color:#a6e22e">getHeader</span>()),
</span></span><span style="display:flex;"><span>                () <span style="color:#f92672">-&gt;</span> assertNotNull(claims.<span style="color:#a6e22e">getBody</span>()),
</span></span><span style="display:flex;"><span>                () <span style="color:#f92672">-&gt;</span> assertEquals(claims.<span style="color:#a6e22e">getHeader</span>().<span style="color:#a6e22e">getAlgorithm</span>(), <span style="color:#e6db74">&#34;HS256&#34;</span>),
</span></span><span style="display:flex;"><span>                () <span style="color:#f92672">-&gt;</span> assertEquals(claims.<span style="color:#a6e22e">getBody</span>().<span style="color:#a6e22e">get</span>(<span style="color:#e6db74">&#34;id&#34;</span>), <span style="color:#e6db74">&#34;abc123&#34;</span>),
</span></span><span style="display:flex;"><span>                () <span style="color:#f92672">-&gt;</span> assertEquals(claims.<span style="color:#a6e22e">getBody</span>().<span style="color:#a6e22e">get</span>(<span style="color:#e6db74">&#34;role&#34;</span>), <span style="color:#e6db74">&#34;admin&#34;</span>),
</span></span><span style="display:flex;"><span>                () <span style="color:#f92672">-&gt;</span> assertEquals(claims.<span style="color:#a6e22e">getBody</span>().<span style="color:#a6e22e">getIssuer</span>(), <span style="color:#e6db74">&#34;TestApplication&#34;</span>)
</span></span><span style="display:flex;"><span>        );
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><p>有关可用解析方法的完整列表，请参阅<a href="https://javadoc.io/doc/io.jsonwebtoken/jjwt-api/0.11.2/io/jsonwebtoken/JwtParser.html" target="_blank">文档</a>。</p>
<h3 id="spring-security-中基本身份验证和-jwt-的比较">Spring Security 中基本身份验证和 JWT 的比较</h3>
<p>在深入研究示例 Spring Boot 应用程序中 JWT 的实现之前，让我们先看看 BasicAuth 和 JWT 之间的几个比较点。</p>
<table>
  <thead>
      <tr>
          <th>比较依据</th>
          <th>基本身份验证</th>
          <th>智威汤逊</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><strong>授权标头</strong></td>
          <td>示例基本身份验证标头：<strong>Authorization：Basic xxx</strong>。</td>
          <td>示例 JWT 标头：<strong>Authorization：Bearer xxx</strong>。</td>
      </tr>
      <tr>
          <td><strong>有效期和到期日</strong></td>
          <td>基本身份验证凭据只需配置一次，每次请求都需要传递相同的凭据。它永不过期。</td>
          <td>使用 JWT 令牌，我们可以使用<code>exp</code>已注册的声明来设置有效性/到期时间，之后令牌将抛出一个<code>io.jsonwebtoken.ExpiredJwtException</code>。由于令牌有效期较短，这使得 JWT 更加安全。用户必须重新发送请求才能生成新令牌。</td>
      </tr>
      <tr>
          <td><strong>数据</strong></td>
          <td>基本身份验证仅用于处理凭证（通常是用户名-密码）。</td>
          <td>JWT 可以包含其他信息，例如 id、角色等。一旦签名被验证，服务器就可以信任客户端发送的数据，从而避免可能需要的任何额外查找。</td>
      </tr>
  </tbody>
</table>
<h2 id="在-spring-boot-应用程序中实现-jwt">在 Spring Boot 应用程序中实现 JWT</h2>
<p>现在我们更好地了解了 JWT，让我们在一个简单的 Spring Boot 应用程序中实现它。在我们的<em>pom.xml</em>中，让我们添加以下依赖项：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;artifactId&gt;</span>spring-boot-starter-web<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;artifactId&gt;</span>spring-boot-starter-security<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;groupId&gt;</span>io.jsonwebtoken<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;artifactId&gt;</span>jjwt-api<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;version&gt;</span>0.11.1<span style="color:#f92672">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;groupId&gt;</span>io.jsonwebtoken<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;artifactId&gt;</span>jjwt-impl<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;version&gt;</span>0.11.1<span style="color:#f92672">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;scope&gt;</span>runtime<span style="color:#f92672">&lt;/scope&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;groupId&gt;</span>io.jsonwebtoken<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;artifactId&gt;</span>jjwt-jackson<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;version&gt;</span>0.11.1<span style="color:#f92672">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;scope&gt;</span>runtime<span style="color:#f92672">&lt;/scope&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>我们创建了一个简单的 Spring Boot Library 应用程序，该应用程序使用内存中的 H2 数据库来存储数据。该应用程序配置为在端口 8083 上运行。要运行该应用程序：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>mvnw clean verify spring-boot:run (for Windows)
</span></span><span style="display:flex;"><span>./mvnw clean verify spring-boot:run (for Linux)
</span></span></code></pre></div><h3 id="拦截-jwt-的-spring-security-过滤器链">拦截 JWT 的 Spring Security 过滤器链</h3>
<p>该应用程序有一个 REST 端点<code>/library/books/all</code>，用于获取数据库中存储的所有书籍。如果我们通过 Postman 进行此 GET 调用，则会收到<code>401 UnAuthorized</code>错误：</p>
<p><img src="../../../static/images/spring-security-jwt-04.webp" alt="设置"></p>
<p>这是因为，我们在pom.xml中添加的依赖项会自动为所有创建的端点引入基本身份验证。spring-boot-starter-security 由于我们没有在 Postman 中指定任何凭据，因此我们收到<code>UnAuthorized</code>错误。就本文而言，我们需要用基于 JWT 的身份验证替换基本身份验证。我们知道 Spring 通过触发处理每个请求的身份验证和授权的过滤器链来为我们的端点提供安全性。<a href="https://docs.spring.io/spring-security/site/docs/current/api/org/springframework/security/web/authentication/UsernamePasswordAuthenticationFilter.html" target="_blank"><code>UsernamePasswordAuthenticationFilter</code></a>负责验证每个请求的凭据。为了覆盖此过滤器，让我们创建一个<code>Filter</code>名为的新过滤器<code>JwtFilter</code>。此过滤器将扩展<code>OncePerRequestFilter</code>类，因为我们希望每个请求仅调用一次过滤器：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Component</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Slf4j</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">JwtFilter</span> <span style="color:#66d9ef">extends</span> OncePerRequestFilter {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> AuthUserDetailsService userDetailsService;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> JwtHelper jwtHelper;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">JwtFilter</span>(AuthUserDetailsService userDetailsService, JwtHelper jwtHelper) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">userDetailsService</span> <span style="color:#f92672">=</span> userDetailsService;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">jwtHelper</span> <span style="color:#f92672">=</span> jwtHelper;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">doFilterInternal</span>(HttpServletRequest request, 
</span></span><span style="display:flex;"><span>                                    HttpServletResponse response, 
</span></span><span style="display:flex;"><span>                                    FilterChain filterChain) 
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">throws</span> ServletException, IOException {
</span></span><span style="display:flex;"><span>        log.<span style="color:#a6e22e">info</span>(<span style="color:#e6db74">&#34;Inside JWT filter&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Code to validate the Authorization header</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>该类<code>JwtHelper</code>负责创建和验证 token。我们先看看如何创建 token：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">createToken</span>(Map<span style="color:#f92672">&lt;</span>String, Object<span style="color:#f92672">&gt;</span> claims, String subject) {
</span></span><span style="display:flex;"><span>    Date expiryDate <span style="color:#f92672">=</span> 
</span></span><span style="display:flex;"><span>        Date.<span style="color:#a6e22e">from</span>(Instant.<span style="color:#a6e22e">ofEpochMilli</span>(System.<span style="color:#a6e22e">currentTimeMillis</span>() <span style="color:#f92672">+</span> 
</span></span><span style="display:flex;"><span>        jwtProperties.<span style="color:#a6e22e">getValidity</span>()));
</span></span><span style="display:flex;"><span>    Key hmacKey <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> SecretKeySpec(Base64.<span style="color:#a6e22e">getDecoder</span>()
</span></span><span style="display:flex;"><span>        .<span style="color:#a6e22e">decode</span>(jwtProperties.<span style="color:#a6e22e">getSecretKey</span>()),
</span></span><span style="display:flex;"><span>            SignatureAlgorithm.<span style="color:#a6e22e">HS256</span>.<span style="color:#a6e22e">getJcaName</span>());
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> Jwts.<span style="color:#a6e22e">builder</span>()
</span></span><span style="display:flex;"><span>            .<span style="color:#a6e22e">setClaims</span>(claims)
</span></span><span style="display:flex;"><span>            .<span style="color:#a6e22e">setSubject</span>(subject)
</span></span><span style="display:flex;"><span>            .<span style="color:#a6e22e">setIssuedAt</span>(<span style="color:#66d9ef">new</span> Date(System.<span style="color:#a6e22e">currentTimeMillis</span>()))
</span></span><span style="display:flex;"><span>            .<span style="color:#a6e22e">setExpiration</span>(expiryDate)
</span></span><span style="display:flex;"><span>            .<span style="color:#a6e22e">signWith</span>(hmacKey)
</span></span><span style="display:flex;"><span>            .<span style="color:#a6e22e">compact</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>以下参数负责创建令牌：</p>
<ul>
<li><code>claims</code>指的是空映射。此示例尚未定义任何用户特定的声明。</li>
<li><code>subject</code>指的是用户在调用 API 创建 token 时传递的用户名。</li>
<li><code>expiryDate</code>指的是在当前日期上添加“x”毫秒后的日期。“x”的值在属性中定义<code>jwt.validity</code>。</li>
<li><code>hmacKey</code>指的是<code>jva.security.Key</code>用于签署 JWT 请求的对象。对于此示例，使用的密钥在属性中定义<code>jwt.secretKey</code>，并<code>HS256</code>使用算法。</li>
</ul>
<p>此方法返回一个字符串 token，每次请求时都需要传递给它<code>Authorization header</code>。现在我们已经创建了一个 token，让我们看看类<code>doFilterInternal</code>中的方法<code>JwtFilter</code>，并了解这个类的职责<code>Filter</code>：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">doFilterInternal</span>(
</span></span><span style="display:flex;"><span>    HttpServletRequest request, 
</span></span><span style="display:flex;"><span>    HttpServletResponse response, 
</span></span><span style="display:flex;"><span>    FilterChain filterChain
</span></span><span style="display:flex;"><span>) <span style="color:#66d9ef">throws</span> ServletException, IOException {
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">final</span> String authorizationHeader <span style="color:#f92672">=</span> request.<span style="color:#a6e22e">getHeader</span>(AUTHORIZATION);
</span></span><span style="display:flex;"><span>      String jwt <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>      String username <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (Objects.<span style="color:#a6e22e">nonNull</span>(authorizationHeader) <span style="color:#f92672">&amp;&amp;</span> 
</span></span><span style="display:flex;"><span>              authorizationHeader.<span style="color:#a6e22e">startsWith</span>(<span style="color:#e6db74">&#34;Bearer &#34;</span>)) {
</span></span><span style="display:flex;"><span>          jwt <span style="color:#f92672">=</span> authorizationHeader.<span style="color:#a6e22e">substring</span>(7);
</span></span><span style="display:flex;"><span>          username <span style="color:#f92672">=</span> jwtHelper.<span style="color:#a6e22e">extractUsername</span>(jwt);
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (Objects.<span style="color:#a6e22e">nonNull</span>(username) <span style="color:#f92672">&amp;&amp;</span> 
</span></span><span style="display:flex;"><span>              SecurityContextHolder.<span style="color:#a6e22e">getContext</span>().<span style="color:#a6e22e">getAuthentication</span>() <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>          UserDetails userDetails <span style="color:#f92672">=</span> 
</span></span><span style="display:flex;"><span>              <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">userDetailsService</span>.<span style="color:#a6e22e">loadUserByUsername</span>(username);
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">boolean</span> isTokenValidated <span style="color:#f92672">=</span> 
</span></span><span style="display:flex;"><span>              jwtHelper.<span style="color:#a6e22e">validateToken</span>(jwt, userDetails);
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">if</span> (isTokenValidated) {
</span></span><span style="display:flex;"><span>              UsernamePasswordAuthenticationToken usernamePasswordAuthenticationToken <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>                      <span style="color:#66d9ef">new</span> UsernamePasswordAuthenticationToken(
</span></span><span style="display:flex;"><span>                                  userDetails, <span style="color:#66d9ef">null</span>, userDetails.<span style="color:#a6e22e">getAuthorities</span>());
</span></span><span style="display:flex;"><span>              usernamePasswordAuthenticationToken.<span style="color:#a6e22e">setDetails</span>(
</span></span><span style="display:flex;"><span>                      <span style="color:#66d9ef">new</span> WebAuthenticationDetailsSource().<span style="color:#a6e22e">buildDetails</span>(request));
</span></span><span style="display:flex;"><span>              SecurityContextHolder.<span style="color:#a6e22e">getContext</span>().<span style="color:#a6e22e">setAuthentication</span>(
</span></span><span style="display:flex;"><span>                      usernamePasswordAuthenticationToken);
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  filterChain.<span style="color:#a6e22e">doFilter</span>(request, response);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>步骤1。读取<code>Authorization</code>标头并提取 JWT 字符串。</p>
<p>步骤2。解析 JWT 字符串并提取用户名。我们为此使用该<code>io.jsonwebtoken</code>库。如下所示：<code>Jwts.parseBuilder()、jwtHelper.extractUsername()</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">extractUsername</span>(String bearerToken) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> extractClaimBody(bearerToken, Claims::getSubject);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> T <span style="color:#a6e22e">extractClaimBody</span>(String bearerToken, 
</span></span><span style="display:flex;"><span>            Function<span style="color:#f92672">&lt;</span>Claims, T<span style="color:#f92672">&gt;</span> claimsResolver) {
</span></span><span style="display:flex;"><span>        Jws<span style="color:#f92672">&lt;</span>Claims<span style="color:#f92672">&gt;</span> jwsClaims <span style="color:#f92672">=</span> extractClaims(bearerToken);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> claimsResolver.<span style="color:#a6e22e">apply</span>(jwsClaims.<span style="color:#a6e22e">getBody</span>());
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">private</span> Jws<span style="color:#f92672">&lt;</span>Claims<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">extractClaims</span>(String bearerToken) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> Jwts.<span style="color:#a6e22e">parserBuilder</span>().<span style="color:#a6e22e">setSigningKey</span>(jwtProperties.<span style="color:#a6e22e">getSecretKey</span>())
</span></span><span style="display:flex;"><span>        .<span style="color:#a6e22e">build</span>().<span style="color:#a6e22e">parseClaimsJws</span>(bearerToken);
</span></span><span style="display:flex;"><span>        }
</span></span></code></pre></div><p>步骤 3。提取用户名后，我们将使用 验证<code>Authentication</code>对象是否有效，即是否有登录用户<code>SecurityContextHolder.getContext().getAuthentication()</code>。如果没有，我们将使用 Spring Security<code>UserDetailsService</code>加载<code>UserDetails</code>对象。对于此示例，我们创建了<code>AuthUserDetailsService</code>返回对象的类<code>UserDetails</code>。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AuthUserDetailsService</span> <span style="color:#66d9ef">implements</span> UserDetailsService {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> UserProperties userProperties;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Autowired</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">AuthUserDetailsService</span>(UserProperties userProperties) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">userProperties</span> <span style="color:#f92672">=</span> userProperties;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> UserDetails <span style="color:#a6e22e">loadUserByUsername</span>(String username) 
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">throws</span> UsernameNotFoundException {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (StringUtils.<span style="color:#a6e22e">isEmpty</span>(username) <span style="color:#f92672">||</span> 
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">!</span>username.<span style="color:#a6e22e">equals</span>(userProperties.<span style="color:#a6e22e">getName</span>())) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> UsernameNotFoundException(
</span></span><span style="display:flex;"><span>                    String.<span style="color:#a6e22e">format</span>(<span style="color:#e6db74">&#34;User not found, or unauthorized %s&#34;</span>, username));
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> User(userProperties.<span style="color:#a6e22e">getName</span>(), 
</span></span><span style="display:flex;"><span>                userProperties.<span style="color:#a6e22e">getPassword</span>(), <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;&gt;</span>());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>下面的用户名和密码<code>UserProperties</code>是从<code>application.yml</code>以下位置加载的：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">spring</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">security</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">user</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">name</span>: <span style="color:#ae81ff">libUser</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">password</span>: <span style="color:#ae81ff">libPassword</span>
</span></span></code></pre></div><p>步骤4。接下来，<code>JwtFilter</code>调用<code>jwtHelper.validateToken()</code>来验证提取的用户名并确保jwt令牌尚未过期。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">validateToken</span>(String token, UserDetails userDetails) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">final</span> String userName <span style="color:#f92672">=</span> extractUsername(token);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> userName.<span style="color:#a6e22e">equals</span>(userDetails.<span style="color:#a6e22e">getUsername</span>()) <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>isTokenExpired(token);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">private</span> Boolean <span style="color:#a6e22e">isTokenExpired</span>(String bearerToken) {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> extractExpiry(bearerToken).<span style="color:#a6e22e">before</span>(<span style="color:#66d9ef">new</span> Date());
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> Date <span style="color:#a6e22e">extractExpiry</span>(String bearerToken) {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> extractClaimBody(bearerToken, Claims::getExpiration);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>步骤 5。一旦令牌被验证，我们就创建一个对象实例。在这里，创建<code>Authentication</code>对象对象（它是接口的一个实现）并将其设置为。这表明用户现在已通过身份验证。<code>SecurityContextHolder.getContext().setAuthentication(usernamePasswordAuthenticationToken)</code></p>
<p>步骤6。最后，我们调用<code>filterChain.doFilter(request, response)</code>以便在中调用下一个过滤器<code>FilterChain</code>。</p>
<p>这样，我们就成功创建了一个过滤器类来验证令牌。我们将在后续章节中讨论异常处理。</p>
<h3 id="jwt-令牌创建端点">JWT 令牌创建端点</h3>
<p><code>Authorization</code>在本节中，我们将创建一个 Controller 类来创建一个端点，这将允许我们创建一个 JWT 令牌字符串。当我们调用 Library 应用程序时，此令牌将在标头中设置。让我们创建一个<code>TokenController</code>类：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@RestController</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TokenController</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> TokenService tokenService;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">TokenController</span>(TokenService tokenService) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">tokenService</span> <span style="color:#f92672">=</span> tokenService;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@PostMapping</span>(<span style="color:#e6db74">&#34;/token/create&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> TokenResponse <span style="color:#a6e22e">createToken</span>(<span style="color:#a6e22e">@RequestBody</span> TokenRequest tokenRequest) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> tokenService.<span style="color:#a6e22e">generateToken</span>(tokenRequest);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>请求主体<code>TokenRequest</code>类将接受用户名和密码：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Data</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@NoArgsConstructor</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@AllArgsConstructor</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Builder</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TokenRequest</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> String username;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> String password;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>该类<code>TokenService</code>负责验证请求主体中传递的凭据并<code>jwtHelper.createToken()</code>按照上一节中的定义进行调用。为了验证凭据，我们需要实现一个<code>AuthenticationManager</code>。让我们创建一个<code>SecurityConfiguration</code>类来定义所有与 Spring 安全相关的配置。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Configuration</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@EnableWebSecurity</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SecurityConfiguration</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> JwtFilter jwtFilter;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> AuthUserDetailsService authUserDetailsService;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> JwtAuthenticationEntryPoint jwtAuthenticationEntryPoint;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Autowired</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">SecurityConfiguration</span>(JwtFilter jwtFilter,
</span></span><span style="display:flex;"><span>                                 AuthUserDetailsService authUserDetailsService,
</span></span><span style="display:flex;"><span>                                 JwtAuthenticationEntryPoint 
</span></span><span style="display:flex;"><span>                                             jwtAuthenticationEntryPoint) {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">jwtFilter</span> <span style="color:#f92672">=</span> jwtFilter;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">authUserDetailsService</span> <span style="color:#f92672">=</span> authUserDetailsService;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">jwtAuthenticationEntryPoint</span> <span style="color:#f92672">=</span> jwtAuthenticationEntryPoint;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Bean</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> DaoAuthenticationProvider <span style="color:#a6e22e">authenticationProvider</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">final</span> DaoAuthenticationProvider daoAuthenticationProvider <span style="color:#f92672">=</span> 
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">new</span> DaoAuthenticationProvider();
</span></span><span style="display:flex;"><span>        daoAuthenticationProvider.<span style="color:#a6e22e">setUserDetailsService</span>(authUserDetailsService);
</span></span><span style="display:flex;"><span>        daoAuthenticationProvider.<span style="color:#a6e22e">setPasswordEncoder</span>(
</span></span><span style="display:flex;"><span>                PlainTextPasswordEncoder.<span style="color:#a6e22e">getInstance</span>());
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> daoAuthenticationProvider;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Bean</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> AuthenticationManager <span style="color:#a6e22e">authenticationManager</span>(HttpSecurity httpSecurity) 
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">throws</span> Exception {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> httpSecurity.<span style="color:#a6e22e">getSharedObject</span>(AuthenticationManagerBuilder.<span style="color:#a6e22e">class</span>)
</span></span><span style="display:flex;"><span>                .<span style="color:#a6e22e">authenticationProvider</span>(authenticationProvider())
</span></span><span style="display:flex;"><span>                .<span style="color:#a6e22e">build</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>使用<code>AuthenticationManager</code>，<code>AuthUserDetailsService</code>它使用<code>spring.security.user</code>属性。现在我们已经有了<code>AuthenticationManager</code>，让我们看看 是如何<code>TokenService</code>定义的：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Service</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TokenService</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> AuthenticationManager authenticationManager;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> AuthUserDetailsService userDetailsService;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> JwtHelper jwtHelper;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">TokenService</span>(AuthenticationManager authenticationManager,
</span></span><span style="display:flex;"><span>                        AuthUserDetailsService userDetailsService,
</span></span><span style="display:flex;"><span>                        JwtHelper jwtHelper) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">authenticationManager</span> <span style="color:#f92672">=</span> authenticationManager;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">userDetailsService</span> <span style="color:#f92672">=</span> userDetailsService;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">jwtHelper</span> <span style="color:#f92672">=</span> jwtHelper;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> TokenResponse <span style="color:#a6e22e">generateToken</span>(TokenRequest tokenRequest) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">authenticationManager</span>.<span style="color:#a6e22e">authenticate</span>(
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">new</span> UsernamePasswordAuthenticationToken(
</span></span><span style="display:flex;"><span>                        tokenRequest.<span style="color:#a6e22e">getUsername</span>(), tokenRequest.<span style="color:#a6e22e">getPassword</span>()));
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">final</span> UserDetails userDetails <span style="color:#f92672">=</span> 
</span></span><span style="display:flex;"><span>                userDetailsService.<span style="color:#a6e22e">loadUserByUsername</span>(tokenRequest.<span style="color:#a6e22e">getUsername</span>());
</span></span><span style="display:flex;"><span>        String token <span style="color:#f92672">=</span> jwtHelper.<span style="color:#a6e22e">createToken</span>(
</span></span><span style="display:flex;"><span>                Collections.<span style="color:#a6e22e">emptyMap</span>(), userDetails.<span style="color:#a6e22e">getUsername</span>());
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> TokenResponse.<span style="color:#a6e22e">builder</span>()
</span></span><span style="display:flex;"><span>                .<span style="color:#a6e22e">token</span>(token)
</span></span><span style="display:flex;"><span>                .<span style="color:#a6e22e">build</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><code>TokenResponse</code>是包含标记字符串的 Response 对象：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Data</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@NoArgsConstructor</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@AllArgsConstructor</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Builder</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TokenResponse</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> String token;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>现在创建了 API，让我们启动应用程序并尝试使用 Postman 访问端点。我们看到<code>401 Unauthorized</code>以下错误：</p>
<p><img src="../../../static/images/spring-security-jwt-05.webp" alt="设置"></p>
<p>原因和我们之前遇到的一样。Spring Security 默认保护所有端点。我们需要一种方法来仅排除令牌端点的保护。此外，在启动日志中我们可以看到，虽然我们已经定义<code>JwtFilter</code>并且我们期望此过滤器覆盖<code>UsernamePasswordAuthenticationFilter</code>，但我们没有看到此过滤器连接到安全链中，如下所示：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>2024-05-22 15:41:09.441  INFO 20432 --- [           main] 
</span></span><span style="display:flex;"><span>o.s.s.web.DefaultSecurityFilterChain     : 
</span></span><span style="display:flex;"><span>Will secure any request with 
</span></span><span style="display:flex;"><span>    [org.springframework.security.web.session.DisableEncodeUrlFilter@14d36bb2, 
</span></span><span style="display:flex;"><span>org.springframework.security.web.context.request.async.
</span></span><span style="display:flex;"><span>    WebAsyncManagerIntegrationFilter@432448, 
</span></span><span style="display:flex;"><span>org.springframework.security.web.context.SecurityContextPersistenceFilter@54d46c8, 
</span></span><span style="display:flex;"><span>org.springframework.security.web.header.HeaderWriterFilter@c7cf8c4, 
</span></span><span style="display:flex;"><span>org.springframework.security.web.csrf.CsrfFilter@17fb5184, 
</span></span><span style="display:flex;"><span>org.springframework.security.web.authentication.logout.LogoutFilter@42fa5cb, 
</span></span><span style="display:flex;"><span>org.springframework.security.web.authentication.
</span></span><span style="display:flex;"><span>    UsernamePasswordAuthenticationFilter@70d7a49b, 
</span></span><span style="display:flex;"><span>org.springframework.security.web.authentication.ui.
</span></span><span style="display:flex;"><span>    DefaultLoginPageGeneratingFilter@67cd84f9, 
</span></span><span style="display:flex;"><span>org.springframework.security.web.authentication.ui.
</span></span><span style="display:flex;"><span>    DefaultLogoutPageGeneratingFilter@4452e13c, 
</span></span><span style="display:flex;"><span>org.springframework.security.web.authentication.www.
</span></span><span style="display:flex;"><span>    BasicAuthenticationFilter@788d9139, 
</span></span><span style="display:flex;"><span>org.springframework.security.web.savedrequest.RequestCacheAwareFilter@5c34b0f2, 
</span></span><span style="display:flex;"><span>org.springframework.security.web.servletapi.
</span></span><span style="display:flex;"><span>    SecurityContextHolderAwareRequestFilter@7dfec0bc, 
</span></span><span style="display:flex;"><span>org.springframework.security.web.authentication.
</span></span><span style="display:flex;"><span>    AnonymousAuthenticationFilter@4d964c9e, 
</span></span><span style="display:flex;"><span>org.springframework.security.web.session.SessionManagementFilter@731fae, 
</span></span><span style="display:flex;"><span>org.springframework.security.web.access.ExceptionTranslationFilter@66d61298, 
</span></span><span style="display:flex;"><span>org.springframework.security.web.access.intercept.FilterSecurityInterceptor@55c20a91]
</span></span></code></pre></div><p>为了链接<code>JwtFilter</code>到另一组过滤器并排除保护令牌端点，让我们在类<code>SecurityFilterChain</code>中创建一个 bean <code>SecurityConfiguration</code>：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Bean</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> SecurityFilterChain <span style="color:#a6e22e">configure</span> (HttpSecurity http) <span style="color:#66d9ef">throws</span> Exception {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> http.<span style="color:#a6e22e">csrf</span>().<span style="color:#a6e22e">disable</span>()
</span></span><span style="display:flex;"><span>                .<span style="color:#a6e22e">authorizeRequests</span>()
</span></span><span style="display:flex;"><span>                .<span style="color:#a6e22e">antMatchers</span>(<span style="color:#e6db74">&#34;/token/*&#34;</span>).<span style="color:#a6e22e">permitAll</span>()
</span></span><span style="display:flex;"><span>                .<span style="color:#a6e22e">anyRequest</span>().<span style="color:#a6e22e">authenticated</span>().<span style="color:#a6e22e">and</span>()
</span></span><span style="display:flex;"><span>                .<span style="color:#a6e22e">sessionManagement</span>(session <span style="color:#f92672">-&gt;</span> 
</span></span><span style="display:flex;"><span>                    session.<span style="color:#a6e22e">sessionCreationPolicy</span>(SessionCreationPolicy.<span style="color:#a6e22e">STATELESS</span>))
</span></span><span style="display:flex;"><span>                .<span style="color:#a6e22e">addFilterBefore</span>(jwtFilter, 
</span></span><span style="display:flex;"><span>                    UsernamePasswordAuthenticationFilter.<span style="color:#a6e22e">class</span>)
</span></span><span style="display:flex;"><span>                .<span style="color:#a6e22e">exceptionHandling</span>(exception <span style="color:#f92672">-&gt;</span> 
</span></span><span style="display:flex;"><span>                    exception.<span style="color:#a6e22e">authenticationEntryPoint</span>(jwtAuthenticationEntryPoint))
</span></span><span style="display:flex;"><span>                .<span style="color:#a6e22e">build</span>();
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><p>在此配置中，我们关注以下内容：</p>
<ul>
<li><strong>antMatchers(&quot;/token/*&quot;).permitAll()</strong> - 这将允许与模式匹配的 API 端点<code>/token/*</code>并将其从安全性中排除。</li>
<li><strong>anyRequest().authenticated()</strong> - Spring Security 将保护所有其他 API 请求。</li>
<li><strong>addFilterBefore(jwtFilter, UsernamePasswordAuthenticationFilter.class)</strong> - 这将在 FilterChain<code>JwtFilter</code>中将其连接起来。<code>UsernamePasswordAuthenticationFilter</code></li>
<li><strong>exceptionHandling(exception -&gt; exception.authenticationEntryPoint(jwtAuthenticationEntryPoint)</strong> - 如果发生身份验证异常，<code>JwtAuthenticationEntryPoint</code>将调用类。在这里，我们创建了一个<code>JwtAuthenticationEntryPoint</code>实现的类，<code>org.springframework.security.web.AuthenticationEntryPoint</code>以便优雅地处理未经授权的错误。我们将在后面的部分中详细介绍如何处理异常。</li>
</ul>
<p>完成这些更改后，让我们重新启动应用程序并检查日志：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>2024-05-22 16:13:07.803  INFO 16188 --- [           main] 
</span></span><span style="display:flex;"><span>o.s.s.web.DefaultSecurityFilterChain     : Will secure any request with 
</span></span><span style="display:flex;"><span>[org.springframework.security.web.session.DisableEncodeUrlFilter@73e25780, 
</span></span><span style="display:flex;"><span>org.springframework.security.web.context.request.async.
</span></span><span style="display:flex;"><span>    WebAsyncManagerIntegrationFilter@1f4cb17b, 
</span></span><span style="display:flex;"><span>org.springframework.security.web.context.SecurityContextPersistenceFilter@b548f51, 
</span></span><span style="display:flex;"><span>org.springframework.security.web.header.HeaderWriterFilter@4f9980e1, 
</span></span><span style="display:flex;"><span>org.springframework.security.web.authentication.logout.LogoutFilter@6b92a0d1, 
</span></span><span style="display:flex;"><span>com.reflectoring.security.filter.JwtFilter@5961e92d, 
</span></span><span style="display:flex;"><span>org.springframework.security.web.savedrequest.RequestCacheAwareFilter@56976b8b, 
</span></span><span style="display:flex;"><span>org.springframework.security.web.servletapi.
</span></span><span style="display:flex;"><span>    SecurityContextHolderAwareRequestFilter@74844216, 
</span></span><span style="display:flex;"><span>org.springframework.security.web.authentication.
</span></span><span style="display:flex;"><span>    AnonymousAuthenticationFilter@280099a0, 
</span></span><span style="display:flex;"><span>org.springframework.security.web.session.SessionManagementFilter@144dc2f7, 
</span></span><span style="display:flex;"><span>org.springframework.security.web.access.ExceptionTranslationFilter@7a0f43dc, 
</span></span><span style="display:flex;"><span>org.springframework.security.web.access.intercept.
</span></span><span style="display:flex;"><span>    FilterSecurityInterceptor@735167e1]
</span></span></code></pre></div><p>我们看到<code>JwtFilter</code>被链接起来，这表明基本身份验证现在已被基于令牌的身份验证所覆盖。现在，让我们再次尝试访问端点<code>/token/create</code>。我们看到端点现在能够成功返回生成的令牌：</p>
<p><img src="../../../static/images/spring-security-jwt-06.webp" alt="设置"></p>
<h3 id="保护图书馆应用程序端点">保护图书馆应用程序端点</h3>
<p>现在，我们能够成功创建令牌，我们需要将此令牌传递给我们的库应用程序以成功调用<code>/library/books/all</code>。让我们添加一个带有生成的令牌值<code>Authorization</code>的类型的标头<code>Bearer Token</code>并触发请求。我们现在可以看到 200 OK 响应，如下所示：</p>
<p><img src="../../../static/images/spring-security-jwt-07.webp" alt="设置"></p>
<h3 id="使用-jwt-处理异常">使用 JWT 处理异常</h3>
<p>在本节中，我们将了解<code>io.jsonwebtoken</code>包中一些常见的异常：</p>
<ol>
<li><a href="https://javadoc.io/doc/io.jsonwebtoken/jjwt/0.9.1/io/jsonwebtoken/ExpiredJwtException.html" target="_blank">ExpiredJwtException</a> - JWT token 包含过期时间，解析 token 时，如果已经超过过期时间，则会抛出 ExpiredJwtException。</li>
<li><a href="https://javadoc.io/doc/io.jsonwebtoken/jjwt/0.9.1/io/jsonwebtoken/UnsupportedJwtException.html" target="_blank">UnsupportedJwtException</a> - 当收到的 JWT 格式不符合预期时，会抛出此异常。此错误最常见的用例是当我们尝试使用方法<code>Jwts.parserBuilder().setSigningKey(jwtProperties.getSecretKey()) .build().parseClaimsJwt</code>而不是<code>Jwts.parserBuilder().setSigningKey(jwtProperties.getSecretKey()) .build().parseClaimsJws</code></li>
<li><a href="https://javadoc.io/doc/io.jsonwebtoken/jjwt/0.9.1/io/jsonwebtoken/MalformedJwtException.html" target="_blank">MalformedJwtException</a> - 此异常表示 JWT 构造不正确。</li>
<li><a href="https://javadoc.io/doc/io.jsonwebtoken/jjwt-api/latest/io/jsonwebtoken/IncorrectClaimException.html" target="_blank">IncorrectClaimException</a> - 表示所需声明没有预期值。因此，JWT 无效。</li>
<li><a href="https://javadoc.io/doc/io.jsonwebtoken/jjwt-api/latest/io/jsonwebtoken/MissingClaimException.html" target="_blank">MissingClaimException</a> - 此异常表示 JWT 中缺少所需声明，因此无效。</li>
</ol>
<p>通常，妥善处理与身份验证相关的异常被认为是一种很好的做法。在基本身份验证的情况下，Spring Security<strong>默认将添加<code>BasicAuthenticationEntryPoint</code>到安全过滤器链中，该过滤器链将基本身份验证相关错误包装为 401 Unauthorized。</strong> 同样，在我们的示例中，我们明确创建了<code>JwtAuthenticationEntryPoint</code>处理可能的身份验证错误，例如 Spring Security<code>BadCredentialsException</code>或 JJwt 的<code>MalformedJwtException</code>：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Component</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Slf4j</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">JwtAuthenticationEntryPoint</span> <span style="color:#66d9ef">implements</span> AuthenticationEntryPoint {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">commence</span>(HttpServletRequest request, 
</span></span><span style="display:flex;"><span>                         HttpServletResponse response, 
</span></span><span style="display:flex;"><span>                         AuthenticationException authException) 
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">throws</span> IOException, ServletException {
</span></span><span style="display:flex;"><span>        Exception exception <span style="color:#f92672">=</span> (Exception) request.<span style="color:#a6e22e">getAttribute</span>(<span style="color:#e6db74">&#34;exception&#34;</span>);
</span></span><span style="display:flex;"><span>        response.<span style="color:#a6e22e">setStatus</span>(HttpServletResponse.<span style="color:#a6e22e">SC_UNAUTHORIZED</span>);
</span></span><span style="display:flex;"><span>        response.<span style="color:#a6e22e">setContentType</span>(APPLICATION_JSON_VALUE);
</span></span><span style="display:flex;"><span>        log.<span style="color:#a6e22e">error</span>(<span style="color:#e6db74">&#34;Authentication Exception: {} &#34;</span>, exception, exception);
</span></span><span style="display:flex;"><span>        Map<span style="color:#f92672">&lt;</span>String, Object<span style="color:#f92672">&gt;</span> data <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HashMap<span style="color:#f92672">&lt;&gt;</span>();
</span></span><span style="display:flex;"><span>        data.<span style="color:#a6e22e">put</span>(<span style="color:#e6db74">&#34;message&#34;</span>, exception <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">?</span> 
</span></span><span style="display:flex;"><span>                exception.<span style="color:#a6e22e">getMessage</span>() : authException.<span style="color:#a6e22e">getCause</span>().<span style="color:#a6e22e">toString</span>());
</span></span><span style="display:flex;"><span>        OutputStream out <span style="color:#f92672">=</span> response.<span style="color:#a6e22e">getOutputStream</span>();
</span></span><span style="display:flex;"><span>        ObjectMapper mapper <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ObjectMapper();
</span></span><span style="display:flex;"><span>        mapper.<span style="color:#a6e22e">writeValue</span>(out, data);
</span></span><span style="display:flex;"><span>        out.<span style="color:#a6e22e">flush</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>在我们的<code>JwtFilter</code>类中，我们将异常消息添加到<code>HttpServletRequest</code> <code>exception</code>属性中。这使我们能够使用<code>request.getAttribute(&quot;exception&quot;)</code>它并将其写入输出流。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">JwtFilter</span> <span style="color:#66d9ef">extends</span> OncePerRequestFilter {
</span></span><span style="display:flex;"><span>   <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">doFilterInternal</span>(HttpServletRequest request, 
</span></span><span style="display:flex;"><span>                                   HttpServletResponse response, 
</span></span><span style="display:flex;"><span>                                   FilterChain filterChain) 
</span></span><span style="display:flex;"><span>           <span style="color:#66d9ef">throws</span> ServletException, IOException {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>         <span style="color:#75715e">//validate token here</span>
</span></span><span style="display:flex;"><span>      } <span style="color:#66d9ef">catch</span> (ExpiredJwtException jwtException) {
</span></span><span style="display:flex;"><span>         request.<span style="color:#a6e22e">setAttribute</span>(<span style="color:#e6db74">&#34;exception&#34;</span>, jwtException);
</span></span><span style="display:flex;"><span>      } <span style="color:#66d9ef">catch</span> (BadCredentialsException <span style="color:#f92672">|</span> 
</span></span><span style="display:flex;"><span>               UnsupportedJwtException <span style="color:#f92672">|</span> 
</span></span><span style="display:flex;"><span>               MalformedJwtException e) {
</span></span><span style="display:flex;"><span>         log.<span style="color:#a6e22e">error</span>(<span style="color:#e6db74">&#34;Filter exception: {}&#34;</span>, e.<span style="color:#a6e22e">getMessage</span>());
</span></span><span style="display:flex;"><span>         request.<span style="color:#a6e22e">setAttribute</span>(<span style="color:#e6db74">&#34;exception&#34;</span>, e);
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      filterChain.<span style="color:#a6e22e">doFilter</span>(request, response);
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><code>401 Unauthorized</code>通过这些更改，我们现在可以看到包含以下异常的异常消息：</p>
<p><img src="../../../static/images/spring-security-jwt-08.webp" alt="设置"></p>
<p>但是，需要注意的是，<code>JwtFilter</code>只有通过 Spring Security 过滤器链保护的端点才会调用 。在我们的例子中，端点是<code>/library/books/all</code>。由于我们已经从 Spring Security 中排除了令牌端点<code>/token/create</code>，因此下面的异常处理<code>JwtAuthenticationEntryPoint</code>将不适用于此处。对于这种情况，我们将使用 Spring 的全局异常处理程序来处理异常。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@ControllerAdvice</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">GlobalExceptionHandler</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@ExceptionHandler</span>({BadCredentialsException.<span style="color:#a6e22e">class</span>})
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> ResponseEntity<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">handleBadCredentialsException</span>(BadCredentialsException exception) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> ResponseEntity
</span></span><span style="display:flex;"><span>                .<span style="color:#a6e22e">status</span>(HttpStatus.<span style="color:#a6e22e">UNAUTHORIZED</span>)
</span></span><span style="display:flex;"><span>                .<span style="color:#a6e22e">body</span>(exception.<span style="color:#a6e22e">getMessage</span>());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><code>401 Unauthorized</code>通过此异常处理，由于凭证不良而导致的异常现在将通过错误处理：</p>
<p><img src="../../../static/images/spring-security-jwt-09.webp" alt="设置"></p>
<h2 id="swagger-文档">Swagger 文档</h2>
<p>在本节中，我们将了解如何为 JWT 配置 Open API。我们将添加以下 Maven 依赖项：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">&lt;groupId&gt;</span>org.springdoc<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">&lt;artifactId&gt;</span>springdoc-openapi-ui<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">&lt;version&gt;</span>1.7.0<span style="color:#f92672">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>接下来，让我们添加以下配置：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@OpenAPIDefinition</span>(
</span></span><span style="display:flex;"><span>        info <span style="color:#f92672">=</span> <span style="color:#a6e22e">@Info</span>(
</span></span><span style="display:flex;"><span>                title <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Library application&#34;</span>,
</span></span><span style="display:flex;"><span>                description <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Get all library books&#34;</span>,
</span></span><span style="display:flex;"><span>                version <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;1.0.0&#34;</span>,
</span></span><span style="display:flex;"><span>                license <span style="color:#f92672">=</span> <span style="color:#a6e22e">@License</span>(
</span></span><span style="display:flex;"><span>                        name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Apache 2.0&#34;</span>,
</span></span><span style="display:flex;"><span>                        url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;http://www.apache.org/licenses/LICENSE-2.0&#34;</span>
</span></span><span style="display:flex;"><span>                )),
</span></span><span style="display:flex;"><span>        security <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">@SecurityRequirement</span>(
</span></span><span style="display:flex;"><span>                        name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;bearerAuth&#34;</span>
</span></span><span style="display:flex;"><span>                )
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@SecurityScheme</span>(
</span></span><span style="display:flex;"><span>        name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;bearerAuth&#34;</span>,
</span></span><span style="display:flex;"><span>        description <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;JWT Authorization&#34;</span>,
</span></span><span style="display:flex;"><span>        scheme <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;bearer&#34;</span>,
</span></span><span style="display:flex;"><span>        type <span style="color:#f92672">=</span> SecuritySchemeType.<span style="color:#a6e22e">HTTP</span>,
</span></span><span style="display:flex;"><span>        bearerFormat <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;JWT&#34;</span>,
</span></span><span style="display:flex;"><span>        in <span style="color:#f92672">=</span> SecuritySchemeIn.<span style="color:#a6e22e">HEADER</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">OpenApiConfig</span> {
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>这里，使用一个或多个 来描述安全性<code>@SecurityScheme</code>。<code>type</code>此处定义的<code>SecuritySchemeType.HTTP</code>适用于基本身份验证和 JWT。其他属性（如 和<code>scheme</code>）<code>bearerFormat</code>依赖于此<code>type</code>属性。定义安全方案后，我们可以通过 <code>security</code>在根级别或操作级别添加 部分将它们应用于整个应用程序或单个操作。在我们的示例中，所有 API 操作都将使用 bearer token 身份验证方案。有关配置多个安全方案以及在 API 级别应用不同方案的更多信息，请参阅其<a href="https://swagger.io/docs/specification/authentication/" target="_blank">文档</a>。</p>
<p>接下来，让我们向控制器类添加一些基本的 swagger 注释，以便为 API 操作添加描述。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@RestController</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Tag</span>(name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Library Controller&#34;</span>, description <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Get library books&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">BookController</span> {
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@RestController</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Tag</span>(name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Create Token&#34;</span>, description <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Create Token&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TokenController</span> {
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>此外，我们将使用以下属性来覆盖 Springdoc 的 Swagger-UI 加载的 URL。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">springdoc</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">swagger-ui</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/swagger-ui</span>
</span></span></code></pre></div><p>通过此配置，Swagger UI 现在可在<code>http://localhost:8083/swagger-ui/index.html</code></p>
<p>让我们尝试运行该应用程序并在上述 URL 处加载 Swagger 页面。当我们尝试访问端点时，我们会看到以下内容：</p>
<p><img src="../../../static/images/spring-security-jwt-10.webp" alt="设置"></p>
<p><strong>这是因为应用程序中的所有端点都自动受到保护。我们需要一种方法来明确排除 swagger 端点不受保护。</strong> 我们可以通过在类中添加<code>WebSecurityCustomizer</code>bean 并排除 swagger 端点来实现这一点<code>SecurityConfiguration</code>。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Bean</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> WebSecurityCustomizer <span style="color:#a6e22e">webSecurityCustomizer</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> web <span style="color:#f92672">-&gt;</span> web.<span style="color:#a6e22e">ignoring</span>().<span style="color:#a6e22e">antMatchers</span>(
</span></span><span style="display:flex;"><span>                ArrayUtils.<span style="color:#a6e22e">addAll</span>(buildExemptedRoutes()));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> String<span style="color:#f92672">[]</span> <span style="color:#a6e22e">buildExemptedRoutes</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> String<span style="color:#f92672">[]</span> {<span style="color:#e6db74">&#34;/swagger-ui/**&#34;</span>,<span style="color:#e6db74">&#34;/v3/api-docs/**&#34;</span>};
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><p>现在，当我们运行应用程序时，swagger 页面将按如下方式加载：</p>
<p><img src="../../../static/images/spring-security-jwt-11.webp" alt="设置"></p>
<p>由于我们只有一个安全方案，因此我们将 JWT 令牌添加到<code>Authorize</code>swagger 页面顶部的按钮中：</p>
<p><img src="../../../static/images/spring-security-jwt-12.webp" alt="设置"></p>
<p>设置了承载令牌后，让我们尝试访问<code>/library/books/all</code>端点：</p>
<p><img src="../../../static/images/spring-security-jwt-13.webp" alt="设置"></p>
<p>这样，我们就成功地为我们的应用程序配置了 swagger 端点。</p>
<h2 id="添加-spring-security-测试">添加 Spring Security 测试</h2>
<p>在我们的示例中，我们需要编写测试来测试我们的令牌端点，并为我们的库应用程序编写另一个测试。</p>
<p>让我们为测试添加一些必需的属性以及内存数据库来处理真实数据。测试<code>application.yml</code>：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">spring</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">security</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">user</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">name</span>: <span style="color:#ae81ff">libUser</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">password</span>: <span style="color:#ae81ff">libPassword</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">datasource</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">driver-class-name</span>: <span style="color:#ae81ff">org.hsqldb.jdbc.JDBCDriver</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">url</span>: <span style="color:#ae81ff">jdbc:hsqldb:mem:testdb;DB_CLOSE_DELAY=-1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">username</span>: <span style="color:#ae81ff">sa</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">password</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">jwt</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">secretKey</span>: <span style="color:#ae81ff">5JzoMbk6E5qIqHSuBTgeQCARtUsxAkBiHwdjXOSW8kWdXzYmP3X51C0</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">validity</span>: <span style="color:#ae81ff">600000</span>
</span></span></code></pre></div><p>接下来，让我们编写测试来验证我们的令牌端点：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@SpringBootTest</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@AutoConfigureMockMvc</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TokenControllerTest</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Autowired</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> MockMvc mvc;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Test</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">shouldNotAllowAccessToUnauthenticatedUsers</span>() <span style="color:#66d9ef">throws</span> Exception {
</span></span><span style="display:flex;"><span>        TokenRequest request <span style="color:#f92672">=</span> TokenRequest.<span style="color:#a6e22e">builder</span>()
</span></span><span style="display:flex;"><span>                .<span style="color:#a6e22e">username</span>(<span style="color:#e6db74">&#34;testUser&#34;</span>)
</span></span><span style="display:flex;"><span>                .<span style="color:#a6e22e">password</span>(<span style="color:#e6db74">&#34;testPassword&#34;</span>)
</span></span><span style="display:flex;"><span>                .<span style="color:#a6e22e">build</span>();
</span></span><span style="display:flex;"><span>        mvc.<span style="color:#a6e22e">perform</span>(MockMvcRequestBuilders.<span style="color:#a6e22e">post</span>(<span style="color:#e6db74">&#34;/token/create&#34;</span>)
</span></span><span style="display:flex;"><span>                        .<span style="color:#a6e22e">contentType</span>(MediaType.<span style="color:#a6e22e">APPLICATION_JSON</span>)
</span></span><span style="display:flex;"><span>                        .<span style="color:#a6e22e">content</span>(<span style="color:#66d9ef">new</span> ObjectMapper().<span style="color:#a6e22e">writeValueAsString</span>(request)))
</span></span><span style="display:flex;"><span>                .<span style="color:#a6e22e">andExpect</span>(status().<span style="color:#a6e22e">isUnauthorized</span>());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Test</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">shouldGenerateAuthToken</span>() <span style="color:#66d9ef">throws</span> Exception {
</span></span><span style="display:flex;"><span>        TokenRequest request <span style="color:#f92672">=</span> TokenRequest.<span style="color:#a6e22e">builder</span>()
</span></span><span style="display:flex;"><span>                .<span style="color:#a6e22e">username</span>(<span style="color:#e6db74">&#34;libUser&#34;</span>)
</span></span><span style="display:flex;"><span>                .<span style="color:#a6e22e">password</span>(<span style="color:#e6db74">&#34;libPassword&#34;</span>)
</span></span><span style="display:flex;"><span>                .<span style="color:#a6e22e">build</span>();
</span></span><span style="display:flex;"><span>        mvc.<span style="color:#a6e22e">perform</span>(MockMvcRequestBuilders.<span style="color:#a6e22e">post</span>(<span style="color:#e6db74">&#34;/token/create&#34;</span>)
</span></span><span style="display:flex;"><span>                        .<span style="color:#a6e22e">contentType</span>(MediaType.<span style="color:#a6e22e">APPLICATION_JSON</span>)
</span></span><span style="display:flex;"><span>                        .<span style="color:#a6e22e">content</span>(<span style="color:#66d9ef">new</span> ObjectMapper().<span style="color:#a6e22e">writeValueAsString</span>(request)))
</span></span><span style="display:flex;"><span>                .<span style="color:#a6e22e">andExpect</span>(status().<span style="color:#a6e22e">isOk</span>());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>在这里，我们将用来<code>@MockMvc</code>验证我们的<code>TokenController</code>类端点在正面和负面场景中是否按预期工作。</p>
<p>类似地，我们的<code>BookControllerTest</code>意愿是这样的：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@SpringBootTest</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@AutoConfigureMockMvc</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@SqlGroup</span>({
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">@Sql</span>(value <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;classpath:init/first.sql&#34;</span>, 
</span></span><span style="display:flex;"><span>                executionPhase <span style="color:#f92672">=</span> BEFORE_TEST_METHOD),
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">@Sql</span>(value <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;classpath:init/second.sql&#34;</span>, 
</span></span><span style="display:flex;"><span>                executionPhase <span style="color:#f92672">=</span> BEFORE_TEST_METHOD)
</span></span><span style="display:flex;"><span>})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">BookControllerTest</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Autowired</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> MockMvc mockMvc;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Test</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">failsAsBearerTokenNotSet</span>() <span style="color:#66d9ef">throws</span> Exception {
</span></span><span style="display:flex;"><span>        mockMvc.<span style="color:#a6e22e">perform</span>(get(<span style="color:#e6db74">&#34;/library/books/all&#34;</span>))
</span></span><span style="display:flex;"><span>                .<span style="color:#a6e22e">andDo</span>(print())
</span></span><span style="display:flex;"><span>                .<span style="color:#a6e22e">andExpect</span>(status().<span style="color:#a6e22e">isUnauthorized</span>());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Test</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">testWithValidBearerToken</span>() <span style="color:#66d9ef">throws</span> Exception {
</span></span><span style="display:flex;"><span>        TokenRequest request <span style="color:#f92672">=</span> TokenRequest.<span style="color:#a6e22e">builder</span>()
</span></span><span style="display:flex;"><span>                .<span style="color:#a6e22e">username</span>(<span style="color:#e6db74">&#34;libUser&#34;</span>)
</span></span><span style="display:flex;"><span>                .<span style="color:#a6e22e">password</span>(<span style="color:#e6db74">&#34;libPassword&#34;</span>)
</span></span><span style="display:flex;"><span>                .<span style="color:#a6e22e">build</span>();
</span></span><span style="display:flex;"><span>        MvcResult mvcResult <span style="color:#f92672">=</span> mockMvc.<span style="color:#a6e22e">perform</span>(
</span></span><span style="display:flex;"><span>                MockMvcRequestBuilders.<span style="color:#a6e22e">post</span>(<span style="color:#e6db74">&#34;/token/create&#34;</span>)
</span></span><span style="display:flex;"><span>                        .<span style="color:#a6e22e">contentType</span>(MediaType.<span style="color:#a6e22e">APPLICATION_JSON</span>)
</span></span><span style="display:flex;"><span>                        .<span style="color:#a6e22e">content</span>(<span style="color:#66d9ef">new</span> ObjectMapper().<span style="color:#a6e22e">writeValueAsString</span>(request)))
</span></span><span style="display:flex;"><span>                .<span style="color:#a6e22e">andExpect</span>(status().<span style="color:#a6e22e">isOk</span>()).<span style="color:#a6e22e">andReturn</span>();
</span></span><span style="display:flex;"><span>        String resultStr <span style="color:#f92672">=</span> mvcResult.<span style="color:#a6e22e">getResponse</span>().<span style="color:#a6e22e">getContentAsString</span>();
</span></span><span style="display:flex;"><span>        TokenResponse token <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ObjectMapper().<span style="color:#a6e22e">readValue</span>(
</span></span><span style="display:flex;"><span>                resultStr, TokenResponse.<span style="color:#a6e22e">class</span>);
</span></span><span style="display:flex;"><span>        mockMvc.<span style="color:#a6e22e">perform</span>(get(<span style="color:#e6db74">&#34;/library/books/all&#34;</span>)
</span></span><span style="display:flex;"><span>                        .<span style="color:#a6e22e">header</span>(<span style="color:#e6db74">&#34;Authorization&#34;</span>, <span style="color:#e6db74">&#34;Bearer &#34;</span> <span style="color:#f92672">+</span> token.<span style="color:#a6e22e">getToken</span>()))
</span></span><span style="display:flex;"><span>                .<span style="color:#a6e22e">andDo</span>(print())
</span></span><span style="display:flex;"><span>                .<span style="color:#a6e22e">andExpect</span>(status().<span style="color:#a6e22e">isOk</span>())
</span></span><span style="display:flex;"><span>                .<span style="color:#a6e22e">andExpect</span>(jsonPath(<span style="color:#e6db74">&#34;$&#34;</span>, hasSize(5)));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Test</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">testWithInvalidBearerToken</span>() <span style="color:#66d9ef">throws</span> Exception {
</span></span><span style="display:flex;"><span>        mockMvc.<span style="color:#a6e22e">perform</span>(get(<span style="color:#e6db74">&#34;/library/books/all&#34;</span>)
</span></span><span style="display:flex;"><span>                        .<span style="color:#a6e22e">header</span>(<span style="color:#e6db74">&#34;Authorization&#34;</span>, <span style="color:#e6db74">&#34;Bearer 123&#34;</span>))
</span></span><span style="display:flex;"><span>                .<span style="color:#a6e22e">andDo</span>(print())
</span></span><span style="display:flex;"><span>                .<span style="color:#a6e22e">andExpect</span>(status().<span style="color:#a6e22e">isUnauthorized</span>());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>为了测试应用程序端点，我们将使用 Spring<code>MockMvc</code>类并使用示例 SQL 脚本将数据加载到内存数据库中。为此，我们将使用注释<code>@SqlGroup</code>并将<code>@Sql</code>插入脚本放在<code>/resources/init</code>文件夹中。</p>
<p>为了验证端点是否成功运行<code>testWithValidBearerToken()</code>，我们将首先<code>/token/create</code> 使用 调用端点<code>MockMvc</code>，从响应中提取令牌，并将令牌设置在下<code>Authorization</code>一次调用的标头中<code>/library/books/all</code>。</p>
<h2 id="结论">结论</h2>
<p>总而言之，在安全性方面，JWT 身份验证比 Spring 的基本身份验证领先一步。它是最受欢迎的身份验证和授权方式之一。在本文中，我们探讨了一些最佳实践、使用 JWT 的优势，并研究了如何配置一个简单的 Spring Boot 应用程序以使用 JWT 来确保安全性。</p>
<p>原文链接：<a href="https://reflectoring.io/spring-security-jwt/" target="_blank">https://reflectoring.io/spring-security-jwt/</a></p>

		</div>


	</article>
</main>
<footer class="post__footer">
	

<div class="post-related">
	<h3>相关文章</h3>
	<ul class="post-related-list">
		
		<li class="post-related-item">
			<a href="/posts/2024/06/05/oauth2-with-spring-part-4-spring-authorization-client-social-login-demo-with-google/" target="_blank" title="[译]OAuth2 with Spring 第4部分：Spring授权客户端与Google授权服务器的社交登录演示">[译]OAuth2 with Spring 第4部分：Spring授权客户端与Google授权服务器的社交登录演示</a>
		</li>
		
		<li class="post-related-item">
			<a href="/posts/2024/06/05/oauth2-with-spring-part-5-securing-your-spring-boot-application-with-pkce-for-enhanced-security/" target="_blank" title="[译]OAuth2 with Spring 第5部分：使用PKCE保护您的Spring Boot应用程序以增强安全性">[译]OAuth2 with Spring 第5部分：使用PKCE保护您的Spring Boot应用程序以增强安全性</a>
		</li>
		
		<li class="post-related-item">
			<a href="/posts/2024/05/30/building-a-restful-api-with-spring-boot-integrating-ddd-and-hexagonal-architecture/" target="_blank" title="[译]使用 Spring Boot 构建 RESTful API：集成 DDD 和六边形架构">[译]使用 Spring Boot 构建 RESTful API：集成 DDD 和六边形架构</a>
		</li>
		
		<li class="post-related-item">
			<a href="/posts/2024/01/30/til/" target="_blank" title="2024-01-30｜Mybatis plus和Jackson配置">2024-01-30｜Mybatis plus和Jackson配置</a>
		</li>
		
		<li class="post-related-item">
			<a href="/posts/2023/10/12/spring-security-interview-questions/" target="_blank" title="[译]Spring Security 面试问题">[译]Spring Security 面试问题</a>
		</li>
		
		<li class="post-related-item">
			<a href="/posts/2023/09/19/spring-security-jwt/" target="_blank" title="[译]如何使用Spring Security和JWT保护您的REST API">[译]如何使用Spring Security和JWT保护您的REST API</a>
		</li>
		
	</ul>
</div>

</footer>

<footer class="post__footer">
	<footer class="post__footer">
		
<div class="post__tags tags clearfix">
	<svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M4 0h8s2 0 4 2l15 15s2 2 0 4L21 31s-2 2-4 0L2 16s-2-2-2-4V3s0-3 4-3m3 10a3 3 0 0 0 0-6 3 3 0 0 0 0 6"/></svg>
	<ul class="tags__list">
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/java/" rel="tag">java</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/javascript/" rel="tag">javascript</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/backend/" rel="tag">backend</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/security/" rel="tag">security</a>
		</li>
	</ul>
</div>
	</footer>
</footer>


<nav class="pagination flex">
	<div class="pagination__item pagination__item--prev">
		<a class="pagination__link" href="/posts/2024/10/14/testing-spring-boot-applications-best-practices-and-frameworks/" rel="prev">
			<p class="pagination__title">«&thinsp;上一篇: [译]测试 Spring Boot 应用程序：最佳实践和框架</p>
		</a>
	</div>
	<div class="pagination__item pagination__item--next">
		<a class="pagination__link" href="/posts/2024/10/17/kafka-fundamental/" rel="next">
			<p class="pagination__title">&thinsp;» 下一篇: Kafka 基础知识</p>
		</a>
	</div>
</nav>



<div class="authorbox clearfix">
	<figure class="authorbox__avatar">
		<img alt="ChenSoul avatar" src="/avatar.jpg" class="avatar" height="60" width="60" loading="lazy">
	</figure>
	<div class="authorbox__header">
		<span class="authorbox__name">关于 ChenSoul</span>
	</div>
	<div class="authorbox__description">
		一个来自中国武汉的开发者，主要撰写软件开发和开源方面的文章。浏览我的<a href="%28/posts%29">博客文章</a>，订阅我的 <a href="/index.xml">RSS</a> 源，或了解更多<a href="/about/">关于我</a>的信息。
	</div>
</div>




	<p><h3>欢迎留言！</h3></p>
<div id="remark42"></div>
<script>
	var remark_config = {
		host: 'https:\/\/comment.chensoul.cc',
		site_id: 'remark',
		components: ['embed'],
		url: 'https:\/\/blog.chensoul.cc\/posts\/2024\/10\/15\/spring-security-jwt\/',
		locale: 'zh'
	};

	!function(e, n) {
		for (var o = 0; o < e.length; o++) {
			var r = n.createElement('script'),
			c = '.js',
			d = n.head || n.body;
			'noModule' in r ? (r.type = 'module', c = '.mjs') : r.async = !0, r.defer = !0, r.src = remark_config.host + '/web/' + e[o] + c, d.appendChild(r)
		}
	}(remark_config.components || ['embed'], document);

</script>





			</div>
			

<aside class="sidebar sidebar--right">
	<div class="post__toc toc">
		<div class="toc__title">目录</div>
		<div class="toc__menu">
			<nav id="TableOfContents">
  <ul>
    <li><a href="#示例代码">示例代码</a></li>
    <li><a href="#什么是-jwt">什么是 JWT</a></li>
    <li><a href="#jwt-结构">JWT 结构</a>
      <ul>
        <li><a href="#jwt-标头">JWT 标头</a></li>
        <li><a href="#jwt-有效负载">JWT 有效负载</a></li>
        <li><a href="#jwt-签名">JWT 签名</a></li>
      </ul>
    </li>
    <li><a href="#jwt-的常见用例">JWT 的常见用例</a></li>
    <li><a href="#使用-jwt-的注意事项">使用 JWT 的注意事项</a></li>
    <li><a href="#使用-java-创建-jwt-令牌">使用 Java 创建 JWT 令牌</a>
      <ul>
        <li><a href="#配置-jwt-依赖项">配置 JWT 依赖项</a></li>
        <li><a href="#创建-jwt-令牌">创建 JWT 令牌</a></li>
        <li><a href="#解析-jwt-令牌">解析 JWT 令牌</a></li>
        <li><a href="#spring-security-中基本身份验证和-jwt-的比较">Spring Security 中基本身份验证和 JWT 的比较</a></li>
      </ul>
    </li>
    <li><a href="#在-spring-boot-应用程序中实现-jwt">在 Spring Boot 应用程序中实现 JWT</a>
      <ul>
        <li><a href="#拦截-jwt-的-spring-security-过滤器链">拦截 JWT 的 Spring Security 过滤器链</a></li>
        <li><a href="#jwt-令牌创建端点">JWT 令牌创建端点</a></li>
        <li><a href="#保护图书馆应用程序端点">保护图书馆应用程序端点</a></li>
        <li><a href="#使用-jwt-处理异常">使用 JWT 处理异常</a></li>
      </ul>
    </li>
    <li><a href="#swagger-文档">Swagger 文档</a></li>
    <li><a href="#添加-spring-security-测试">添加 Spring Security 测试</a></li>
    <li><a href="#结论">结论</a></li>
  </ul>
</nav>
		</div>
	</div>
</aside>

		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
<div class="footer__links">
	<a class="footer__link" href="/">首页</a> | <a class="footer__link" href="/categories/">分类</a> | <a class="footer__link" href="/tags/">标签</a> | <a class="footer__link" href="/index.xml">订阅</a> | <a class="footer__link" href="/about/">关于</a>
</div>
		<div class="footer__copyright">
			&copy; 2025 ChenSoul.
			<span class="footer__copyright-credits">基于 <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> 引擎和 <a href="https://github.com/chensoul/rose-hugo/" rel="nofollow noopener" target="_blank">Rose Hugo</a> 主题</span>
		</div>
	</div>

	






<style>
	.scroll-up a {
		display: block;
		height: 3.125rem;
		width: 3.125rem;
		text-align: center;
		line-height: 2.7;
		border-radius: 50px;
		font-size: 1.125rem;
		color: #fff;
		opacity: 1;
		transition: all 0.3s ease 0s;
		box-shadow: 0 0 10px rgb(0 0 0 / 20%);
	}
	.scroll-up a {
		background: #ee591f;
	}
	.scroll-up {
		position: fixed;
		display: none;
		bottom: 50px;
		z-index: 999;
	}
	.scroll-up.right {
		right: 60px;
	}
</style>

<div class="scroll-up custom right" style="display: block;"><a href="#top" id="top-link" accesskey="g"><i
	class="fa fa-arrow-up"></i></a></div>

<script>
	var mybutton = document.getElementById("top-link");
	window.onscroll = function () {
		if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
			mybutton.style.visibility = "visible";
			mybutton.style.opacity = "1";
		} else {
			mybutton.style.visibility = "hidden";
			mybutton.style.opacity = "0";
		}
	};
</script>


    <script defer src="https://umami.chensoul.cc/random-string.js" data-website-id="1e07d36d-bec3-4ba6-9459-876b1ac3bbe7"></script>
</footer>


	</div>

	<script>
		'use strict';
		(function iifeMenu(document, window, undefined) {
			var menuBtn = document.querySelector('.menu__btn');
			var	menu = document.querySelector('.menu__list');
			function toggleMenu() {
				menu.classList.toggle('menu__list--active');
				menu.classList.toggle('menu__list--transition');
				this.classList.toggle('menu__btn--active');
				this.setAttribute(
					'aria-expanded',
					this.getAttribute('aria-expanded') === 'true' ? 'false' : 'true'
				);
			}
			function removeMenuTransition() {
				this.classList.remove('menu__list--transition');
			}
			if (menuBtn && menu) {
				menuBtn.addEventListener('click', toggleMenu, false);
				menu.addEventListener('transitionend', removeMenuTransition, false);
			}
		}(document, window));
	</script>
</body>
</html>