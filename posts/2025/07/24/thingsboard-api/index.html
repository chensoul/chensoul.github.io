<!doctype html><html class=no-js lang=zh-cn><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>ThingsBoard接口设计 - Java、Spring、Spring Boot、MicroServices、Architecture、Kubernetes、DevOps</title><script>(function(e,t){e[t]=e[t].replace("no-js","js")})(document.documentElement,"className")</script><meta name=description content><meta property="og:title" content="ThingsBoard接口设计"><meta property="og:description" content="Java、Spring、Spring Boot、MicroServices、Architecture、Kubernetes、DevOps"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.chensoul.cc/posts/2025/07/24/thingsboard-api/"><meta property="og:site_name" content="ChenSoul Blog"><meta property="og:image" content><meta itemprop=name content="ThingsBoard接口设计"><meta itemprop=description content="本文档整理了ThingsBoard平台的各种协议接口设计，作为IoT平台开发的参考。"><meta itemprop=datePublished content="2025-07-24T00:00:00+00:00"><meta itemprop=dateModified content="2025-07-24T00:00:00+00:00"><meta itemprop=wordCount content="3255"><meta itemprop=keywords content="Thingsboard"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="ThingsBoard接口设计"><meta name=twitter:description content="Java、Spring、Spring Boot、MicroServices、Architecture、Kubernetes、DevOps"><meta name=twitter:image content><link rel=preconnect href=//fonts.loli.net crossorigin><link rel=dns-prefetch href=//fonts.loli.net><link rel=stylesheet href="https://fonts.loli.net/css?family=Open+Sans:400,400i,700"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css integrity="sha512-2SwdPD6INVrV/lHTZbO2nodKhrnDdJK9/kg2XD1r9uGqPo1cUbujc+IYdlYdEErWNu69gVcYgdxlmVmzTWnetw==" crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=/css/style.css><link rel="shortcut icon" href=/favicon.ico></head><body class=body><div class="container container--outer"><header class=header><div class="container header__container"><div class="logo logo--mixed"><a class=logo__link href=/ title="ChenSoul Blog" rel=home><div class="logo__item logo__imagebox"><img class=logo__img src=/logo.svg loading=lazy alt="Site logo" width=60 height=60></div><div class="logo__item logo__text"><div class=logo__title>ChenSoul Blog</div><div class=logo__tagline>Java、Spring、Spring Boot、MicroServices、Architecture、Kubernetes、DevOps</div></div></a></div><nav class=menu><button class=menu__btn aria-haspopup=true aria-expanded=false tabindex=0>
<span class=menu__btn-title tabindex=-1>菜单</span></button><ul class=menu__list><li class=menu__item><a class=menu__link href=/><span class=menu__text>首页</span></a></li><li class=menu__item><a class=menu__link href=/categories/><span class=menu__text>分类</span></a></li><li class=menu__item><a class=menu__link href=/about/><span class=menu__text>关于</span></a></li><li class=menu__item><a class=menu__link href=/index.xml><span class=menu__text>RSS</span></a></li></ul></nav></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>ThingsBoard接口设计</h1><div class="post__meta meta"><div class="meta__item-datetime meta__item"><svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0a14 14 0 110 28 1 1 0 010-28m0 3a3 3 0 100 22 3 3 0 000-22m1 4h-2v8.4l6.8 4.4L22 18l-6-3.8z"/></svg><time class=meta__text datetime=2025-07-24>2025-07-24</time></div><div class="meta__item-categories meta__item"><svg class="meta__icon icon icon-category" width="16" height="16" viewBox="0 0 16 16"><path d="m7 2 1 2h8v11H0V2z"/></svg><span class=meta__text><a class=meta__link href=/categories/java/ rel=category>Java</a></span></div><div class="meta__item-author meta__item"><svg class="meta__icon icon icon-author" width="16" height="16" viewBox="0 0 16 16"><path d="M8 1c2 0 3.5 2 3.5 4.5S10 9 10 9c3 1 4 2 4 6H2c0-4 1-5 4-6 0 0-1.5-1-1.5-3.5S6 1 8 1"/></svg><span class=meta__text>ChenSoul</span></div></div></header><div class="content post__content clearfix"><p>本文档整理了ThingsBoard平台的各种协议接口设计，作为IoT平台开发的参考。</p><h2 id=1-rest-api接口>1. REST API接口</h2><h3 id=11-认证接口>1.1 认证接口</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>POST /api/auth/login
</span></span><span style=display:flex><span>POST /api/auth/token
</span></span><span style=display:flex><span>POST /api/auth/logout
</span></span></code></pre></div><h3 id=12-设备管理接口>1.2 设备管理接口</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 设备CRUD</span>
</span></span><span style=display:flex><span>POST   /api/device
</span></span><span style=display:flex><span>GET    /api/device/<span style=color:#f92672>{</span>deviceId<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>PUT    /api/device/<span style=color:#f92672>{</span>deviceId<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>DELETE /api/device/<span style=color:#f92672>{</span>deviceId<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 设备属性</span>
</span></span><span style=display:flex><span>GET    /api/device/<span style=color:#f92672>{</span>deviceId<span style=color:#f92672>}</span>/attributes
</span></span><span style=display:flex><span>POST   /api/device/<span style=color:#f92672>{</span>deviceId<span style=color:#f92672>}</span>/attributes
</span></span><span style=display:flex><span>DELETE /api/device/<span style=color:#f92672>{</span>deviceId<span style=color:#f92672>}</span>/attributes/<span style=color:#f92672>{</span>scope<span style=color:#f92672>}</span>/<span style=color:#f92672>{</span>attributeKey<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 设备关系</span>
</span></span><span style=display:flex><span>GET    /api/device/<span style=color:#f92672>{</span>deviceId<span style=color:#f92672>}</span>/relations
</span></span><span style=display:flex><span>POST   /api/device/<span style=color:#f92672>{</span>deviceId<span style=color:#f92672>}</span>/relation
</span></span><span style=display:flex><span>DELETE /api/device/<span style=color:#f92672>{</span>deviceId<span style=color:#f92672>}</span>/relation
</span></span></code></pre></div><h3 id=13-遥测数据接口>1.3 遥测数据接口</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 时间序列数据</span>
</span></span><span style=display:flex><span>POST   /api/plugins/telemetry/DEVICE/<span style=color:#f92672>{</span>deviceId<span style=color:#f92672>}</span>/values/timeseries
</span></span><span style=display:flex><span>GET    /api/plugins/telemetry/DEVICE/<span style=color:#f92672>{</span>deviceId<span style=color:#f92672>}</span>/values/timeseries
</span></span><span style=display:flex><span>DELETE /api/plugins/telemetry/DEVICE/<span style=color:#f92672>{</span>deviceId<span style=color:#f92672>}</span>/values/timeseries
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 属性数据</span>
</span></span><span style=display:flex><span>POST   /api/plugins/telemetry/DEVICE/<span style=color:#f92672>{</span>deviceId<span style=color:#f92672>}</span>/values/attributes
</span></span><span style=display:flex><span>GET    /api/plugins/telemetry/DEVICE/<span style=color:#f92672>{</span>deviceId<span style=color:#f92672>}</span>/values/attributes
</span></span><span style=display:flex><span>DELETE /api/plugins/telemetry/DEVICE/<span style=color:#f92672>{</span>deviceId<span style=color:#f92672>}</span>/values/attributes
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 聚合数据</span>
</span></span><span style=display:flex><span>GET    /api/plugins/telemetry/DEVICE/<span style=color:#f92672>{</span>deviceId<span style=color:#f92672>}</span>/values/aggregation
</span></span></code></pre></div><h3 id=14-租户管理接口>1.4 租户管理接口</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 租户CRUD</span>
</span></span><span style=display:flex><span>POST   /api/tenant
</span></span><span style=display:flex><span>GET    /api/tenant/<span style=color:#f92672>{</span>tenantId<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>PUT    /api/tenant/<span style=color:#f92672>{</span>tenantId<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>DELETE /api/tenant/<span style=color:#f92672>{</span>tenantId<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 租户信息</span>
</span></span><span style=display:flex><span>GET    /api/tenant/info
</span></span></code></pre></div><h3 id=15-客户管理接口>1.5 客户管理接口</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 客户CRUD</span>
</span></span><span style=display:flex><span>POST   /api/customer
</span></span><span style=display:flex><span>GET    /api/customer/<span style=color:#f92672>{</span>customerId<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>PUT    /api/customer/<span style=color:#f92672>{</span>customerId<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>DELETE /api/customer/<span style=color:#f92672>{</span>customerId<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 客户设备</span>
</span></span><span style=display:flex><span>GET    /api/customer/<span style=color:#f92672>{</span>customerId<span style=color:#f92672>}</span>/devices
</span></span><span style=display:flex><span>POST   /api/customer/<span style=color:#f92672>{</span>customerId<span style=color:#f92672>}</span>/device/<span style=color:#f92672>{</span>deviceId<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>DELETE /api/customer/<span style=color:#f92672>{</span>customerId<span style=color:#f92672>}</span>/device/<span style=color:#f92672>{</span>deviceId<span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=16-用户管理接口>1.6 用户管理接口</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 用户CRUD</span>
</span></span><span style=display:flex><span>POST   /api/user
</span></span><span style=display:flex><span>GET    /api/user/<span style=color:#f92672>{</span>userId<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>PUT    /api/user/<span style=color:#f92672>{</span>userId<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>DELETE /api/user/<span style=color:#f92672>{</span>userId<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 用户权限</span>
</span></span><span style=display:flex><span>GET    /api/user/<span style=color:#f92672>{</span>userId<span style=color:#f92672>}</span>/authority
</span></span><span style=display:flex><span>POST   /api/user/<span style=color:#f92672>{</span>userId<span style=color:#f92672>}</span>/authority
</span></span></code></pre></div><h3 id=17-规则引擎接口>1.7 规则引擎接口</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 规则链</span>
</span></span><span style=display:flex><span>POST   /api/ruleChain
</span></span><span style=display:flex><span>GET    /api/ruleChain/<span style=color:#f92672>{</span>ruleChainId<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>PUT    /api/ruleChain/<span style=color:#f92672>{</span>ruleChainId<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>DELETE /api/ruleChain/<span style=color:#f92672>{</span>ruleChainId<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 规则节点</span>
</span></span><span style=display:flex><span>POST   /api/ruleNode
</span></span><span style=display:flex><span>GET    /api/ruleNode/<span style=color:#f92672>{</span>ruleNodeId<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>PUT    /api/ruleNode/<span style=color:#f92672>{</span>ruleNodeId<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>DELETE /api/ruleNode/<span style=color:#f92672>{</span>ruleNodeId<span style=color:#f92672>}</span>
</span></span></code></pre></div><h2 id=2-mqtt接口>2. MQTT接口</h2><h3 id=21-设备连接>2.1 设备连接</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 设备认证</span>
</span></span><span style=display:flex><span>POST /v1/devices/me/telemetry
</span></span><span style=display:flex><span>POST /v1/devices/me/attributes
</span></span><span style=display:flex><span>GET  /v1/devices/me/attributes
</span></span><span style=display:flex><span>POST /v1/devices/me/attributes/request
</span></span><span style=display:flex><span>POST /v1/devices/me/attributes/response
</span></span></code></pre></div><h3 id=22-遥测数据>2.2 遥测数据</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 发布遥测数据</span>
</span></span><span style=display:flex><span>Topic: v1/devices/me/telemetry
</span></span><span style=display:flex><span>Payload: <span style=color:#f92672>{</span><span style=color:#e6db74>&#34;temperature&#34;</span>: 25.5, <span style=color:#e6db74>&#34;humidity&#34;</span>: 60.2<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 发布属性</span>
</span></span><span style=display:flex><span>Topic: v1/devices/me/attributes
</span></span><span style=display:flex><span>Payload: <span style=color:#f92672>{</span><span style=color:#e6db74>&#34;firmware_version&#34;</span>: <span style=color:#e6db74>&#34;1.0.0&#34;</span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=23-命令下发>2.3 命令下发</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 订阅命令</span>
</span></span><span style=display:flex><span>Topic: v1/devices/me/commands/request/+
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 响应命令</span>
</span></span><span style=display:flex><span>Topic: v1/devices/me/commands/response/<span style=color:#f92672>{</span>requestId<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>Payload: <span style=color:#f92672>{</span><span style=color:#e6db74>&#34;status&#34;</span>: <span style=color:#e6db74>&#34;SUCCESS&#34;</span>, <span style=color:#e6db74>&#34;data&#34;</span>: <span style=color:#f92672>{</span>...<span style=color:#f92672>}}</span>
</span></span></code></pre></div><h3 id=24-属性请求>2.4 属性请求</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 请求属性</span>
</span></span><span style=display:flex><span>Topic: v1/devices/me/attributes/request/<span style=color:#f92672>{</span>requestId<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>Payload: <span style=color:#f92672>{</span><span style=color:#e6db74>&#34;clientKeys&#34;</span>: <span style=color:#f92672>[</span><span style=color:#e6db74>&#34;key1&#34;</span>, <span style=color:#e6db74>&#34;key2&#34;</span><span style=color:#f92672>]</span>, <span style=color:#e6db74>&#34;sharedKeys&#34;</span>: <span style=color:#f92672>[</span><span style=color:#e6db74>&#34;sharedKey1&#34;</span><span style=color:#f92672>]}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 响应属性</span>
</span></span><span style=display:flex><span>Topic: v1/devices/me/attributes/response/<span style=color:#f92672>{</span>requestId<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>Payload: <span style=color:#f92672>{</span><span style=color:#e6db74>&#34;key1&#34;</span>: <span style=color:#e6db74>&#34;value1&#34;</span>, <span style=color:#e6db74>&#34;key2&#34;</span>: <span style=color:#e6db74>&#34;value2&#34;</span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h2 id=3-websocket接口>3. WebSocket接口</h2><h3 id=31-连接url>3.1 连接URL</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 设备连接</span>
</span></span><span style=display:flex><span>ws://thingsboard:8080/api/ws/plugins/telemetry?token<span style=color:#f92672>={</span>deviceToken<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 用户连接</span>
</span></span><span style=display:flex><span>ws://thingsboard:8080/api/ws/plugins/telemetry?token<span style=color:#f92672>={</span>userToken<span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=32-消息格式>3.2 消息格式</h3><h4 id=321-订阅消息>3.2.1 订阅消息</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;deviceId&#34;</span>: <span style=color:#e6db74>&#34;device_001&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;keys&#34;</span>: [<span style=color:#e6db74>&#34;temperature&#34;</span>, <span style=color:#e6db74>&#34;humidity&#34;</span>],
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;startTs&#34;</span>: <span style=color:#ae81ff>1640995200000</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;endTs&#34;</span>: <span style=color:#ae81ff>1641081600000</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;interval&#34;</span>: <span style=color:#ae81ff>1000</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;limit&#34;</span>: <span style=color:#ae81ff>100</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;agg&#34;</span>: <span style=color:#e6db74>&#34;AVG&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=322-实时数据推送>3.2.2 实时数据推送</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;subscriptionId&#34;</span>: <span style=color:#ae81ff>1</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;errorCode&#34;</span>: <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;errorMsg&#34;</span>: <span style=color:#66d9ef>null</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;data&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;temperature&#34;</span>: <span style=color:#ae81ff>25.5</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;humidity&#34;</span>: <span style=color:#ae81ff>60.2</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;ts&#34;</span>: <span style=color:#ae81ff>1640995200000</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=323-命令下发>3.2.3 命令下发</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;deviceId&#34;</span>: <span style=color:#e6db74>&#34;device_001&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;command&#34;</span>: <span style=color:#e6db74>&#34;setTemperature&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;params&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;temperature&#34;</span>: <span style=color:#ae81ff>26.0</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=4-coap接口>4. CoAP接口</h2><h3 id=41-设备连接>4.1 设备连接</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 设备认证</span>
</span></span><span style=display:flex><span>POST /api/v1/<span style=color:#f92672>{</span>deviceToken<span style=color:#f92672>}</span>/telemetry
</span></span><span style=display:flex><span>POST /api/v1/<span style=color:#f92672>{</span>deviceToken<span style=color:#f92672>}</span>/attributes
</span></span><span style=display:flex><span>GET  /api/v1/<span style=color:#f92672>{</span>deviceToken<span style=color:#f92672>}</span>/attributes
</span></span></code></pre></div><h3 id=42-数据上报>4.2 数据上报</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 遥测数据</span>
</span></span><span style=display:flex><span>POST /api/v1/<span style=color:#f92672>{</span>deviceToken<span style=color:#f92672>}</span>/telemetry
</span></span><span style=display:flex><span>Content-Type: application/json
</span></span><span style=display:flex><span>Payload: <span style=color:#f92672>{</span><span style=color:#e6db74>&#34;temperature&#34;</span>: 25.5, <span style=color:#e6db74>&#34;humidity&#34;</span>: 60.2<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 属性数据</span>
</span></span><span style=display:flex><span>POST /api/v1/<span style=color:#f92672>{</span>deviceToken<span style=color:#f92672>}</span>/attributes
</span></span><span style=display:flex><span>Content-Type: application/json
</span></span><span style=display:flex><span>Payload: <span style=color:#f92672>{</span><span style=color:#e6db74>&#34;firmware_version&#34;</span>: <span style=color:#e6db74>&#34;1.0.0&#34;</span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h2 id=5-http接口>5. HTTP接口</h2><h3 id=51-设备数据接口>5.1 设备数据接口</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 遥测数据上报</span>
</span></span><span style=display:flex><span>POST /api/v1/<span style=color:#f92672>{</span>deviceToken<span style=color:#f92672>}</span>/telemetry
</span></span><span style=display:flex><span>Content-Type: application/json
</span></span><span style=display:flex><span>Payload: <span style=color:#f92672>{</span><span style=color:#e6db74>&#34;temperature&#34;</span>: 25.5, <span style=color:#e6db74>&#34;humidity&#34;</span>: 60.2<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 属性上报</span>
</span></span><span style=display:flex><span>POST /api/v1/<span style=color:#f92672>{</span>deviceToken<span style=color:#f92672>}</span>/attributes
</span></span><span style=display:flex><span>Content-Type: application/json
</span></span><span style=display:flex><span>Payload: <span style=color:#f92672>{</span><span style=color:#e6db74>&#34;firmware_version&#34;</span>: <span style=color:#e6db74>&#34;1.0.0&#34;</span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 获取属性</span>
</span></span><span style=display:flex><span>GET /api/v1/<span style=color:#f92672>{</span>deviceToken<span style=color:#f92672>}</span>/attributes
</span></span></code></pre></div><h3 id=52-命令接口>5.2 命令接口</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 获取命令</span>
</span></span><span style=display:flex><span>GET /api/v1/<span style=color:#f92672>{</span>deviceToken<span style=color:#f92672>}</span>/commands?timeout<span style=color:#f92672>={</span>timeout<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 响应命令</span>
</span></span><span style=display:flex><span>POST /api/v1/<span style=color:#f92672>{</span>deviceToken<span style=color:#f92672>}</span>/commands/<span style=color:#f92672>{</span>commandId<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>Content-Type: application/json
</span></span><span style=display:flex><span>Payload: <span style=color:#f92672>{</span><span style=color:#e6db74>&#34;status&#34;</span>: <span style=color:#e6db74>&#34;SUCCESS&#34;</span>, <span style=color:#e6db74>&#34;data&#34;</span>: <span style=color:#f92672>{</span>...<span style=color:#f92672>}}</span>
</span></span></code></pre></div><h2 id=6-接口设计特点>6. 接口设计特点</h2><h3 id=61-统一认证>6.1 统一认证</h3><ul><li><strong>JWT Token</strong>: REST API和WebSocket使用JWT Token认证</li><li><strong>设备Token</strong>: MQTT、CoAP、HTTP设备接口使用设备Token认证</li><li><strong>Token刷新</strong>: 支持Token自动刷新机制</li></ul><h3 id=62-数据格式>6.2 数据格式</h3><ul><li><strong>JSON格式</strong>: 所有接口使用JSON作为数据交换格式</li><li><strong>时间戳</strong>: 使用毫秒级时间戳</li><li><strong>错误码</strong>: 统一的错误码和错误信息格式</li></ul><h3 id=63-版本控制>6.3 版本控制</h3><ul><li><strong>URL版本</strong>: 使用 <code>/api/v1/</code> 进行版本控制</li><li><strong>向后兼容</strong>: 新版本保持对旧版本的兼容性</li><li><strong>版本弃用</strong>: 提供版本弃用通知和迁移指南</li></ul><h3 id=64-权限控制>6.4 权限控制</h3><ul><li><strong>租户隔离</strong>: 多租户数据隔离</li><li><strong>角色权限</strong>: 基于角色的权限控制</li><li><strong>资源权限</strong>: 细粒度资源权限控制</li></ul><h2 id=7-最佳实践>7. 最佳实践</h2><h3 id=71-设备连接>7.1 设备连接</h3><ul><li>使用设备Token进行设备认证</li><li>实现断线重连机制</li><li>支持心跳保活</li></ul><h3 id=72-数据上报>7.2 数据上报</h3><ul><li>批量上报减少网络开销</li><li>使用压缩减少数据传输量</li><li>实现数据缓存和重传机制</li></ul><h3 id=73-命令下发>7.3 命令下发</h3><ul><li>使用唯一命令ID</li><li>实现命令超时处理</li><li>支持命令状态跟踪</li></ul><h3 id=74-错误处理>7.4 错误处理</h3><ul><li>统一的错误码定义</li><li>详细的错误信息</li><li>错误重试机制</li></ul><h2 id=8-接口测试>8. 接口测试</h2><h3 id=81-测试环境准备>8.1 测试环境准备</h3><h4 id=811-thingsboard环境搭建>8.1.1 ThingsBoard环境搭建</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 使用Docker快速搭建ThingsBoard环境</span>
</span></span><span style=display:flex><span>docker run -it -p 9090:9090 -p 1883:1883 -p 5683:5683/udp <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --name thingsboard <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --restart always <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  thingsboard/tb-postgres
</span></span></code></pre></div><h4 id=812-测试工具准备>8.1.2 测试工具准备</h4><ul><li><strong>Postman</strong>: REST API测试</li><li><strong>MQTT.fx</strong>: MQTT协议测试</li><li><strong>WebSocket客户端</strong>: WebSocket测试</li><li><strong>CoAP客户端</strong>: CoAP协议测试</li><li><strong>curl</strong>: 命令行HTTP测试</li></ul><h3 id=82-rest-api测试>8.2 REST API测试</h3><h4 id=821-认证测试>8.2.1 认证测试</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 用户登录获取Token</span>
</span></span><span style=display:flex><span>curl -X POST http://localhost:9090/api/auth/login <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -H <span style=color:#e6db74>&#34;Content-Type: application/json&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -d <span style=color:#e6db74>&#39;{
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;username&#34;: &#34;tenant@thingsboard.org&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;password&#34;: &#34;tenant&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  }&#39;</span> | jq
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 响应示例</span>
</span></span><span style=display:flex><span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;token&#34;</span>: <span style=color:#e6db74>&#34;eyJhbGciOiJIUzI1NiJ9...&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;refreshToken&#34;</span>: <span style=color:#e6db74>&#34;eyJhbGciOiJIUzI1NiJ9...&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;expiresIn&#34;</span>: <span style=color:#ae81ff>86400</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h4 id=822-设备管理测试>8.2.2 设备管理测试</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 创建设备</span>
</span></span><span style=display:flex><span>curl -X POST http://localhost:9090/api/device <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -H <span style=color:#e6db74>&#34;Content-Type: application/json&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -H <span style=color:#e6db74>&#34;X-Authorization: Bearer YOUR_TOKEN&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -d <span style=color:#e6db74>&#39;{
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;name&#34;: &#34;Test Device&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;type&#34;: &#34;default&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;additionalInfo&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#34;description&#34;: &#34;Test device for API testing&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  }&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 查询设备</span>
</span></span><span style=display:flex><span>curl -X GET http://localhost:9090/api/device/<span style=color:#f92672>{</span>deviceId<span style=color:#f92672>}</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -H <span style=color:#e6db74>&#34;X-Authorization: Bearer YOUR_TOKEN&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 更新设备</span>
</span></span><span style=display:flex><span>curl -X PUT http://localhost:9090/api/device/<span style=color:#f92672>{</span>deviceId<span style=color:#f92672>}</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -H <span style=color:#e6db74>&#34;Content-Type: application/json&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -H <span style=color:#e6db74>&#34;X-Authorization: Bearer YOUR_TOKEN&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -d <span style=color:#e6db74>&#39;{
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;name&#34;: &#34;Updated Test Device&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;type&#34;: &#34;default&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  }&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 删除设备</span>
</span></span><span style=display:flex><span>curl -X DELETE http://localhost:9090/api/device/<span style=color:#f92672>{</span>deviceId<span style=color:#f92672>}</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -H <span style=color:#e6db74>&#34;X-Authorization: Bearer YOUR_TOKEN&#34;</span>
</span></span></code></pre></div><h4 id=823-设备预注册测试>8.2.3 设备预注册测试</h4><h5 id=8231-设备预注册api>8.2.3.1 设备预注册API</h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 设备预注册（创建设备并获取访问令牌）</span>
</span></span><span style=display:flex><span>curl -X POST http://localhost:9090/api/device <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -H <span style=color:#e6db74>&#34;Content-Type: application/json&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -H <span style=color:#e6db74>&#34;X-Authorization: Bearer YOUR_TOKEN&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -d <span style=color:#e6db74>&#39;{
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;name&#34;: &#34;PreRegisteredDevice_001&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;type&#34;: &#34;default&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;additionalInfo&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#34;description&#34;: &#34;Pre-registered device for testing&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#34;manufacturer&#34;: &#34;TestManufacturer&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#34;model&#34;: &#34;TestModel&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#34;firmwareVersion&#34;: &#34;1.0.0&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  }&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 获取设备访问令牌</span>
</span></span><span style=display:flex><span>curl -X GET http://localhost:9090/api/device/<span style=color:#f92672>{</span>deviceId<span style=color:#f92672>}</span>/credentials <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -H <span style=color:#e6db74>&#34;X-Authorization: Bearer YOUR_TOKEN&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 更新设备访问令牌</span>
</span></span><span style=display:flex><span>curl -X POST http://localhost:9090/api/device/<span style=color:#f92672>{</span>deviceId<span style=color:#f92672>}</span>/credentials <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -H <span style=color:#e6db74>&#34;Content-Type: application/json&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -H <span style=color:#e6db74>&#34;X-Authorization: Bearer YOUR_TOKEN&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -d <span style=color:#e6db74>&#39;{
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;credentialsType&#34;: &#34;ACCESS_TOKEN&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;credentialsId&#34;: &#34;NEW_DEVICE_TOKEN_001&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  }&#39;</span>
</span></span></code></pre></div><h5 id=8232-python设备预注册测试脚本>8.2.3.2 Python设备预注册测试脚本</h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e>#!/usr/bin/env python3</span>
</span></span><span style=display:flex><span><span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>ThingsBoard设备预注册测试脚本
</span></span></span><span style=display:flex><span><span style=color:#e6db74>支持批量设备预注册、令牌管理和连接测试
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> requests
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> json
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> time
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> uuid
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> csv
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> typing <span style=color:#f92672>import</span> List, Dict, Optional
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> logging
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 配置日志</span>
</span></span><span style=display:flex><span>logging<span style=color:#f92672>.</span>basicConfig(level<span style=color:#f92672>=</span>logging<span style=color:#f92672>.</span>INFO, format<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;</span><span style=color:#e6db74>%(asctime)s</span><span style=color:#e6db74> - </span><span style=color:#e6db74>%(levelname)s</span><span style=color:#e6db74> - </span><span style=color:#e6db74>%(message)s</span><span style=color:#e6db74>&#39;</span>)
</span></span><span style=display:flex><span>logger <span style=color:#f92672>=</span> logging<span style=color:#f92672>.</span>getLogger(__name__)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>DevicePreRegistrationTester</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>__init__</span>(self, host: str <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;localhost&#34;</span>, port: int <span style=color:#f92672>=</span> <span style=color:#ae81ff>9090</span>, user_token: str <span style=color:#f92672>=</span> <span style=color:#66d9ef>None</span>):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>host <span style=color:#f92672>=</span> host
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>port <span style=color:#f92672>=</span> port
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>user_token <span style=color:#f92672>=</span> user_token
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>base_url <span style=color:#f92672>=</span> <span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;http://</span><span style=color:#e6db74>{</span>host<span style=color:#e6db74>}</span><span style=color:#e6db74>:</span><span style=color:#e6db74>{</span>port<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>headers <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;Content-Type&#34;</span>: <span style=color:#e6db74>&#34;application/json&#34;</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> user_token:
</span></span><span style=display:flex><span>            self<span style=color:#f92672>.</span>headers[<span style=color:#e6db74>&#34;X-Authorization&#34;</span>] <span style=color:#f92672>=</span> <span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;Bearer </span><span style=color:#e6db74>{</span>user_token<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>registered_devices <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>login</span>(self, username: str, password: str) <span style=color:#f92672>-&gt;</span> bool:
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;&#34;&#34;用户登录获取Token&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>            login_data <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;username&#34;</span>: username,
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;password&#34;</span>: password
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            response <span style=color:#f92672>=</span> requests<span style=color:#f92672>.</span>post(
</span></span><span style=display:flex><span>                <span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>{</span>self<span style=color:#f92672>.</span>base_url<span style=color:#e6db74>}</span><span style=color:#e6db74>/api/auth/login&#34;</span>,
</span></span><span style=display:flex><span>                headers<span style=color:#f92672>=</span>{<span style=color:#e6db74>&#34;Content-Type&#34;</span>: <span style=color:#e6db74>&#34;application/json&#34;</span>},
</span></span><span style=display:flex><span>                json<span style=color:#f92672>=</span>login_data
</span></span><span style=display:flex><span>            )
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> response<span style=color:#f92672>.</span>status_code <span style=color:#f92672>==</span> <span style=color:#ae81ff>200</span>:
</span></span><span style=display:flex><span>                token_data <span style=color:#f92672>=</span> response<span style=color:#f92672>.</span>json()
</span></span><span style=display:flex><span>                self<span style=color:#f92672>.</span>user_token <span style=color:#f92672>=</span> token_data[<span style=color:#e6db74>&#34;token&#34;</span>]
</span></span><span style=display:flex><span>                self<span style=color:#f92672>.</span>headers[<span style=color:#e6db74>&#34;X-Authorization&#34;</span>] <span style=color:#f92672>=</span> <span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;Bearer </span><span style=color:#e6db74>{</span>self<span style=color:#f92672>.</span>user_token<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>                logger<span style=color:#f92672>.</span>info(<span style=color:#e6db74>&#34;登录成功，获取到Token&#34;</span>)
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>True</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>                logger<span style=color:#f92672>.</span>error(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;登录失败: </span><span style=color:#e6db74>{</span>response<span style=color:#f92672>.</span>status_code<span style=color:#e6db74>}</span><span style=color:#e6db74> - </span><span style=color:#e6db74>{</span>response<span style=color:#f92672>.</span>text<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>False</span>
</span></span><span style=display:flex><span>                
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>except</span> <span style=color:#a6e22e>Exception</span> <span style=color:#66d9ef>as</span> e:
</span></span><span style=display:flex><span>            logger<span style=color:#f92672>.</span>error(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;登录异常: </span><span style=color:#e6db74>{</span>e<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>False</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>create_device</span>(self, device_name: str, device_type: str <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;default&#34;</span>, 
</span></span><span style=display:flex><span>                     additional_info: Dict <span style=color:#f92672>=</span> <span style=color:#66d9ef>None</span>) <span style=color:#f92672>-&gt;</span> Optional[Dict]:
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;&#34;&#34;创建设备&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>            device_data <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;name&#34;</span>: device_name,
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;type&#34;</span>: device_type
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> additional_info:
</span></span><span style=display:flex><span>                device_data[<span style=color:#e6db74>&#34;additionalInfo&#34;</span>] <span style=color:#f92672>=</span> additional_info
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            response <span style=color:#f92672>=</span> requests<span style=color:#f92672>.</span>post(
</span></span><span style=display:flex><span>                <span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>{</span>self<span style=color:#f92672>.</span>base_url<span style=color:#e6db74>}</span><span style=color:#e6db74>/api/device&#34;</span>,
</span></span><span style=display:flex><span>                headers<span style=color:#f92672>=</span>self<span style=color:#f92672>.</span>headers,
</span></span><span style=display:flex><span>                json<span style=color:#f92672>=</span>device_data
</span></span><span style=display:flex><span>            )
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> response<span style=color:#f92672>.</span>status_code <span style=color:#f92672>==</span> <span style=color:#ae81ff>200</span>:
</span></span><span style=display:flex><span>                device_info <span style=color:#f92672>=</span> response<span style=color:#f92672>.</span>json()
</span></span><span style=display:flex><span>                logger<span style=color:#f92672>.</span>info(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;设备创建成功: </span><span style=color:#e6db74>{</span>device_name<span style=color:#e6db74>}</span><span style=color:#e6db74> (ID: </span><span style=color:#e6db74>{</span>device_info[<span style=color:#e6db74>&#39;id&#39;</span>][<span style=color:#e6db74>&#39;id&#39;</span>]<span style=color:#e6db74>}</span><span style=color:#e6db74>)&#34;</span>)
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> device_info
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>                logger<span style=color:#f92672>.</span>error(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;设备创建失败: </span><span style=color:#e6db74>{</span>response<span style=color:#f92672>.</span>status_code<span style=color:#e6db74>}</span><span style=color:#e6db74> - </span><span style=color:#e6db74>{</span>response<span style=color:#f92672>.</span>text<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>None</span>
</span></span><span style=display:flex><span>                
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>except</span> <span style=color:#a6e22e>Exception</span> <span style=color:#66d9ef>as</span> e:
</span></span><span style=display:flex><span>            logger<span style=color:#f92672>.</span>error(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;创建设备异常: </span><span style=color:#e6db74>{</span>e<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>None</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_device_credentials</span>(self, device_id: str) <span style=color:#f92672>-&gt;</span> Optional[Dict]:
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;&#34;&#34;获取设备访问令牌&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>            response <span style=color:#f92672>=</span> requests<span style=color:#f92672>.</span>get(
</span></span><span style=display:flex><span>                <span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>{</span>self<span style=color:#f92672>.</span>base_url<span style=color:#e6db74>}</span><span style=color:#e6db74>/api/device/</span><span style=color:#e6db74>{</span>device_id<span style=color:#e6db74>}</span><span style=color:#e6db74>/credentials&#34;</span>,
</span></span><span style=display:flex><span>                headers<span style=color:#f92672>=</span>self<span style=color:#f92672>.</span>headers
</span></span><span style=display:flex><span>            )
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> response<span style=color:#f92672>.</span>status_code <span style=color:#f92672>==</span> <span style=color:#ae81ff>200</span>:
</span></span><span style=display:flex><span>                credentials <span style=color:#f92672>=</span> response<span style=color:#f92672>.</span>json()
</span></span><span style=display:flex><span>                logger<span style=color:#f92672>.</span>info(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;获取设备令牌成功: </span><span style=color:#e6db74>{</span>device_id<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> credentials
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>                logger<span style=color:#f92672>.</span>error(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;获取设备令牌失败: </span><span style=color:#e6db74>{</span>response<span style=color:#f92672>.</span>status_code<span style=color:#e6db74>}</span><span style=color:#e6db74> - </span><span style=color:#e6db74>{</span>response<span style=color:#f92672>.</span>text<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>None</span>
</span></span><span style=display:flex><span>                
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>except</span> <span style=color:#a6e22e>Exception</span> <span style=color:#66d9ef>as</span> e:
</span></span><span style=display:flex><span>            logger<span style=color:#f92672>.</span>error(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;获取设备令牌异常: </span><span style=color:#e6db74>{</span>e<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>None</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>update_device_credentials</span>(self, device_id: str, credentials_id: str) <span style=color:#f92672>-&gt;</span> bool:
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;&#34;&#34;更新设备访问令牌&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>            credentials_data <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;credentialsType&#34;</span>: <span style=color:#e6db74>&#34;ACCESS_TOKEN&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;credentialsId&#34;</span>: credentials_id
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            response <span style=color:#f92672>=</span> requests<span style=color:#f92672>.</span>post(
</span></span><span style=display:flex><span>                <span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>{</span>self<span style=color:#f92672>.</span>base_url<span style=color:#e6db74>}</span><span style=color:#e6db74>/api/device/</span><span style=color:#e6db74>{</span>device_id<span style=color:#e6db74>}</span><span style=color:#e6db74>/credentials&#34;</span>,
</span></span><span style=display:flex><span>                headers<span style=color:#f92672>=</span>self<span style=color:#f92672>.</span>headers,
</span></span><span style=display:flex><span>                json<span style=color:#f92672>=</span>credentials_data
</span></span><span style=display:flex><span>            )
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> response<span style=color:#f92672>.</span>status_code <span style=color:#f92672>==</span> <span style=color:#ae81ff>200</span>:
</span></span><span style=display:flex><span>                logger<span style=color:#f92672>.</span>info(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;更新设备令牌成功: </span><span style=color:#e6db74>{</span>device_id<span style=color:#e6db74>}</span><span style=color:#e6db74> -&gt; </span><span style=color:#e6db74>{</span>credentials_id<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>True</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>                logger<span style=color:#f92672>.</span>error(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;更新设备令牌失败: </span><span style=color:#e6db74>{</span>response<span style=color:#f92672>.</span>status_code<span style=color:#e6db74>}</span><span style=color:#e6db74> - </span><span style=color:#e6db74>{</span>response<span style=color:#f92672>.</span>text<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>False</span>
</span></span><span style=display:flex><span>                
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>except</span> <span style=color:#a6e22e>Exception</span> <span style=color:#66d9ef>as</span> e:
</span></span><span style=display:flex><span>            logger<span style=color:#f92672>.</span>error(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;更新设备令牌异常: </span><span style=color:#e6db74>{</span>e<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>False</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>batch_create_devices</span>(self, device_count: int, prefix: str <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;TestDevice&#34;</span>, 
</span></span><span style=display:flex><span>                           device_type: str <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;default&#34;</span>) <span style=color:#f92672>-&gt;</span> List[Dict]:
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;&#34;&#34;批量创建设备&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        logger<span style=color:#f92672>.</span>info(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;开始批量创建设备，数量: </span><span style=color:#e6db74>{</span>device_count<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        created_devices <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> range(device_count):
</span></span><span style=display:flex><span>            device_name <span style=color:#f92672>=</span> <span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>{</span>prefix<span style=color:#e6db74>}</span><span style=color:#e6db74>_</span><span style=color:#e6db74>{</span>i<span style=color:#f92672>+</span><span style=color:#ae81ff>1</span><span style=color:#e6db74>:</span><span style=color:#e6db74>03d</span><span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>            additional_info <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;description&#34;</span>: <span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;Batch created device </span><span style=color:#e6db74>{</span>i<span style=color:#f92672>+</span><span style=color:#ae81ff>1</span><span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;manufacturer&#34;</span>: <span style=color:#e6db74>&#34;TestManufacturer&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;model&#34;</span>: <span style=color:#e6db74>&#34;TestModel&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;firmwareVersion&#34;</span>: <span style=color:#e6db74>&#34;1.0.0&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;batchId&#34;</span>: <span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;batch_</span><span style=color:#e6db74>{</span>int(time<span style=color:#f92672>.</span>time())<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;createdAt&#34;</span>: int(time<span style=color:#f92672>.</span>time() <span style=color:#f92672>*</span> <span style=color:#ae81ff>1000</span>)
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            device_info <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>create_device(device_name, device_type, additional_info)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> device_info:
</span></span><span style=display:flex><span>                created_devices<span style=color:#f92672>.</span>append(device_info)
</span></span><span style=display:flex><span>                <span style=color:#75715e># 添加延迟避免请求过快</span>
</span></span><span style=display:flex><span>                time<span style=color:#f92672>.</span>sleep(<span style=color:#ae81ff>0.1</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>                logger<span style=color:#f92672>.</span>warning(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;设备 </span><span style=color:#e6db74>{</span>device_name<span style=color:#e6db74>}</span><span style=color:#e6db74> 创建失败&#34;</span>)
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        logger<span style=color:#f92672>.</span>info(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;批量创建设备完成，成功: </span><span style=color:#e6db74>{</span>len(created_devices)<span style=color:#e6db74>}</span><span style=color:#e6db74>/</span><span style=color:#e6db74>{</span>device_count<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> created_devices
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>generate_device_tokens</span>(self, devices: List[Dict]) <span style=color:#f92672>-&gt;</span> List[Dict]:
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;&#34;&#34;为设备生成访问令牌&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        logger<span style=color:#f92672>.</span>info(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;开始为 </span><span style=color:#e6db74>{</span>len(devices)<span style=color:#e6db74>}</span><span style=color:#e6db74> 个设备生成令牌&#34;</span>)
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        devices_with_tokens <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> device <span style=color:#f92672>in</span> devices:
</span></span><span style=display:flex><span>            device_id <span style=color:#f92672>=</span> device[<span style=color:#e6db74>&#34;id&#34;</span>][<span style=color:#e6db74>&#34;id&#34;</span>]
</span></span><span style=display:flex><span>            device_name <span style=color:#f92672>=</span> device[<span style=color:#e6db74>&#34;name&#34;</span>]
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            <span style=color:#75715e># 生成唯一令牌</span>
</span></span><span style=display:flex><span>            token <span style=color:#f92672>=</span> <span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;DEVICE_TOKEN_</span><span style=color:#e6db74>{</span>device_name<span style=color:#e6db74>}</span><span style=color:#e6db74>_</span><span style=color:#e6db74>{</span>uuid<span style=color:#f92672>.</span>uuid4()<span style=color:#f92672>.</span>hex[:<span style=color:#ae81ff>8</span>]<span style=color:#f92672>.</span>upper()<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            <span style=color:#75715e># 更新设备令牌</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> self<span style=color:#f92672>.</span>update_device_credentials(device_id, token):
</span></span><span style=display:flex><span>                device[<span style=color:#e6db74>&#34;accessToken&#34;</span>] <span style=color:#f92672>=</span> token
</span></span><span style=display:flex><span>                devices_with_tokens<span style=color:#f92672>.</span>append(device)
</span></span><span style=display:flex><span>                logger<span style=color:#f92672>.</span>info(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;设备 </span><span style=color:#e6db74>{</span>device_name<span style=color:#e6db74>}</span><span style=color:#e6db74> 令牌生成成功: </span><span style=color:#e6db74>{</span>token<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>                logger<span style=color:#f92672>.</span>error(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;设备 </span><span style=color:#e6db74>{</span>device_name<span style=color:#e6db74>}</span><span style=color:#e6db74> 令牌生成失败&#34;</span>)
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        logger<span style=color:#f92672>.</span>info(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;令牌生成完成，成功: </span><span style=color:#e6db74>{</span>len(devices_with_tokens)<span style=color:#e6db74>}</span><span style=color:#e6db74>/</span><span style=color:#e6db74>{</span>len(devices)<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> devices_with_tokens
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>test_device_connection</span>(self, device_token: str, protocol: str <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;mqtt&#34;</span>) <span style=color:#f92672>-&gt;</span> bool:
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;&#34;&#34;测试设备连接&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> protocol<span style=color:#f92672>.</span>lower() <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;mqtt&#34;</span>:
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> self<span style=color:#f92672>.</span>_test_mqtt_connection(device_token)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>elif</span> protocol<span style=color:#f92672>.</span>lower() <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;http&#34;</span>:
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> self<span style=color:#f92672>.</span>_test_http_connection(device_token)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>                logger<span style=color:#f92672>.</span>error(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;不支持的协议: </span><span style=color:#e6db74>{</span>protocol<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>False</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>except</span> <span style=color:#a6e22e>Exception</span> <span style=color:#66d9ef>as</span> e:
</span></span><span style=display:flex><span>            logger<span style=color:#f92672>.</span>error(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;设备连接测试异常: </span><span style=color:#e6db74>{</span>e<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>False</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>_test_mqtt_connection</span>(self, device_token: str) <span style=color:#f92672>-&gt;</span> bool:
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;&#34;&#34;测试MQTT连接&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>import</span> paho.mqtt.client <span style=color:#66d9ef>as</span> mqtt
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>on_connect</span>(client, userdata, flags, rc):
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> rc <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>:
</span></span><span style=display:flex><span>                    logger<span style=color:#f92672>.</span>info(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;MQTT连接成功: </span><span style=color:#e6db74>{</span>device_token<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>                    client<span style=color:#f92672>.</span>disconnect()
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>                    logger<span style=color:#f92672>.</span>error(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;MQTT连接失败: </span><span style=color:#e6db74>{</span>rc<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            client <span style=color:#f92672>=</span> mqtt<span style=color:#f92672>.</span>Client()
</span></span><span style=display:flex><span>            client<span style=color:#f92672>.</span>username_pw_set(device_token, <span style=color:#e6db74>&#34;&#34;</span>)
</span></span><span style=display:flex><span>            client<span style=color:#f92672>.</span>on_connect <span style=color:#f92672>=</span> on_connect
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            client<span style=color:#f92672>.</span>connect(self<span style=color:#f92672>.</span>host, <span style=color:#ae81ff>1883</span>, <span style=color:#ae81ff>10</span>)
</span></span><span style=display:flex><span>            client<span style=color:#f92672>.</span>loop_start()
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            <span style=color:#75715e># 等待连接结果</span>
</span></span><span style=display:flex><span>            time<span style=color:#f92672>.</span>sleep(<span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span>            client<span style=color:#f92672>.</span>loop_stop()
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>True</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>except</span> <span style=color:#a6e22e>Exception</span> <span style=color:#66d9ef>as</span> e:
</span></span><span style=display:flex><span>            logger<span style=color:#f92672>.</span>error(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;MQTT连接测试异常: </span><span style=color:#e6db74>{</span>e<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>False</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>_test_http_connection</span>(self, device_token: str) <span style=color:#f92672>-&gt;</span> bool:
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;&#34;&#34;测试HTTP连接&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>            <span style=color:#75715e># 发送测试遥测数据</span>
</span></span><span style=display:flex><span>            telemetry_data <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;test&#34;</span>: <span style=color:#e6db74>&#34;connection_test&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;timestamp&#34;</span>: int(time<span style=color:#f92672>.</span>time() <span style=color:#f92672>*</span> <span style=color:#ae81ff>1000</span>)
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            response <span style=color:#f92672>=</span> requests<span style=color:#f92672>.</span>post(
</span></span><span style=display:flex><span>                <span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;http://</span><span style=color:#e6db74>{</span>self<span style=color:#f92672>.</span>host<span style=color:#e6db74>}</span><span style=color:#e6db74>:8080/api/v1/</span><span style=color:#e6db74>{</span>device_token<span style=color:#e6db74>}</span><span style=color:#e6db74>/telemetry&#34;</span>,
</span></span><span style=display:flex><span>                headers<span style=color:#f92672>=</span>{<span style=color:#e6db74>&#34;Content-Type&#34;</span>: <span style=color:#e6db74>&#34;application/json&#34;</span>},
</span></span><span style=display:flex><span>                json<span style=color:#f92672>=</span>telemetry_data
</span></span><span style=display:flex><span>            )
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> response<span style=color:#f92672>.</span>status_code <span style=color:#f92672>==</span> <span style=color:#ae81ff>200</span>:
</span></span><span style=display:flex><span>                logger<span style=color:#f92672>.</span>info(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;HTTP连接测试成功: </span><span style=color:#e6db74>{</span>device_token<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>True</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>                logger<span style=color:#f92672>.</span>error(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;HTTP连接测试失败: </span><span style=color:#e6db74>{</span>response<span style=color:#f92672>.</span>status_code<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>False</span>
</span></span><span style=display:flex><span>                
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>except</span> <span style=color:#a6e22e>Exception</span> <span style=color:#66d9ef>as</span> e:
</span></span><span style=display:flex><span>            logger<span style=color:#f92672>.</span>error(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;HTTP连接测试异常: </span><span style=color:#e6db74>{</span>e<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>False</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>export_devices_to_csv</span>(self, devices: List[Dict], filename: str <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;devices.csv&#34;</span>):
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;&#34;&#34;导出设备信息到CSV文件&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>with</span> open(filename, <span style=color:#e6db74>&#39;w&#39;</span>, newline<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;&#39;</span>, encoding<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;utf-8&#39;</span>) <span style=color:#66d9ef>as</span> csvfile:
</span></span><span style=display:flex><span>                fieldnames <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#39;device_id&#39;</span>, <span style=color:#e6db74>&#39;device_name&#39;</span>, <span style=color:#e6db74>&#39;device_type&#39;</span>, <span style=color:#e6db74>&#39;access_token&#39;</span>, 
</span></span><span style=display:flex><span>                             <span style=color:#e6db74>&#39;manufacturer&#39;</span>, <span style=color:#e6db74>&#39;model&#39;</span>, <span style=color:#e6db74>&#39;firmware_version&#39;</span>, <span style=color:#e6db74>&#39;created_time&#39;</span>]
</span></span><span style=display:flex><span>                writer <span style=color:#f92672>=</span> csv<span style=color:#f92672>.</span>DictWriter(csvfile, fieldnames<span style=color:#f92672>=</span>fieldnames)
</span></span><span style=display:flex><span>                
</span></span><span style=display:flex><span>                writer<span style=color:#f92672>.</span>writeheader()
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>for</span> device <span style=color:#f92672>in</span> devices:
</span></span><span style=display:flex><span>                    additional_info <span style=color:#f92672>=</span> device<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#39;additionalInfo&#39;</span>, {})
</span></span><span style=display:flex><span>                    writer<span style=color:#f92672>.</span>writerow({
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#39;device_id&#39;</span>: device[<span style=color:#e6db74>&#39;id&#39;</span>][<span style=color:#e6db74>&#39;id&#39;</span>],
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#39;device_name&#39;</span>: device[<span style=color:#e6db74>&#39;name&#39;</span>],
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#39;device_type&#39;</span>: device[<span style=color:#e6db74>&#39;type&#39;</span>],
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#39;access_token&#39;</span>: device<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#39;accessToken&#39;</span>, <span style=color:#e6db74>&#39;&#39;</span>),
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#39;manufacturer&#39;</span>: additional_info<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#39;manufacturer&#39;</span>, <span style=color:#e6db74>&#39;&#39;</span>),
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#39;model&#39;</span>: additional_info<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#39;model&#39;</span>, <span style=color:#e6db74>&#39;&#39;</span>),
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#39;firmware_version&#39;</span>: additional_info<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#39;firmwareVersion&#39;</span>, <span style=color:#e6db74>&#39;&#39;</span>),
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#39;created_time&#39;</span>: additional_info<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#39;createdAt&#39;</span>, <span style=color:#e6db74>&#39;&#39;</span>)
</span></span><span style=display:flex><span>                    })
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            logger<span style=color:#f92672>.</span>info(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;设备信息已导出到: </span><span style=color:#e6db74>{</span>filename<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>except</span> <span style=color:#a6e22e>Exception</span> <span style=color:#66d9ef>as</span> e:
</span></span><span style=display:flex><span>            logger<span style=color:#f92672>.</span>error(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;导出CSV文件异常: </span><span style=color:#e6db74>{</span>e<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>cleanup_devices</span>(self, devices: List[Dict]) <span style=color:#f92672>-&gt;</span> int:
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;&#34;&#34;清理测试设备&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        logger<span style=color:#f92672>.</span>info(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;开始清理 </span><span style=color:#e6db74>{</span>len(devices)<span style=color:#e6db74>}</span><span style=color:#e6db74> 个测试设备&#34;</span>)
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        cleaned_count <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> device <span style=color:#f92672>in</span> devices:
</span></span><span style=display:flex><span>            device_id <span style=color:#f92672>=</span> device[<span style=color:#e6db74>&#34;id&#34;</span>][<span style=color:#e6db74>&#34;id&#34;</span>]
</span></span><span style=display:flex><span>            device_name <span style=color:#f92672>=</span> device[<span style=color:#e6db74>&#34;name&#34;</span>]
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>                response <span style=color:#f92672>=</span> requests<span style=color:#f92672>.</span>delete(
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>{</span>self<span style=color:#f92672>.</span>base_url<span style=color:#e6db74>}</span><span style=color:#e6db74>/api/device/</span><span style=color:#e6db74>{</span>device_id<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>,
</span></span><span style=display:flex><span>                    headers<span style=color:#f92672>=</span>self<span style=color:#f92672>.</span>headers
</span></span><span style=display:flex><span>                )
</span></span><span style=display:flex><span>                
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> response<span style=color:#f92672>.</span>status_code <span style=color:#f92672>==</span> <span style=color:#ae81ff>200</span>:
</span></span><span style=display:flex><span>                    logger<span style=color:#f92672>.</span>info(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;设备删除成功: </span><span style=color:#e6db74>{</span>device_name<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>                    cleaned_count <span style=color:#f92672>+=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>                    logger<span style=color:#f92672>.</span>error(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;设备删除失败: </span><span style=color:#e6db74>{</span>device_name<span style=color:#e6db74>}</span><span style=color:#e6db74> - </span><span style=color:#e6db74>{</span>response<span style=color:#f92672>.</span>status_code<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>                
</span></span><span style=display:flex><span>                time<span style=color:#f92672>.</span>sleep(<span style=color:#ae81ff>0.1</span>)  <span style=color:#75715e># 添加延迟</span>
</span></span><span style=display:flex><span>                
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>except</span> <span style=color:#a6e22e>Exception</span> <span style=color:#66d9ef>as</span> e:
</span></span><span style=display:flex><span>                logger<span style=color:#f92672>.</span>error(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;删除设备异常: </span><span style=color:#e6db74>{</span>device_name<span style=color:#e6db74>}</span><span style=color:#e6db74> - </span><span style=color:#e6db74>{</span>e<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        logger<span style=color:#f92672>.</span>info(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;设备清理完成，成功: </span><span style=color:#e6db74>{</span>cleaned_count<span style=color:#e6db74>}</span><span style=color:#e6db74>/</span><span style=color:#e6db74>{</span>len(devices)<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> cleaned_count
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>run_comprehensive_test</span>(self, device_count: int <span style=color:#f92672>=</span> <span style=color:#ae81ff>10</span>, test_connection: bool <span style=color:#f92672>=</span> <span style=color:#66d9ef>True</span>):
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;&#34;&#34;运行完整的设备预注册测试&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        logger<span style=color:#f92672>.</span>info(<span style=color:#e6db74>&#34;开始运行设备预注册综合测试&#34;</span>)
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#75715e># 1. 批量创建设备</span>
</span></span><span style=display:flex><span>        devices <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>batch_create_devices(device_count)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> devices:
</span></span><span style=display:flex><span>            logger<span style=color:#f92672>.</span>error(<span style=color:#e6db74>&#34;设备创建失败，测试终止&#34;</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#75715e># 2. 生成设备令牌</span>
</span></span><span style=display:flex><span>        devices_with_tokens <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>generate_device_tokens(devices)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> devices_with_tokens:
</span></span><span style=display:flex><span>            logger<span style=color:#f92672>.</span>error(<span style=color:#e6db74>&#34;令牌生成失败，测试终止&#34;</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#75715e># 3. 测试设备连接</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> test_connection:
</span></span><span style=display:flex><span>            connection_results <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>for</span> device <span style=color:#f92672>in</span> devices_with_tokens:
</span></span><span style=display:flex><span>                token <span style=color:#f92672>=</span> device<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#39;accessToken&#39;</span>)
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> token:
</span></span><span style=display:flex><span>                    mqtt_result <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>test_device_connection(token, <span style=color:#e6db74>&#34;mqtt&#34;</span>)
</span></span><span style=display:flex><span>                    http_result <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>test_device_connection(token, <span style=color:#e6db74>&#34;http&#34;</span>)
</span></span><span style=display:flex><span>                    connection_results<span style=color:#f92672>.</span>append({
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#39;device_name&#39;</span>: device[<span style=color:#e6db74>&#39;name&#39;</span>],
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#39;mqtt_connection&#39;</span>: mqtt_result,
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#39;http_connection&#39;</span>: http_result
</span></span><span style=display:flex><span>                    })
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            <span style=color:#75715e># 统计连接结果</span>
</span></span><span style=display:flex><span>            mqtt_success <span style=color:#f92672>=</span> sum(<span style=color:#ae81ff>1</span> <span style=color:#66d9ef>for</span> r <span style=color:#f92672>in</span> connection_results <span style=color:#66d9ef>if</span> r[<span style=color:#e6db74>&#39;mqtt_connection&#39;</span>])
</span></span><span style=display:flex><span>            http_success <span style=color:#f92672>=</span> sum(<span style=color:#ae81ff>1</span> <span style=color:#66d9ef>for</span> r <span style=color:#f92672>in</span> connection_results <span style=color:#66d9ef>if</span> r[<span style=color:#e6db74>&#39;http_connection&#39;</span>])
</span></span><span style=display:flex><span>            logger<span style=color:#f92672>.</span>info(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;连接测试结果 - MQTT: </span><span style=color:#e6db74>{</span>mqtt_success<span style=color:#e6db74>}</span><span style=color:#e6db74>/</span><span style=color:#e6db74>{</span>len(connection_results)<span style=color:#e6db74>}</span><span style=color:#e6db74>, HTTP: </span><span style=color:#e6db74>{</span>http_success<span style=color:#e6db74>}</span><span style=color:#e6db74>/</span><span style=color:#e6db74>{</span>len(connection_results)<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#75715e># 4. 导出设备信息</span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>export_devices_to_csv(devices_with_tokens)
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#75715e># 5. 保存测试结果</span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>registered_devices <span style=color:#f92672>=</span> devices_with_tokens
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        logger<span style=color:#f92672>.</span>info(<span style=color:#e6db74>&#34;设备预注册综合测试完成&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> devices_with_tokens
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 使用示例</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;__main__&#34;</span>:
</span></span><span style=display:flex><span>    <span style=color:#75715e># 创建测试器实例</span>
</span></span><span style=display:flex><span>    tester <span style=color:#f92672>=</span> DevicePreRegistrationTester(host<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;localhost&#34;</span>, port<span style=color:#f92672>=</span><span style=color:#ae81ff>9090</span>)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 登录（可选，如果已有Token）</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># tester.login(&#34;tenant@thingsboard.org&#34;, &#34;tenant&#34;)</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 运行综合测试</span>
</span></span><span style=display:flex><span>    devices <span style=color:#f92672>=</span> tester<span style=color:#f92672>.</span>run_comprehensive_test(device_count<span style=color:#f92672>=</span><span style=color:#ae81ff>5</span>, test_connection<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 查看结果</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> devices:
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>成功预注册 </span><span style=color:#e6db74>{</span>len(devices)<span style=color:#e6db74>}</span><span style=color:#e6db74> 个设备:&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> device <span style=color:#f92672>in</span> devices:
</span></span><span style=display:flex><span>            print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;  - </span><span style=color:#e6db74>{</span>device[<span style=color:#e6db74>&#39;name&#39;</span>]<span style=color:#e6db74>}</span><span style=color:#e6db74>: </span><span style=color:#e6db74>{</span>device<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#39;accessToken&#39;</span>, <span style=color:#e6db74>&#39;N/A&#39;</span>)<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 清理测试设备（可选）</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># tester.cleanup_devices(devices)</span>
</span></span></code></pre></div><h5 id=8233-shell脚本版本>8.2.3.3 Shell脚本版本</h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e># ThingsBoard设备预注册测试脚本</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 配置参数</span>
</span></span><span style=display:flex><span>THINGSBOARD_HOST<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;localhost&#34;</span>
</span></span><span style=display:flex><span>THINGSBOARD_PORT<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;9090&#34;</span>
</span></span><span style=display:flex><span>USER_TOKEN<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;YOUR_USER_TOKEN&#34;</span>
</span></span><span style=display:flex><span>DEVICE_COUNT<span style=color:#f92672>=</span><span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>DEVICE_PREFIX<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;TestDevice&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 颜色输出</span>
</span></span><span style=display:flex><span>RED<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;\033[0;31m&#39;</span>
</span></span><span style=display:flex><span>GREEN<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;\033[0;32m&#39;</span>
</span></span><span style=display:flex><span>YELLOW<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;\033[1;33m&#39;</span>
</span></span><span style=display:flex><span>NC<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;\033[0m&#39;</span> <span style=color:#75715e># No Color</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 日志函数</span>
</span></span><span style=display:flex><span>log_info<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    echo -e <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>GREEN<span style=color:#e6db74>}</span><span style=color:#e6db74>[INFO]</span><span style=color:#e6db74>${</span>NC<span style=color:#e6db74>}</span><span style=color:#e6db74> </span>$1<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>log_warn<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    echo -e <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>YELLOW<span style=color:#e6db74>}</span><span style=color:#e6db74>[WARN]</span><span style=color:#e6db74>${</span>NC<span style=color:#e6db74>}</span><span style=color:#e6db74> </span>$1<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>log_error<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    echo -e <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>RED<span style=color:#e6db74>}</span><span style=color:#e6db74>[ERROR]</span><span style=color:#e6db74>${</span>NC<span style=color:#e6db74>}</span><span style=color:#e6db74> </span>$1<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 创建设备函数</span>
</span></span><span style=display:flex><span>create_device<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    local device_name<span style=color:#f92672>=</span>$1
</span></span><span style=display:flex><span>    local device_type<span style=color:#f92672>=</span><span style=color:#e6db74>${</span>2<span style=color:#66d9ef>:-</span><span style=color:#e6db74>&#34;default&#34;</span><span style=color:#e6db74>}</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    log_info <span style=color:#e6db74>&#34;创建设备: </span>$device_name<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    response<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>curl -s -X POST <span style=color:#e6db74>&#34;http://</span>$THINGSBOARD_HOST<span style=color:#e6db74>:</span>$THINGSBOARD_PORT<span style=color:#e6db74>/api/device&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        -H <span style=color:#e6db74>&#34;Content-Type: application/json&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        -H <span style=color:#e6db74>&#34;X-Authorization: Bearer </span>$USER_TOKEN<span style=color:#e6db74>&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        -d <span style=color:#e6db74>&#34;{
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            \&#34;name\&#34;: \&#34;</span>$device_name<span style=color:#e6db74>\&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            \&#34;type\&#34;: \&#34;</span>$device_type<span style=color:#e6db74>\&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            \&#34;additionalInfo\&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                \&#34;description\&#34;: \&#34;Pre-registered device for testing\&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                \&#34;manufacturer\&#34;: \&#34;TestManufacturer\&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                \&#34;model\&#34;: \&#34;TestModel\&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                \&#34;firmwareVersion\&#34;: \&#34;1.0.0\&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                \&#34;createdAt\&#34;: </span><span style=color:#66d9ef>$(</span>date +%s<span style=color:#66d9ef>)</span><span style=color:#e6db74>000
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        }&#34;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> $? -eq <span style=color:#ae81ff>0</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        device_id<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>echo <span style=color:#e6db74>&#34;</span>$response<span style=color:#e6db74>&#34;</span> | jq -r <span style=color:#e6db74>&#39;.id.id&#39;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> <span style=color:#e6db74>&#34;</span>$device_id<span style=color:#e6db74>&#34;</span> !<span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;null&#34;</span> <span style=color:#f92672>]</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>[</span> <span style=color:#e6db74>&#34;</span>$device_id<span style=color:#e6db74>&#34;</span> !<span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>            log_info <span style=color:#e6db74>&#34;设备创建成功: </span>$device_name<span style=color:#e6db74> (ID: </span>$device_id<span style=color:#e6db74>)&#34;</span>
</span></span><span style=display:flex><span>            echo <span style=color:#e6db74>&#34;</span>$device_id<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>            log_error <span style=color:#e6db74>&#34;设备创建失败: </span>$device_name<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>            echo <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>        log_error <span style=color:#e6db74>&#34;设备创建请求失败: </span>$device_name<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 生成设备令牌函数</span>
</span></span><span style=display:flex><span>generate_device_token<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    local device_id<span style=color:#f92672>=</span>$1
</span></span><span style=display:flex><span>    local device_name<span style=color:#f92672>=</span>$2
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    log_info <span style=color:#e6db74>&#34;为设备生成令牌: </span>$device_name<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 生成唯一令牌</span>
</span></span><span style=display:flex><span>    token<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;DEVICE_TOKEN_</span><span style=color:#e6db74>${</span>device_name<span style=color:#e6db74>}</span><span style=color:#e6db74>_</span><span style=color:#66d9ef>$(</span>date +%s<span style=color:#66d9ef>)</span><span style=color:#e6db74>_</span><span style=color:#66d9ef>$(</span>openssl rand -hex 4<span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    response<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>curl -s -X POST <span style=color:#e6db74>&#34;http://</span>$THINGSBOARD_HOST<span style=color:#e6db74>:</span>$THINGSBOARD_PORT<span style=color:#e6db74>/api/device/</span>$device_id<span style=color:#e6db74>/credentials&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        -H <span style=color:#e6db74>&#34;Content-Type: application/json&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        -H <span style=color:#e6db74>&#34;X-Authorization: Bearer </span>$USER_TOKEN<span style=color:#e6db74>&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        -d <span style=color:#e6db74>&#34;{
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            \&#34;credentialsType\&#34;: \&#34;ACCESS_TOKEN\&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            \&#34;credentialsId\&#34;: \&#34;</span>$token<span style=color:#e6db74>\&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        }&#34;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> $? -eq <span style=color:#ae81ff>0</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        log_info <span style=color:#e6db74>&#34;令牌生成成功: </span>$device_name<span style=color:#e6db74> -&gt; </span>$token<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;</span>$token<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>        log_error <span style=color:#e6db74>&#34;令牌生成失败: </span>$device_name<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 测试设备连接函数</span>
</span></span><span style=display:flex><span>test_device_connection<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    local device_token<span style=color:#f92672>=</span>$1
</span></span><span style=display:flex><span>    local device_name<span style=color:#f92672>=</span>$2
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    log_info <span style=color:#e6db74>&#34;测试设备连接: </span>$device_name<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 测试HTTP连接</span>
</span></span><span style=display:flex><span>    response<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>curl -s -X POST <span style=color:#e6db74>&#34;http://</span>$THINGSBOARD_HOST<span style=color:#e6db74>:8080/api/v1/</span>$device_token<span style=color:#e6db74>/telemetry&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        -H <span style=color:#e6db74>&#34;Content-Type: application/json&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        -d <span style=color:#e6db74>&#34;{
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            \&#34;test\&#34;: \&#34;connection_test\&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            \&#34;timestamp\&#34;: </span><span style=color:#66d9ef>$(</span>date +%s<span style=color:#66d9ef>)</span><span style=color:#e6db74>000
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        }&#34;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> $? -eq <span style=color:#ae81ff>0</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        log_info <span style=color:#e6db74>&#34;HTTP连接测试成功: </span>$device_name<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>        log_error <span style=color:#e6db74>&#34;HTTP连接测试失败: </span>$device_name<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 主函数</span>
</span></span><span style=display:flex><span>main<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    log_info <span style=color:#e6db74>&#34;开始设备预注册测试，设备数量: </span>$DEVICE_COUNT<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 创建结果文件</span>
</span></span><span style=display:flex><span>    result_file<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;device_registration_</span><span style=color:#66d9ef>$(</span>date +%Y%m%d_%H%M%S<span style=color:#66d9ef>)</span><span style=color:#e6db74>.csv&#34;</span>
</span></span><span style=display:flex><span>    echo <span style=color:#e6db74>&#34;device_id,device_name,device_type,access_token,created_time&#34;</span> &gt; <span style=color:#e6db74>&#34;</span>$result_file<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    success_count<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> i in <span style=color:#66d9ef>$(</span>seq <span style=color:#ae81ff>1</span> $DEVICE_COUNT<span style=color:#66d9ef>)</span>; <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>        device_name<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>DEVICE_PREFIX<span style=color:#e6db74>}</span><span style=color:#e6db74>_</span><span style=color:#66d9ef>$(</span>printf <span style=color:#e6db74>&#34;%03d&#34;</span> $i<span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#75715e># 创建设备</span>
</span></span><span style=display:flex><span>        device_id<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>create_device <span style=color:#e6db74>&#34;</span>$device_name<span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> -z <span style=color:#e6db74>&#34;</span>$device_id<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#75715e># 生成令牌</span>
</span></span><span style=display:flex><span>        device_token<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>generate_device_token <span style=color:#e6db74>&#34;</span>$device_id<span style=color:#e6db74>&#34;</span> <span style=color:#e6db74>&#34;</span>$device_name<span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> -z <span style=color:#e6db74>&#34;</span>$device_token<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#75715e># 测试连接</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> test_device_connection <span style=color:#e6db74>&#34;</span>$device_token<span style=color:#e6db74>&#34;</span> <span style=color:#e6db74>&#34;</span>$device_name<span style=color:#e6db74>&#34;</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>            success_count<span style=color:#f92672>=</span><span style=color:#66d9ef>$((</span>success_count <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span><span style=color:#66d9ef>))</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#75715e># 保存结果</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;</span>$device_id<span style=color:#e6db74>,</span>$device_name<span style=color:#e6db74>,default,</span>$device_token<span style=color:#e6db74>,</span><span style=color:#66d9ef>$(</span>date +%s<span style=color:#66d9ef>)</span><span style=color:#e6db74>000&#34;</span> &gt;&gt; <span style=color:#e6db74>&#34;</span>$result_file<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#75715e># 添加延迟</span>
</span></span><span style=display:flex><span>        sleep 0.5
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>done</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    log_info <span style=color:#e6db74>&#34;设备预注册测试完成&#34;</span>
</span></span><span style=display:flex><span>    log_info <span style=color:#e6db74>&#34;成功注册设备: </span>$success_count<span style=color:#e6db74>/</span>$DEVICE_COUNT<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    log_info <span style=color:#e6db74>&#34;结果文件: </span>$result_file<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 运行主函数</span>
</span></span><span style=display:flex><span>main <span style=color:#e6db74>&#34;</span>$@<span style=color:#e6db74>&#34;</span>
</span></span></code></pre></div><h4 id=823-遥测数据测试>8.2.3 遥测数据测试</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 上报遥测数据</span>
</span></span><span style=display:flex><span>curl -X POST http://localhost:9090/api/plugins/telemetry/DEVICE/<span style=color:#f92672>{</span>deviceId<span style=color:#f92672>}</span>/values/timeseries <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -H <span style=color:#e6db74>&#34;Content-Type: application/json&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -H <span style=color:#e6db74>&#34;X-Authorization: Bearer YOUR_TOKEN&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -d <span style=color:#e6db74>&#39;{
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;temperature&#34;: 25.5,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;humidity&#34;: 60.2,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;pressure&#34;: 1013.25
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  }&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 查询遥测数据</span>
</span></span><span style=display:flex><span>curl -X GET <span style=color:#e6db74>&#34;http://localhost:9090/api/plugins/telemetry/DEVICE/{deviceId}/values/timeseries?keys=temperature,humidity&amp;startTs=1640995200000&amp;endTs=1641081600000&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -H <span style=color:#e6db74>&#34;X-Authorization: Bearer YOUR_TOKEN&#34;</span>
</span></span></code></pre></div><h4 id=824-postman测试集合>8.2.4 Postman测试集合</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;info&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;ThingsBoard API Tests&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;schema&#34;</span>: <span style=color:#e6db74>&#34;https://schema.getpostman.com/json/collection/v2.1.0/collection.json&#34;</span>
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;item&#34;</span>: [
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;Authentication&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;item&#34;</span>: [
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>          <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;Login&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#f92672>&#34;request&#34;</span>: {
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;method&#34;</span>: <span style=color:#e6db74>&#34;POST&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;header&#34;</span>: [
</span></span><span style=display:flex><span>              {
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;key&#34;</span>: <span style=color:#e6db74>&#34;Content-Type&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;value&#34;</span>: <span style=color:#e6db74>&#34;application/json&#34;</span>
</span></span><span style=display:flex><span>              }
</span></span><span style=display:flex><span>            ],
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;body&#34;</span>: {
</span></span><span style=display:flex><span>              <span style=color:#f92672>&#34;mode&#34;</span>: <span style=color:#e6db74>&#34;raw&#34;</span>,
</span></span><span style=display:flex><span>              <span style=color:#f92672>&#34;raw&#34;</span>: <span style=color:#e6db74>&#34;{\n  \&#34;username\&#34;: \&#34;tenant@thingsboard.org\&#34;,\n  \&#34;password\&#34;: \&#34;tenant\&#34;\n}&#34;</span>
</span></span><span style=display:flex><span>            },
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;url&#34;</span>: {
</span></span><span style=display:flex><span>              <span style=color:#f92672>&#34;raw&#34;</span>: <span style=color:#e6db74>&#34;http://localhost:9090/api/auth/login&#34;</span>,
</span></span><span style=display:flex><span>              <span style=color:#f92672>&#34;protocol&#34;</span>: <span style=color:#e6db74>&#34;http&#34;</span>,
</span></span><span style=display:flex><span>              <span style=color:#f92672>&#34;host&#34;</span>: [<span style=color:#e6db74>&#34;localhost&#34;</span>],
</span></span><span style=display:flex><span>              <span style=color:#f92672>&#34;port&#34;</span>: <span style=color:#e6db74>&#34;9090&#34;</span>,
</span></span><span style=display:flex><span>              <span style=color:#f92672>&#34;path&#34;</span>: [<span style=color:#e6db74>&#34;api&#34;</span>, <span style=color:#e6db74>&#34;auth&#34;</span>, <span style=color:#e6db74>&#34;login&#34;</span>]
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      ]
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;Device Management&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;item&#34;</span>: [
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>          <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;Create Device&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#f92672>&#34;request&#34;</span>: {
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;method&#34;</span>: <span style=color:#e6db74>&#34;POST&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;header&#34;</span>: [
</span></span><span style=display:flex><span>              {
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;key&#34;</span>: <span style=color:#e6db74>&#34;Content-Type&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;value&#34;</span>: <span style=color:#e6db74>&#34;application/json&#34;</span>
</span></span><span style=display:flex><span>              },
</span></span><span style=display:flex><span>              {
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;key&#34;</span>: <span style=color:#e6db74>&#34;X-Authorization&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;value&#34;</span>: <span style=color:#e6db74>&#34;Bearer {{token}}&#34;</span>
</span></span><span style=display:flex><span>              }
</span></span><span style=display:flex><span>            ],
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;body&#34;</span>: {
</span></span><span style=display:flex><span>              <span style=color:#f92672>&#34;mode&#34;</span>: <span style=color:#e6db74>&#34;raw&#34;</span>,
</span></span><span style=display:flex><span>              <span style=color:#f92672>&#34;raw&#34;</span>: <span style=color:#e6db74>&#34;{\n  \&#34;name\&#34;: \&#34;Test Device\&#34;,\n  \&#34;type\&#34;: \&#34;default\&#34;\n}&#34;</span>
</span></span><span style=display:flex><span>            },
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;url&#34;</span>: {
</span></span><span style=display:flex><span>              <span style=color:#f92672>&#34;raw&#34;</span>: <span style=color:#e6db74>&#34;http://localhost:9090/api/device&#34;</span>,
</span></span><span style=display:flex><span>              <span style=color:#f92672>&#34;protocol&#34;</span>: <span style=color:#e6db74>&#34;http&#34;</span>,
</span></span><span style=display:flex><span>              <span style=color:#f92672>&#34;host&#34;</span>: [<span style=color:#e6db74>&#34;localhost&#34;</span>],
</span></span><span style=display:flex><span>              <span style=color:#f92672>&#34;port&#34;</span>: <span style=color:#e6db74>&#34;9090&#34;</span>,
</span></span><span style=display:flex><span>              <span style=color:#f92672>&#34;path&#34;</span>: [<span style=color:#e6db74>&#34;api&#34;</span>, <span style=color:#e6db74>&#34;device&#34;</span>]
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      ]
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  ]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=83-mqtt协议测试>8.3 MQTT协议测试</h3><h4 id=831-mqttfx配置>8.3.1 MQTT.fx配置</h4><ol><li><p><strong>连接配置</strong></p><ul><li>Broker: <code>localhost</code></li><li>Port: <code>1883</code></li><li>Client ID: <code>test_device_001</code></li><li>Username: <code>{deviceToken}</code> (设备Token)</li><li>Password: 留空</li></ul></li><li><p><strong>测试脚本</strong></p></li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># 使用Python paho-mqtt库测试</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> paho.mqtt.client <span style=color:#66d9ef>as</span> mqtt
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> json
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> time
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 设备Token</span>
</span></span><span style=display:flex><span>DEVICE_TOKEN <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;YOUR_DEVICE_TOKEN&#34;</span>
</span></span><span style=display:flex><span>BROKER <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;localhost&#34;</span>
</span></span><span style=display:flex><span>PORT <span style=color:#f92672>=</span> <span style=color:#ae81ff>1883</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>on_connect</span>(client, userdata, flags, rc):
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;Connected with result code </span><span style=color:#e6db74>{</span>rc<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#75715e># 订阅命令主题</span>
</span></span><span style=display:flex><span>    client<span style=color:#f92672>.</span>subscribe(<span style=color:#e6db74>&#34;v1/devices/me/commands/request/+&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>on_message</span>(client, userdata, msg):
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;Received command: </span><span style=color:#e6db74>{</span>msg<span style=color:#f92672>.</span>topic<span style=color:#e6db74>}</span><span style=color:#e6db74> </span><span style=color:#e6db74>{</span>str(msg<span style=color:#f92672>.</span>payload)<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#75715e># 解析命令并响应</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>        command_data <span style=color:#f92672>=</span> json<span style=color:#f92672>.</span>loads(msg<span style=color:#f92672>.</span>payload)
</span></span><span style=display:flex><span>        request_id <span style=color:#f92672>=</span> msg<span style=color:#f92672>.</span>topic<span style=color:#f92672>.</span>split(<span style=color:#e6db74>&#39;/&#39;</span>)[<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>]
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#75715e># 发送命令响应</span>
</span></span><span style=display:flex><span>        response <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;status&#34;</span>: <span style=color:#e6db74>&#34;SUCCESS&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;data&#34;</span>: {<span style=color:#e6db74>&#34;result&#34;</span>: <span style=color:#e6db74>&#34;Command executed successfully&#34;</span>}
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        client<span style=color:#f92672>.</span>publish(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;v1/devices/me/commands/response/</span><span style=color:#e6db74>{</span>request_id<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>, 
</span></span><span style=display:flex><span>                      json<span style=color:#f92672>.</span>dumps(response))
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>except</span> <span style=color:#a6e22e>Exception</span> <span style=color:#66d9ef>as</span> e:
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;Error processing command: </span><span style=color:#e6db74>{</span>e<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>on_publish</span>(client, userdata, mid):
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;Message published with mid: </span><span style=color:#e6db74>{</span>mid<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 创建客户端</span>
</span></span><span style=display:flex><span>client <span style=color:#f92672>=</span> mqtt<span style=color:#f92672>.</span>Client()
</span></span><span style=display:flex><span>client<span style=color:#f92672>.</span>username_pw_set(DEVICE_TOKEN, <span style=color:#e6db74>&#34;&#34;</span>)
</span></span><span style=display:flex><span>client<span style=color:#f92672>.</span>on_connect <span style=color:#f92672>=</span> on_connect
</span></span><span style=display:flex><span>client<span style=color:#f92672>.</span>on_message <span style=color:#f92672>=</span> on_message
</span></span><span style=display:flex><span>client<span style=color:#f92672>.</span>on_publish <span style=color:#f92672>=</span> on_publish
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 连接MQTT Broker</span>
</span></span><span style=display:flex><span>client<span style=color:#f92672>.</span>connect(BROKER, PORT, <span style=color:#ae81ff>60</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 发布遥测数据</span>
</span></span><span style=display:flex><span>telemetry_data <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;temperature&#34;</span>: <span style=color:#ae81ff>25.5</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;humidity&#34;</span>: <span style=color:#ae81ff>60.2</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;timestamp&#34;</span>: int(time<span style=color:#f92672>.</span>time() <span style=color:#f92672>*</span> <span style=color:#ae81ff>1000</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>client<span style=color:#f92672>.</span>publish(<span style=color:#e6db74>&#34;v1/devices/me/telemetry&#34;</span>, json<span style=color:#f92672>.</span>dumps(telemetry_data))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 发布属性数据</span>
</span></span><span style=display:flex><span>attributes_data <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;firmware_version&#34;</span>: <span style=color:#e6db74>&#34;1.0.0&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;device_model&#34;</span>: <span style=color:#e6db74>&#34;TestDevice&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>client<span style=color:#f92672>.</span>publish(<span style=color:#e6db74>&#34;v1/devices/me/attributes&#34;</span>, json<span style=color:#f92672>.</span>dumps(attributes_data))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 保持连接</span>
</span></span><span style=display:flex><span>client<span style=color:#f92672>.</span>loop_forever()
</span></span></code></pre></div><h4 id=832-命令下发测试>8.3.2 命令下发测试</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 使用mosquitto_pub发送命令</span>
</span></span><span style=display:flex><span>mosquitto_pub -h localhost -p <span style=color:#ae81ff>1883</span> -u <span style=color:#e6db74>&#34;YOUR_DEVICE_TOKEN&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -t <span style=color:#e6db74>&#34;v1/devices/me/commands/request/1&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -m <span style=color:#e6db74>&#39;{&#34;method&#34;: &#34;setTemperature&#34;, &#34;params&#34;: {&#34;temperature&#34;: 26.0}}&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 监听命令响应</span>
</span></span><span style=display:flex><span>mosquitto_sub -h localhost -p <span style=color:#ae81ff>1883</span> -u <span style=color:#e6db74>&#34;YOUR_DEVICE_TOKEN&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -t <span style=color:#e6db74>&#34;v1/devices/me/commands/response/+&#34;</span>
</span></span></code></pre></div><h3 id=84-websocket测试>8.4 WebSocket测试</h3><h4 id=841-javascript-websocket客户端>8.4.1 JavaScript WebSocket客户端</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span><span style=color:#75715e>&lt;!DOCTYPE html&gt;</span>
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>html</span>&gt;
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>head</span>&gt;
</span></span><span style=display:flex><span>    &lt;<span style=color:#f92672>title</span>&gt;ThingsBoard WebSocket Test&lt;/<span style=color:#f92672>title</span>&gt;
</span></span><span style=display:flex><span>&lt;/<span style=color:#f92672>head</span>&gt;
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>body</span>&gt;
</span></span><span style=display:flex><span>    &lt;<span style=color:#f92672>h2</span>&gt;ThingsBoard WebSocket Test&lt;/<span style=color:#f92672>h2</span>&gt;
</span></span><span style=display:flex><span>    &lt;<span style=color:#f92672>div</span> <span style=color:#a6e22e>id</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;messages&#34;</span>&gt;&lt;/<span style=color:#f92672>div</span>&gt;
</span></span><span style=display:flex><span>    &lt;<span style=color:#f92672>script</span>&gt;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>token</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;YOUR_USER_TOKEN&#39;</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>ws</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>WebSocket</span>(<span style=color:#e6db74>`ws://localhost:8080/api/ws/plugins/telemetry?token=</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>token</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ws</span>.<span style=color:#a6e22e>onopen</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>function</span>(<span style=color:#a6e22e>event</span>) {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#39;WebSocket connected&#39;</span>);
</span></span><span style=display:flex><span>            document.<span style=color:#a6e22e>getElementById</span>(<span style=color:#e6db74>&#39;messages&#39;</span>).<span style=color:#a6e22e>innerHTML</span> <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#39;&lt;p&gt;Connected to ThingsBoard&lt;/p&gt;&#39;</span>;
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 订阅设备数据
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>subscribeMessage</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>deviceId</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;device_001&#39;</span>,
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>keys</span><span style=color:#f92672>:</span> [<span style=color:#e6db74>&#39;temperature&#39;</span>, <span style=color:#e6db74>&#39;humidity&#39;</span>],
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>startTs</span><span style=color:#f92672>:</span> Date.<span style=color:#a6e22e>now</span>() <span style=color:#f92672>-</span> <span style=color:#ae81ff>3600000</span>, <span style=color:#75715e>// 1小时前
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#a6e22e>endTs</span><span style=color:#f92672>:</span> Date.<span style=color:#a6e22e>now</span>(),
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>interval</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>1000</span>,
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>limit</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>100</span>,
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>agg</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;AVG&#39;</span>
</span></span><span style=display:flex><span>            };
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>ws</span>.<span style=color:#a6e22e>send</span>(<span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>stringify</span>(<span style=color:#a6e22e>subscribeMessage</span>));
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ws</span>.<span style=color:#a6e22e>onmessage</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>function</span>(<span style=color:#a6e22e>event</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>data</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>parse</span>(<span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>data</span>);
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#39;Received:&#39;</span>, <span style=color:#a6e22e>data</span>);
</span></span><span style=display:flex><span>            document.<span style=color:#a6e22e>getElementById</span>(<span style=color:#e6db74>&#39;messages&#39;</span>).<span style=color:#a6e22e>innerHTML</span> <span style=color:#f92672>+=</span> 
</span></span><span style=display:flex><span>                <span style=color:#e6db74>`&lt;p&gt;Received: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>stringify</span>(<span style=color:#a6e22e>data</span>)<span style=color:#e6db74>}</span><span style=color:#e6db74>&lt;/p&gt;`</span>;
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ws</span>.<span style=color:#a6e22e>onerror</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>function</span>(<span style=color:#a6e22e>error</span>) {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#e6db74>&#39;WebSocket error:&#39;</span>, <span style=color:#a6e22e>error</span>);
</span></span><span style=display:flex><span>            document.<span style=color:#a6e22e>getElementById</span>(<span style=color:#e6db74>&#39;messages&#39;</span>).<span style=color:#a6e22e>innerHTML</span> <span style=color:#f92672>+=</span> 
</span></span><span style=display:flex><span>                <span style=color:#e6db74>`&lt;p style=&#34;color: red;&#34;&gt;Error: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>error</span><span style=color:#e6db74>}</span><span style=color:#e6db74>&lt;/p&gt;`</span>;
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ws</span>.<span style=color:#a6e22e>onclose</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>function</span>(<span style=color:#a6e22e>event</span>) {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#39;WebSocket closed&#39;</span>);
</span></span><span style=display:flex><span>            document.<span style=color:#a6e22e>getElementById</span>(<span style=color:#e6db74>&#39;messages&#39;</span>).<span style=color:#a6e22e>innerHTML</span> <span style=color:#f92672>+=</span> 
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#39;&lt;p&gt;Connection closed&lt;/p&gt;&#39;</span>;
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>    &lt;/<span style=color:#f92672>script</span>&gt;
</span></span><span style=display:flex><span>&lt;/<span style=color:#f92672>body</span>&gt;
</span></span><span style=display:flex><span>&lt;/<span style=color:#f92672>html</span>&gt;
</span></span></code></pre></div><h4 id=842-python-websocket客户端>8.4.2 Python WebSocket客户端</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> asyncio
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> websockets
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> json
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>test_websocket</span>():
</span></span><span style=display:flex><span>    token <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;YOUR_USER_TOKEN&#34;</span>
</span></span><span style=display:flex><span>    uri <span style=color:#f92672>=</span> <span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;ws://localhost:8080/api/ws/plugins/telemetry?token=</span><span style=color:#e6db74>{</span>token<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>async</span> <span style=color:#66d9ef>with</span> websockets<span style=color:#f92672>.</span>connect(uri) <span style=color:#66d9ef>as</span> websocket:
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#34;Connected to ThingsBoard WebSocket&#34;</span>)
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#75715e># 订阅设备数据</span>
</span></span><span style=display:flex><span>        subscribe_message <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;deviceId&#34;</span>: <span style=color:#e6db74>&#34;device_001&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;keys&#34;</span>: [<span style=color:#e6db74>&#34;temperature&#34;</span>, <span style=color:#e6db74>&#34;humidity&#34;</span>],
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;startTs&#34;</span>: int(time<span style=color:#f92672>.</span>time() <span style=color:#f92672>*</span> <span style=color:#ae81ff>1000</span>) <span style=color:#f92672>-</span> <span style=color:#ae81ff>3600000</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;endTs&#34;</span>: int(time<span style=color:#f92672>.</span>time() <span style=color:#f92672>*</span> <span style=color:#ae81ff>1000</span>),
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;interval&#34;</span>: <span style=color:#ae81ff>1000</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;limit&#34;</span>: <span style=color:#ae81ff>100</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;agg&#34;</span>: <span style=color:#e6db74>&#34;AVG&#34;</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>await</span> websocket<span style=color:#f92672>.</span>send(json<span style=color:#f92672>.</span>dumps(subscribe_message))
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;Sent subscription: </span><span style=color:#e6db74>{</span>subscribe_message<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#75715e># 接收消息</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>while</span> <span style=color:#66d9ef>True</span>:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>                message <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> websocket<span style=color:#f92672>.</span>recv()
</span></span><span style=display:flex><span>                data <span style=color:#f92672>=</span> json<span style=color:#f92672>.</span>loads(message)
</span></span><span style=display:flex><span>                print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;Received: </span><span style=color:#e6db74>{</span>data<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>except</span> websockets<span style=color:#f92672>.</span>exceptions<span style=color:#f92672>.</span>ConnectionClosed:
</span></span><span style=display:flex><span>                print(<span style=color:#e6db74>&#34;WebSocket connection closed&#34;</span>)
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>except</span> <span style=color:#a6e22e>Exception</span> <span style=color:#66d9ef>as</span> e:
</span></span><span style=display:flex><span>                print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;Error: </span><span style=color:#e6db74>{</span>e<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 运行测试</span>
</span></span><span style=display:flex><span>asyncio<span style=color:#f92672>.</span>run(test_websocket())
</span></span></code></pre></div><h3 id=85-coap协议测试>8.5 CoAP协议测试</h3><h4 id=851-使用coap-client测试>8.5.1 使用coap-client测试</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 安装coap-client</span>
</span></span><span style=display:flex><span>sudo apt-get install libcoap2-bin
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 上报遥测数据</span>
</span></span><span style=display:flex><span>coap-client -m POST <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -H <span style=color:#e6db74>&#34;Content-Type: application/json&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -e <span style=color:#e6db74>&#39;{&#34;temperature&#34;: 25.5, &#34;humidity&#34;: 60.2}&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  coap://localhost:5683/api/v1/YOUR_DEVICE_TOKEN/telemetry
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 上报属性数据</span>
</span></span><span style=display:flex><span>coap-client -m POST <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -H <span style=color:#e6db74>&#34;Content-Type: application/json&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -e <span style=color:#e6db74>&#39;{&#34;firmware_version&#34;: &#34;1.0.0&#34;}&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  coap://localhost:5683/api/v1/YOUR_DEVICE_TOKEN/attributes
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 获取属性</span>
</span></span><span style=display:flex><span>coap-client -m GET <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  coap://localhost:5683/api/v1/YOUR_DEVICE_TOKEN/attributes
</span></span></code></pre></div><h4 id=852-python-coap客户端>8.5.2 Python CoAP客户端</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> asyncio
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> aiocoap <span style=color:#f92672>import</span> Context, Message
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> json
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>test_coap</span>():
</span></span><span style=display:flex><span>    context <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> Context<span style=color:#f92672>.</span>create_client_context()
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    device_token <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;YOUR_DEVICE_TOKEN&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 上报遥测数据</span>
</span></span><span style=display:flex><span>    telemetry_data <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;temperature&#34;</span>: <span style=color:#ae81ff>25.5</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;humidity&#34;</span>: <span style=color:#ae81ff>60.2</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;timestamp&#34;</span>: int(time<span style=color:#f92672>.</span>time() <span style=color:#f92672>*</span> <span style=color:#ae81ff>1000</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    payload <span style=color:#f92672>=</span> json<span style=color:#f92672>.</span>dumps(telemetry_data)<span style=color:#f92672>.</span>encode(<span style=color:#e6db74>&#39;utf-8&#39;</span>)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    request <span style=color:#f92672>=</span> Message(
</span></span><span style=display:flex><span>        code<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>,  <span style=color:#75715e># POST</span>
</span></span><span style=display:flex><span>        uri<span style=color:#f92672>=</span><span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;coap://localhost:5683/api/v1/</span><span style=color:#e6db74>{</span>device_token<span style=color:#e6db74>}</span><span style=color:#e6db74>/telemetry&#39;</span>,
</span></span><span style=display:flex><span>        payload<span style=color:#f92672>=</span>payload,
</span></span><span style=display:flex><span>        opt<span style=color:#f92672>=</span>Message<span style=color:#f92672>.</span>opt<span style=color:#f92672>.</span>ContentFormat(<span style=color:#ae81ff>50</span>)  <span style=color:#75715e># application/json</span>
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>        response <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> context<span style=color:#f92672>.</span>request(request)<span style=color:#f92672>.</span>response
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;Telemetry response: </span><span style=color:#e6db74>{</span>response<span style=color:#f92672>.</span>code<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;Response payload: </span><span style=color:#e6db74>{</span>response<span style=color:#f92672>.</span>payload<span style=color:#f92672>.</span>decode()<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>except</span> <span style=color:#a6e22e>Exception</span> <span style=color:#66d9ef>as</span> e:
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;Error sending telemetry: </span><span style=color:#e6db74>{</span>e<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>await</span> context<span style=color:#f92672>.</span>shutdown()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 运行测试</span>
</span></span><span style=display:flex><span>asyncio<span style=color:#f92672>.</span>run(test_coap())
</span></span></code></pre></div><h3 id=86-http设备接口测试>8.6 HTTP设备接口测试</h3><h4 id=861-设备数据上报测试>8.6.1 设备数据上报测试</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 上报遥测数据</span>
</span></span><span style=display:flex><span>curl -X POST <span style=color:#e6db74>&#34;http://localhost:8080/api/v1/YOUR_DEVICE_TOKEN/telemetry&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -H <span style=color:#e6db74>&#34;Content-Type: application/json&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -d <span style=color:#e6db74>&#39;{
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;temperature&#34;: 25.5,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;humidity&#34;: 60.2,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;pressure&#34;: 1013.25
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  }&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 上报属性</span>
</span></span><span style=display:flex><span>curl -X POST <span style=color:#e6db74>&#34;http://localhost:8080/api/v1/YOUR_DEVICE_TOKEN/attributes&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -H <span style=color:#e6db74>&#34;Content-Type: application/json&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -d <span style=color:#e6db74>&#39;{
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;firmware_version&#34;: &#34;1.0.0&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;device_model&#34;: &#34;TestDevice&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  }&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 获取属性</span>
</span></span><span style=display:flex><span>curl -X GET <span style=color:#e6db74>&#34;http://localhost:8080/api/v1/YOUR_DEVICE_TOKEN/attributes&#34;</span>
</span></span></code></pre></div><h4 id=862-命令处理测试>8.6.2 命令处理测试</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 获取命令（长轮询）</span>
</span></span><span style=display:flex><span>curl -X GET <span style=color:#e6db74>&#34;http://localhost:8080/api/v1/YOUR_DEVICE_TOKEN/commands?timeout=10000&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 响应命令</span>
</span></span><span style=display:flex><span>curl -X POST <span style=color:#e6db74>&#34;http://localhost:8080/api/v1/YOUR_DEVICE_TOKEN/commands/1&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -H <span style=color:#e6db74>&#34;Content-Type: application/json&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -d <span style=color:#e6db74>&#39;{
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;status&#34;: &#34;SUCCESS&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;data&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#34;result&#34;: &#34;Temperature set to 26.0&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  }&#39;</span>
</span></span></code></pre></div><h3 id=87-自动化测试脚本>8.7 自动化测试脚本</h3><h4 id=871-综合测试脚本>8.7.1 综合测试脚本</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e>#!/usr/bin/env python3</span>
</span></span><span style=display:flex><span><span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>ThingsBoard接口综合测试脚本
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> requests
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> json
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> time
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> paho.mqtt.client <span style=color:#66d9ef>as</span> mqtt
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> asyncio
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> websockets
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> concurrent.futures <span style=color:#f92672>import</span> ThreadPoolExecutor
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ThingsBoardTester</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>__init__</span>(self, host<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;localhost&#34;</span>, port<span style=color:#f92672>=</span><span style=color:#ae81ff>9090</span>, device_token<span style=color:#f92672>=</span><span style=color:#66d9ef>None</span>, user_token<span style=color:#f92672>=</span><span style=color:#66d9ef>None</span>):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>host <span style=color:#f92672>=</span> host
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>port <span style=color:#f92672>=</span> port
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>device_token <span style=color:#f92672>=</span> device_token
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>user_token <span style=color:#f92672>=</span> user_token
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>base_url <span style=color:#f92672>=</span> <span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;http://</span><span style=color:#e6db74>{</span>host<span style=color:#e6db74>}</span><span style=color:#e6db74>:</span><span style=color:#e6db74>{</span>port<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>test_rest_api</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;&#34;&#34;测试REST API接口&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#34;=== Testing REST API ===&#34;</span>)
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#75715e># 测试设备创建</span>
</span></span><span style=display:flex><span>        device_data <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;name&#34;</span>: <span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;TestDevice_</span><span style=color:#e6db74>{</span>int(time<span style=color:#f92672>.</span>time())<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;default&#34;</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        headers <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#34;Content-Type&#34;</span>: <span style=color:#e6db74>&#34;application/json&#34;</span>}
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> self<span style=color:#f92672>.</span>user_token:
</span></span><span style=display:flex><span>            headers[<span style=color:#e6db74>&#34;X-Authorization&#34;</span>] <span style=color:#f92672>=</span> <span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;Bearer </span><span style=color:#e6db74>{</span>self<span style=color:#f92672>.</span>user_token<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        response <span style=color:#f92672>=</span> requests<span style=color:#f92672>.</span>post(
</span></span><span style=display:flex><span>            <span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>{</span>self<span style=color:#f92672>.</span>base_url<span style=color:#e6db74>}</span><span style=color:#e6db74>/api/device&#34;</span>,
</span></span><span style=display:flex><span>            headers<span style=color:#f92672>=</span>headers,
</span></span><span style=display:flex><span>            json<span style=color:#f92672>=</span>device_data
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> response<span style=color:#f92672>.</span>status_code <span style=color:#f92672>==</span> <span style=color:#ae81ff>200</span>:
</span></span><span style=display:flex><span>            device_id <span style=color:#f92672>=</span> response<span style=color:#f92672>.</span>json()[<span style=color:#e6db74>&#34;id&#34;</span>][<span style=color:#e6db74>&#34;id&#34;</span>]
</span></span><span style=display:flex><span>            print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;✓ Device created: </span><span style=color:#e6db74>{</span>device_id<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            <span style=color:#75715e># 测试遥测数据上报</span>
</span></span><span style=display:flex><span>            telemetry_data <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;temperature&#34;</span>: <span style=color:#ae81ff>25.5</span>,
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;humidity&#34;</span>: <span style=color:#ae81ff>60.2</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            response <span style=color:#f92672>=</span> requests<span style=color:#f92672>.</span>post(
</span></span><span style=display:flex><span>                <span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>{</span>self<span style=color:#f92672>.</span>base_url<span style=color:#e6db74>}</span><span style=color:#e6db74>/api/plugins/telemetry/DEVICE/</span><span style=color:#e6db74>{</span>device_id<span style=color:#e6db74>}</span><span style=color:#e6db74>/values/timeseries&#34;</span>,
</span></span><span style=display:flex><span>                headers<span style=color:#f92672>=</span>headers,
</span></span><span style=display:flex><span>                json<span style=color:#f92672>=</span>telemetry_data
</span></span><span style=display:flex><span>            )
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> response<span style=color:#f92672>.</span>status_code <span style=color:#f92672>==</span> <span style=color:#ae81ff>200</span>:
</span></span><span style=display:flex><span>                print(<span style=color:#e6db74>&#34;✓ Telemetry data sent successfully&#34;</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>                print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;✗ Failed to send telemetry: </span><span style=color:#e6db74>{</span>response<span style=color:#f92672>.</span>status_code<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>            print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;✗ Failed to create device: </span><span style=color:#e6db74>{</span>response<span style=color:#f92672>.</span>status_code<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>test_mqtt</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;&#34;&#34;测试MQTT协议&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#34;=== Testing MQTT ===&#34;</span>)
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> self<span style=color:#f92672>.</span>device_token:
</span></span><span style=display:flex><span>            print(<span style=color:#e6db74>&#34;✗ Device token required for MQTT test&#34;</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>on_connect</span>(client, userdata, flags, rc):
</span></span><span style=display:flex><span>            print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;✓ MQTT connected with result code </span><span style=color:#e6db74>{</span>rc<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>on_publish</span>(client, userdata, mid):
</span></span><span style=display:flex><span>            print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;✓ Message published with mid: </span><span style=color:#e6db74>{</span>mid<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>        client <span style=color:#f92672>=</span> mqtt<span style=color:#f92672>.</span>Client()
</span></span><span style=display:flex><span>        client<span style=color:#f92672>.</span>username_pw_set(self<span style=color:#f92672>.</span>device_token, <span style=color:#e6db74>&#34;&#34;</span>)
</span></span><span style=display:flex><span>        client<span style=color:#f92672>.</span>on_connect <span style=color:#f92672>=</span> on_connect
</span></span><span style=display:flex><span>        client<span style=color:#f92672>.</span>on_publish <span style=color:#f92672>=</span> on_publish
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>            client<span style=color:#f92672>.</span>connect(self<span style=color:#f92672>.</span>host, <span style=color:#ae81ff>1883</span>, <span style=color:#ae81ff>60</span>)
</span></span><span style=display:flex><span>            client<span style=color:#f92672>.</span>loop_start()
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            <span style=color:#75715e># 发布遥测数据</span>
</span></span><span style=display:flex><span>            telemetry_data <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;temperature&#34;</span>: <span style=color:#ae81ff>25.5</span>,
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;humidity&#34;</span>: <span style=color:#ae81ff>60.2</span>,
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;timestamp&#34;</span>: int(time<span style=color:#f92672>.</span>time() <span style=color:#f92672>*</span> <span style=color:#ae81ff>1000</span>)
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            client<span style=color:#f92672>.</span>publish(<span style=color:#e6db74>&#34;v1/devices/me/telemetry&#34;</span>, json<span style=color:#f92672>.</span>dumps(telemetry_data))
</span></span><span style=display:flex><span>            time<span style=color:#f92672>.</span>sleep(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            client<span style=color:#f92672>.</span>loop_stop()
</span></span><span style=display:flex><span>            client<span style=color:#f92672>.</span>disconnect()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>except</span> <span style=color:#a6e22e>Exception</span> <span style=color:#66d9ef>as</span> e:
</span></span><span style=display:flex><span>            print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;✗ MQTT test failed: </span><span style=color:#e6db74>{</span>e<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>test_http_device_api</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;&#34;&#34;测试HTTP设备接口&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#34;=== Testing HTTP Device API ===&#34;</span>)
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> self<span style=color:#f92672>.</span>device_token:
</span></span><span style=display:flex><span>            print(<span style=color:#e6db74>&#34;✗ Device token required for HTTP device API test&#34;</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#75715e># 上报遥测数据</span>
</span></span><span style=display:flex><span>        telemetry_data <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;temperature&#34;</span>: <span style=color:#ae81ff>25.5</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;humidity&#34;</span>: <span style=color:#ae81ff>60.2</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        response <span style=color:#f92672>=</span> requests<span style=color:#f92672>.</span>post(
</span></span><span style=display:flex><span>            <span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;http://</span><span style=color:#e6db74>{</span>self<span style=color:#f92672>.</span>host<span style=color:#e6db74>}</span><span style=color:#e6db74>:8080/api/v1/</span><span style=color:#e6db74>{</span>self<span style=color:#f92672>.</span>device_token<span style=color:#e6db74>}</span><span style=color:#e6db74>/telemetry&#34;</span>,
</span></span><span style=display:flex><span>            headers<span style=color:#f92672>=</span>{<span style=color:#e6db74>&#34;Content-Type&#34;</span>: <span style=color:#e6db74>&#34;application/json&#34;</span>},
</span></span><span style=display:flex><span>            json<span style=color:#f92672>=</span>telemetry_data
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> response<span style=color:#f92672>.</span>status_code <span style=color:#f92672>==</span> <span style=color:#ae81ff>200</span>:
</span></span><span style=display:flex><span>            print(<span style=color:#e6db74>&#34;✓ HTTP telemetry data sent successfully&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>            print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;✗ HTTP telemetry failed: </span><span style=color:#e6db74>{</span>response<span style=color:#f92672>.</span>status_code<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>run_all_tests</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;&#34;&#34;运行所有测试&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#34;Starting ThingsBoard interface tests...&#34;</span>)
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#75715e># 并行运行测试</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>with</span> ThreadPoolExecutor(max_workers<span style=color:#f92672>=</span><span style=color:#ae81ff>3</span>) <span style=color:#66d9ef>as</span> executor:
</span></span><span style=display:flex><span>            executor<span style=color:#f92672>.</span>submit(self<span style=color:#f92672>.</span>test_rest_api)
</span></span><span style=display:flex><span>            executor<span style=color:#f92672>.</span>submit(self<span style=color:#f92672>.</span>test_mqtt)
</span></span><span style=display:flex><span>            executor<span style=color:#f92672>.</span>submit(self<span style=color:#f92672>.</span>test_http_device_api)
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#34;All tests completed!&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 使用示例</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;__main__&#34;</span>:
</span></span><span style=display:flex><span>    <span style=color:#75715e># 配置测试参数</span>
</span></span><span style=display:flex><span>    tester <span style=color:#f92672>=</span> ThingsBoardTester(
</span></span><span style=display:flex><span>        host<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;localhost&#34;</span>,
</span></span><span style=display:flex><span>        port<span style=color:#f92672>=</span><span style=color:#ae81ff>9090</span>,
</span></span><span style=display:flex><span>        device_token<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;YOUR_DEVICE_TOKEN&#34;</span>,
</span></span><span style=display:flex><span>        user_token<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;YOUR_USER_TOKEN&#34;</span>
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 运行测试</span>
</span></span><span style=display:flex><span>    tester<span style=color:#f92672>.</span>run_all_tests()
</span></span></code></pre></div><h4 id=872-性能测试脚本>8.7.2 性能测试脚本</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e>#!/usr/bin/env python3</span>
</span></span><span style=display:flex><span><span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>ThingsBoard接口性能测试脚本
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> time
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> threading
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> statistics
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> requests
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> paho.mqtt.client <span style=color:#66d9ef>as</span> mqtt
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> json
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>PerformanceTester</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>__init__</span>(self, host<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;localhost&#34;</span>, device_token<span style=color:#f92672>=</span><span style=color:#66d9ef>None</span>):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>host <span style=color:#f92672>=</span> host
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>device_token <span style=color:#f92672>=</span> device_token
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>results <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>test_rest_api_performance</span>(self, num_requests<span style=color:#f92672>=</span><span style=color:#ae81ff>100</span>):
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;&#34;&#34;测试REST API性能&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;Testing REST API performance with </span><span style=color:#e6db74>{</span>num_requests<span style=color:#e6db74>}</span><span style=color:#e6db74> requests...&#34;</span>)
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        times <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> range(num_requests):
</span></span><span style=display:flex><span>            start_time <span style=color:#f92672>=</span> time<span style=color:#f92672>.</span>time()
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            <span style=color:#75715e># 发送遥测数据</span>
</span></span><span style=display:flex><span>            telemetry_data <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;temperature&#34;</span>: <span style=color:#ae81ff>25.5</span> <span style=color:#f92672>+</span> (i <span style=color:#f92672>%</span> <span style=color:#ae81ff>10</span>),
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;humidity&#34;</span>: <span style=color:#ae81ff>60.2</span> <span style=color:#f92672>+</span> (i <span style=color:#f92672>%</span> <span style=color:#ae81ff>5</span>),
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;timestamp&#34;</span>: int(time<span style=color:#f92672>.</span>time() <span style=color:#f92672>*</span> <span style=color:#ae81ff>1000</span>)
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            response <span style=color:#f92672>=</span> requests<span style=color:#f92672>.</span>post(
</span></span><span style=display:flex><span>                <span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;http://</span><span style=color:#e6db74>{</span>self<span style=color:#f92672>.</span>host<span style=color:#e6db74>}</span><span style=color:#e6db74>:9090/api/plugins/telemetry/DEVICE/test_device/values/timeseries&#34;</span>,
</span></span><span style=display:flex><span>                headers<span style=color:#f92672>=</span>{<span style=color:#e6db74>&#34;Content-Type&#34;</span>: <span style=color:#e6db74>&#34;application/json&#34;</span>},
</span></span><span style=display:flex><span>                json<span style=color:#f92672>=</span>telemetry_data
</span></span><span style=display:flex><span>            )
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            end_time <span style=color:#f92672>=</span> time<span style=color:#f92672>.</span>time()
</span></span><span style=display:flex><span>            times<span style=color:#f92672>.</span>append(end_time <span style=color:#f92672>-</span> start_time)
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (i <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>) <span style=color:#f92672>%</span> <span style=color:#ae81ff>10</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>:
</span></span><span style=display:flex><span>                print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;Completed </span><span style=color:#e6db74>{</span>i <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span><span style=color:#e6db74>}</span><span style=color:#e6db74>/</span><span style=color:#e6db74>{</span>num_requests<span style=color:#e6db74>}</span><span style=color:#e6db74> requests&#34;</span>)
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#75715e># 计算统计信息</span>
</span></span><span style=display:flex><span>        avg_time <span style=color:#f92672>=</span> statistics<span style=color:#f92672>.</span>mean(times)
</span></span><span style=display:flex><span>        min_time <span style=color:#f92672>=</span> min(times)
</span></span><span style=display:flex><span>        max_time <span style=color:#f92672>=</span> max(times)
</span></span><span style=display:flex><span>        p95_time <span style=color:#f92672>=</span> statistics<span style=color:#f92672>.</span>quantiles(times, n<span style=color:#f92672>=</span><span style=color:#ae81ff>20</span>)[<span style=color:#ae81ff>18</span>]  <span style=color:#75715e># 95th percentile</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;REST API Performance Results:&#34;</span>)
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;  Average: </span><span style=color:#e6db74>{</span>avg_time<span style=color:#e6db74>:</span><span style=color:#e6db74>.3f</span><span style=color:#e6db74>}</span><span style=color:#e6db74>s&#34;</span>)
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;  Min: </span><span style=color:#e6db74>{</span>min_time<span style=color:#e6db74>:</span><span style=color:#e6db74>.3f</span><span style=color:#e6db74>}</span><span style=color:#e6db74>s&#34;</span>)
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;  Max: </span><span style=color:#e6db74>{</span>max_time<span style=color:#e6db74>:</span><span style=color:#e6db74>.3f</span><span style=color:#e6db74>}</span><span style=color:#e6db74>s&#34;</span>)
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;  95th percentile: </span><span style=color:#e6db74>{</span>p95_time<span style=color:#e6db74>:</span><span style=color:#e6db74>.3f</span><span style=color:#e6db74>}</span><span style=color:#e6db74>s&#34;</span>)
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;protocol&#34;</span>: <span style=color:#e6db74>&#34;REST&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;avg_time&#34;</span>: avg_time,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;min_time&#34;</span>: min_time,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;max_time&#34;</span>: max_time,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;p95_time&#34;</span>: p95_time
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>test_mqtt_performance</span>(self, num_messages<span style=color:#f92672>=</span><span style=color:#ae81ff>100</span>):
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;&#34;&#34;测试MQTT性能&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;Testing MQTT performance with </span><span style=color:#e6db74>{</span>num_messages<span style=color:#e6db74>}</span><span style=color:#e6db74> messages...&#34;</span>)
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> self<span style=color:#f92672>.</span>device_token:
</span></span><span style=display:flex><span>            print(<span style=color:#e6db74>&#34;Device token required for MQTT test&#34;</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>None</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        times <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>        messages_sent <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>on_connect</span>(client, userdata, flags, rc):
</span></span><span style=display:flex><span>            print(<span style=color:#e6db74>&#34;MQTT connected&#34;</span>)
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>on_publish</span>(client, userdata, mid):
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>nonlocal</span> messages_sent
</span></span><span style=display:flex><span>            messages_sent <span style=color:#f92672>+=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> messages_sent <span style=color:#f92672>==</span> num_messages:
</span></span><span style=display:flex><span>                client<span style=color:#f92672>.</span>disconnect()
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        client <span style=color:#f92672>=</span> mqtt<span style=color:#f92672>.</span>Client()
</span></span><span style=display:flex><span>        client<span style=color:#f92672>.</span>username_pw_set(self<span style=color:#f92672>.</span>device_token, <span style=color:#e6db74>&#34;&#34;</span>)
</span></span><span style=display:flex><span>        client<span style=color:#f92672>.</span>on_connect <span style=color:#f92672>=</span> on_connect
</span></span><span style=display:flex><span>        client<span style=color:#f92672>.</span>on_publish <span style=color:#f92672>=</span> on_publish
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        client<span style=color:#f92672>.</span>connect(self<span style=color:#f92672>.</span>host, <span style=color:#ae81ff>1883</span>, <span style=color:#ae81ff>60</span>)
</span></span><span style=display:flex><span>        client<span style=color:#f92672>.</span>loop_start()
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#75715e># 发送消息</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> range(num_messages):
</span></span><span style=display:flex><span>            start_time <span style=color:#f92672>=</span> time<span style=color:#f92672>.</span>time()
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            telemetry_data <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;temperature&#34;</span>: <span style=color:#ae81ff>25.5</span> <span style=color:#f92672>+</span> (i <span style=color:#f92672>%</span> <span style=color:#ae81ff>10</span>),
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;humidity&#34;</span>: <span style=color:#ae81ff>60.2</span> <span style=color:#f92672>+</span> (i <span style=color:#f92672>%</span> <span style=color:#ae81ff>5</span>),
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;timestamp&#34;</span>: int(time<span style=color:#f92672>.</span>time() <span style=color:#f92672>*</span> <span style=color:#ae81ff>1000</span>)
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            client<span style=color:#f92672>.</span>publish(<span style=color:#e6db74>&#34;v1/devices/me/telemetry&#34;</span>, json<span style=color:#f92672>.</span>dumps(telemetry_data))
</span></span><span style=display:flex><span>            times<span style=color:#f92672>.</span>append(time<span style=color:#f92672>.</span>time() <span style=color:#f92672>-</span> start_time)
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#75715e># 等待所有消息发送完成</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>while</span> messages_sent <span style=color:#f92672>&lt;</span> num_messages:
</span></span><span style=display:flex><span>            time<span style=color:#f92672>.</span>sleep(<span style=color:#ae81ff>0.1</span>)
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        client<span style=color:#f92672>.</span>loop_stop()
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#75715e># 计算统计信息</span>
</span></span><span style=display:flex><span>        avg_time <span style=color:#f92672>=</span> statistics<span style=color:#f92672>.</span>mean(times)
</span></span><span style=display:flex><span>        min_time <span style=color:#f92672>=</span> min(times)
</span></span><span style=display:flex><span>        max_time <span style=color:#f92672>=</span> max(times)
</span></span><span style=display:flex><span>        p95_time <span style=color:#f92672>=</span> statistics<span style=color:#f92672>.</span>quantiles(times, n<span style=color:#f92672>=</span><span style=color:#ae81ff>20</span>)[<span style=color:#ae81ff>18</span>]
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;MQTT Performance Results:&#34;</span>)
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;  Average: </span><span style=color:#e6db74>{</span>avg_time<span style=color:#e6db74>:</span><span style=color:#e6db74>.3f</span><span style=color:#e6db74>}</span><span style=color:#e6db74>s&#34;</span>)
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;  Min: </span><span style=color:#e6db74>{</span>min_time<span style=color:#e6db74>:</span><span style=color:#e6db74>.3f</span><span style=color:#e6db74>}</span><span style=color:#e6db74>s&#34;</span>)
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;  Max: </span><span style=color:#e6db74>{</span>max_time<span style=color:#e6db74>:</span><span style=color:#e6db74>.3f</span><span style=color:#e6db74>}</span><span style=color:#e6db74>s&#34;</span>)
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;  95th percentile: </span><span style=color:#e6db74>{</span>p95_time<span style=color:#e6db74>:</span><span style=color:#e6db74>.3f</span><span style=color:#e6db74>}</span><span style=color:#e6db74>s&#34;</span>)
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;protocol&#34;</span>: <span style=color:#e6db74>&#34;MQTT&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;avg_time&#34;</span>: avg_time,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;min_time&#34;</span>: min_time,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;max_time&#34;</span>: max_time,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;p95_time&#34;</span>: p95_time
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>run_performance_tests</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;&#34;&#34;运行性能测试&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#34;Starting ThingsBoard performance tests...&#34;</span>)
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#75715e># 测试REST API性能</span>
</span></span><span style=display:flex><span>        rest_results <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>test_rest_api_performance(<span style=color:#ae81ff>100</span>)
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#75715e># 测试MQTT性能</span>
</span></span><span style=display:flex><span>        mqtt_results <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>test_mqtt_performance(<span style=color:#ae81ff>100</span>)
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#75715e># 比较结果</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> rest_results <span style=color:#f92672>and</span> mqtt_results:
</span></span><span style=display:flex><span>            print(<span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>Performance Comparison:&#34;</span>)
</span></span><span style=display:flex><span>            print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;REST API avg: </span><span style=color:#e6db74>{</span>rest_results[<span style=color:#e6db74>&#39;avg_time&#39;</span>]<span style=color:#e6db74>:</span><span style=color:#e6db74>.3f</span><span style=color:#e6db74>}</span><span style=color:#e6db74>s&#34;</span>)
</span></span><span style=display:flex><span>            print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;MQTT avg: </span><span style=color:#e6db74>{</span>mqtt_results[<span style=color:#e6db74>&#39;avg_time&#39;</span>]<span style=color:#e6db74>:</span><span style=color:#e6db74>.3f</span><span style=color:#e6db74>}</span><span style=color:#e6db74>s&#34;</span>)
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> rest_results[<span style=color:#e6db74>&#39;avg_time&#39;</span>] <span style=color:#f92672>&lt;</span> mqtt_results[<span style=color:#e6db74>&#39;avg_time&#39;</span>]:
</span></span><span style=display:flex><span>                print(<span style=color:#e6db74>&#34;REST API is faster&#34;</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>                print(<span style=color:#e6db74>&#34;MQTT is faster&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 使用示例</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;__main__&#34;</span>:
</span></span><span style=display:flex><span>    tester <span style=color:#f92672>=</span> PerformanceTester(
</span></span><span style=display:flex><span>        host<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;localhost&#34;</span>,
</span></span><span style=display:flex><span>        device_token<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;YOUR_DEVICE_TOKEN&#34;</span>
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    tester<span style=color:#f92672>.</span>run_performance_tests()
</span></span></code></pre></div><h2 id=9-参考资源>9. 参考资源</h2><ul><li><a href=https://thingsboard.io/docs/ target=_blank>ThingsBoard官方文档</a></li><li><a href=https://thingsboard.io/docs/reference/rest-api/ target=_blank>ThingsBoard API参考</a></li><li><a href=https://thingsboard.io/docs/reference/mqtt-api/ target=_blank>ThingsBoard MQTT API</a></li><li><a href=https://thingsboard.io/docs/reference/websocket-api/ target=_blank>ThingsBoard WebSocket API</a></li><li><a href=https://thingsboard.io/docs/user-guide/contribution/testing/ target=_blank>ThingsBoard测试工具</a></li></ul></div><footer class=post__footer><footer class=post__footer><div class="post__tags tags clearfix"><svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M4 0h8s2 0 4 2l15 15s2 2 0 4L21 31s-2 2-4 0L2 16s-2-2-2-4V3s0-3 4-3m3 10a3 3 0 000-6 3 3 0 000 6"/></svg><ul class=tags__list><li class=tags__item><a class="tags__link btn" href=/tags/thingsboard/ rel=tag>thingsboard</a></li></ul></div></footer></footer></article></main><nav class="pagination flex"><div class="pagination__item pagination__item--prev"><a class=pagination__link href=/posts/2025/07/17/spring-i18n/ rel=prev><p class=pagination__title>«&#8201;上一篇: Spring 国际化实现</p></a></div><div class="pagination__item pagination__item--next"><a class=pagination__link href=/posts/2025/07/24/spring-exception/ rel=next><p class=pagination__title>&#8201;» 下一篇: Spring异常处理思路</p></a></div></nav><footer class=post__footer><div class=post-related><h3>相关文章</h3><ul class=post-related-list><li class=post-related-item><a href=/posts/2025/07/02/thingsboard-http-transport/ target=_blank title="ThingsBoard HTTP Transport 实现方式">ThingsBoard HTTP Transport 实现方式</a></li><li class=post-related-item><a href=/posts/2025/06/06/oauth2-client-login-in-thingsboard/ target=_blank title=Thingsboard源码中的OAuth2登录实现>Thingsboard源码中的OAuth2登录实现</a></li><li class=post-related-item><a href=/posts/2025/04/30/codes-in-thingsboard/ target=_blank title=Thingsboard源码中的代码片段>Thingsboard源码中的代码片段</a></li><li class=post-related-item><a href=/posts/2024/12/03/github-actions-in-thingsboard/ target=_blank title="ThingsBoard源码中的Github Actions">ThingsBoard源码中的Github Actions</a></li><li class=post-related-item><a href=/posts/2024/12/03/security-in-thingsboard/ target=_blank title=ThingsBoard源码中的Security>ThingsBoard源码中的Security</a></li><li class=post-related-item><a href=/posts/2024/08/27/thingsboard-code-source-compile/ target=_blank title=ThingsBoard源码编译和Idea运行>ThingsBoard源码编译和Idea运行</a></li></ul></div></footer><div class="authorbox clearfix"><figure class=authorbox__avatar><img alt="ChenSoul avatar" src=/avatar.jpg class=avatar height=60 width=60 loading=lazy></figure><div class=authorbox__header><span class=authorbox__name>关于 ChenSoul</span></div><div class=authorbox__description>一个来自中国武汉的开发者，主要撰写软件开发和开源方面的文章。浏览我的<a href=%28/posts%29>博客文章</a>，订阅我的 <a href=/index.xml>RSS</a> 源，或了解更多<a href=/about/>关于我</a>的信息。</div></div><p><h3>欢迎留言！</h3></p><div id=remark42></div><script>var remark_config={host:"https://comment.chensoul.cc",site_id:"remark",components:["embed"],url:"https://blog.chensoul.cc/posts/2025/07/24/thingsboard-api/",locale:"zh"};!function(e,t){for(s=0;s<e.length;s++){var s,n=t.createElement("script"),o=".js",i=t.head||t.body;"noModule"in n?(n.type="module",o=".mjs"):n.async=!0,n.defer=!0,n.src=remark_config.host+"/web/"+e[s]+o,i.appendChild(n)}}(remark_config.components||["embed"],document)</script></div><aside class="sidebar sidebar--right"><div class="post__toc toc"><div class=toc__title>目录</div><div class=toc__menu><nav id=TableOfContents><ul><li><a href=#1-rest-api接口>1. REST API接口</a><ul><li><a href=#11-认证接口>1.1 认证接口</a></li><li><a href=#12-设备管理接口>1.2 设备管理接口</a></li><li><a href=#13-遥测数据接口>1.3 遥测数据接口</a></li><li><a href=#14-租户管理接口>1.4 租户管理接口</a></li><li><a href=#15-客户管理接口>1.5 客户管理接口</a></li><li><a href=#16-用户管理接口>1.6 用户管理接口</a></li><li><a href=#17-规则引擎接口>1.7 规则引擎接口</a></li></ul></li><li><a href=#2-mqtt接口>2. MQTT接口</a><ul><li><a href=#21-设备连接>2.1 设备连接</a></li><li><a href=#22-遥测数据>2.2 遥测数据</a></li><li><a href=#23-命令下发>2.3 命令下发</a></li><li><a href=#24-属性请求>2.4 属性请求</a></li></ul></li><li><a href=#3-websocket接口>3. WebSocket接口</a><ul><li><a href=#31-连接url>3.1 连接URL</a></li><li><a href=#32-消息格式>3.2 消息格式</a></li></ul></li><li><a href=#4-coap接口>4. CoAP接口</a><ul><li><a href=#41-设备连接>4.1 设备连接</a></li><li><a href=#42-数据上报>4.2 数据上报</a></li></ul></li><li><a href=#5-http接口>5. HTTP接口</a><ul><li><a href=#51-设备数据接口>5.1 设备数据接口</a></li><li><a href=#52-命令接口>5.2 命令接口</a></li></ul></li><li><a href=#6-接口设计特点>6. 接口设计特点</a><ul><li><a href=#61-统一认证>6.1 统一认证</a></li><li><a href=#62-数据格式>6.2 数据格式</a></li><li><a href=#63-版本控制>6.3 版本控制</a></li><li><a href=#64-权限控制>6.4 权限控制</a></li></ul></li><li><a href=#7-最佳实践>7. 最佳实践</a><ul><li><a href=#71-设备连接>7.1 设备连接</a></li><li><a href=#72-数据上报>7.2 数据上报</a></li><li><a href=#73-命令下发>7.3 命令下发</a></li><li><a href=#74-错误处理>7.4 错误处理</a></li></ul></li><li><a href=#8-接口测试>8. 接口测试</a><ul><li><a href=#81-测试环境准备>8.1 测试环境准备</a></li><li><a href=#82-rest-api测试>8.2 REST API测试</a></li><li><a href=#83-mqtt协议测试>8.3 MQTT协议测试</a></li><li><a href=#84-websocket测试>8.4 WebSocket测试</a></li><li><a href=#85-coap协议测试>8.5 CoAP协议测试</a></li><li><a href=#86-http设备接口测试>8.6 HTTP设备接口测试</a></li><li><a href=#87-自动化测试脚本>8.7 自动化测试脚本</a></li></ul></li><li><a href=#9-参考资源>9. 参考资源</a></li></ul></nav></div></div></aside></div><footer class=footer><div class="container footer__container flex"><div class=footer__links><a class=footer__link href=/>首页</a> | <a class=footer__link href=/categories/>分类</a> | <a class=footer__link href=/about/>关于</a> | <a class=footer__link href=/index.xml>RSS</a></div><div class=footer__copyright>&copy; 2025 ChenSoul.
<span class=footer__copyright-credits>基于 <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> 引擎和 <a href=https://github.com/chensoul/rose-hugo/ rel="nofollow noopener" target=_blank>Rose Hugo</a> 主题</span></div></div><style>.scroll-up a{display:block;height:3.125rem;width:3.125rem;text-align:center;line-height:2.7;border-radius:50px;font-size:1.125rem;color:#fff;opacity:1;transition:all .3s ease 0s;box-shadow:0 0 10px rgb(0 0 0/.2)}.scroll-up a{background:#ee591f}.scroll-up{position:fixed;display:none;bottom:50px;z-index:999}.scroll-up.right{right:60px}</style><div class="scroll-up custom right" style=display:block><a href=#top id=top-link accesskey=g><i class="fa fa-arrow-up"></i></a></div><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script defer src=https://umami.chensoul.cc/random-string.js data-website-id=1e07d36d-bec3-4ba6-9459-876b1ac3bbe7></script></footer></div><script>"use strict";(function(t){var i=t.querySelector(".menu__btn"),o=t.querySelector(".menu__list");function a(){o.classList.toggle("menu__list--active"),o.classList.toggle("menu__list--transition"),this.classList.toggle("menu__btn--active"),this.setAttribute("aria-expanded",this.getAttribute("aria-expanded")==="true"?"false":"true")}function r(){this.classList.remove("menu__list--transition")}i&&o&&(i.addEventListener("click",a,!1),o.addEventListener("transitionend",r,!1))})(document,window)</script></body></html>