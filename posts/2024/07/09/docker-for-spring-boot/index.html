<!doctype html><html class=no-js lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>使用 Docker 容器化并运行 Spring Boot 应用程序 - ChenSoul Blog</title><script>(function(e,t){e[t]=e[t].replace("no-js","js")})(document.documentElement,"className")</script><meta name=description content><meta property="og:url" content="https://blog.chensoul.cc/posts/2024/07/09/docker-for-spring-boot/"><meta property="og:site_name" content="ChenSoul Blog"><meta property="og:title" content="使用 Docker 容器化并运行 Spring Boot 应用程序"><meta property="og:description" content="本文翻译自 Docker 官方网站的《Java language-specific guide》文章，并做了一些改动。
Java 入门指南教您如何使用 Docker 创建容器化的 Spring Boot 应用程序。在本模块中，您将学习如何："><meta property="og:locale" content="zh_cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-07-09T00:00:00+00:00"><meta property="article:modified_time" content="2024-07-09T00:00:00+00:00"><meta property="article:tag" content="Spring-Boot"><meta property="article:tag" content="Docker"><meta itemprop=name content="使用 Docker 容器化并运行 Spring Boot 应用程序"><meta itemprop=description content="本文翻译自 Docker 官方网站的《Java language-specific guide》文章，并做了一些改动。
Java 入门指南教您如何使用 Docker 创建容器化的 Spring Boot 应用程序。在本模块中，您将学习如何："><meta itemprop=datePublished content="2024-07-09T00:00:00+00:00"><meta itemprop=dateModified content="2024-07-09T00:00:00+00:00"><meta itemprop=wordCount content="1453"><meta itemprop=keywords content="Spring-Boot,Docker"><meta name=twitter:card content="summary"><meta name=twitter:title content="使用 Docker 容器化并运行 Spring Boot 应用程序"><meta name=twitter:description content="本文翻译自 Docker 官方网站的《Java language-specific guide》文章，并做了一些改动。
Java 入门指南教您如何使用 Docker 创建容器化的 Spring Boot 应用程序。在本模块中，您将学习如何："><link rel=stylesheet href=/css/style.css><link rel="shortcut icon" href=/favicon.ico></head><body class=body><div class="container container--outer"><header class=header><div class="container header__container"><div class=logo><a class=logo__link href=/ title="ChenSoul Blog" rel=home><div class="logo__item logo__text"><div class=logo__title>ChenSoul Blog</div><div class=logo__tagline>Java, Spring Boot, Microservice, Cloud, Architecture and DevOps Tutorials</div></div></a></div><nav class=menu><button class=menu__btn aria-haspopup=true aria-expanded=false tabindex=0>
<span class=menu__btn-title tabindex=-1>Menu</span></button><ul class=menu__list><li class=menu__item><a class=menu__link href=/tools/><span class=menu__text>Tools</span></a></li><li class=menu__item><a class=menu__link href=/tutorials/><span class=menu__text>Tutorials</span></a></li><li class=menu__item><a class=menu__link href=/about/><span class=menu__text>About</span></a></li></ul></nav></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>使用 Docker 容器化并运行 Spring Boot 应用程序</h1><div class="post__meta meta"><div class="meta__item-datetime meta__item"><svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0a14 14 0 110 28 1 1 0 010-28m0 3a3 3 0 100 22 3 3 0 000-22m1 4h-2v8.4l6.8 4.4L22 18l-6-3.8z"/></svg><time class=meta__text datetime=2024-07-09T00:00:00Z>2024-07-09</time></div><div class="meta__item-categories meta__item"><svg class="meta__icon icon icon-category" width="16" height="16" viewBox="0 0 16 16"><path d="m7 2 1 2h8v11H0V2z"/></svg><span class=meta__text><a class=meta__link href=/categories/devops/ rel=category>Devops</a></span></div></div></header><div class="content post__content clearfix"><blockquote><p>本文翻译自 Docker 官方网站的《<a href=https://docs.docker.com/guides/java/ target=_blank>Java language-specific guide</a>》文章，并做了一些改动。</p></blockquote><p>Java 入门指南教您如何使用 Docker 创建容器化的 Spring Boot 应用程序。在本模块中，您将学习如何：</p><ul><li>使用 Maven 容器化并运行 Spring Boot 应用程序</li><li>设置本地开发环境以将数据库连接到容器，配置调试器，并使用 Compose Watch 进行实时重新加载</li><li>在容器内运行单元测试</li><li>使用 GitHub Actions 为应用程序配置 CI/CD 管道</li><li>将容器化应用程序本地部署到 Kubernetes 以测试和调试您的部署</li></ul><p>完成 Java 入门模块后，您应该能够根据本指南中提供的示例和说明来容器化您自己的 Java 应用程序。</p><h1 id=容器化你的应用>容器化你的应用</h1><h2 id=先决条件>先决条件</h2><ul><li><p>您已安装最新版本的 <a href=https://docs.docker.com/get-docker/ target=_blank>Docker Desktop</a>，Docker 会定期添加新功能，本指南的某些部分可能仅适用于最新版本的 Docker Desktop。</p></li><li><p>您有一个 <a href=https://git-scm.com/downloads target=_blank>Git 客户端</a>。本节中的示例使用基于命令行的 Git 客户端，但您可以使用任何客户端。</p></li></ul><h2 id=获取示例应用程序>获取示例应用程序</h2><p>将要使用的示例应用程序克隆到本地开发机器。在终端中运行以下命令来克隆存储库。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>$ git clone https://github.com/spring-projects/spring-petclinic.git
</span></span><span style=display:flex><span>$ cd spring-petclinic
</span></span></code></pre></div><h2 id=初始化-docker-资产>初始化 Docker 资产</h2><p>现在您有了一个应用程序，您可以使用它<code>docker init</code>来创建必要的 Docker 资产来容器化您的应用程序。在 spring-petclinic 中已包含 Docker 资产。系统将提示您覆盖现有 Docker 资产。要继续本指南，请选择<code>y</code>覆盖它们。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>$ docker init
</span></span><span style=display:flex><span>Welcome to the Docker Init CLI!
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>This utility will walk you through creating the following files with sensible defaults <span style=color:#66d9ef>for</span> your project:
</span></span><span style=display:flex><span>  - .dockerignore
</span></span><span style=display:flex><span>  - Dockerfile
</span></span><span style=display:flex><span>  - compose.yaml
</span></span><span style=display:flex><span>  - README.Docker.md
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Let<span style=color:#e6db74>&#39;s get started!
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>WARNING: The following Docker files already exist in this directory:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  - docker-compose.yml
</span></span></span><span style=display:flex><span><span style=color:#e6db74>? Do you want to overwrite them? Yes
</span></span></span><span style=display:flex><span><span style=color:#e6db74>? What application platform does your project use? Java
</span></span></span><span style=display:flex><span><span style=color:#e6db74>? What&#39;</span>s the relative directory <span style=color:#f92672>(</span>with a leading .<span style=color:#f92672>)</span> <span style=color:#66d9ef>for</span> your app? ./src
</span></span><span style=display:flex><span>? What version of Java <span style=color:#66d9ef>do</span> you want to use? <span style=color:#ae81ff>21</span>
</span></span><span style=display:flex><span>? What port does your server listen on? <span style=color:#ae81ff>8080</span>
</span></span></code></pre></div><p>您的目录中现在应该有以下三个新文件<code>spring-petclinic</code> 。</p><ul><li><a href=https://docs.docker.com/reference/dockerfile/ target=_blank>Dockerfile</a></li><li><a href=https://docs.docker.com/reference/dockerfile/#dockerignore-file target=_blank>.dockerignore</a></li><li><a href=https://docs.docker.com/compose/compose-file/ target=_blank>docker-compose.yaml</a></li></ul><h2 id=运行应用程序>运行应用程序</h2><p>在目录内<code>spring-petclinic</code>，在终端运行以下命令。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>$ docker compose up --build
</span></span></code></pre></div><p>首次构建并运行应用程序时，Docker 会下载依赖项并构建应用程序。这可能需要几分钟，具体取决于您的网络连接。</p><p>打开浏览器并通过 <a href=http://localhost:8080/ target=_blank>http://localhost:8080</a>查看应用程序。您应该看到一个宠物诊所的简单应用程序。</p><p>在终端中，按<code>ctrl</code>+<code>c</code>停止应用程序。</p><p>您可以通过添加选项来运行与终端分离的应用程序<code>-d</code> 。在<code>spring-petclinic</code>目录中，在终端中运行以下命令。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>$ docker compose up --build -d
</span></span></code></pre></div><p>打开浏览器并通过 <a href=http://localhost:8080/ target=_blank>http://localhost:8080</a>查看应用程序。您应该看到一个宠物诊所的简单应用程序。</p><p>在终端中，运行以下命令来停止应用程序。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>$ docker compose down
</span></span></code></pre></div><p>有关 Compose 命令的更多信息，请参阅 <a href=https://docs.docker.com/compose/reference/ target=_blank>Compose CLI 参考</a>。</p><h2 id=概括>概括</h2><p>在本节中，您了解了如何使用 Docker 容器化并运行 Java 应用程序。</p><p>相关信息：</p><ul><li><a href=https://docs.docker.com/reference/cli/docker/init/ target=_blank>docker init 参考</a></li></ul><h1 id=使用容器进行-java-开发>使用容器进行 Java 开发</h1><p>在本部分中，您将逐步为上一节中容器化的应用程序设置本地开发环境。这包括：</p><ul><li>添加本地数据库并持久保存数据</li><li>创建开发容器来连接调试器</li><li>配置 Compose 以在您编辑和保存代码时自动更新正在运行的 Compose 服务</li></ul><h2 id=添加本地数据库并保存数据>添加本地数据库并保存数据</h2><p>您可以使用容器来设置本地服务，例如数据库。在本部分中，您将更新文件<code>docker-compose.yaml</code>以定义数据库服务和用于保存数据的卷。此外，此特定应用程序使用系统属性来定义数据库类型，因此您需要更新以<code>Dockerfile</code>在启动应用程序时传入系统属性。</p><p>在克隆的存储库的目录中，<code>docker-compose.yaml</code>在 IDE 或文本编辑器中打开文件。<code>docker init</code>添加了一个示例数据库服务，但它需要针对您的独特应用程序进行一些更改。</p><p>在该<code>docker-compose.yaml</code>文件中，您需要执行以下操作：</p><ul><li>取消注释所有数据库指令。现在您将使用数据库服务而不是本地存储来存储数据。</li><li>删除顶级<code>secrets</code>元素以及<code>db</code> 服务内的元素。此示例使用环境变量作为密码而不是机密。</li><li><code>user</code>从服务中删除元素<code>db</code>。此示例在环境变量中指定用户。</li><li>更新数据库环境变量。这些由 Postgres 镜像定义。有关更多详细信息，请参阅 <a href=https://hub.docker.com/_/postgres target=_blank>Postgres 官方 Docker 镜像</a>。</li><li>更新服务的健康检查测试<code>db</code>并指定用户。默认情况下，健康检查使用 root 用户，而不是<code>petclinic</code>您定义的用户。</li><li>将数据库 URL 添加为服务中的环境变量<code>server</code>。这将覆盖 中定义的默认值 <code>spring-petclinic/src/main/resources/application-postgres.properties</code>。</li></ul><p>以下是更新后的<code>compose.yaml</code>文件。所有注释均已删除。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>services</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>server</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>build</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>context</span>: <span style=color:#ae81ff>.</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>8080</span>:<span style=color:#ae81ff>8080</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>depends_on</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>db</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>condition</span>: <span style=color:#ae81ff>service_healthy</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>environment</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>POSTGRES_URL=jdbc:postgresql://db:5432/petclinic</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>db</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>postgres</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>restart</span>: <span style=color:#ae81ff>always</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>db-data://var/lib/postgresql/data</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>environment</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>POSTGRES_DB=petclinic</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>POSTGRES_USER=petclinic</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>POSTGRES_PASSWORD=petclinic</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>5432</span>:<span style=color:#ae81ff>5432</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>healthcheck</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>test</span>: [ <span style=color:#e6db74>&#34;CMD&#34;</span>, <span style=color:#e6db74>&#34;pg_isready&#34;</span>, <span style=color:#e6db74>&#34;-U&#34;</span>, <span style=color:#e6db74>&#34;petclinic&#34;</span> ]
</span></span><span style=display:flex><span>      <span style=color:#f92672>interval</span>: <span style=color:#ae81ff>10s</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>timeout</span>: <span style=color:#ae81ff>5s</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>retries</span>: <span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span><span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>db-data</span>:
</span></span></code></pre></div><p><code>Dockerfile</code>在 IDE 或文本编辑器中打开。在<code>ENTRYPOINT</code>指令中，更新指令以传入 <code>spring-petclinic/src/resources/db/postgres/petclinic_db_setup_postgres.txt</code> 文件中指定的系统属性。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-diff data-lang=diff><span style=display:flex><span><span style=color:#f92672>- ENTRYPOINT [ &#34;java&#34;, &#34;org.springframework.boot.loader.launch.JarLauncher&#34; ]
</span></span></span><span style=display:flex><span><span style=color:#f92672></span><span style=color:#a6e22e>+ ENTRYPOINT [ &#34;java&#34;, &#34;-Dspring.profiles.active=postgres&#34;, &#34;org.springframework.boot.loader.launch.JarLauncher&#34; ]
</span></span></span></code></pre></div><p>保存并关闭所有文件。</p><p>现在，运行以下<code>docker compose up</code>命令来启动您的应用程序。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span>$ docker compose up --build
</span></span></code></pre></div><p>打开浏览器并通过 <a href=http://localhost:8080/ target=_blank>http://localhost:8080</a>查看应用程序。您应该看到一个宠物诊所的简单应用程序。</p><p>在终端中，按<code>ctrl</code>+<code>c</code>停止应用程序。</p><h2 id=用于开发的-dockerfile>用于开发的 Dockerfile</h2><p>您现在拥有的 Dockerfile 非常适合小型、安全的生产映像，其中仅包含运行应用程序所需的组件。在开发时，您可能需要具有不同环境的其他映像。</p><p>例如，在开发图像中，您可能希望设置图像来启动应用程序，以便您可以将调试器连接到正在运行的 Java 进程。</p><p>您无需管理多个 Dockerfile，只需添加一个新阶段即可。然后，您的 Dockerfile 可以生成可用于生产的最终映像以及开发映像。</p><p>将 Dockerfile 的内容替换为以下内容。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#75715e># syntax=docker/dockerfile:1</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># https://docs.docker.com/reference/dockerfile/</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># https://docs.docker.com/build/guide/multi-stage/</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> maven:3-eclipse-temurin-21-alpine AS base</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span><span style=color:#e6db74> /build</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> ./src src/<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> sed -i -E <span style=color:#e6db74>&#39;159a &lt;mirror&gt;\n&lt;id&gt;aliyun&lt;/id&gt;\n&lt;name&gt;Aliyun Mirror&lt;/name&gt;\n&lt;url&gt;http://maven.aliyun.com/nexus/content/groups/public/&lt;/url&gt;\n&lt;mirrorOf&gt;central&lt;/mirrorOf&gt;\n&lt;/mirror&gt;&#39;</span> /usr/share/maven/conf/settings.xml<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> base AS package</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span><span style=color:#e6db74> /build</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> --mount<span style=color:#f92672>=</span>type<span style=color:#f92672>=</span>bind,source<span style=color:#f92672>=</span>pom.xml,target<span style=color:#f92672>=</span>pom.xml <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --mount<span style=color:#f92672>=</span>type<span style=color:#f92672>=</span>cache,target<span style=color:#f92672>=</span>/root/.m2 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    mvn package -DskipTests <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    mv target/<span style=color:#66d9ef>$(</span>mvn help:evaluate -Dexpression<span style=color:#f92672>=</span>project.artifactId -q -DforceStdout<span style=color:#66d9ef>)</span>-<span style=color:#66d9ef>$(</span>mvn help:evaluate -Dexpression<span style=color:#f92672>=</span>project.version -q -DforceStdout<span style=color:#66d9ef>)</span>.jar target/app.jar<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> package AS extract</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span><span style=color:#e6db74> /build</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> java -Djarmode<span style=color:#f92672>=</span>layertools -jar target/app.jar extract --destination target/extracted<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> eclipse-temurin:21-jre-jammy AS final</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span><span style=color:#e6db74> /app</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># See https://docs.docker.com/go/dockerfile-user-best-practices/</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ARG</span> UID<span style=color:#f92672>=</span><span style=color:#ae81ff>10001</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>RUN</span> adduser <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --disabled-password <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --gecos <span style=color:#e6db74>&#34;&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --home <span style=color:#e6db74>&#34;/nonexistent&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --shell <span style=color:#e6db74>&#34;/sbin/nologin&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --no-create-home <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --uid <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>UID<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    appuser<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>USER</span><span style=color:#e6db74> appuser</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> --from<span style=color:#f92672>=</span>extract /build/target/extracted/dependencies/ ./<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> --from<span style=color:#f92672>=</span>extract /build/target/extracted/spring-boot-loader/ ./<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> --from<span style=color:#f92672>=</span>extract /build/target/extracted/snapshot-dependencies/ ./<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> --from<span style=color:#f92672>=</span>extract /build/target/extracted/application/ ./<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>EXPOSE</span><span style=color:#e6db74> 8080</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENTRYPOINT</span> [ <span style=color:#e6db74>&#34;java&#34;</span>, <span style=color:#e6db74>&#34;-Dspring.profiles.active=postgres&#34;</span>, <span style=color:#e6db74>&#34;org.springframework.boot.loader.launch.JarLauncher&#34;</span> ]<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>保存并关闭<code>Dockerfile</code>。</p><h2 id=使用-compose-进行本地开发>使用 Compose 进行本地开发</h2><p>当前 Compose 文件无法启动您的开发容器。为此，您必须更新 Compose 文件以定位开发阶段。此外，更新服务器服务的端口映射以提供对调试器的访问权限。</p><p><code>petclinic</code>在 IDE 或文本编辑器中 打开并创建一个名为 <code>docker-compose.dev.yml</code> 的新文件。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>services</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>server</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>build</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>context</span>: <span style=color:#ae81ff>.</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>target</span>: <span style=color:#ae81ff>development</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>8080</span>:<span style=color:#ae81ff>8080</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>8000</span>:<span style=color:#ae81ff>8000</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>depends_on</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>db</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>condition</span>: <span style=color:#ae81ff>service_healthy</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>environment</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>POSTGRES_URL=jdbc:postgresql://db:5432/petclinic</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>db</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>postgres</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>restart</span>: <span style=color:#ae81ff>always</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>db-data://var/lib/postgresql/data</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>environment</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>POSTGRES_DB=petclinic</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>POSTGRES_USER=petclinic</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>POSTGRES_PASSWORD=petclinic</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>5432</span>:<span style=color:#ae81ff>5432</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>healthcheck</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>test</span>: [ <span style=color:#e6db74>&#34;CMD&#34;</span>, <span style=color:#e6db74>&#34;pg_isready&#34;</span>, <span style=color:#e6db74>&#34;-U&#34;</span>, <span style=color:#e6db74>&#34;petclinic&#34;</span> ]
</span></span><span style=display:flex><span>      <span style=color:#f92672>interval</span>: <span style=color:#ae81ff>10s</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>timeout</span>: <span style=color:#ae81ff>5s</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>retries</span>: <span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span><span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>db-data</span>:
</span></span></code></pre></div><p>现在，启动您的应用程序并确认它正在运行。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>$ docker compose up --build
</span></span></code></pre></div><p>最后，测试您的 API 端点。运行以下 curl 命令：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>$ curl  --request GET <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --url http://localhost:8080/vets <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --header <span style=color:#e6db74>&#39;content-type: application/json&#39;</span>
</span></span></code></pre></div><p>您应该收到以下回复：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json><span style=display:flex><span>{<span style=color:#f92672>&#34;vetList&#34;</span>:[{<span style=color:#f92672>&#34;id&#34;</span>:<span style=color:#ae81ff>1</span>,<span style=color:#f92672>&#34;firstName&#34;</span>:<span style=color:#e6db74>&#34;James&#34;</span>,<span style=color:#f92672>&#34;lastName&#34;</span>:<span style=color:#e6db74>&#34;Carter&#34;</span>,<span style=color:#f92672>&#34;specialties&#34;</span>:[],<span style=color:#f92672>&#34;nrOfSpecialties&#34;</span>:<span style=color:#ae81ff>0</span>,<span style=color:#f92672>&#34;new&#34;</span>:<span style=color:#66d9ef>false</span>},{<span style=color:#f92672>&#34;id&#34;</span>:<span style=color:#ae81ff>2</span>,<span style=color:#f92672>&#34;firstName&#34;</span>:<span style=color:#e6db74>&#34;Helen&#34;</span>,<span style=color:#f92672>&#34;lastName&#34;</span>:<span style=color:#e6db74>&#34;Leary&#34;</span>,<span style=color:#f92672>&#34;specialties&#34;</span>:[{<span style=color:#f92672>&#34;id&#34;</span>:<span style=color:#ae81ff>1</span>,<span style=color:#f92672>&#34;name&#34;</span>:<span style=color:#e6db74>&#34;radiology&#34;</span>,<span style=color:#f92672>&#34;new&#34;</span>:<span style=color:#66d9ef>false</span>}],<span style=color:#f92672>&#34;nrOfSpecialties&#34;</span>:<span style=color:#ae81ff>1</span>,<span style=color:#f92672>&#34;new&#34;</span>:<span style=color:#66d9ef>false</span>},{<span style=color:#f92672>&#34;id&#34;</span>:<span style=color:#ae81ff>3</span>,<span style=color:#f92672>&#34;firstName&#34;</span>:<span style=color:#e6db74>&#34;Linda&#34;</span>,<span style=color:#f92672>&#34;lastName&#34;</span>:<span style=color:#e6db74>&#34;Douglas&#34;</span>,<span style=color:#f92672>&#34;specialties&#34;</span>:[{<span style=color:#f92672>&#34;id&#34;</span>:<span style=color:#ae81ff>3</span>,<span style=color:#f92672>&#34;name&#34;</span>:<span style=color:#e6db74>&#34;dentistry&#34;</span>,<span style=color:#f92672>&#34;new&#34;</span>:<span style=color:#66d9ef>false</span>},{<span style=color:#f92672>&#34;id&#34;</span>:<span style=color:#ae81ff>2</span>,<span style=color:#f92672>&#34;name&#34;</span>:<span style=color:#e6db74>&#34;surgery&#34;</span>,<span style=color:#f92672>&#34;new&#34;</span>:<span style=color:#66d9ef>false</span>}],<span style=color:#f92672>&#34;nrOfSpecialties&#34;</span>:<span style=color:#ae81ff>2</span>,<span style=color:#f92672>&#34;new&#34;</span>:<span style=color:#66d9ef>false</span>},{<span style=color:#f92672>&#34;id&#34;</span>:<span style=color:#ae81ff>4</span>,<span style=color:#f92672>&#34;firstName&#34;</span>:<span style=color:#e6db74>&#34;Rafael&#34;</span>,<span style=color:#f92672>&#34;lastName&#34;</span>:<span style=color:#e6db74>&#34;Ortega&#34;</span>,<span style=color:#f92672>&#34;specialties&#34;</span>:[{<span style=color:#f92672>&#34;id&#34;</span>:<span style=color:#ae81ff>2</span>,<span style=color:#f92672>&#34;name&#34;</span>:<span style=color:#e6db74>&#34;surgery&#34;</span>,<span style=color:#f92672>&#34;new&#34;</span>:<span style=color:#66d9ef>false</span>}],<span style=color:#f92672>&#34;nrOfSpecialties&#34;</span>:<span style=color:#ae81ff>1</span>,<span style=color:#f92672>&#34;new&#34;</span>:<span style=color:#66d9ef>false</span>},{<span style=color:#f92672>&#34;id&#34;</span>:<span style=color:#ae81ff>5</span>,<span style=color:#f92672>&#34;firstName&#34;</span>:<span style=color:#e6db74>&#34;Henry&#34;</span>,<span style=color:#f92672>&#34;lastName&#34;</span>:<span style=color:#e6db74>&#34;Stevens&#34;</span>,<span style=color:#f92672>&#34;specialties&#34;</span>:[{<span style=color:#f92672>&#34;id&#34;</span>:<span style=color:#ae81ff>1</span>,<span style=color:#f92672>&#34;name&#34;</span>:<span style=color:#e6db74>&#34;radiology&#34;</span>,<span style=color:#f92672>&#34;new&#34;</span>:<span style=color:#66d9ef>false</span>}],<span style=color:#f92672>&#34;nrOfSpecialties&#34;</span>:<span style=color:#ae81ff>1</span>,<span style=color:#f92672>&#34;new&#34;</span>:<span style=color:#66d9ef>false</span>},{<span style=color:#f92672>&#34;id&#34;</span>:<span style=color:#ae81ff>6</span>,<span style=color:#f92672>&#34;firstName&#34;</span>:<span style=color:#e6db74>&#34;Sharon&#34;</span>,<span style=color:#f92672>&#34;lastName&#34;</span>:<span style=color:#e6db74>&#34;Jenkins&#34;</span>,<span style=color:#f92672>&#34;specialties&#34;</span>:[],<span style=color:#f92672>&#34;nrOfSpecialties&#34;</span>:<span style=color:#ae81ff>0</span>,<span style=color:#f92672>&#34;new&#34;</span>:<span style=color:#66d9ef>false</span>}]}
</span></span></code></pre></div><h2 id=连接调试器>连接调试器</h2><p>您将使用 IntelliJ IDEA 自带的调试器。您可以使用此 IDE 的社区版本。在 IntelliJ IDEA 中打开您的项目，转到**“运行”<strong>菜单，然后</strong>转到“编辑配置”**。添加类似于以下内容的新远程 JVM 调试配置：</p><p><img src=https://docs.docker.com/guides/java/images/connect-debugger.webp alt="Java 连接调试器"></p><p>设置断点。</p><p>打开<code>src/main/java/org/springframework/samples/petclinic/vet/VetController.java</code>并在函数内部添加断点<code>showResourcesVetList</code>。</p><p>要启动调试会话，请选择<strong>运行</strong>菜单，然后<strong>选择调试*NameOfYourConfiguration*</strong>。</p><p><img src=https://docs.docker.com/guides/java/images/debug-menu.webp alt=调试菜单></p><p>您现在应该可以在 Compose 应用程序的日志中看到该连接。</p><p><img src=https://docs.docker.com/guides/java/images/compose-logs.webp alt=撰写日志文件></p><p>您现在可以调用服务器端点。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>$ curl --request GET --url http://localhost:8080/vets
</span></span></code></pre></div><p>您应该已经看到代码在标记的行上中断，现在您可以像平常一样使用调试器。您还可以检查和观察变量、设置条件断点、查看堆栈跟踪以及执行许多其他操作。</p><p><img src=https://docs.docker.com/guides/java/images/debugger-breakpoint.webp alt=调试器代码断点></p><p>按下<code>ctrl+c</code>终端即可停止您的应用程序。</p><h2 id=自动更新服务>自动更新服务</h2><p>使用 Compose Watch 可在您编辑和保存代码时自动更新正在运行的 Compose 服务。有关 Compose Watch 的更多详细信息，请参阅 <a href=https://docs.docker.com/compose/file-watch/ target=_blank>使用 Compose Watch</a>。</p><p>在 IDE 或文本编辑器中打开您的<code>docker-compose.yaml</code>文件，然后添加 Compose Watch 指令。以下是更新后的<code>docker-compose.yaml</code> 文件。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>services</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>server</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>build</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>context</span>: <span style=color:#ae81ff>.</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>target</span>: <span style=color:#ae81ff>development</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>8080</span>:<span style=color:#ae81ff>8080</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>8000</span>:<span style=color:#ae81ff>8000</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>depends_on</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>db</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>condition</span>: <span style=color:#ae81ff>service_healthy</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>environment</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>POSTGRES_URL=jdbc:postgresql://db:5432/petclinic</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>develop</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>watch</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>action</span>: <span style=color:#ae81ff>rebuild</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>path</span>: <span style=color:#ae81ff>.</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>db</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>postgres</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>restart</span>: <span style=color:#ae81ff>always</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>db-data://var/lib/postgresql/data</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>environment</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>POSTGRES_DB=petclinic</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>POSTGRES_USER=petclinic</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>POSTGRES_PASSWORD=petclinic</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>5432</span>:<span style=color:#ae81ff>5432</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>healthcheck</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>test</span>: [ <span style=color:#e6db74>&#34;CMD&#34;</span>, <span style=color:#e6db74>&#34;pg_isready&#34;</span>, <span style=color:#e6db74>&#34;-U&#34;</span>, <span style=color:#e6db74>&#34;petclinic&#34;</span> ]
</span></span><span style=display:flex><span>      <span style=color:#f92672>interval</span>: <span style=color:#ae81ff>10s</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>timeout</span>: <span style=color:#ae81ff>5s</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>retries</span>: <span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span><span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>db-data</span>:
</span></span></code></pre></div><p>运行以下命令以使用 Compose Watch 运行您的应用程序。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>$ docker compose watch
</span></span></code></pre></div><p>打开 Web 浏览器并通过 http://localhost:8080 查看应用程序 。您应该会看到 Spring Pet Clinic 主页。</p><p>现在，对本地计算机上应用程序源文件的任何更改都将自动反映在正在运行的容器中。</p><p><code>spring-petclinic/src/main/resources/templates/fragments/layout.html</code>在 IDE 或文本编辑器中打开并<code>Home</code>通过添加感叹号来更新导航字符串。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-diff data-lang=diff><span style=display:flex><span><span style=color:#f92672>-   &lt;li th:replace=&#34;~{::menuItem (&#39;/&#39;,&#39;home&#39;,&#39;home page&#39;,&#39;home&#39;,&#39;Home&#39;)}&#34;&gt;
</span></span></span><span style=display:flex><span><span style=color:#f92672></span><span style=color:#a6e22e>+   &lt;li th:replace=&#34;~{::menuItem (&#39;/&#39;,&#39;home&#39;,&#39;home page&#39;,&#39;home&#39;,&#39;Home!&#39;)}&#34;&gt;
</span></span></span></code></pre></div><p>保存更改<code>layout.html</code>，然后您可以在容器自动重建时继续开发。</p><p>容器重建并运行后，刷新 <a href=http://localhost:8080/ target=_blank>http://localhost:8080</a>，然后验证 **Home！**现在是否出现在菜单中。</p><p>按下<code>ctrl+c</code>终端即可停止 Compose Watch。</p><h2 id=概括-1>概括</h2><p>在本部分中，您了解了如何在本地运行数据库并持久保存数据。您还创建了一个包含 JDK 的开发映像，并允许您附加调试器。最后，您设置了 Compose 文件以公开调试端口，并配置了 Compose Watch 以实时重新加载您的更改。</p><p>相关信息：</p><ul><li><a href=https://docs.docker.com/compose/compose-file/ target=_blank>Compose file reference</a></li><li><a href=https://docs.docker.com/compose/file-watch/ target=_blank>Compose Watch</a></li><li><a href=https://docs.docker.com/reference/dockerfile/ target=_blank>Dockerfile reference</a></li></ul><h1 id=运行-java-测试>运行 Java 测试</h1><h2 id=概述>概述</h2><p>测试是现代软件开发的重要组成部分。测试对不同的开发团队来说可能意味着很多事情。有单元测试、集成测试和端到端测试。在本指南中，您将了解如何在 Docker 中运行单元测试。</p><h2 id=用于测试的多阶段-dockerfile>用于测试的多阶段 Dockerfile</h2><p>在以下示例中，您将把测试命令拉入 Dockerfile。将 Dockerfile 的内容替换为以下内容。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#75715e># syntax=docker/dockerfile:1</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># https://docs.docker.com/reference/dockerfile/</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># https://docs.docker.com/build/guide/multi-stage/</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> maven:3-eclipse-temurin-21-alpine AS base</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span><span style=color:#e6db74> /build</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> ./src src/<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> sed -i -E <span style=color:#e6db74>&#39;159a &lt;mirror&gt;\n&lt;id&gt;aliyun&lt;/id&gt;\n&lt;name&gt;Aliyun Mirror&lt;/name&gt;\n&lt;url&gt;http://maven.aliyun.com/nexus/content/groups/public/&lt;/url&gt;\n&lt;mirrorOf&gt;central&lt;/mirrorOf&gt;\n&lt;/mirror&gt;&#39;</span> /usr/share/maven/conf/settings.xml<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> base AS test</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span><span style=color:#e6db74> /build</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> --mount<span style=color:#f92672>=</span>type<span style=color:#f92672>=</span>bind,source<span style=color:#f92672>=</span>pom.xml,target<span style=color:#f92672>=</span>pom.xml <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --mount<span style=color:#f92672>=</span>type<span style=color:#f92672>=</span>cache,target<span style=color:#f92672>=</span>/root/.m2 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    mvn test<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> base AS package</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span><span style=color:#e6db74> /build</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> --mount<span style=color:#f92672>=</span>type<span style=color:#f92672>=</span>bind,source<span style=color:#f92672>=</span>pom.xml,target<span style=color:#f92672>=</span>pom.xml <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --mount<span style=color:#f92672>=</span>type<span style=color:#f92672>=</span>cache,target<span style=color:#f92672>=</span>/root/.m2 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    mvn package -DskipTests <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    mv target/<span style=color:#66d9ef>$(</span>mvn help:evaluate -Dexpression<span style=color:#f92672>=</span>project.artifactId -q -DforceStdout<span style=color:#66d9ef>)</span>-<span style=color:#66d9ef>$(</span>mvn help:evaluate -Dexpression<span style=color:#f92672>=</span>project.version -q -DforceStdout<span style=color:#66d9ef>)</span>.jar target/app.jar<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> package AS extract</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span><span style=color:#e6db74> /build</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> java -Djarmode<span style=color:#f92672>=</span>layertools -jar target/app.jar extract --destination target/extracted<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> extract AS development</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span><span style=color:#e6db74> /build</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> cp -r /build/target/extracted/dependencies/. ./<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> cp -r /build/target/extracted/spring-boot-loader/. ./<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> cp -r /build/target/extracted/snapshot-dependencies/. ./<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> cp -r /build/target/extracted/application/. ./<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>CMD</span> [ <span style=color:#e6db74>&#34;java&#34;</span>, <span style=color:#e6db74>&#34;-Dspring-boot.run.jvmArguments=&#39;-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:8000&#39;&#34;</span>, <span style=color:#e6db74>&#34;org.springframework.boot.loader.launch.JarLauncher&#34;</span> ]<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> eclipse-temurin:21-jre-jammy AS final</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span><span style=color:#e6db74> /app</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># See https://docs.docker.com/go/dockerfile-user-best-practices/</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ARG</span> UID<span style=color:#f92672>=</span><span style=color:#ae81ff>10001</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>RUN</span> adduser <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --disabled-password <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --gecos <span style=color:#e6db74>&#34;&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --home <span style=color:#e6db74>&#34;/nonexistent&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --shell <span style=color:#e6db74>&#34;/sbin/nologin&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --no-create-home <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --uid <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>UID<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    appuser<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>USER</span><span style=color:#e6db74> appuser</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> --from<span style=color:#f92672>=</span>extract /build/target/extracted/dependencies/ ./<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> --from<span style=color:#f92672>=</span>extract /build/target/extracted/spring-boot-loader/ ./<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> --from<span style=color:#f92672>=</span>extract /build/target/extracted/snapshot-dependencies/ ./<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> --from<span style=color:#f92672>=</span>extract /build/target/extracted/application/ ./<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>EXPOSE</span><span style=color:#e6db74> 8080</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENTRYPOINT</span> [ <span style=color:#e6db74>&#34;java&#34;</span>, <span style=color:#e6db74>&#34;-Dspring.profiles.active=postgres&#34;</span>, <span style=color:#e6db74>&#34;org.springframework.boot.loader.launch.JarLauncher&#34;</span> ]<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>现在，构建您的映像并运行测试。您将运行命令<code>docker build</code>并添加<code>--target test</code>标志，以便专门运行测试构建阶段。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>$ docker build -t java-docker-image-test --progress<span style=color:#f92672>=</span>plain --no-cache --target<span style=color:#f92672>=</span>test .
</span></span></code></pre></div><p>您应该看到包含以下内容的输出</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span>...
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>#<span style=color:#ae81ff>15</span> 101.3 <span style=color:#f92672>[</span>WARNING<span style=color:#f92672>]</span> Tests run: 45, Failures: 0, Errors: 0, Skipped: <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>#<span style=color:#ae81ff>15</span> 101.3 <span style=color:#f92672>[</span>INFO<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>#<span style=color:#ae81ff>15</span> 101.3 <span style=color:#f92672>[</span>INFO<span style=color:#f92672>]</span> ------------------------------------------------------------------------
</span></span><span style=display:flex><span>#<span style=color:#ae81ff>15</span> 101.3 <span style=color:#f92672>[</span>INFO<span style=color:#f92672>]</span> BUILD SUCCESS
</span></span><span style=display:flex><span>#<span style=color:#ae81ff>15</span> 101.3 <span style=color:#f92672>[</span>INFO<span style=color:#f92672>]</span> ------------------------------------------------------------------------
</span></span><span style=display:flex><span>#<span style=color:#ae81ff>15</span> 101.3 <span style=color:#f92672>[</span>INFO<span style=color:#f92672>]</span> Total time:  01:39 min
</span></span><span style=display:flex><span>#<span style=color:#ae81ff>15</span> 101.3 <span style=color:#f92672>[</span>INFO<span style=color:#f92672>]</span> Finished at: 2024-02-01T23:24:48Z
</span></span><span style=display:flex><span>#<span style=color:#ae81ff>15</span> 101.3 <span style=color:#f92672>[</span>INFO<span style=color:#f92672>]</span> ------------------------------------------------------------------------
</span></span><span style=display:flex><span>#<span style=color:#ae81ff>15</span> DONE 101.4s
</span></span></code></pre></div><h2 id=概括-2>概括</h2><p>在本节中，您学习了如何在构建图像时运行测试。</p><p>相关信息：</p><ul><li><a href=https://docs.docker.com/build/guide/ target=_blank>使用 Docker 指南进行构建</a></li></ul><h1 id=为-java-应用程序配置-cicd>为 Java 应用程序配置 CI/CD</h1><h2 id=先决条件-1>先决条件</h2><p>完成本指南的前面部分，从 <a href=https://docs.docker.com/guides/java/containerize/ target=_blank>容器化您的应用</a>开始。您必须拥有 <a href=https://github.com/signup target=_blank>GitHub</a>帐户和 <a href=https://hub.docker.com/signup target=_blank>Docker</a>帐户才能完成此部分。</p><h2 id=概述-1>概述</h2><p>在本部分中，您将了解如何设置和使用 GitHub Actions 构建 Docker 映像并将其推送到 Docker Hub。您将完成以下步骤：</p><ol><li>在 GitHub 上创建一个新的存储库。</li><li>定义 GitHub Actions 工作流程。</li><li>运行工作流程。</li></ol><h2 id=第一步创建存储库>第一步：创建存储库</h2><p>创建 GitHub 存储库，配置 Docker Hub 凭据并推送源代码。</p><ol><li><p>在 GitHub 上<a href=https://github.com/new target=_blank>创建一个新的存储库</a>。</p></li><li><p>打开存储库<strong>设置</strong>，然后转到<strong>机密和变量</strong>> <strong>操作</strong>。</p></li><li><p>创建一个名为的新<strong>Repository 变量</strong><code>DOCKER_USERNAME</code>，并以您的 Docker ID 作为值。</p></li><li><p>为 Docker Hub创建一个新的 <a href=https://docs.docker.com/security/for-developers/access-tokens/#create-an-access-token target=_blank>个人访问令牌 (PAT)</a>。您可以将此令牌命名为 <code>docker-tutorial</code> 。确保访问权限包括读取和写入。</p></li><li><p>将 PAT 作为<strong>存储库机密</strong>添加到您的 GitHub 存储库中，名称为 <code>DOCKER_TOKEN</code>。</p></li><li><p>在您机器上的本地存储库中，运行以下命令将源更改为您刚刚创建的存储库。确保更改 <code>your-username</code>为您的 GitHub 用户名和<code>your-repository</code>您创建的存储库的名称。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>$ git remote set-url origin https://github.com/your-username/your-repository.git
</span></span></code></pre></div></li><li><p>运行以下命令将本地存储库暂存、提交并推送到 GitHub。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>$ git add -A
</span></span><span style=display:flex><span>$ git commit -m <span style=color:#e6db74>&#34;my commit&#34;</span>
</span></span><span style=display:flex><span>$ git push -u origin main
</span></span></code></pre></div></li></ol><h2 id=第二步设置工作流程>第二步：设置工作流程</h2><p>设置 GitHub Actions 工作流程以构建、测试和将映像推送到 Docker Hub。</p><ol><li><p>转到 GitHub 上的存储库，然后选择“操作”选项卡。该项目已经具有<code>maven-build</code>使用 Maven 构建和测试 Java 应用程序的工作流程。如果需要，您可以选择禁用此工作流程，因为您不会在本指南中使用它。您将创建一个新的替代工作流程来构建、测试和推送您的映像。</p></li><li><p>选择<strong>新工作流程</strong>。</p></li><li><p>选择<strong>自己设置工作流程</strong>。</p><p><code>.github/workflows/docker</code>默认情况下，这将带您进入一个在存储库中创建新的 GitHub 操作工作流文件的页面。</p></li><li><p>在编辑器窗口中，复制并粘贴以下 YAML 配置。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># https://github.com/docker/metadata-action</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>name</span>: <span style=color:#ae81ff>Build Docker Image</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>on</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>push</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>branches</span>: [ <span style=color:#e6db74>&#34;main&#34;</span> ]
</span></span><span style=display:flex><span>    <span style=color:#f92672>tags</span>: [ <span style=color:#e6db74>&#34;*&#34;</span> ]
</span></span><span style=display:flex><span>  <span style=color:#f92672>release</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>types</span>: [ <span style=color:#ae81ff>created ]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>jobs</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>build</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>runs-on</span>: <span style=color:#ae81ff>ubuntu-latest</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>steps</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Docker meta</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>id</span>: <span style=color:#ae81ff>meta</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>uses</span>: <span style=color:#ae81ff>docker/metadata-action@v5</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>with</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>images</span>: |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            ${{ secrets.DOCKER_USERNAME }}/${{ github.event.repository.name }}</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>tags</span>: |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            type=ref,event=tag
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            type=semver,pattern={{version}}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            type=semver,pattern={{major}}.{{minor}}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            type=semver,pattern={{major}}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            type=raw,latest</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Set up Docker Buildx</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>uses</span>: <span style=color:#ae81ff>docker/setup-buildx-action@v3</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Set up QEMU</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>uses</span>: <span style=color:#ae81ff>docker/setup-qemu-action@v3</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Set up Docker Buildx</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>uses</span>: <span style=color:#ae81ff>docker/setup-buildx-action@v3</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Login to Docker Hub</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>if</span>: <span style=color:#ae81ff>github.event_name != &#39;pull_request&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>uses</span>: <span style=color:#ae81ff>docker/login-action@v3</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>with</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>username</span>: <span style=color:#ae81ff>${{ secrets.DOCKER_USERNAME }}</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>password</span>: <span style=color:#ae81ff>${{ secrets.DOCKER_TOKEN }}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Build and push</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>uses</span>: <span style=color:#ae81ff>docker/build-push-action@v6</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>with</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>file</span>: <span style=color:#ae81ff>Dockerfile</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>platforms</span>: <span style=color:#ae81ff>linux/amd64,linux/arm64</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>target</span>: <span style=color:#ae81ff>final</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>tags</span>: <span style=color:#ae81ff>${{ steps.meta.outputs.tags }}</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>push</span>: <span style=color:#ae81ff>${{ github.event_name != &#39;pull_request&#39; }}</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>labels</span>: <span style=color:#ae81ff>${{ steps.meta.outputs.labels }}</span>
</span></span></code></pre></div><p>有关的 YAML 语法的更多信息<code>docker/build-push-action</code>，请参阅 <a href=https://github.com/docker/build-push-action/blob/master/README.md target=_blank>GitHub Action README</a>。</p></li></ol><h2 id=第三步运行工作流程>第三步：运行工作流程</h2><p>保存工作流文件并运行作业。</p><ol><li><p>选择**提交更改&mldr;**并将更改推送到<code>main</code>分支。</p><p>推送提交后，工作流程将自动启动。</p></li><li><p>转到**“操作”**选项卡。它显示工作流程。</p><p>选择工作流程可以显示所有步骤的细目。</p></li><li><p>工作流程完成后，转到 <a href=https://hub.docker.com/repositories target=_blank>Docker Hub 上的存储库</a>。</p><p>如果您在该列表中看到新的存储库，则表示 GitHub Actions 已成功将映像推送到 Docker Hub。</p></li></ol><h2 id=概括-3>概括</h2><p>在本节中，您学习了如何为您的应用程序设置 GitHub Actions 工作流程。</p><p>相关信息：</p><ul><li><a href=https://docs.docker.com/build/ci/github-actions/ target=_blank>GitHub Actions 简介</a></li><li><a href=https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions target=_blank>GitHub Actions 的工作流程语法</a></li></ul><h1 id=测试-kubernetes-部署>测试 Kubernetes 部署</h1><h2 id=先决条件-2>先决条件</h2><ul><li>完成本指南前面的所有部分，从 <a href=https://docs.docker.com/guides/java/containerize/ target=_blank>“容器化你的应用”</a>开始。</li><li>在 Docker Desktop 中<a href=https://docs.docker.com/desktop/kubernetes/#install-and-turn-on-kubernetes target=_blank>打开 Kubernetes</a>。</li></ul><h2 id=概述-2>概述</h2><p>在本部分中，您将了解如何使用 Docker Desktop 将应用程序部署到开发机器上功能齐全的 Kubernetes 环境。这样，您可以在部署之前在本地测试和调试 Kubernetes 上的工作负载。</p><h2 id=创建-kubernetes-yaml-文件>创建 Kubernetes YAML 文件</h2><p>在您的<code>spring-petclinic</code>目录中，创建一个名为 的文件 <code>docker-java-kubernetes.yaml</code>。在 IDE 或文本编辑器中打开该文件并添加以下内容。将其替换为您的 Docker 用户名和您在<a href=https://docs.docker.com/guides/java/configure-ci-cd/ target=_blank>为 Java 应用程序配置 CI/CD</a><code>DOCKER_USERNAME/REPO_NAME</code>中创建的存储库的名称 。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>apps/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Deployment</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>docker-java-demo</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>default</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>replicas</span>: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>matchLabels</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>service</span>: <span style=color:#ae81ff>server</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>template</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>service</span>: <span style=color:#ae81ff>server</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>containers</span>:
</span></span><span style=display:flex><span>       - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>server-service</span>
</span></span><span style=display:flex><span>         <span style=color:#f92672>image</span>: <span style=color:#ae81ff>DOCKER_USERNAME/REPO_NAME</span>
</span></span><span style=display:flex><span>         <span style=color:#f92672>imagePullPolicy</span>: <span style=color:#ae81ff>Always</span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Service</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>service-entrypoint</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>default</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>type</span>: <span style=color:#ae81ff>NodePort</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>service</span>: <span style=color:#ae81ff>server</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>port</span>: <span style=color:#ae81ff>8080</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>targetPort</span>: <span style=color:#ae81ff>8080</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>nodePort</span>: <span style=color:#ae81ff>30001</span>
</span></span></code></pre></div><p>在此 Kubernetes YAML 文件中，有两个对象，由以下字符分隔<code>---</code>：</p><ul><li>部署，描述一组可扩展的相同 Pod。在这种情况下，您将只获得一个副本或 Pod 的副本。该 Pod（如下所述）中只有一个容器。该容器是根据 GitHub Actions 在<a href=https://docs.docker.com/guides/java/configure-ci-cd/ target=_blank>为 Java 应用程序配置 CI/CD</a><code>template</code>中构建的映像创建的 。</li><li>NodePort 服务会将流量从主机上的端口 30001 路由到其路由到的 pod 内的端口 8080，从而允许您从网络访问您的应用程序。</li></ul><p>要了解有关 Kubernetes 对象的更多信息，请参阅 <a href=https://kubernetes.io/docs/home/ target=_blank>Kubernetes 文档</a>。</p><h2 id=部署并检查您的应用程序>部署并检查您的应用程序</h2><ol><li><p>在终端中，导航到 Kubernetes<code>spring-petclinic</code>并将其部署到 Kubernetes。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span>$ kubectl apply -f docker-java-kubernetes.yaml
</span></span></code></pre></div><p>您应该看到如下所示的输出，表明您的 Kubernetes 对象已成功创建。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>deployment.apps/docker-java-demo created
</span></span><span style=display:flex><span>service/service-entrypoint created
</span></span></code></pre></div></li><li><p>通过列出您的部署来确保一切正常。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl get deployments
</span></span></code></pre></div><p>您的部署应列出如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>NAME                 READY   UP-TO-DATE   AVAILABLE   AGE
</span></span><span style=display:flex><span>docker-java-demo     1/1     <span style=color:#ae81ff>1</span>            <span style=color:#ae81ff>1</span>           15s
</span></span></code></pre></div><p>这表明您在 YAML 中请求的所有 pod 均已启动并正在运行。对您的服务执行相同的检查。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl get services
</span></span></code></pre></div><p>您应该获得如下输出。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>NAME                 TYPE        CLUSTER-IP      EXTERNAL-IP   PORT<span style=color:#f92672>(</span>S<span style=color:#f92672>)</span>          AGE
</span></span><span style=display:flex><span>kubernetes           ClusterIP   10.96.0.1       &lt;none&gt;        443/TCP          23h
</span></span><span style=display:flex><span>service-entrypoint   NodePort    10.99.128.230   &lt;none&gt;        8080:30001/TCP   75s
</span></span></code></pre></div><p>除了默认<code>kubernetes</code>服务之外，您还可以看到您的<code>service-entrypoint</code>服务在端口 30001/TCP 上接受流量。</p></li><li><p>在终端中，curl 服务。请注意，此示例中未部署数据库。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>$ curl --request GET <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --url http://localhost:30001/actuator/health <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --header <span style=color:#e6db74>&#39;content-type: application/json&#39;</span>
</span></span></code></pre></div><p>您应该获得如下输出。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json><span style=display:flex><span>{<span style=color:#f92672>&#34;status&#34;</span>:<span style=color:#e6db74>&#34;UP&#34;</span>,<span style=color:#f92672>&#34;groups&#34;</span>:[<span style=color:#e6db74>&#34;liveness&#34;</span>,<span style=color:#e6db74>&#34;readiness&#34;</span>]}
</span></span></code></pre></div></li><li><p>运行以下命令来关闭您的应用程序。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl delete -f docker-java-kubernetes.yaml
</span></span></code></pre></div></li></ol><h2 id=概括-4>概括</h2><p>在本节中，您学习了如何使用 Docker Desktop 将应用程序部署到开发机器上功能齐全的 Kubernetes 环境。</p><p>相关信息：</p><ul><li><a href=https://kubernetes.io/docs/home/ target=_blank>Kubernetes 文档</a></li><li><a href=https://docs.docker.com/desktop/kubernetes/ target=_blank>使用 Docker Desktop 在 Kubernetes 上部署</a></li><li><a href=https://docs.docker.com/engine/swarm/ target=_blank>Swarm 模式概述</a></li></ul></div><footer class=post__footer><div class="post__tags tags clearfix"><svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M4 0h8s2 0 4 2l15 15s2 2 0 4L21 31s-2 2-4 0L2 16s-2-2-2-4V3s0-3 4-3m3 10a3 3 0 000-6 3 3 0 000 6"/></svg><ul class=tags__list><li class=tags__item><a class="tags__link btn" href=/tags/spring-boot/ rel=tag>spring-boot</a></li><li class=tags__item><a class="tags__link btn" href=/tags/docker/ rel=tag>docker</a></li></ul></div></footer></article></main><div class="authorbox clearfix"><figure class=authorbox__avatar><img alt="ChenSoul avatar" src=/images/favicon.webp class=avatar height=60 width=60></figure><div class=authorbox__header><span class=authorbox__name>About ChenSoul</span></div><div class=authorbox__description>Java, Spring Boot, Microservice, Cloud, Architecture and DevOps Tutorials</div></div><nav class="pager flex"><div class="pager__item pager__item--prev"><a class=pager__link href=/posts/2024/07/08/minions-in-minikube-a-kubernetes-intro-for-java-de/ rel=prev><span class=pager__subtitle>«&#8201;Previous</span><p class=pager__title>[译]Minikube 中的 Minions - 面向 Java 开发人员的 Kubernetes 简介</p></a></div><div class="pager__item pager__item--next"><a class=pager__link href=/posts/2024/07/09/install-docker/ rel=next><span class=pager__subtitle>Next&#8201;»</span><p class=pager__title>Docker安装和配置</p></a></div></nav></div></div><footer class=footer><div class="container footer__container flex"><div class=footer__links><a class=footer__link href=/tools/>Tools</a> | <a class=footer__link href=/tutorials/>Tutorials</a> | <a class=footer__link href=/about/>About</a></div><div class=footer__copyright>&copy; 2025 ChenSoul.
<span class=footer__copyright-credits>Generated with <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> and <a href=https://github.com/chensoul/mainroad/ rel="nofollow noopener" target=_blank>Mainroad</a> theme.</span></div></div><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script></footer><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/MathJax.js?config=TeX-AMS-MML_HTMLorMML" async></script><script>"use strict";(function(t){var i=t.querySelector(".menu__btn"),o=t.querySelector(".menu__list");function a(){o.classList.toggle("menu__list--active"),o.classList.toggle("menu__list--transition"),this.classList.toggle("menu__btn--active"),this.setAttribute("aria-expanded",this.getAttribute("aria-expanded")==="true"?"false":"true")}function r(){this.classList.remove("menu__list--transition")}i&&o&&(i.addEventListener("click",a,!1),o.addEventListener("transitionend",r,!1))})(document,window)</script></div><script defer src=https://umami.chensoul.cc/random-string.js data-website-id=1e07d36d-bec3-4ba6-9459-876b1ac3bbe7></script></body></html>