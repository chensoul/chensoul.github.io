<!doctype html><html lang=en-US prefix="og: http://ogp.me/ns#"><head><meta charset=utf-8><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="今天做了什么：

雪崩问题
Spring Cloud微服务集成 Sentinel
扩展 Sentinel 集成 OpenFeign，实现自动降级

雪崩问题
1、什么是雪崩问题？"><title>2024-01-02｜雪崩问题、Spring Cloud微服务集成 Sentinel | ChenSoul</title><link rel=canonical href=https://blog.chensoul.cc/posts/2024/01/02/til/><link rel=preconnect href=https://fonts.font.im><link rel=preconnect href=https://fonts.loli.net crossorigin><link href="https://fonts.loli.net/css2?family=Roboto+Slab:wght@400;500;700&display=swap" rel=stylesheet><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://blog.chensoul.cc/images/favicon.webp"><meta name=twitter:title content="2024-01-02｜雪崩问题、Spring Cloud微服务集成 Sentinel"><meta name=twitter:description content="今天做了什么：
雪崩问题 Spring Cloud微服务集成 Sentinel 扩展 Sentinel 集成 OpenFeign，实现自动降级 雪崩问题 1、什么是雪崩问题？"><meta name=twitter:creator content="@ichensoul"><meta property="og:locale" content="en_US"><meta property="og:site_name" content="chensoul"><meta property="og:url" content="https://blog.chensoul.cc/posts/2024/01/02/til/"><meta property="og:site_name" content="ChenSoul"><meta property="og:title" content="2024-01-02｜雪崩问题、Spring Cloud微服务集成 Sentinel"><meta property="og:description" content="今天做了什么：
雪崩问题 Spring Cloud微服务集成 Sentinel 扩展 Sentinel 集成 OpenFeign，实现自动降级 雪崩问题 1、什么是雪崩问题？"><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-01-02T00:00:00+00:00"><meta property="article:modified_time" content="2024-01-02T00:00:00+00:00"><meta property="article:tag" content="Spring-Cloud"><meta property="og:image" content="https://blog.chensoul.cc/images/favicon.webp"><meta itemprop=name content="2024-01-02｜雪崩问题、Spring Cloud微服务集成 Sentinel"><meta itemprop=description content="今天做了什么：
雪崩问题 Spring Cloud微服务集成 Sentinel 扩展 Sentinel 集成 OpenFeign，实现自动降级 雪崩问题 1、什么是雪崩问题？"><meta itemprop=datePublished content="2024-01-02T00:00:00+00:00"><meta itemprop=dateModified content="2024-01-02T00:00:00+00:00"><meta itemprop=wordCount content="889"><meta itemprop=image content="https://blog.chensoul.cc/images/favicon.webp"><meta itemprop=keywords content="Spring-Cloud"><link rel=stylesheet href=https://cdnjs.loli.net/ajax/libs/font-awesome/6.4.0/css/all.min.css media=all><link rel=stylesheet href=/main.min.css type=text/css media=all><link rel="shortcut icon" href=/favicon.ico type=image/x-icon><script type=application/ld+json>{"@context":"https://schema.org","@graph":[{"@type":"TechArticle","name":"2024-01-02｜雪崩问题、Spring Cloud微服务集成 Sentinel","headline":"2024-01-02｜雪崩问题、Spring Cloud微服务集成 Sentinel","inLanguage":"en-US","url":"https://blog.chensoul.cc/posts/2024/01/02/til/","description":"\u003cp\u003e今天做了什么：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e雪崩问题\u003c/li\u003e\n\u003cli\u003eSpring Cloud微服务集成 Sentinel\u003c/li\u003e\n\u003cli\u003e扩展 Sentinel 集成 OpenFeign，实现自动降级\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"雪崩问题\"\u003e雪崩问题\u003c/h2\u003e\n\u003cp\u003e1、什么是雪崩问题？\u003c/p\u003e","wordCount":"889","keywords":["spring-cloud"],"datePublished":"2024-01-02T00:00:00Z","dateModified":"2024-01-02T00:00:00Z","author":{"@type":"Person","name":"chensoul"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.chensoul.cc/posts/2024/01/02/til/"},"publisher":{"@type":"Organization","name":"chensoul","url":"https://blog.chensoul.cc/posts/2024/01/02/til/"}},{"@context":"https://schema.org","@type":"Organization","name":"chensoul","url":"https://blog.chensoul.cc/","sameAs":["https://x.com/ichensoul","https://github.com/chensoul","https://www.linkedin.com/in/","https://www.youtube.com/@chensoul","https://t.me/chensouls"]}]}</script><script defer src=https://umami.chensoul.cc/random-string.js data-website-id=4718b57b-c900-4a61-a7af-0fe1fb1d50ce></script></head><body class="home blog post-layout-one-column"><button onclick=topFunction() id=scrollTopBtn title="Go to top">
<i class="fa-solid fa-arrow-up"></i></button><div id=header-top class=header-bar-wrap></div><div id=page class=site><a class="skip-link screen-reader-text" href=#content>Skip to content</a><header id=masthead class="site-header clearfix" role=banner><div class="header-main container clearfix"><div id=logo class="site-branding clearfix"><h1 class=site-title><a href=/ title=ChenSoul rel=home>ChenSoul</a></h1><p class=site-description>Java, Spring Boot, Microservice, Cloud, Architecture and DevOps Tutorials</p></div><div class="header-widgets clearfix"><aside id=search-2 class="header-widget widget_search"><form role=search method=get class=search-form onsubmit="return searchSite(event)"><label><span class=screen-reader-text>Search for:</span>
<input type=search class=search-field placeholder="Enter search keyword" name=query id=query title="Enter search keyword">
</label><button type=submit class=search-submit title=Search> <span class=genericon-search></span>
<span class=screen-reader-text>Search</span></button></form></aside></div></div><div id=main-navigation-wrap class=primary-navigation-wrap><nav id=main-navigation class="primary-navigation navigation container clearfix" role=navigation><ul id=menu-home class=main-navigation-menu><li class="menu-item menu-item-type-custom menu-item-object-custom
current-menu-item current_page_item menu-item-home"><a href=/>Home</a></li><li class="menu-item menu-item-type-taxonomy menu-item-object-category"><a href=/categories/spring-boot/>Spring Boot</a></li><li class="menu-item menu-item-type-taxonomy menu-item-object-category"><a href=/categories/architecture/>Architecture</a></li><li class="menu-item menu-item-type-taxonomy menu-item-object-category"><a href=/categories/microservice/>Microservice</a></li><li class="menu-item menu-item-type-taxonomy menu-item-object-category"><a href=/categories/kubernetes/>Kubernetes</a></li><li class="menu-item menu-item-type-taxonomy menu-item-object-category
menu-item-has-children"><a href=/tutorials/>Tutorials</a><ul class=sub-menu><li class="menu-item menu-item-type-taxonomy menu-item-object-category"><a href=/spring-boot-tutorials/>Spring Boot Tutorials</a></li><li class="menu-item menu-item-type-taxonomy menu-item-object-category"><a href=/microservice-tutorials/>Microservice Tutorials</a></li><li class="menu-item menu-item-type-taxonomy menu-item-object-category"><a href=/kubernetes-tutorials/>Kubernetes Tutorials</a></li></ul></li><li class="menu-item menu-item-type-post_type menu-item-object-page"><a href=https://github.com/chensoul target=_blank>About Me</a></li></ul></nav></div></header><div id=content class="site-content container clearfix"><section id=primary class="content-archive content-area post-content-area"><main id=main class=site-main role=main><article class="post type-post"><div class=post-inner-content><header class=entry-header><h2 class=entry-title><a href=https://blog.chensoul.cc/posts/2024/01/02/til/ rel=bookmark title="2024-01-02｜雪崩问题、Spring Cloud微服务集成 Sentinel">2024-01-02｜雪崩问题、Spring Cloud微服务集成 Sentinel</a></h2><div class=entry-meta><span class=meta-date><time class="entry-date published" datetime=2024-01-02T00:00:00>2024-01-02
</time></span><span class=meta-author><span class="author vcard">chensoul</span>
</span><span class="tagcloud post-tags"><i class="fa fa-tags"></i>&nbsp;
<a class="tag-cloud-link widget__link widget__link--taglist" href=/tags/spring-cloud/ title=spring-cloud>spring-cloud</a></span></div></header><div class=entry-content><p>今天做了什么：</p><ul><li>雪崩问题</li><li>Spring Cloud微服务集成 Sentinel</li><li>扩展 Sentinel 集成 OpenFeign，实现自动降级</li></ul><h2 id=雪崩问题>雪崩问题</h2><p>1、什么是雪崩问题？</p><p>雪崩问题（Avalanche Effect）是指在分布式系统中，当一个节点或服务出现故障或不可用时，其影响会扩散到其他节点或服务，导致级联故障的现象。这种现象类似于雪崩，一旦开始，会不断放大和蔓延，最终导致整个系统崩溃。</p><p>雪崩问题的主要原因是系统中的节点或服务之间存在过度依赖、高度耦合，以及缺乏容错机制。当一个节点或服务出现故障时，由于其他节点或服务无法及时处理或适应，故障会不断传播，最终导致整个系统的崩溃。</p><p>2、如何解决雪崩问题？</p><ul><li>超时处理：在请求其他节点或服务时，设置适当的超时时间。如果在规定的时间内未收到响应，可以认为请求失败，并进行相应的处理，如返回默认值或错误信息。超时处理可以防止因等待过长的响应时间导致的请求堆积和资源浪费。</li><li>线程隔离：通过将不同的请求在不同的线程中执行，可以避免因某个请求的执行时间过长而影响其他请求的处理。线程隔离可以通过线程池或独立的线程来实现。每个请求都在独立的线程中执行，发生故障或异常时只会影响当前请求，而不会影响整个系统的稳定性。</li><li>降级熔断：当系统压力过大或出现故障时，可以通过降级熔断机制暂时关闭或减少对某些功能或服务的请求，以保护核心功能的稳定性。例如，当请求某个服务的失败率超过阈值时，可以自动触发熔断机制，暂时停止对该服务的请求，并返回一个默认值或错误信息。</li><li>流量控制：通过实施流量控制策略，限制对系统的并发请求数量。可以使用令牌桶算法或漏桶算法等进行流量控制。这可以避免过多的请求集中在某个节点或服务上，导致其负载过重，进而引发雪崩效应。</li><li>负载均衡：使用负载均衡器将请求分发到多个节点或服务上，以均衡系统的负载。负载均衡可以基于不同的算法，如轮询、随机、加权轮询等。通过负载均衡，可以避免单一节点或服务承受过大的压力，从而减少故障和雪崩的风险。</li></ul><p>这些方法可以单独或组合使用，具体的选择和实施取决于系统的需求和架构。此外，还需要定期进行系统性能评估和压力测试，以便及时发现和解决潜在的雪崩问题，并不断优化系统的可靠性和稳定性。</p><h2 id=spring-cloud-微服务集成-sentinel>Spring Cloud 微服务集成 Sentinel</h2><p>添加 maven 依赖：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;groupId&gt;</span>com.alibaba.cloud<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;artifactId&gt;</span>spring-cloud-starter-alibaba-sentinel<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>添加配置文件：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-properties data-lang=properties><span style=display:flex><span><span style=color:#a6e22e>spring.cloud.sentinel.transport.dashboard</span><span style=color:#f92672>=</span><span style=color:#e6db74>localhost:8080</span>
</span></span></code></pre></div><p>配置文件打开 Sentinel 对 Feign 的支持：<code>feign.sentinel.enabled=true</code></p><p>加入 <code>spring-cloud-starter-openfeign</code> 依赖使 Sentinel starter 中的自动化配置类生效：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;groupId&gt;</span>org.springframework.cloud<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;artifactId&gt;</span>spring-cloud-starter-openfeign<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>配置 RestTemplate 支持 sentinel：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@SentinelRestTemplate</span>(
</span></span><span style=display:flex><span>    blockHandler <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;handleBlock&#34;</span>,
</span></span><span style=display:flex><span>    fallback <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;handleFallback&#34;</span>,
</span></span><span style=display:flex><span>    fallbackClass <span style=color:#f92672>=</span> SentinelFallbackBlockHandler.<span style=color:#a6e22e>class</span>,
</span></span><span style=display:flex><span>    blockHandlerClass <span style=color:#f92672>=</span> SentinelFallbackBlockHandler.<span style=color:#a6e22e>class</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> RestTemplate <span style=color:#a6e22e>restTemplate</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> RestTemplate();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>SentinelFallbackBlockHandler 类：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SentinelFallbackBlockHandler</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> ClientHttpResponse <span style=color:#a6e22e>handleBlock</span>(HttpRequest request, <span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> body, ClientHttpRequestExecution execution, BlockException exception) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> SentinelClientHttpResponse();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> ClientHttpResponse <span style=color:#a6e22e>handleFallback</span>(HttpRequest request, <span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> body, ClientHttpRequestExecution execution, BlockException ex) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> SentinelClientHttpResponse();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=扩展-sentinel-集成-openfeign实现自动降级>扩展 Sentinel 集成 OpenFeign，实现自动降级</h2><p>1、扩展 BlockExceptionHandler，实现 JSON 输出</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Slf4j</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RequiredArgsConstructor</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>JsonBlockExceptionHandler</span> <span style=color:#66d9ef>implements</span> BlockExceptionHandler {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> ObjectMapper objectMapper;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>handle</span>(HttpServletRequest request, HttpServletResponse response, BlockException e) <span style=color:#66d9ef>throws</span> Exception {
</span></span><span style=display:flex><span>        log.<span style=color:#a6e22e>error</span>(<span style=color:#e6db74>&#34;Sentinel fallback , resource is {}&#34;</span>, e.<span style=color:#a6e22e>getRule</span>().<span style=color:#a6e22e>getResource</span>(), e);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        response.<span style=color:#a6e22e>setContentType</span>(MediaType.<span style=color:#a6e22e>APPLICATION_JSON_VALUE</span>);
</span></span><span style=display:flex><span>        response.<span style=color:#a6e22e>setStatus</span>(HttpStatus.<span style=color:#a6e22e>TOO_MANY_REQUESTS</span>.<span style=color:#a6e22e>value</span>());
</span></span><span style=display:flex><span>        response.<span style=color:#a6e22e>getWriter</span>().<span style=color:#a6e22e>print</span>(objectMapper.<span style=color:#a6e22e>writeValueAsString</span>(Result.<span style=color:#a6e22e>error</span>(ResultCode.<span style=color:#a6e22e>TOO_MANY_REQUESTS</span>)));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>2、重写 SentinelInvocationHandler，实现自动降级处理</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Slf4j</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>AutoFallbackSentinelInvocationHandler</span> <span style=color:#66d9ef>implements</span> InvocationHandler {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String EQUALS <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;equals&#34;</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String HASH_CODE <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;hashCode&#34;</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String TO_STRING <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;toString&#34;</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> Target<span style=color:#f92672>&lt;?&gt;</span> target;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> Map<span style=color:#f92672>&lt;</span>Method, InvocationHandlerFactory.<span style=color:#a6e22e>MethodHandler</span><span style=color:#f92672>&gt;</span> dispatch;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> FallbackFactory<span style=color:#f92672>&lt;?&gt;</span> fallbackFactory;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Map<span style=color:#f92672>&lt;</span>Method, Method<span style=color:#f92672>&gt;</span> fallbackMethodMap;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    AutoFallbackSentinelInvocationHandler(Target<span style=color:#f92672>&lt;?&gt;</span> target, Map<span style=color:#f92672>&lt;</span>Method, InvocationHandlerFactory.<span style=color:#a6e22e>MethodHandler</span><span style=color:#f92672>&gt;</span> dispatch,
</span></span><span style=display:flex><span>                                          FallbackFactory<span style=color:#f92672>&lt;?&gt;</span> fallbackFactory) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>target</span> <span style=color:#f92672>=</span> checkNotNull(target, <span style=color:#e6db74>&#34;target&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>dispatch</span> <span style=color:#f92672>=</span> checkNotNull(dispatch, <span style=color:#e6db74>&#34;dispatch&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>fallbackFactory</span> <span style=color:#f92672>=</span> fallbackFactory;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>fallbackMethodMap</span> <span style=color:#f92672>=</span> toFallbackMethod(dispatch);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    AutoFallbackSentinelInvocationHandler(Target<span style=color:#f92672>&lt;?&gt;</span> target, Map<span style=color:#f92672>&lt;</span>Method, InvocationHandlerFactory.<span style=color:#a6e22e>MethodHandler</span><span style=color:#f92672>&gt;</span> dispatch) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>target</span> <span style=color:#f92672>=</span> checkNotNull(target, <span style=color:#e6db74>&#34;target&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>dispatch</span> <span style=color:#f92672>=</span> checkNotNull(dispatch, <span style=color:#e6db74>&#34;dispatch&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Object <span style=color:#a6e22e>invoke</span>(<span style=color:#66d9ef>final</span> Object proxy, <span style=color:#66d9ef>final</span> Method method, <span style=color:#66d9ef>final</span> Object<span style=color:#f92672>[]</span> args) <span style=color:#66d9ef>throws</span> Throwable {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (EQUALS.<span style=color:#a6e22e>equals</span>(method.<span style=color:#a6e22e>getName</span>())) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>                Object otherHandler <span style=color:#f92672>=</span> args.<span style=color:#a6e22e>length</span> <span style=color:#f92672>&gt;</span> 0 <span style=color:#f92672>&amp;&amp;</span> args<span style=color:#f92672>[</span>0<span style=color:#f92672>]</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>?</span> Proxy.<span style=color:#a6e22e>getInvocationHandler</span>(args<span style=color:#f92672>[</span>0<span style=color:#f92672>]</span>) : <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> equals(otherHandler);
</span></span><span style=display:flex><span>            } <span style=color:#66d9ef>catch</span> (IllegalArgumentException e) {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (HASH_CODE.<span style=color:#a6e22e>equals</span>(method.<span style=color:#a6e22e>getName</span>())) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> hashCode();
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (TO_STRING.<span style=color:#a6e22e>equals</span>(method.<span style=color:#a6e22e>getName</span>())) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> toString();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        Object result;
</span></span><span style=display:flex><span>        InvocationHandlerFactory.<span style=color:#a6e22e>MethodHandler</span> methodHandler <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>dispatch</span>.<span style=color:#a6e22e>get</span>(method);
</span></span><span style=display:flex><span>        <span style=color:#f92672>/</span> only handle by HardCodedTarget
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>if</span> (target <span style=color:#66d9ef>instanceof</span> Target.<span style=color:#a6e22e>HardCodedTarget</span>) {
</span></span><span style=display:flex><span>            Target.<span style=color:#a6e22e>HardCodedTarget</span><span style=color:#f92672>&lt;?&gt;</span> hardCodedTarget <span style=color:#f92672>=</span> (Target.<span style=color:#a6e22e>HardCodedTarget</span>) target;
</span></span><span style=display:flex><span>            MethodMetadata methodMetadata <span style=color:#f92672>=</span> SentinelContractHolder.<span style=color:#a6e22e>METADATA_MAP</span>
</span></span><span style=display:flex><span>                .<span style=color:#a6e22e>get</span>(hardCodedTarget.<span style=color:#a6e22e>type</span>().<span style=color:#a6e22e>getName</span>() <span style=color:#f92672>+</span> Feign.<span style=color:#a6e22e>configKey</span>(hardCodedTarget.<span style=color:#a6e22e>type</span>(), method));
</span></span><span style=display:flex><span>            <span style=color:#f92672>/</span> resource <span style=color:#66d9ef>default</span> is HttpMethod:protocol:<span style=color:#75715e>//url</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (methodMetadata <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>                result <span style=color:#f92672>=</span> methodHandler.<span style=color:#a6e22e>invoke</span>(args);
</span></span><span style=display:flex><span>            } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>                String resourceName <span style=color:#f92672>=</span> methodMetadata.<span style=color:#a6e22e>template</span>().<span style=color:#a6e22e>method</span>().<span style=color:#a6e22e>toUpperCase</span>() <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;:&#39;</span> <span style=color:#f92672>+</span> hardCodedTarget.<span style=color:#a6e22e>url</span>()
</span></span><span style=display:flex><span>                    <span style=color:#f92672>+</span> methodMetadata.<span style=color:#a6e22e>template</span>().<span style=color:#a6e22e>path</span>();
</span></span><span style=display:flex><span>                Entry entry <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>                    ContextUtil.<span style=color:#a6e22e>enter</span>(resourceName);
</span></span><span style=display:flex><span>                    entry <span style=color:#f92672>=</span> SphU.<span style=color:#a6e22e>entry</span>(resourceName, EntryType.<span style=color:#a6e22e>OUT</span>, 1, args);
</span></span><span style=display:flex><span>                    result <span style=color:#f92672>=</span> methodHandler.<span style=color:#a6e22e>invoke</span>(args);
</span></span><span style=display:flex><span>                } <span style=color:#66d9ef>catch</span> (Throwable ex) {
</span></span><span style=display:flex><span>                    <span style=color:#f92672>/</span> fallback handle
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>if</span> (<span style=color:#f92672>!</span>BlockException.<span style=color:#a6e22e>isBlockException</span>(ex)) {
</span></span><span style=display:flex><span>                        Tracer.<span style=color:#a6e22e>trace</span>(ex);
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span> (fallbackFactory <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>return</span> fallbackMethodMap.<span style=color:#a6e22e>get</span>(method).<span style=color:#a6e22e>invoke</span>(fallbackFactory.<span style=color:#a6e22e>create</span>(ex), args);
</span></span><span style=display:flex><span>                        } <span style=color:#66d9ef>catch</span> (IllegalAccessException e) {
</span></span><span style=display:flex><span>                            <span style=color:#f92672>/</span> shouldn<span style=color:#960050;background-color:#1e0010>&#39;</span>t happen as method is <span style=color:#66d9ef>public</span> due to being an
</span></span><span style=display:flex><span>                            <span style=color:#f92672>/</span> <span style=color:#66d9ef>interface</span>
</span></span><span style=display:flex><span>                            <span style=color:#a6e22e>throw</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>AssertionError</span>(e);
</span></span><span style=display:flex><span>                        } <span style=color:#66d9ef>catch</span> (InvocationTargetException e) {
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> AssertionError(e.<span style=color:#a6e22e>getCause</span>());
</span></span><span style=display:flex><span>                        }
</span></span><span style=display:flex><span>                    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>                        <span style=color:#f92672>/</span> 若是Result类型 并且不包含<span style=color:#a6e22e>@FeignRetry</span> 执行自动降级返回
</span></span><span style=display:flex><span>                        FeignRetry feignRetry <span style=color:#f92672>=</span> AnnotationUtils.<span style=color:#a6e22e>findAnnotation</span>(method, FeignRetry.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>if</span> (Result.<span style=color:#a6e22e>class</span> <span style=color:#f92672>==</span> method.<span style=color:#a6e22e>getReturnType</span>() <span style=color:#f92672>&amp;&amp;</span> Objects.<span style=color:#a6e22e>isNull</span>(feignRetry)) {
</span></span><span style=display:flex><span>                            log.<span style=color:#a6e22e>error</span>(<span style=color:#e6db74>&#34;服务调用异常&#34;</span>, ex);
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>return</span> Result.<span style=color:#a6e22e>error</span>(ResultCode.<span style=color:#a6e22e>INNER_SERVICE_ERROR</span>, ex.<span style=color:#a6e22e>getMessage</span>());
</span></span><span style=display:flex><span>                        } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>throw</span> ex;
</span></span><span style=display:flex><span>                        }
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>                } <span style=color:#66d9ef>finally</span> {
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span> (entry <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>                        entry.<span style=color:#a6e22e>exit</span>(1, args);
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>                    ContextUtil.<span style=color:#a6e22e>exit</span>();
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>            <span style=color:#f92672>/</span> other target type using <span style=color:#66d9ef>default</span> strategy
</span></span><span style=display:flex><span>            result <span style=color:#f92672>=</span> methodHandler.<span style=color:#a6e22e>invoke</span>(args);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> result;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>equals</span>(Object obj) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (obj <span style=color:#66d9ef>instanceof</span> SentinelInvocationHandler) {
</span></span><span style=display:flex><span>            AutoFallbackSentinelInvocationHandler other <span style=color:#f92672>=</span> (AutoFallbackSentinelInvocationHandler) obj;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> target.<span style=color:#a6e22e>equals</span>(other.<span style=color:#a6e22e>target</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>hashCode</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> target.<span style=color:#a6e22e>hashCode</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>toString</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> target.<span style=color:#a6e22e>toString</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>static</span> Map<span style=color:#f92672>&lt;</span>Method, Method<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>toFallbackMethod</span>(Map<span style=color:#f92672>&lt;</span>Method, InvocationHandlerFactory.<span style=color:#a6e22e>MethodHandler</span><span style=color:#f92672>&gt;</span> dispatch) {
</span></span><span style=display:flex><span>        Map<span style=color:#f92672>&lt;</span>Method, Method<span style=color:#f92672>&gt;</span> result <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> LinkedHashMap<span style=color:#f92672>&lt;&gt;</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> (Method method : dispatch.<span style=color:#a6e22e>keySet</span>()) {
</span></span><span style=display:flex><span>            method.<span style=color:#a6e22e>setAccessible</span>(<span style=color:#66d9ef>true</span>);
</span></span><span style=display:flex><span>            result.<span style=color:#a6e22e>put</span>(method, method);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> result;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>3、重写 SentinelFeign，支持自动降级注入</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>AutoFallbackSentinelFeign</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>AutoFallbackSentinelFeign</span>() {
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> Builder <span style=color:#a6e22e>builder</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> Builder();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Builder</span> <span style=color:#66d9ef>extends</span> Feign.<span style=color:#a6e22e>Builder</span> <span style=color:#66d9ef>implements</span> ApplicationContextAware {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>private</span> Contract contract <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Contract.<span style=color:#a6e22e>Default</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>private</span> ApplicationContext applicationContext;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>private</span> FeignContext feignContext;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> Feign.<span style=color:#a6e22e>Builder</span> <span style=color:#a6e22e>invocationHandlerFactory</span>(InvocationHandlerFactory invocationHandlerFactory) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> UnsupportedOperationException();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> Builder <span style=color:#a6e22e>contract</span>(Contract contract) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>contract</span> <span style=color:#f92672>=</span> contract;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> Feign <span style=color:#a6e22e>build</span>() {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>super</span>.<span style=color:#a6e22e>invocationHandlerFactory</span>(<span style=color:#66d9ef>new</span> InvocationHandlerFactory() {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>public</span> InvocationHandler <span style=color:#a6e22e>create</span>(Target target, Map<span style=color:#f92672>&lt;</span>Method, MethodHandler<span style=color:#f92672>&gt;</span> dispatch) {
</span></span><span style=display:flex><span>                    <span style=color:#f92672>/</span> 查找 FeignClient 上的 降级策略
</span></span><span style=display:flex><span>                    FeignClient feignClient <span style=color:#f92672>=</span> AnnotationUtils.<span style=color:#a6e22e>findAnnotation</span>(target.<span style=color:#a6e22e>type</span>(), FeignClient.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span>                    Class<span style=color:#f92672>&lt;?&gt;</span> fallback <span style=color:#f92672>=</span> feignClient.<span style=color:#a6e22e>fallback</span>();
</span></span><span style=display:flex><span>                    Class<span style=color:#f92672>&lt;?&gt;</span> fallbackFactory <span style=color:#f92672>=</span> feignClient.<span style=color:#a6e22e>fallbackFactory</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                    String beanName <span style=color:#f92672>=</span> feignClient.<span style=color:#a6e22e>contextId</span>();
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>StringUtils.<span style=color:#a6e22e>hasText</span>(beanName)) {
</span></span><span style=display:flex><span>                        beanName <span style=color:#f92672>=</span> feignClient.<span style=color:#a6e22e>name</span>();
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                    Object fallbackInstance;
</span></span><span style=display:flex><span>                    FallbackFactory<span style=color:#f92672>&lt;?&gt;</span> fallbackFactoryInstance;
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>void</span>.<span style=color:#a6e22e>class</span> <span style=color:#f92672>!=</span> fallback) {
</span></span><span style=display:flex><span>                        fallbackInstance <span style=color:#f92672>=</span> getFromContext(beanName, <span style=color:#e6db74>&#34;fallback&#34;</span>, fallback, target.<span style=color:#a6e22e>type</span>());
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> AutoFallbackSentinelInvocationHandler(target, dispatch,
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>new</span> FallbackFactory.<span style=color:#a6e22e>Default</span>(fallbackInstance));
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>void</span>.<span style=color:#a6e22e>class</span> <span style=color:#f92672>!=</span> fallbackFactory) {
</span></span><span style=display:flex><span>                        <span style=color:#f92672>/</span>针对 hystrix fallbackFactory 特殊处理
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>                            fallbackFactoryInstance <span style=color:#f92672>=</span> (FallbackFactory<span style=color:#f92672>&lt;?&gt;</span>) getFromContext(beanName, <span style=color:#e6db74>&#34;fallbackFactory&#34;</span>,
</span></span><span style=display:flex><span>                                fallbackFactory, FallbackFactory.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span>                        } <span style=color:#66d9ef>catch</span> (Exception e) {
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> AutoFallbackSentinelInvocationHandler(target, dispatch);
</span></span><span style=display:flex><span>                        }
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> AutoFallbackSentinelInvocationHandler(target, dispatch, fallbackFactoryInstance);
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> AutoFallbackSentinelInvocationHandler(target, dispatch);
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>private</span> Object <span style=color:#a6e22e>getFromContext</span>(String name, String type, Class<span style=color:#f92672>&lt;?&gt;</span> fallbackType, Class<span style=color:#f92672>&lt;?&gt;</span> targetType) {
</span></span><span style=display:flex><span>                    Object fallbackInstance <span style=color:#f92672>=</span> feignContext.<span style=color:#a6e22e>getInstance</span>(name, fallbackType);
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span> (fallbackInstance <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalStateException(String
</span></span><span style=display:flex><span>                            .<span style=color:#a6e22e>format</span>(<span style=color:#e6db74>&#34;No %s instance of type %s found for loadbalance client %s&#34;</span>, type, fallbackType, name));
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>targetType.<span style=color:#a6e22e>isAssignableFrom</span>(fallbackType)) {
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalStateException(String.<span style=color:#a6e22e>format</span>(
</span></span><span style=display:flex><span>                            <span style=color:#e6db74>&#34;Incompatible %s instance. Fallback/fallbackFactory of type %s is not assignable to %s for loadbalance client %s&#34;</span>,
</span></span><span style=display:flex><span>                            type, fallbackType, targetType, name));
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>return</span> fallbackInstance;
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>super</span>.<span style=color:#a6e22e>contract</span>(<span style=color:#66d9ef>new</span> SentinelContractHolder(contract));
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>super</span>.<span style=color:#a6e22e>build</span>();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>private</span> Object <span style=color:#a6e22e>getFieldValue</span>(Object instance, String fieldName) {
</span></span><span style=display:flex><span>            Field field <span style=color:#f92672>=</span> ReflectionUtils.<span style=color:#a6e22e>findField</span>(instance.<span style=color:#a6e22e>getClass</span>(), fieldName);
</span></span><span style=display:flex><span>            field.<span style=color:#a6e22e>setAccessible</span>(<span style=color:#66d9ef>true</span>);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> field.<span style=color:#a6e22e>get</span>(instance);
</span></span><span style=display:flex><span>            } <span style=color:#66d9ef>catch</span> (IllegalAccessException e) {
</span></span><span style=display:flex><span>                <span style=color:#f92672>/</span> ignore
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setApplicationContext</span>(ApplicationContext applicationContext) <span style=color:#66d9ef>throws</span> BeansException {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>applicationContext</span> <span style=color:#f92672>=</span> applicationContext;
</span></span><span style=display:flex><span>            feignContext <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>applicationContext</span>.<span style=color:#a6e22e>getBean</span>(FeignContext.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>最后，再进行自动装配：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@AutoConfiguration</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@AutoConfigureBefore</span>(SentinelFeignAutoConfiguration.<span style=color:#a6e22e>class</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>@ConditionalOnProperty</span>(name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;feign.sentinel.enabled&#34;</span>, havingValue <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;true&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SentinelFeignConfiguration</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Scope</span>(<span style=color:#e6db74>&#34;prototype&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@ConditionalOnMissingBean</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Feign.<span style=color:#a6e22e>Builder</span> <span style=color:#a6e22e>autoFallbackSentinelFeignBuilder</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> AutoFallbackSentinelFeign.<span style=color:#a6e22e>builder</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@ConditionalOnMissingBean</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> BlockExceptionHandler <span style=color:#a6e22e>blockExceptionHandler</span>(ObjectMapper objectMapper) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> JsonBlockExceptionHandler(objectMapper);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@ConditionalOnMissingBean</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> RequestOriginParser <span style=color:#a6e22e>requestOriginParser</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> AllowHeaderRequestOriginParser();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></div><div><div style=font-weight:700>Share this post:</div><a class=social-link-item href="https://twitter.com/intent/tweet?text=2024-01-02%ef%bd%9c%e9%9b%aa%e5%b4%a9%e9%97%ae%e9%a2%98%e3%80%81Spring%20Cloud%e5%be%ae%e6%9c%8d%e5%8a%a1%e9%9b%86%e6%88%90%20Sentinel https%3a%2f%2fblog.chensoul.cc%2fposts%2f2024%2f01%2f02%2ftil%2f" target=_blank rel="noopener noreferrer" title="Click to share on Twitter"><i class="fa-brands fa-square-twitter fa-2xl" style=color:#55acee></i>
</a><a class=social-link-item href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fblog.chensoul.cc%2fposts%2f2024%2f01%2f02%2ftil%2f&title=2024-01-02%ef%bd%9c%e9%9b%aa%e5%b4%a9%e9%97%ae%e9%a2%98%e3%80%81Spring%20Cloud%e5%be%ae%e6%9c%8d%e5%8a%a1%e9%9b%86%e6%88%90%20Sentinel" target=_blank rel="noopener noreferrer" title="Click to share on LinkedIn"><i class="fa-brands fa-linkedin fa-2xl" style=color:#007bb5></i>
</a><a class=social-link-item href="https://telegram.me/share/url?text=2024-01-02%ef%bd%9c%e9%9b%aa%e5%b4%a9%e9%97%ae%e9%a2%98%e3%80%81Spring%20Cloud%e5%be%ae%e6%9c%8d%e5%8a%a1%e9%9b%86%e6%88%90%20Sentinel&amp;url=https%3a%2f%2fblog.chensoul.cc%2fposts%2f2024%2f01%2f02%2ftil%2f" target=_blank rel="noopener noreferrer" title="Click to share on telegram"><i class="fa-brands fa-telegram fa-2xl" style=color:#007bb5></i>
</a><a class=social-link-item href="https://reddit.com/submit?url=https%3a%2f%2fblog.chensoul.cc%2fposts%2f2024%2f01%2f02%2ftil%2f&title=2024-01-02%ef%bd%9c%e9%9b%aa%e5%b4%a9%e9%97%ae%e9%a2%98%e3%80%81Spring%20Cloud%e5%be%ae%e6%9c%8d%e5%8a%a1%e9%9b%86%e6%88%90%20Sentinel" target=_blank rel="noopener noreferrer" title="Click to share on reddit"><i class="fa-brands fa-reddit fa-2xl" style=color:#007bb5></i>
</a><a class=social-link-item href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fblog.chensoul.cc%2fposts%2f2024%2f01%2f02%2ftil%2f" target=_blank rel="noopener noreferrer" title="Click to share on facebook"><i class="fa-brands fa-facebook fa-2xl" style=color:#007bb5></i>
</a><a class=social-link-item href="https://api.whatsapp.com/send?text=2024-01-02%ef%bd%9c%e9%9b%aa%e5%b4%a9%e9%97%ae%e9%a2%98%e3%80%81Spring%20Cloud%e5%be%ae%e6%9c%8d%e5%8a%a1%e9%9b%86%e6%88%90%20Sentinel%20-%20https%3a%2f%2fblog.chensoul.cc%2fposts%2f2024%2f01%2f02%2ftil%2f" target=_blank rel="noopener noreferrer" title="Click to share on whatsapp"><i class="fa-brands fa-whatsapp fa-2xl" style=color:#007bb5></i></a></div></div></article><nav class="navigation post-navigation" role=navigation><h2 class=screen-reader-text>Post navigation</h2><div class=nav-links><div class=nav-previous><a href=/posts/2024/01/03/til/ rel=next><span class=post-title>2024-01-03｜今天做了什么</span></a></div><div class=nav-next><a href=/posts/2023/12/28/til/ rel=prev><span class=post-title>2023-12-28｜今天做了什么</span></a></div></div></nav><h2>Related content</h2><ul><li><a href=/posts/2024/12/31/til/>2024年我的付费软件</a></li><li><a href=/posts/2024/12/27/til/>2024-12-27｜今天我做了什么</a></li><li><a href=/posts/2024/11/13/til/>2024-11-13｜今天我做了什么</a></li><li><a href=/posts/2024/11/07/til/>2024-11-07｜今天我做了什么</a></li><li><a href=/posts/2024/11/06/til/>2024-11-06｜今天我做了什么</a></li><li><a href=/posts/2024/11/05/til/>2024-11-05｜今天我做了什么</a></li><li><a href=/posts/2024/11/04/sivalabs-blog-posts/>2024-11-04｜SivaLabs博客文章</a></li><li><a href=/posts/2024/02/20/til/>2024-02-20｜RateLimitAspect请求限流、调整spring-cloud-examples项目结构</a></li><li><a href=/posts/2024/02/19/til/>2024-02-19｜foodie-cloud集成Sharding Sphere实现读写分离</a></li><li><a href=/posts/2024/02/18/til/>2024-02-18｜NewRelice应用性能监控、6个Diagrams工具、foodie-food测试</a></li></ul></main></section></div><div id=footer class=footer-wrap><footer id=colophon class="site-footer container clearfix" role=contentinfo><div id=footer-text class=site-info><span class=credit-link>Made with 🩷
by <a href=/ target=_blank rel="noopener noreferrer">ChenSoul</a></span></div></footer></div></div><script type=text/javascript src=/main.min.js></script></body></html>