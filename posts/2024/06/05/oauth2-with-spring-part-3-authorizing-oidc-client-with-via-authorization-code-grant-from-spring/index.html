<!doctype html><html class=no-js lang=zh-cn><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>[译]OAuth2 with Spring 第3部分：使用Spring授权服务器授予authorization_code OIDC客户端 - Java、Spring、Spring Boot、MicroServices、Architecture、Kubernetes、DevOps</title><script>(function(e,t){e[t]=e[t].replace("no-js","js")})(document.documentElement,"className")</script><meta name=description content><meta property="og:title" content="[译]OAuth2 with Spring 第3部分：使用Spring授权服务器授予authorization_code OIDC客户端"><meta property="og:description" content="Java、Spring、Spring Boot、MicroServices、Architecture、Kubernetes、DevOps"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.chensoul.cc/posts/2024/06/05/oauth2-with-spring-part-3-authorizing-oidc-client-with-via-authorization-code-grant-from-spring/"><meta property="og:site_name" content="ChenSoul Blog"><meta property="og:image" content><meta itemprop=name content="[译]OAuth2 with Spring 第3部分：使用Spring授权服务器授予authorization_code OIDC客户端"><meta itemprop=description content="原文地址：https://mainul35.medium.com/oauth2-with-spring-part-3-authorizing-oidc-client-with-via-authorization-code-grant-from-spring-67769f9dd68a
在上一篇文章中，我们讨论了使用 client_credential 的 OAuth2 授权服务器配置。在本文中，我们将讨论使用 authorization_code 授予类型的授权服务器配置。此授权流程将有一个 OIDC 客户端，它将通过使用授权码进行请求来获取 JWT 令牌。"><meta itemprop=datePublished content="2024-06-05T00:00:00+00:00"><meta itemprop=dateModified content="2024-06-05T00:00:00+00:00"><meta itemprop=wordCount content="778"><meta itemprop=keywords content="Oauth2,Java"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="[译]OAuth2 with Spring 第3部分：使用Spring授权服务器授予authorization_code OIDC客户端"><meta name=twitter:description content="Java、Spring、Spring Boot、MicroServices、Architecture、Kubernetes、DevOps"><meta name=twitter:image content><link rel=preconnect href=//fonts.loli.net crossorigin><link rel=dns-prefetch href=//fonts.loli.net><link rel=stylesheet href="https://fonts.loli.net/css?family=Open+Sans:400,400i,700"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css integrity="sha512-2SwdPD6INVrV/lHTZbO2nodKhrnDdJK9/kg2XD1r9uGqPo1cUbujc+IYdlYdEErWNu69gVcYgdxlmVmzTWnetw==" crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=/css/style.css><link rel="shortcut icon" href=/favicon.ico></head><body class=body><div class="container container--outer"><header class=header><div class="container header__container"><div class="logo logo--mixed"><a class=logo__link href=/ title="ChenSoul Blog" rel=home><div class="logo__item logo__imagebox"><img class=logo__img src=/logo.svg loading=lazy alt="Site logo" width=60 height=60></div><div class="logo__item logo__text"><div class=logo__title>ChenSoul Blog</div><div class=logo__tagline>Java、Spring、Spring Boot、MicroServices、Architecture、Kubernetes、DevOps</div></div></a></div><nav class=menu><button class=menu__btn aria-haspopup=true aria-expanded=false tabindex=0>
<span class=menu__btn-title tabindex=-1>菜单</span></button><ul class=menu__list><li class=menu__item><a class=menu__link href=/><span class=menu__text>首页</span></a></li><li class=menu__item><a class=menu__link href=/categories/><span class=menu__text>分类</span></a></li><li class=menu__item><a class=menu__link href=/about/><span class=menu__text>关于</span></a></li><li class=menu__item><a class=menu__link href=/index.xml><span class=menu__text>RSS</span></a></li></ul></nav></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>[译]OAuth2 with Spring 第3部分：使用Spring授权服务器授予authorization_code OIDC客户端</h1><div class="post__meta meta"><div class="meta__item-datetime meta__item"><svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0a14 14 0 110 28 1 1 0 010-28m0 3a3 3 0 100 22 3 3 0 000-22m1 4h-2v8.4l6.8 4.4L22 18l-6-3.8z"/></svg><time class=meta__text datetime=2024-06-05>2024-06-05</time></div><div class="meta__item-categories meta__item"><svg class="meta__icon icon icon-category" width="16" height="16" viewBox="0 0 16 16"><path d="m7 2 1 2h8v11H0V2z"/></svg><span class=meta__text><a class=meta__link href=/categories/spring-boot/ rel=category>Spring-Boot</a></span></div><div class="meta__item-author meta__item"><svg class="meta__icon icon icon-author" width="16" height="16" viewBox="0 0 16 16"><path d="M8 1c2 0 3.5 2 3.5 4.5S10 9 10 9c3 1 4 2 4 6H2c0-4 1-5 4-6 0 0-1.5-1-1.5-3.5S6 1 8 1"/></svg><span class=meta__text>ChenSoul</span></div></div></header><div class="content post__content clearfix"><p>原文地址：<a href=https://mainul35.medium.com/oauth2-with-spring-part-3-authorizing-oidc-client-with-via-authorization-code-grant-from-spring-67769f9dd68a target=_blank>https://mainul35.medium.com/oauth2-with-spring-part-3-authorizing-oidc-client-with-via-authorization-code-grant-from-spring-67769f9dd68a</a></p><p>在<a href=/posts/2024/06/05/oauth2-with-spring-part-2-getting-started-with-authorization-server/>上一篇文章</a>中，我们讨论了使用 client_credential 的 OAuth2 授权服务器配置。在本文中，我们将讨论使用 authorization_code 授予类型的授权服务器配置。此授权流程将有一个 OIDC 客户端，它将通过使用授权码进行请求来获取 JWT 令牌。</p><p>如今，社交登录非常流行，它已由 OAuth2 和 OIDC 规范标准化。我们今天的讨论主题是设置我们的社交登录客户端 (oidc-client) 应用程序，将其注册到 Spring Boot 授权服务器，使用授权服务器登录并从 OIDC 客户端应用程序访问安全资源。</p><p>今天的演示将包含 2 个应用程序：</p><ol><li>授权服务器（端口 8080）</li><li>社交登录客户端（端口 8081）</li></ol><p>由于这是一个复杂的主题，让我们首先查看 UI 中的应用程序身份验证和授权流程，然后再讨论配置。</p><p>要继续阅读本文，请从<a href=https://github.com/mainul35/authorization-server-demo/tree/authorization-server-demo/social-login-with-oidc target=_blank>此处</a>获取项目源代码。首先启动授权服务器应用程序，然后在您最喜欢的 IDE 上启动社交登录客户端应用程序。</p><p>我们的社交登录客户端有 2 个端点：</p><ul><li>“/” 将使我们能够访问公共数据</li><li>“/private-data” 将为我们提供 JWT 令牌</li></ul><p>在浏览器上，导航到“ http://127.0.0.1:8081/private-data ”。这将带我们进入客户端应用程序的登录页面。</p><p><img src=/images/oauth2-with-spring-part-3-01.webp alt=img></p><p>由于我们对社交登录感兴趣，因此不要在此登录页面中输入您的用户名和密码，而是单击<strong>oidc-client</strong>。它将带您进入授权服务器的登录页面。</p><p>在下面的屏幕中输入“ user”作为用户名，输入“ secret”作为密码，然后单击“登录”。</p><p><img src=/images/oauth2-with-spring-part-3-02.webp alt=img></p><p>这将带您进入同意页面。请注意同意页面的以下 URL：</p><p><a href="http://localhost:8080/oauth2/authorize?response_type=code&amp;client_id=oidc-client&amp;scope=openid+profile+read+write&amp;state=PcF7UjHDmYvmhwpKfv9zVosy0ZBIA2pZe7HHPixZ76E%3D&amp;redirect_uri=http%3A%2F%2F127.0.0.1%3A8081%2Flogin%2Foauth2%2Fcode%2Foidc-client&amp;nonce=_KHIsN6mNur-AFQz5KNK0TnZi3VPmj567qbe8-4zPMo&amp;continue=" target=_blank>http://localhost:8080/oauth2/authorize?response_type=code&amp;client_id=oidc-client&amp;scope=openid%20profile%20read%20write&amp;state=PcF7UjHDmYvmhwpKfv9zVosy0ZBIA2pZe7HHPixZ76E%3D&amp;redirect_uri=http://127.0.0.1:8081/login/oauth2/code/oidc-client&amp;nonce=_KHIsN6mNur-AFQz5KNK0TnZi3VPmj567qbe8-4zPMo&amp;continue</a></p><p>从上面的URL我们可以找到几条信息：</p><ul><li><a href="http://localhost:8080/oauth2/authorize?response_type=code&amp;client_id=oidc-client&amp;scope=openid+profile+read+write&amp;state=PcF7UjHDmYvmhwpKfv9zVosy0ZBIA2pZe7HHPixZ76E%3D&amp;redirect_uri=http%3A%2F%2F127.0.0.1%3A8081%2Flogin%2Foauth2%2Fcode%2Foidc-client&amp;nonce=_KHIsN6mNur-AFQz5KNK0TnZi3VPmj567qbe8-4zPMo&amp;continue=" target=_blank>response_type=code</a></li><li><a href="http://localhost:8080/oauth2/authorize?response_type=code&amp;client_id=oidc-client&amp;scope=openid+profile+read+write&amp;state=PcF7UjHDmYvmhwpKfv9zVosy0ZBIA2pZe7HHPixZ76E%3D&amp;redirect_uri=http%3A%2F%2F127.0.0.1%3A8081%2Flogin%2Foauth2%2Fcode%2Foidc-client&amp;nonce=_KHIsN6mNur-AFQz5KNK0TnZi3VPmj567qbe8-4zPMo&amp;continue=" target=_blank>client_id=oidc-client</a></li><li><a href="http://localhost:8080/oauth2/authorize?response_type=code&amp;client_id=oidc-client&amp;scope=openid+profile+read+write&amp;state=PcF7UjHDmYvmhwpKfv9zVosy0ZBIA2pZe7HHPixZ76E%3D&amp;redirect_uri=http%3A%2F%2F127.0.0.1%3A8081%2Flogin%2Foauth2%2Fcode%2Foidc-client&amp;nonce=_KHIsN6mNur-AFQz5KNK0TnZi3VPmj567qbe8-4zPMo&amp;continue=" target=_blank>scope = openid</a>, <a href="http://localhost:8080/oauth2/authorize?response_type=code&amp;client_id=oidc-client&amp;scope=openid+profile+read+write&amp;state=PcF7UjHDmYvmhwpKfv9zVosy0ZBIA2pZe7HHPixZ76E%3D&amp;redirect_uri=http%3A%2F%2F127.0.0.1%3A8081%2Flogin%2Foauth2%2Fcode%2Foidc-client&amp;nonce=_KHIsN6mNur-AFQz5KNK0TnZi3VPmj567qbe8-4zPMo&amp;continue=" target=_blank>profile</a>, <a href="http://localhost:8080/oauth2/authorize?response_type=code&amp;client_id=oidc-client&amp;scope=openid+profile+read+write&amp;state=PcF7UjHDmYvmhwpKfv9zVosy0ZBIA2pZe7HHPixZ76E%3D&amp;redirect_uri=http%3A%2F%2F127.0.0.1%3A8081%2Flogin%2Foauth2%2Fcode%2Foidc-client&amp;nonce=_KHIsN6mNur-AFQz5KNK0TnZi3VPmj567qbe8-4zPMo&amp;continue=" target=_blank>read</a>, <a href="http://localhost:8080/oauth2/authorize?response_type=code&amp;client_id=oidc-client&amp;scope=openid+profile+read+write&amp;state=PcF7UjHDmYvmhwpKfv9zVosy0ZBIA2pZe7HHPixZ76E%3D&amp;redirect_uri=http%3A%2F%2F127.0.0.1%3A8081%2Flogin%2Foauth2%2Fcode%2Foidc-client&amp;nonce=_KHIsN6mNur-AFQz5KNK0TnZi3VPmj567qbe8-4zPMo&amp;continue=" target=_blank>write</a></li><li><a href="http://localhost:8080/oauth2/authorize?response_type=code&amp;client_id=oidc-client&amp;scope=openid+profile+read+write&amp;state=PcF7UjHDmYvmhwpKfv9zVosy0ZBIA2pZe7HHPixZ76E%3D&amp;redirect_uri=http%3A%2F%2F127.0.0.1%3A8081%2Flogin%2Foauth2%2Fcode%2Foidc-client&amp;nonce=_KHIsN6mNur-AFQz5KNK0TnZi3VPmj567qbe8-4zPMo&amp;continue=" target=_blank>redirect_uri=http://127.0.0.1:8081/login/oauth2/code/oidc-client</a></li></ul><p><img src=/images/oauth2-with-spring-part-3-03.webp alt=img></p><p>现在，从上面的页面提供您想要允许客户端应用程序的同意。</p><p>如果最初请求的URL（/private-data）具有您刚刚提供的正确同意，它将向我们提供访问令牌和刷新令牌，否则它将显示403错误页面。</p><p><img src=/images/oauth2-with-spring-part-3-04.webp alt=img></p><p>现在让我们深入研究代码。</p><h2 id=授权服务器配置>授权服务器配置</h2><p>在这个应用程序中，所有的事情都在 application.yml 文件中完成。Java 方面没有什么内容，除了主类。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#f92672>spring</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>security</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>user</span>:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e># Definition of the user details that we will use for login</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e># in the authorization server</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>name</span>: <span style=color:#ae81ff>user</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>password</span>: <span style=color:#e6db74>&#34;{noop}secret&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>roles</span>: <span style=color:#ae81ff>USER</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Oauth2 client registration starts from here</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>oauth2</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>authorization-server</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>client</span>:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>          <span style=color:#75715e># We have defined only one client: oidc-client</span>
</span></span><span style=display:flex><span>          <span style=color:#75715e># This client information was also mentioned</span>
</span></span><span style=display:flex><span>          <span style=color:#75715e># in the above URL: client_id=oidc-client</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>oidc-client</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>registration</span>:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>              <span style=color:#75715e># The following client ID and client secret will be matched with the</span>
</span></span><span style=display:flex><span>              <span style=color:#75715e># provided client credentials from client application</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>client-id</span>: <span style=color:#ae81ff>oidc-client</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>client-secret</span>: <span style=color:#e6db74>&#34;{noop}secret2&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>              <span style=color:#75715e># The following authorization-grant-type will be matched with the</span>
</span></span><span style=display:flex><span>              <span style=color:#75715e># provided authorization-grant-type from the client application</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>authorization-grant-types</span>:
</span></span><span style=display:flex><span>                - <span style=color:#e6db74>&#34;authorization_code&#34;</span>
</span></span><span style=display:flex><span>                - <span style=color:#e6db74>&#34;refresh_token&#34;</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>client-authentication-methods</span>:
</span></span><span style=display:flex><span>                - <span style=color:#ae81ff>client_secret_basic</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>              <span style=color:#75715e># This following redirect URI will be used to redirect the resource owner to the</span>
</span></span><span style=display:flex><span>              <span style=color:#75715e># Client application after the resource owner (user) provides necessary consents.</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>redirect-uris</span>:
</span></span><span style=display:flex><span>                - <span style=color:#ae81ff>http://127.0.0.1:8081/login/oauth2/code/oidc-client</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>post-logout-redirect-uris</span>:
</span></span><span style=display:flex><span>                - <span style=color:#ae81ff>http://127.0.0.1:8081/logout</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>              <span style=color:#75715e># The scopes are defined in the authorization server.</span>
</span></span><span style=display:flex><span>              <span style=color:#75715e># These won&#39;t display in the consent page</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>scopes</span>:
</span></span><span style=display:flex><span>                - <span style=color:#e6db74>&#34;openid&#34;</span>
</span></span><span style=display:flex><span>                - <span style=color:#e6db74>&#34;profile&#34;</span>
</span></span><span style=display:flex><span>                - <span style=color:#e6db74>&#34;read&#34;</span>
</span></span><span style=display:flex><span>                - <span style=color:#e6db74>&#34;write&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#75715e># Marking this flag as true will display the consent page</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>require-authorization-consent</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#75715e># Here we set the access token and refresh token validity duration</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e># in seconds</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>token</span>:
</span></span><span style=display:flex><span>              <span style=color:#f92672>access-token-time-to-live</span>: <span style=color:#ae81ff>3600s</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>refresh-token-time-to-live</span>: <span style=color:#ae81ff>7200s</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#        endpoint:</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#          token-uri: &#34;/oauth2/token&#34;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#        issuer-uri: http://127.0.0.1:8080/issuer</span>
</span></span><span style=display:flex><span><span style=color:#f92672>logging</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>level</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>org</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>springframework</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>security</span>: <span style=color:#ae81ff>trace</span>
</span></span></code></pre></div><h2 id=社交登录客户端>社交登录客户端</h2><p>客户端应用程序有一些 java 代码以及 application.yml 配置。</p><p>application.yml</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#f92672>server</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>port</span>: <span style=color:#ae81ff>8081</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>logging</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>level</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>org</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>springframework</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>security</span>: <span style=color:#ae81ff>TRACE</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>spring</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>security</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>oauth2</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>client</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>registration</span>:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>          <span style=color:#75715e># Client registration starts here</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>oidc-client</span>:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#75715e># Our oidc-client needs a provider. The provider information has been registered</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e># at the bottom of this configuration</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>provider</span>: <span style=color:#ae81ff>spring</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#75715e># The following client-id and client-secred will be sent to the authorization server</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e># for client_credentials authentication to the authorization server. We don&#39;t need to</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e># mention the client_credentials in the grant type here. Note that, here the client-secret</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e># must not have {noop} or any other encoding type mentioned.</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>client-id</span>: <span style=color:#ae81ff>oidc-client</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>client-secret</span>: <span style=color:#ae81ff>secret2</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#75715e># Our authorization grant type is authorization_code</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>authorization-grant-type</span>: <span style=color:#ae81ff>authorization_code</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#75715e># The following redirect URL is the redirect URL definition of our client Server application.</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e># It is generally the current application host address. The authorization server&#39;s redirect URL</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e># definition means that this URL will be triggered when auth server redirects data to here.</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>redirect-uri</span>: <span style=color:#e6db74>&#34;{baseUrl}/login/oauth2/code/{registrationId}&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#75715e># Scopes that will be displayed for requesting in the consent page.</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e># Authorization server must have equal or more scopes than these in number</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>scope</span>:
</span></span><span style=display:flex><span>              - <span style=color:#ae81ff>openid</span>
</span></span><span style=display:flex><span>              - <span style=color:#ae81ff>profile</span>
</span></span><span style=display:flex><span>              - <span style=color:#ae81ff>read</span>
</span></span><span style=display:flex><span>              - <span style=color:#ae81ff>write</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>client-authentication-method</span>: <span style=color:#ae81ff>client_secret_basic</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#75715e># This client name will display in the login screen as social login type</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>client-name</span>: <span style=color:#ae81ff>oidc-client</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># As mentioned above about provider, here we register the provider details</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># for any unknown provider with their issuer URI</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>provider</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>spring</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>issuer-uri</span>: <span style=color:#ae81ff>http://localhost:8080</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e># Since our application acts as both authorization client and resource server,</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e># here is the configuration for resource server</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>resource-server</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>jwt</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>issuer-uri</span>: <span style=color:#ae81ff>http://localhost:8080</span>
</span></span></code></pre></div><p><strong>Controller</strong>：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> com.mainul35.socialloginclient;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.beans.factory.annotation.Autowired;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.http.ResponseEntity;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.web.bind.annotation.GetMapping;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.web.bind.annotation.RequestMapping;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.web.bind.annotation.RestController;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RestController</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RequestMapping</span>(<span style=color:#e6db74>&#34;/&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>AppController</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> AppService appService;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@GetMapping</span>(<span style=color:#e6db74>&#34;/&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> ResponseEntity<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>getPublicData</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> ResponseEntity.<span style=color:#a6e22e>ok</span>(<span style=color:#e6db74>&#34;Public data&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@GetMapping</span>(<span style=color:#e6db74>&#34;/private-data&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> ResponseEntity<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>getPrivateData</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> ResponseEntity.<span style=color:#a6e22e>ok</span>(appService.<span style=color:#a6e22e>getJwtToken</span>());
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><strong>Service：</strong></p><p>由于我们的服务方法中有*@PreAuthorize(“hasAuthority(&lsquo;SCOPE_read&rsquo;)”)*，所以我们必须允许来自同意页面的“读取”权限来访问这些数据，否则我们将收到 403 错误页面。您可能对我们如何在此处获取刷新令牌感兴趣。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> com.mainul35.socialloginclient;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.beans.factory.annotation.Autowired;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.security.access.prepost.PreAuthorize;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.security.core.Authentication;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.security.core.context.SecurityContextHolder;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.security.oauth2.client.OAuth2AuthorizedClient;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.security.oauth2.client.OAuth2AuthorizedClientService;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.security.oauth2.client.authentication.OAuth2AuthenticationToken;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.security.oauth2.core.OAuth2AccessToken;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.security.oauth2.core.OAuth2RefreshToken;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.stereotype.Service;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Service</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>AppService</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> OAuth2AuthorizedClientService authorizedClientService;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@PreAuthorize</span>(<span style=color:#e6db74>&#34;hasAuthority(&#39;SCOPE_profile&#39;)&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>getJwtToken</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>var</span> authentication <span style=color:#f92672>=</span> SecurityContextHolder.<span style=color:#a6e22e>getContext</span>().<span style=color:#a6e22e>getAuthentication</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>var</span> accessToken <span style=color:#f92672>=</span> getAccessToken(authentication);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>var</span> refreshToken <span style=color:#f92672>=</span> getRefreshToken(authentication);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> String.<span style=color:#a6e22e>format</span>(<span style=color:#e6db74>&#34;Access Token = %s &lt;br&gt;&lt;br&gt;&lt;br&gt; Refresh Token = %s&#34;</span>,
</span></span><span style=display:flex><span>                accessToken.<span style=color:#a6e22e>getTokenValue</span>(), refreshToken.<span style=color:#a6e22e>getTokenValue</span>());
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> OAuth2AccessToken <span style=color:#a6e22e>getAccessToken</span> (Authentication authentication) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>var</span> authorizedClient <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>getAuthorizedClient</span>(authentication);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (authorizedClient <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>            OAuth2AccessToken accessToken <span style=color:#f92672>=</span> authorizedClient.<span style=color:#a6e22e>getAccessToken</span>();
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (accessToken <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> accessToken;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> OAuth2RefreshToken <span style=color:#a6e22e>getRefreshToken</span>(Authentication authentication) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>var</span> authorizedClient <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>getAuthorizedClient</span>(authentication);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (authorizedClient <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>            OAuth2RefreshToken refreshToken <span style=color:#f92672>=</span> authorizedClient.<span style=color:#a6e22e>getRefreshToken</span>();
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (refreshToken <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> refreshToken;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> OAuth2AuthorizedClient <span style=color:#a6e22e>getAuthorizedClient</span>(Authentication authentication) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (authentication <span style=color:#66d9ef>instanceof</span> OAuth2AuthenticationToken) {
</span></span><span style=display:flex><span>            OAuth2AuthenticationToken oauthToken <span style=color:#f92672>=</span> (OAuth2AuthenticationToken) authentication;
</span></span><span style=display:flex><span>            String clientRegistrationId <span style=color:#f92672>=</span> oauthToken.<span style=color:#a6e22e>getAuthorizedClientRegistrationId</span>();
</span></span><span style=display:flex><span>            String principalName <span style=color:#f92672>=</span> oauthToken.<span style=color:#a6e22e>getName</span>();
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> authorizedClientService
</span></span><span style=display:flex><span>                    .<span style=color:#a6e22e>loadAuthorizedClient</span>(clientRegistrationId, principalName);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><strong>SocialLoginClientApplication</strong>：</p><p><strong>我们必须用@EnableMethodSecurity</strong>注释我们的Main类以允许应用程序中的方法安全。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> com.mainul35.socialloginclient;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.boot.SpringApplication;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.boot.autoconfigure.SpringBootApplication;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.security.config.annotation.method.configuration.EnableMethodSecurity;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@EnableMethodSecurity</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@SpringBootApplication</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SocialLoginClientApplication</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span>(String<span style=color:#f92672>[]</span> args) {
</span></span><span style=display:flex><span>  SpringApplication.<span style=color:#a6e22e>run</span>(SocialLoginClientApplication.<span style=color:#a6e22e>class</span>, args);
</span></span><span style=display:flex><span> }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>根据<a href=https://docs.spring.io/spring-security/reference/servlet/oauth2/client/authorization-grants.html#oauth2Client-refresh-token-grant target=_blank>Spring Security 文档</a>，对于“ authorization_code”授予，如果<code>OAuth2AuthorizedClient.getRefreshToken()</code>可用并且<code>OAuth2AuthorizedClient.getAccessToken()</code>已过期，则会自动刷新<code>RefreshTokenOAuth2AuthorizedClientProvider</code>。</p><p><img src=/images/oauth2-with-spring-part-3-05.webp alt=img></p><p>感谢您的耐心阅读。在<a href=/posts/2024/06/05/oauth2-with-spring-part-4-spring-authorization-client-social-login-demo-with-google/>下一篇文章</a>中，我们将尝试了解如何在客户端应用程序中使用 Google 作为授权服务器。</p><p>此示例的完整代码可在<a href=https://github.com/mainul35/authorization-server-demo/tree/authorization-server-demo/social-login-with-oidc target=_blank>此处</a>找到。</p></div><footer class=post__footer><footer class=post__footer><div class="post__tags tags clearfix"><svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M4 0h8s2 0 4 2l15 15s2 2 0 4L21 31s-2 2-4 0L2 16s-2-2-2-4V3s0-3 4-3m3 10a3 3 0 000-6 3 3 0 000 6"/></svg><ul class=tags__list><li class=tags__item><a class="tags__link btn" href=/tags/oauth2/ rel=tag>oauth2</a></li><li class=tags__item><a class="tags__link btn" href=/tags/java/ rel=tag>java</a></li></ul></div></footer></footer></article></main><nav class="pagination flex"><div class="pagination__item pagination__item--prev"><a class=pagination__link href=/posts/2024/06/05/oauth2-with-spring-part-4-spring-authorization-client-social-login-demo-with-google/ rel=prev><p class=pagination__title>«&#8201;上一篇: [译]OAuth2 with Spring 第4部分：Spring授权客户端与Google授权服务器的社交登录演示</p></a></div><div class="pagination__item pagination__item--next"><a class=pagination__link href=/posts/2024/06/05/oauth2-with-spring-part-2-getting-started-with-authorization-server/ rel=next><p class=pagination__title>&#8201;» 下一篇: [译]OAuth2 with Spring 第2部分：授权服务器入门</p></a></div></nav><footer class=post__footer><div class=post-related><h3>相关文章</h3><ul class=post-related-list><li class=post-related-item><a href=/posts/2024/06/05/oauth2-with-spring-part-1-knowing-the-basic-concepts/ target=_blank title="[译]OAuth2 with Spring 第1部分：了解基本概念">[译]OAuth2 with Spring 第1部分：了解基本概念</a></li><li class=post-related-item><a href=/posts/2024/06/05/oauth2-with-spring-part-4-spring-authorization-client-social-login-demo-with-google/ target=_blank title="[译]OAuth2 with Spring 第4部分：Spring授权客户端与Google授权服务器的社交登录演示">[译]OAuth2 with Spring 第4部分：Spring授权客户端与Google授权服务器的社交登录演示</a></li><li class=post-related-item><a href=/posts/2024/06/05/oauth2-with-spring-part-5-securing-your-spring-boot-application-with-pkce-for-enhanced-security/ target=_blank title="[译]OAuth2 with Spring 第5部分：使用PKCE保护您的Spring Boot应用程序以增强安全性">[译]OAuth2 with Spring 第5部分：使用PKCE保护您的Spring Boot应用程序以增强安全性</a></li><li class=post-related-item><a href=/posts/2024/06/05/oauth2/ target=_blank title="RFC6749 | OAuth2.0授权框架中文版">RFC6749 | OAuth2.0授权框架中文版</a></li><li class=post-related-item><a href=/posts/2024/06/05/oauth2-with-spring-part-2-getting-started-with-authorization-server/ target=_blank title="[译]OAuth2 with Spring 第2部分：授权服务器入门">[译]OAuth2 with Spring 第2部分：授权服务器入门</a></li><li class=post-related-item><a href=/posts/2024/06/05/oauth2-server/ target=_blank title=[译]OAuth2.0服务器>[译]OAuth2.0服务器</a></li></ul></div></footer><div class="authorbox clearfix"><figure class=authorbox__avatar><img alt="ChenSoul avatar" src=/avatar.jpg class=avatar height=60 width=60 loading=lazy></figure><div class=authorbox__header><span class=authorbox__name>关于 ChenSoul</span></div><div class=authorbox__description>一个来自中国武汉的开发者，主要撰写软件开发和开源方面的文章。浏览我的<a href=%28/posts%29>博客文章</a>，订阅我的 <a href=/index.xml>RSS</a> 源，或了解更多<a href=/about/>关于我</a>的信息。</div></div><p><h3>欢迎留言！</h3></p><div id=remark42></div><script>var remark_config={host:"https://comment.chensoul.cc",site_id:"remark",components:["embed"],url:"https://blog.chensoul.cc/posts/2024/06/05/oauth2-with-spring-part-3-authorizing-oidc-client-with-via-authorization-code-grant-from-spring/",locale:"zh"};!function(e,t){for(s=0;s<e.length;s++){var s,n=t.createElement("script"),o=".js",i=t.head||t.body;"noModule"in n?(n.type="module",o=".mjs"):n.async=!0,n.defer=!0,n.src=remark_config.host+"/web/"+e[s]+o,i.appendChild(n)}}(remark_config.components||["embed"],document)</script></div><aside class="sidebar sidebar--right"><div class="post__toc toc"><div class=toc__title>目录</div><div class=toc__menu><nav id=TableOfContents><ul><li><a href=#授权服务器配置>授权服务器配置</a></li><li><a href=#社交登录客户端>社交登录客户端</a></li></ul></nav></div></div></aside></div><footer class=footer><div class="container footer__container flex"><div class=footer__links><a class=footer__link href=/>首页</a> | <a class=footer__link href=/categories/>分类</a> | <a class=footer__link href=/about/>关于</a> | <a class=footer__link href=/index.xml>RSS</a></div><div class=footer__copyright>&copy; 2025 ChenSoul.
<span class=footer__copyright-credits>基于 <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> 引擎和 <a href=https://github.com/chensoul/rose-hugo/ rel="nofollow noopener" target=_blank>Rose Hugo</a> 主题</span></div></div><style>.scroll-up a{display:block;height:3.125rem;width:3.125rem;text-align:center;line-height:2.7;border-radius:50px;font-size:1.125rem;color:#fff;opacity:1;transition:all .3s ease 0s;box-shadow:0 0 10px rgb(0 0 0/.2)}.scroll-up a{background:#ee591f}.scroll-up{position:fixed;display:none;bottom:50px;z-index:999}.scroll-up.right{right:60px}</style><div class="scroll-up custom right" style=display:block><a href=#top id=top-link accesskey=g><i class="fa fa-arrow-up"></i></a></div><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script defer src=https://umami.chensoul.cc/random-string.js data-website-id=1e07d36d-bec3-4ba6-9459-876b1ac3bbe7></script></footer></div><script>"use strict";(function(t){var i=t.querySelector(".menu__btn"),o=t.querySelector(".menu__list");function a(){o.classList.toggle("menu__list--active"),o.classList.toggle("menu__list--transition"),this.classList.toggle("menu__btn--active"),this.setAttribute("aria-expanded",this.getAttribute("aria-expanded")==="true"?"false":"true")}function r(){this.classList.remove("menu__list--transition")}i&&o&&(i.addEventListener("click",a,!1),o.addEventListener("transitionend",r,!1))})(document,window)</script></body></html>